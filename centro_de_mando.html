<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Mando | AG Visual Info</title>
    <link rel="icon" type="image/png" href="https://placehold.co/32x32/1a1a1a/FDFDFD?text=AG">

    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    
    <style>
        /* Estilos para que el editor se vea profesional y limpio */
        .ql-toolbar { border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; background: #f9fafb; border-color: #e5e7eb; }
        .ql-container { border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; background: white; font-family: 'Montserrat', sans-serif; font-size: 0.9rem; border-color: #e5e7eb; }
        .ql-editor { min-height: 120px; } /* Altura mínima para escribir cómodo */
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root { --bg-main: #FDFDFD; --text-dark: #1a1a1a; --text-muted: #52525b; --accent: #3a3a3a; --border-color: #e5e7eb; --status-pending: #f59e0b; --status-confirmed: #10b981; --status-paid: #3b82f6; --status-canceled: #ef4444; }
        body { font-family: 'Montserrat', sans-serif; background-color: var(--bg-main); color: var(--text-dark); }
        h1, h2, h3, .font-display { font-family: 'Cormorant Garamond', serif; }
        
        /* UI Components */
        .loader-circle { width: 50px; height: 50px; border: 4px solid rgba(0,0,0,0.1); border-radius: 50%; border-top-color: var(--accent); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .btn { padding: 0.5rem 1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.75rem; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; cursor: pointer; border-radius: 4px; }
        .btn-primary { background-color: var(--text-dark); color: white; }
        .btn-primary:hover { background-color: var(--accent); }
        .btn-secondary { border: 1px solid var(--text-dark); color: var(--text-dark); background: transparent; }
        .btn-secondary:hover { background: #f3f4f6; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.7rem; }
        
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); font-family: 'Montserrat', sans-serif; font-size: 0.9rem; background: white; }
        .form-input:focus { border-color: var(--text-dark); outline: none; }
        .form-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.25rem; display: block; }
        
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1.5rem; color: var(--text-muted); border-left: 4px solid transparent; transition: all 0.2s; font-size: 0.9rem; }
        .sidebar-link:hover { background-color: #f3f4f6; color: var(--text-dark); }
        .sidebar-link.active { background-color: #f3f4f6; color: var(--text-dark); border-left-color: var(--text-dark); font-weight: 700; }
        .sidebar-link i { width: 1.5rem; text-align: center; margin-right: 0.75rem; }
        
        .view { display: none; animation: fadeIn 0.3s ease-out; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; width: 95%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); transform: scale(0.95); transition: transform 0.2s; border-radius: 8px; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        
        .toast { position: fixed; bottom: 2rem; right: 2rem; background: var(--text-dark); color: white; padding: 1rem 1.5rem; z-index: 100; transform: translateY(100px); transition: transform 0.3s; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); font-weight: 600; border-radius: 4px; }
        .toast.visible { transform: translateY(0); }
        .toast.error { background: #ef4444; }
        
        .img-preview { width: 60px; height: 60px; object-fit: cover; border: 1px solid #e5e7eb; border-radius: 4px; background-color: #f9fafb; }
        
        .tab-nav { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        .tab-btn { padding: 1rem; color: var(--text-muted); font-weight: 600; border-bottom: 2px solid transparent; transition: all 0.2s; cursor: pointer; }
        .tab-btn.active { color: var(--text-dark); border-bottom-color: var(--text-dark); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .portfolio-grid-item { position: relative; aspect-ratio: 1; overflow: hidden; border-radius: 4px; border: 1px solid #eee; background: #f3f4f6; transition: transform 0.2s; }
        .portfolio-grid-item img { width: 100%; height: 100%; object-fit: cover; }
        .portfolio-grid-overlay { 
            position: absolute; inset: 0; background: rgba(0,0,0,0.8); 
            opacity: 0; transition: opacity 0.2s; 
            display: flex; flex-direction: column; justify-content: center; items-center; gap: 10px; 
        }
        .portfolio-grid-item:hover .portfolio-grid-overlay { opacity: 1; }
        .portfolio-badge { position: absolute; top: 5px; right: 5px; background: #10b981; color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: bold; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        .status-badge { padding: 2px 8px; border-radius: 10px; color: white; font-size: 0.65rem; font-weight: bold; text-transform: uppercase; }
        .status-Pendiente { background: var(--status-pending); }
        .status-Confirmado { background: var(--status-confirmed); }
        .status-Pagado { background: var(--status-paid); }
        .status-Cancelado { background: var(--status-canceled); }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <div id="loading-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-white">
        <div class="loader-circle"></div>
        <p id="loading-text" class="mt-4 font-display text-xl text-text-dark">Cargando Sistema...</p>
        <button onclick="UI.forceReload()" class="mt-4 text-sm text-gray-400 underline hover:text-gray-600 hidden" id="reload-btn">Recargar</button>
    </div>

    <div id="login-screen" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-gray-100">
        <div class="bg-white p-10 shadow-2xl max-w-md w-full text-center border-t-4 border-text-dark">
            <h1 class="font-display text-4xl font-bold mb-2">AG Visual Info</h1>
            <p class="text-text-muted mb-8 uppercase tracking-widest text-xs">Panel de Control</p>
            <button id="google-login-btn" class="w-full bg-[#4285F4] text-white font-bold py-3 px-4 flex items-center justify-center gap-3 hover:bg-[#3367D6] transition-colors shadow-md rounded">
                <i class="fab fa-google"></i> Iniciar con Google Workspace
            </button>
        </div>
    </div>

    <div id="app-screen" class="hidden flex-1 flex h-full overflow-hidden">
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col flex-shrink-0 shadow-sm z-20">
            <div class="p-6 border-b border-gray-100">
                <h2 class="font-display text-2xl font-bold">AG Admin</h2>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 space-y-1" id="main-nav">
                <a href="#" class="sidebar-link active" data-view="dashboard"><i class="fas fa-home"></i>Inicio</a>
                <a href="#" class="sidebar-link" data-view="projects"><i class="fas fa-camera"></i>Proyectos</a>
                <a href="#" class="sidebar-link" data-view="portfolio-manager"><i class="fas fa-images"></i>Portafolio</a>
                <a href="#" class="sidebar-link" data-view="services"><i class="fas fa-concierge-bell"></i>Servicios</a>
                <a href="#" class="sidebar-link" data-view="videos"><i class="fas fa-video"></i>Videos</a>
                <a href="#" class="sidebar-link" data-view="rentals"><i class="fas fa-box"></i>Alquiler</a>
                <a href="#" class="sidebar-link" data-view="bookings"><i class="fas fa-calendar-check"></i>Reservas</a>
                <a href="#" class="sidebar-link" data-view="settings"><i class="fas fa-cog"></i>Configuración</a>
            </nav>
            <div class="p-4 border-t border-gray-100">
                <button id="logout-btn" class="w-full text-left px-4 py-2 text-text-muted hover:text-red-600 transition-colors text-xs font-bold uppercase"><i class="fas fa-sign-out-alt mr-2"></i>Salir</button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-gray-50 p-8 relative">
            
        <div id="view-dashboard" class="view active">
                <h1 class="text-4xl font-display font-bold mb-6">Inicio</h1>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-5 shadow-sm border border-gray-200 rounded-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-500 uppercase font-bold tracking-wider">Proyectos</p>
                                <p class="text-3xl font-display font-bold mt-1" id="dash-projects">0</p>
                            </div>
                            <i class="fas fa-camera text-gray-200 text-2xl"></i>
                        </div>
                    </div>
                    <div class="bg-white p-5 shadow-sm border border-gray-200 rounded-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-500 uppercase font-bold tracking-wider">Portafolio</p>
                                <p class="text-3xl font-display font-bold mt-1" id="dash-portfolio">0</p>
                            </div>
                            <i class="fas fa-images text-gray-200 text-2xl"></i>
                        </div>
                    </div>
                    <div class="bg-white p-5 shadow-sm border border-gray-200 rounded-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-500 uppercase font-bold tracking-wider">Servicios</p>
                                <p class="text-3xl font-display font-bold mt-1" id="dash-services">0</p>
                            </div>
                            <i class="fas fa-concierge-bell text-gray-200 text-2xl"></i>
                        </div>
                    </div>
                    <div class="bg-white p-5 shadow-sm border border-gray-200 rounded-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-500 uppercase font-bold tracking-wider">Equipos</p>
                                <p class="text-3xl font-display font-bold mt-1" id="dash-rentals">0</p>
                            </div>
                            <i class="fas fa-box text-gray-200 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 shadow-sm border border-gray-200 rounded-lg">
                        <h3 class="text-sm text-gray-700 font-bold mb-4 border-b pb-2">Actividad de Alquileres (Últimos 6 Meses)</h3>
                        <div class="relative h-64 w-full">
                            <canvas id="bookingsChart"></canvas>
                        </div>
                    </div>

                    <div class="bg-black text-white p-6 shadow-lg border border-gray-800 rounded-lg flex flex-col justify-between">
                        <div>
                            <h3 class="text-xs text-gray-400 uppercase font-bold tracking-wider mb-1">Atención Requerida</h3>
                            <p class="text-xl font-display">Solicitudes Pendientes</p>
                        </div>
                        <div class="flex items-end justify-between mt-4">
                            <p class="text-6xl font-bold text-white" id="dash-bookings">0</p>
                            <button onclick="App.switchView('bookings')" class="text-sm bg-white/10 hover:bg-white/20 px-3 py-1 rounded transition">Ver Todo &rarr;</button>
                        </div>
                    </div>
                    
                </div>
            </div>

            <div id="view-projects" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-display font-bold">Proyectos</h1>
                    <button class="btn btn-primary" onclick="App.handleEditCrudItem('Projects', null)"><i class="fas fa-plus"></i> Nuevo</button>
                </div>
                <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b">
                            <tr>
                                <th class="p-4 text-center">Orden</th> <th class="p-4">Portada</th>
                                <th class="p-4">Título</th>
                                <th class="p-4 text-center">Fotos</th>
                                <th class="p-4 text-center">Acciones</th> </tr>
                        </thead>
                        <tbody id="projects-table-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-portfolio-manager" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-display font-bold">Portafolio</h1>
                    <button class="btn btn-primary" onclick="App.savePortfolioOrder()"><i class="fas fa-save"></i> Guardar Orden</button>
                </div>
                <div id="portfolio-manager-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
            </div>

            <div id="view-videos" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-display font-bold">Videos</h1>
                    <button class="btn btn-primary" onclick="App.handleEditCrudItem('Videos', null)"><i class="fas fa-plus"></i> Nuevo</button>
                </div>
                <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b">
                            <tr><th class="p-4">Orden</th><th class="p-4">Título</th><th class="p-4">URL</th><th class="p-4">Acciones</th></tr>
                        </thead>
                        <tbody id="videos-table-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-services" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-display font-bold">Servicios</h1>
                    <button class="btn btn-primary" onclick="App.handleEditCrudItem('Services', null)"><i class="fas fa-plus"></i> Nuevo</button>
                </div>
                <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b">
                            <tr><th class="p-4">Orden</th><th class="p-4">Título</th><th class="p-4">Acciones</th></tr>
                        </thead>
                        <tbody id="services-table-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

           <div id="view-rentals" class="view">
                <h1 class="text-3xl font-display font-bold mb-6">Alquiler</h1>
                
                <div class="tab-nav">
                    <button class="tab-btn" onclick="UI.switchTab('rental-cats')">Categorías</button>
                    <button class="tab-btn active" onclick="UI.switchTab('rental-items')">Equipos</button>
                    <button class="tab-btn" onclick="UI.switchTab('blocked-dates')">Bloqueos</button>
                </div>

                <div id="tab-rental-cats" class="tab-content">
                    <div class="flex justify-end mb-4">
                        <button class="btn btn-primary" onclick="App.handleEditCrudItem('RentalCategories', null)"><i class="fas fa-plus"></i> Nueva Categoría</button>
                    </div>
                    <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b">
                                <tr><th class="p-4">Orden</th><th class="p-4">Nombre</th><th class="p-4">Acciones</th></tr>
                            </thead>
                            <tbody id="rental-categories-table-body" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-rental-items" class="tab-content active">
                    <div class="flex justify-end mb-4">
                        <button class="btn btn-primary" onclick="App.handleEditCrudItem('RentalItems', null)"><i class="fas fa-plus"></i> Nuevo Equipo</button>
                    </div>
                    <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b">
                                <tr><th class="p-4">Img</th><th class="p-4">Nombre</th><th class="p-4">Categoría</th><th class="p-4">Precio</th><th class="p-4">Acciones</th></tr>
                            </thead>
                            <tbody id="rental-items-table-body" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="tab-blocked-dates" class="tab-content">
                    <div class="flex justify-end mb-4">
                        <button class="btn btn-primary" onclick="App.handleEditCrudItem('BlockedDates', null)"><i class="fas fa-ban"></i> Nuevo Bloqueo</button>
                    </div>
                    <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b">
                                <tr><th class="p-4">Equipo</th><th class="p-4">Motivo</th><th class="p-4">Desde</th><th class="p-4">Hasta</th><th class="p-4">Acciones</th></tr>
                            </thead>
                            <tbody id="blocked-dates-table-body" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>


            

            <div id="view-bookings" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-display font-bold">Reservas</h1>
                    <button class="btn btn-primary" onclick="App.handleManualBooking()"><i class="fas fa-plus"></i> Nueva Reserva</button>
                </div>
                
                <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b">
                            <tr><th class="p-4">Fecha</th><th class="p-4">Cliente</th><th class="p-4">Equipo</th><th class="p-4">Total</th><th class="p-4">Estado</th><th class="p-4">Acciones</th></tr>
                        </thead>
                        <tbody id="bookings-list-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-settings" class="view">
                <h1 class="text-3xl font-display font-bold mb-6">Configuración</h1>
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="UI.switchTab('settings-gen')">Identidad & Redes</button>
                    <button class="tab-btn" onclick="UI.switchTab('settings-about')">Bio (Sobre Mí)</button>
                    <button class="tab-btn" onclick="UI.switchTab('settings-clients')">Logos Clientes</button>
                </div>
                
                <div id="tab-settings-gen" class="tab-content active space-y-8">
                     <div class="bg-white p-6 rounded border border-gray-200">
                         <h3 class="font-bold text-lg mb-4 border-b pb-2">Identidad de Marca</h3>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                             <div class="text-center">
                                <p class="text-xs font-bold text-gray-500 mb-2">Logo Negro</p>
                                <div class="h-24 bg-gray-100 border rounded flex items-center justify-center mb-2 relative group">
                                    <img id="preview-logo_black" src="https://placehold.co/100x50/transparent/png" class="max-h-20 max-w-full object-contain">
                                    <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center rounded cursor-pointer" onclick="document.getElementById('upload-logo_black').click()">
                                        <i class="fas fa-camera text-white"></i>
                                    </div>
                                </div>
                                <input type="file" id="upload-logo_black" class="hidden" accept="image/*" onchange="App.uploadImages(this, 'logo_black', 'Marca', 'SettingImage')">
                            </div>
                             <div class="text-center">
                                <p class="text-xs font-bold text-gray-500 mb-2">Logo Blanco</p>
                                <div class="h-24 bg-gray-800 border rounded flex items-center justify-center mb-2 relative group">
                                    <img id="preview-logo_white" src="https://placehold.co/100x50/transparent/png" class="max-h-20 max-w-full object-contain">
                                    <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center rounded cursor-pointer" onclick="document.getElementById('upload-logo_white').click()">
                                        <i class="fas fa-camera text-white"></i>
                                    </div>
                                </div>
                                <input type="file" id="upload-logo_white" class="hidden" accept="image/*" onchange="App.uploadImages(this, 'logo_white', 'Marca', 'SettingImage')">
                            </div>
                             <div class="text-center">
                                <p class="text-xs font-bold text-gray-500 mb-2">Favicon</p>
                                <div class="h-24 bg-white border rounded flex items-center justify-center mb-2 relative group">
                                    <img id="preview-favicon" src="https://placehold.co/32" class="w-8 h-8 object-contain">
                                    <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center rounded cursor-pointer" onclick="document.getElementById('upload-favicon').click()">
                                        <i class="fas fa-camera text-white"></i>
                                    </div>
                                </div>
                                <input type="file" id="upload-favicon" class="hidden" accept="image/*" onchange="App.uploadImages(this, 'favicon', 'Marca', 'SettingImage')">
                            </div>
                         </div>
                     </div>
                     <div id="settings-form-container" class="bg-white p-6 rounded border border-gray-200"></div>
                </div>

                <div id="tab-settings-about" class="tab-content">
                    <div class="bg-white p-6 rounded border border-gray-200 max-w-3xl">
                        <div class="mb-6 flex items-center gap-6">
                            <div class="relative group w-32 h-32 flex-shrink-0">
                                <img id="about-profile-preview" src="https://placehold.co/128" class="w-full h-full rounded-full object-cover border shadow-sm">
                                <div class="absolute inset-0 bg-black/50 rounded-full hidden group-hover:flex items-center justify-center cursor-pointer" onclick="document.getElementById('upload-profile-pic').click()">
                                    <i class="fas fa-camera text-white text-2xl"></i>
                                </div>
                                <input type="file" id="upload-profile-pic" class="hidden" accept="image/*" onchange="App.uploadImages(this, 'profile_image', 'Perfil', 'AboutProfile')">
                            </div>
                            <div class="flex-1">
                                <h3 class="font-display text-xl font-bold">Foto de Perfil</h3>
                                <p class="text-sm text-gray-500">Aparece en la sección "Quién Soy".</p>
                            </div>
                        </div>
                        <div id="about-form-container" class="space-y-4"></div>
                        <button class="btn btn-primary mt-4" onclick="App.handleSaveAbout()">Guardar Bio</button>
                    </div>
                </div>
                
                <div id="tab-settings-clients" class="tab-content">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">Logos de Clientes</h3>
                        <div class="flex gap-2">
                             <button class="btn btn-secondary" onclick="App.saveGalleryChanges(null, 'ClientLogos')"><i class="fas fa-save mr-2"></i>Guardar Orden</button>
                             <button class="btn btn-primary" onclick="App.handleClientLogos()">+ Subir Logos</button>
                        </div>
                    </div>
                     <div id="clientlogos-grid" class="grid grid-cols-2 md:grid-cols-6 gap-4 bg-white p-4 rounded border"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-container"></div>
    <div id="toast-container"></div>
    <div id="confirm-modal-overlay" class="modal-overlay">
        <div id="confirm-modal-content" class="modal-content p-6 bg-white rounded-lg max-w-md text-center">
            <h3 id="confirm-title" class="text-xl font-bold mb-2">Confirmar</h3>
            <p id="confirm-message" class="text-gray-600 mb-6">Mensaje...</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="btn btn-secondary flex-1 justify-center">Cancelar</button>
                <button id="confirm-ok-btn" class="btn btn-danger flex-1 justify-center">Eliminar</button>
            </div>
        </div>
    </div>

<script>
const GOOGLE_REDIRECT_URI = 'postmessage';
// Estado Global + Memoria para Edición en Batch
const AppState = { data: {}, token: JSON.parse(localStorage.getItem('gAuthToken') || 'null'), view: 'dashboard' };

let currentModalImages = []; 
let currentServiceBlocks = []; // Memoria para bloques de servicio
let activeQuillEditor = null;  // Instancia del editor de texto
let pendingDeletions = [];

// --- API (Con soporte Batch) ---
const API = {
    async call(endpoint, options = {}) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 60000);
        const headers = new Headers(options.headers || {});
        if (AppState.token?.access_token) headers.set('Authorization', `Bearer ${AppState.token.access_token}`);
        if (options.body && !(options.body instanceof FormData)) {
            headers.set('Content-Type', 'application/json');
            options.body = JSON.stringify(options.body);
        }
        try {
            const sep = endpoint.includes('?') ? '&' : '?';
            const res = await fetch(`${endpoint}${sep}t=${Date.now()}`, { ...options, headers, signal: controller.signal });
            clearTimeout(timeoutId);
            if (res.status === 401) {
                if (await Auth.refresh()) return API.call(endpoint, options);
                else { Auth.logout(); throw new Error('Sesión expirada'); }
            }
            const text = await res.text();
            let data;
            try { data = JSON.parse(text); } catch (e) { throw new Error(`Error Servidor: ${text.substring(0,50)}`); }
            if (!res.ok) throw new Error(data.error || data.message || 'Error desconocido');
            return data;
        } catch (e) { clearTimeout(timeoutId); throw e; }
    },
    
    // Función inteligente para guardar en lotes (Chuncking) y evitar Timeout
    // Se añade el parámetro customLoadingMessage = null
    async batchUpdate(operations, customLoadingMessage = null) {
        if(operations.length === 0) return;

        const BATCH_SIZE = 10; 
        
        // Si no hay mensaje personalizado, usa el genérico. Si hay, usa ese.
        if (!customLoadingMessage) {
            UI.showLoading(`Procesando ${operations.length} cambios...`);
        } else {
            UI.showLoading(customLoadingMessage);
        }

        for (let i = 0; i < operations.length; i += BATCH_SIZE) {
            const batch = operations.slice(i, i + BATCH_SIZE);
            
            // SOLO actualiza el contador si NO hay mensaje personalizado fijo
            if (!customLoadingMessage) {
                const currentCount = Math.min(i + BATCH_SIZE, operations.length);
                UI.showLoading(`Procesando ${currentCount}/${operations.length} cambios...`);
            }

            try {
                await API.call('/.netlify/functions/update-sheet-data', {
                    method: 'POST',
                    body: batch // Enviamos el lote
                });
                
                // Pequeña pausa de seguridad entre lotes (2 segundos)
                if (i + BATCH_SIZE < operations.length) {
                    await new Promise(resolve => setTimeout(resolve, 10000));
                }
            } catch (e) {
                console.error(`Error en lote ${batchNum}:`, e);
                throw new Error(`Fallo al guardar el lote ${batchNum}. Intenta de nuevo.`);
            }
        }
    }
};

// --- AUTH ---
const Auth = {
    async init() { if (AppState.token) { if (Date.now() >= AppState.token.expires_at) await this.refresh(); UI.showApp(); } else UI.showLogin(); },
    async login() { 
        if (typeof google === 'undefined') { alert("Error: Google JS no cargó."); return; }
        try { const c = await fetch('/.netlify/functions/get-auth-config').then(r=>r.json()); google.accounts.oauth2.initCodeClient({ client_id: c.clientId, scope: 'https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/drive', callback: (r) => r.code && this.exchangeCode(r.code) }).requestCode(); } catch(e){alert(e.message);} 
    },
    async exchangeCode(code) { UI.showLoading('Autenticando...'); try { const t = await fetch('/.netlify/functions/auth-google', { method: 'POST', body: JSON.stringify({ code, redirectUri: GOOGLE_REDIRECT_URI }) }).then(r=>r.json()); if(t.error) throw new Error(t.error); this.setToken(t); UI.showApp(); } catch(e){alert(e.message); UI.showLogin();} },
    async refresh() { if(!AppState.token?.refresh_token) return false; try{ const t = await fetch('/.netlify/functions/auth-refresh', { method: 'POST', body: JSON.stringify({ refresh_token: AppState.token.refresh_token }) }).then(r=>r.json()); if(t.error) throw new Error; this.setToken({...AppState.token, ...t}); return true; }catch{return false;} },
    setToken(t) { if(t.expires_in) t.expires_at = Date.now()+(t.expires_in*1000); AppState.token=t; localStorage.setItem('gAuthToken', JSON.stringify(t)); },
    logout() { localStorage.removeItem('gAuthToken'); location.reload(); }
};

// --- UI ---
const UI = {
    showLogin: () => { document.getElementById('loading-screen').style.display='none'; document.getElementById('app-screen').style.display='none'; document.getElementById('login-screen').style.display='flex'; },
    showApp: async () => {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('loading-screen').style.display = 'flex';
        try {
            await App.loadData('dashboard');
            document.getElementById('app-screen').style.display = 'flex';
            document.getElementById('loading-screen').style.display = 'none';
            App.switchView('dashboard'); 
        } catch (e) {
            document.getElementById('loading-screen').style.display = 'none';
            alert("Error inicio: " + e.message);
            document.getElementById('login-screen').style.display = 'flex';
        }
    },
    forceReload: () => location.reload(),
    showLoading: (msg) => { 
        const txt = document.getElementById('loading-text'); if(txt) txt.innerText=msg;
        const scr = document.getElementById('loading-screen'); if(scr) scr.style.display='flex';
        const btn = document.getElementById('reload-btn'); if(btn) btn.classList.add('hidden');
    },
    hideLoading: () => { const scr = document.getElementById('loading-screen'); if(scr) scr.style.display='none'; },
    showToast: (msg, type='success') => { const t=document.createElement('div'); t.className=`toast ${type}`; t.innerText=msg; document.getElementById('toast-container').appendChild(t); setTimeout(()=>t.classList.add('visible'),10); setTimeout(()=>t.remove(),3000); },
    showConfirm: (title, msg, cb) => { 
        const o = document.getElementById('confirm-modal-overlay');
        // Actualizamos Título y Mensaje
        document.getElementById('confirm-title').textContent = title;
        document.getElementById('confirm-message').textContent = msg;
        
        const ok = document.getElementById('confirm-ok-btn');
        const ca = document.getElementById('confirm-cancel-btn');
        
        // Clonamos botones para limpiar eventos anteriores
        const nok = ok.cloneNode(true); 
        const nca = ca.cloneNode(true);
        
        ok.parentNode.replaceChild(nok, ok); 
        ca.parentNode.replaceChild(nca, ca);
        
        nok.addEventListener('click', () => { o.classList.remove('visible'); cb(); });
        nca.addEventListener('click', () => { o.classList.remove('visible'); });
        
        o.classList.add('visible'); 
    },
    switchTab(id) { const v=document.querySelector('.view.active'); if(!v)return; v.querySelectorAll('.tab-btn,.tab-content').forEach(e=>e.classList.remove('active')); v.querySelectorAll(`.tab-btn[onclick*="${id}"]`).forEach(b=>b.classList.add('active')); document.getElementById(`tab-${id}`).classList.add('active'); },
    
    inputHTML: (p,k,l,v='',t='text') => `<div class="mb-4"><label class="form-label">${l}</label><input type="${t}" id="${p}-${k}" data-key="${k}" class="form-input" value="${v||''}"></div>`,
    textareaHTML: (p,k,l,v='') => `<div class="mb-4"><label class="form-label">${l}</label><textarea id="${p}-${k}" data-key="${k}" class="form-textarea" rows="4">${v||''}</textarea></div>`,
    selectHTML: (p,k,l,opts,v='') => `<div class="mb-4"><label class="form-label">${l}</label><select id="${p}-${k}" data-key="${k}" class="form-select">${opts.map(o=>`<option value="${o.id}" ${o.id==v?'selected':''}>${o.name}</option>`).join('')}</select></div>`,
    showModal: (t,b,f) => { document.getElementById('modal-container').innerHTML=`<div class="modal-overlay visible"><div class="modal-content"><div class="p-6 border-b flex justify-between items-center bg-gray-50 flex-shrink-0"><h2 class="text-xl font-display font-bold">${t}</h2><button onclick="UI.closeModal()" class="text-2xl">&times;</button></div><div class="p-6 flex-1 overflow-y-auto">${b}</div><div class="p-6 bg-gray-50 border-t flex-shrink-0">${f}</div></div></div>`; },
    closeModal: () => document.getElementById('modal-container').innerHTML='',
    
    renderView: (view) => {
        AppState.view = view;
        document.querySelectorAll('.view, .sidebar-link').forEach(e => e.classList.remove('active'));
        document.getElementById(`view-${view}`).classList.add('active');
        document.querySelector(`[data-view="${view}"]`)?.classList.add('active');
        const data = AppState.data;

        const getVal = (item, key) => {
            const foundKey = Object.keys(item).find(k => k.toLowerCase().trim() === key.toLowerCase().trim());
            return foundKey ? item[foundKey] : undefined;
        };

        const countPortfolio = (data.ProjectImages||[]).filter(i => {
            const val = String(getVal(i, 'showInPortfolio')).toLowerCase().trim();
            return val === 'si' || val === 'yes' || val === 'true' || val === '1';
        }).length;

        if (view === 'dashboard') {
            // 1. Contadores Simples
            document.getElementById('dash-projects').innerText = (data.Projects||[]).length;
            document.getElementById('dash-portfolio').innerText = countPortfolio;
            document.getElementById('dash-services').innerText = (data.Services||[]).length; // Nuevo
            document.getElementById('dash-rentals').innerText = (data.RentalItems||[]).length; // Nuevo
            document.getElementById('dash-bookings').innerText = (data.Bookings||[]).filter(b=>b.status==='Pendiente').length;

            // 2. Lógica del Gráfico (Reservas por Mes)
            const bookings = data.Bookings || [];
            const monthCounts = {};
            
            // Calcular meses (últimos 6)
            const today = new Date();
            const labels = [];
            const chartData = [];
            
            for (let i = 5; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`; // YYYY-MM
                const monthName = d.toLocaleString('es-ES', { month: 'short' }); // "ene", "feb"
                
                // Contar reservas en este mes (basado en fecha de inicio)
                const count = bookings.filter(b => b.startDate && b.startDate.startsWith(monthKey)).length;
                
                labels.push(monthName);
                chartData.push(count);
            }

            // 3. Renderizar Chart.js
            const ctx = document.getElementById('bookingsChart').getContext('2d');
            
            // Destruir gráfico anterior si existe para evitar conflictos
            if (UI.dashboardChart) UI.dashboardChart.destroy();

            UI.dashboardChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Reservas',
                        data: chartData,
                        backgroundColor: '#3a3a3a', // Color Accent (Gris Oscuro)
                        borderRadius: 4,
                        hoverBackgroundColor: '#1a1a1a' // Text Dark
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { stepSize: 1 },
                            grid: { color: '#f3f4f6' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        } else if (view === 'settings') {
             const s = (data.Settings || []).reduce((acc, i) => ({...acc, [i.key]: i.value}), {});
             const a = (data.About || []).reduce((acc, i) => ({...acc, [i.section]: i.content}), {});
             if(s.logo_black) document.getElementById('preview-logo_black').src = s.logo_black;
             if(s.logo_white) document.getElementById('preview-logo_white').src = s.logo_white;
             if(s.favicon) document.getElementById('preview-favicon').src = s.favicon;
             document.getElementById('settings-form-container').innerHTML = `${UI.inputHTML('settings', 'contact_email', 'Email Contacto', s.contact_email)} ${UI.inputHTML('settings', 'contact_phone', 'Teléfono', s.contact_phone)} ${UI.inputHTML('settings', 'social_instagram', 'Instagram URL', s.social_instagram)} ${UI.inputHTML('settings', 'social_whatsapp', 'WhatsApp Link', s.social_whatsapp)} ${UI.inputHTML('settings', 'social_youtube', 'YouTube URL', s.social_youtube)} ${UI.inputHTML('settings', 'social_facebook', 'Facebook URL', s.social_facebook)} <button class="btn btn-primary mt-2" onclick="App.handleSaveSettings()">Guardar Ajustes</button>`;
             document.getElementById('about-form-container').innerHTML = `${UI.textareaHTML('about', 'filosofia', 'Mi Filosofía', a.filosofia)} ${UI.textareaHTML('about', 'proceso', 'Mi Proceso Creativo', a.proceso)}`;
             if(a.profile_image) document.getElementById('about-profile-preview').src = a.profile_image;
             
             // Client Logos (Usamos memoria local si se edita en batch)
             const logos = currentModalImages.length > 0 ? currentModalImages : (data.ClientLogos || []);
             document.getElementById('clientlogos-grid').innerHTML = logos.sort((a,b)=>(a.order||99)-(b.order||99)).map(i => `
                <div class="relative group border rounded p-2 bg-white flex items-center justify-center aspect-square">
                    <img src="${i.logoUrl}" class="max-w-full max-h-full object-contain">
                    <button class="absolute top-1 right-1 text-red-500 bg-white/90 rounded-full p-1 shadow hover:bg-red-50" onclick="App.handleDeleteImageLocal('${i.id}', 'ClientLogos')"><i class="fas fa-trash"></i></button>
                    <input type="number" class="absolute bottom-1 left-1 w-10 text-xs border text-center opacity-0 group-hover:opacity-100 transition" value="${i.order||99}" onchange="App.updateLocalImage('${i.id}', 'order', this.value, 'ClientLogos')">
                </div>
             `).join('');
        } else if (view === 'projects') {
            document.getElementById('projects-table-body').innerHTML = (data.Projects||[]).sort((a,b)=>(a.order||99)-(b.order||99)).map(p => {
                // ... (lógica de portada y conteo igual que antes) ...
                const cover = (data.ProjectImages||[]).find(i => {
                    const pid = getVal(i, 'projectId') || getVal(i, 'projectID');
                    const isCov = String(getVal(i, 'isCover')).toLowerCase().trim();
                    return pid === p.id && (isCov === 'si' || isCov === 'yes');
                });
                const imageCount = (data.ProjectImages || []).filter(i => {
                     const pid = getVal(i, 'projectId') || getVal(i, 'projectID');
                     return pid === p.id;
                }).length;

                return `<tr class="border-b hover:bg-gray-50">
                    <td class="p-4 font-mono text-xs text-center">${p.order||99}</td> 
                    <td class="p-4"><img src="${cover?.imageUrl||'https://placehold.co/50'}" class="img-preview"></td>
                    <td class="p-4 font-bold text-sm">${p.title}</td>
                    <td class="p-4 text-center font-mono text-sm text-gray-500">${imageCount}</td>
                    <td class="p-4 align-middle">
                        <div class="flex items-center justify-center gap-3">
                            <button class="text-blue-600" onclick="App.handleEditCrudItem('Projects','${p.id}')"><i class="fas fa-edit"></i></button>
                            <button class="text-green-600" onclick="App.handleProjectImages('${p.id}','${p.title.replace(/'/g,"")}')"><i class="fas fa-images"></i></button>
                            <button class="text-red-600" onclick="App.handleDelete('Projects','${p.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
            const thead = document.querySelector('#view-projects thead tr');
            if(thead) {
                thead.innerHTML = '<th class="p-4 text-center">Orden</th><th class="p-4">Portada</th><th class="p-4">Título</th><th class="p-4 text-center">Fotos</th><th class="p-4 text-center">Acciones</th>';
            }
            
        } else if (view === 'portfolio-manager') {
            // En portfolio, usamos currentModalImages SI es que se está editando, sino data directa
            // Pero Portfolio no es un modal, es una vista. Podemos usar batching aquí también?
            // Sí, pero requiere que 'Guardar Cambios' sea global para la vista.
            // Vamos a simplificar: en Portfolio, 'Guardar Orden' ya es un botón manual.
            // Usaremos una lógica similar a la del modal.
            
            // NOTA: Para portfolio, usaremos AppState.data directamente, pero modificaremos 'localmente' 
            // y luego 'Guardar' enviará todo.
            const images = (data.ProjectImages || [])
                .filter(i => {
                    const v = String(getVal(i, 'showInPortfolio')).toLowerCase().trim();
                    return v === 'si' || v === 'yes' || v === 'true' || v === '1';
                })
                .sort((a,b) => (parseInt(a.portfolioOrder)||99)-(parseInt(b.portfolioOrder)||99));
            
            // AJUSTE: Retorno a Collage (Masonry) y arreglo de Clic
            currentModalImages = images; 

            const container = document.getElementById('portfolio-manager-grid');
            // Usamos 'columns' para efecto collage y 'block' para evitar saltos raros
            container.className = "columns-2 md:columns-4 gap-4 p-4 space-y-4 block"; 

            container.innerHTML = images.length ? images.map(i => `
                <div class="relative group break-inside-avoid mb-4 border border-gray-200 bg-white shadow-sm transition-all hover:shadow-lg cursor-zoom-in"
                     draggable="true"
                     ondragstart="App.dragStartPortfolio(event, '${i.id}')"
                     ondragover="App.dragOverPortfolio(event)"
                     ondrop="App.dragDropPortfolio(event, '${i.id}')"
                     onclick="UI.openLightbox('${i.id}')"> <img src="${i.imageUrl}" class="w-full h-auto block">
                    
                    <div class="portfolio-grid-overlay absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center gap-2">
                        <div class="text-white font-bold text-xs uppercase tracking-widest mb-1">Orden</div>
                        
                        <input type="number" class="w-16 p-2 text-center text-lg rounded-none border-none text-black font-bold shadow-lg square" 
                               value="${i.portfolioOrder||99}" 
                               onclick="event.stopPropagation()" 
                               onchange="App.reorderGlobalPortfolio('${i.id}', this.value)">
                        
                        <button class="mt-2 bg-red-500 text-white px-3 py-1 rounded-none text-xs font-bold hover:bg-red-600 transition" 
                                onclick="event.stopPropagation(); App.removeFromPortfolio('${i.id}')">
                            <i class="fas fa-times mr-1"></i> Quitar
                        </button>
                    </div>
                    <span class="portfolio-badge absolute top-2 right-2 bg-black/70 text-white px-2 py-1 rounded text-xs font-mono">#${i.portfolioOrder||99}</span>
                </div>
            `).join('') : '<p class="col-span-full text-center text-gray-500 py-10 w-full">No hay imágenes marcadas para el portafolio.</p>';
        } 
        
        else if (view === 'videos') {
            document.getElementById('videos-table-body').innerHTML = (data.Videos || []).sort((a,b) => (a.order||99)-(b.order||99)).map(v => `
                <tr class="border-b hover:bg-gray-50"><td class="p-4 font-mono text-xs">${v.order||99}</td><td class="p-4 font-bold text-sm">${v.title}</td><td class="p-4 text-xs text-blue-500 truncate max-w-xs"><a href="${v.embedUrl}" target="_blank">${v.embedUrl}</a></td><td class="p-4 flex gap-3"><button class="text-blue-600" onclick="App.handleEditCrudItem('Videos', '${v.id}')"><i class="fas fa-edit"></i></button><button class="text-red-600" onclick="App.handleDelete('Videos', '${v.id}')"><i class="fas fa-trash"></i></button></td></tr>
            `).join('');
            
        } else if (view === 'services') {
             // AJUSTE: Tabla Rediseñada con Contadores
             document.getElementById('services-table-body').innerHTML = (data.Services || []).sort((a,b) => (a.order||99)-(b.order||99)).map(s => {
                
                // Cálculos en tiempo real
                const blockCount = (data.ServiceContentBlocks || []).filter(b => b.serviceId === s.id).length;
                const imageCount = (data.ServiceImages || []).filter(i => i.serviceId === s.id).length;

                return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4 font-mono text-xs w-16 text-center">${s.order||99}</td>
                    <td class="p-4 w-16 text-center text-xl text-gray-600"><i class="${s.iconClass || 'fas fa-circle-question'}"></i></td>
                    <td class="p-4 font-bold text-sm">${s.title}</td>
                    
                    <td class="p-4 text-center font-mono text-sm text-gray-500">
                        <span class="bg-gray-100 px-2 py-1 rounded">${blockCount} Bloques</span>
                    </td>
                    <td class="p-4 text-center font-mono text-sm text-gray-500">
                        <span class="bg-gray-100 px-2 py-1 rounded">${imageCount} Fotos</span>
                    </td>

                    <td class="p-4 flex gap-3 justify-center"> 
                        <button class="text-blue-600 hover:text-blue-800 p-2" onclick="App.handleEditCrudItem('Services', '${s.id}')"><i class="fas fa-edit"></i></button>
                        <button class="text-indigo-600 hover:text-indigo-800 p-2" onclick="App.handleServiceContent('${s.id}', '${s.title}')" title="Contenido"><i class="fas fa-align-left"></i></button>
                        <button class="text-green-600 hover:text-green-800 p-2" onclick="App.handleServiceImages('${s.id}', '${s.title}')" title="Galería"><i class="fas fa-images"></i></button>
                        <button class="text-red-600 hover:text-red-800 p-2" onclick="App.handleDelete('Services', '${s.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');
            
            // Actualizar Encabezados de Tabla
            const thead = document.querySelector('#view-services thead tr');
            if(thead) thead.innerHTML = '<th class="p-4 text-center">Orden</th><th class="p-4 text-center">Icono</th><th class="p-4">Título</th><th class="p-4 text-center">Contenido</th><th class="p-4 text-center">Galería</th><th class="p-4 text-center">Acciones</th>';
            
        } else if (view === 'rentals') { 
             // 1. EQUIPOS (Con Portada Real)
             // Ordenamos por 'order' y buscamos la imagen marcada como 'isCover'
             document.getElementById('rental-items-table-body').innerHTML = (data.RentalItems || [])
                .sort((a,b) => (parseInt(a.order)||99)-(parseInt(b.order)||99))
                .map(i => {
                    const images = data.RentalItemImages || [];
                    // Lógica de Portada: buscar isCover='Si', si no hay, usar la primera
                    const coverObj = images.find(im => im.itemId === i.id && String(im.isCover).toLowerCase() === 'si');
                    const firstObj = images.find(im => im.itemId === i.id);
                    const displayUrl = coverObj ? coverObj.imageUrl : (firstObj ? firstObj.imageUrl : 'https://placehold.co/50?text=No+Img');

                    const catName = (data.RentalCategories || []).find(c => c.id === i.categoryId)?.name || 'Sin Categoría';
                    
                    return `<tr class="border-b hover:bg-gray-50">
                        <td class="p-4 font-mono text-xs text-center">${i.order||99}</td>
                        <td class="p-4 text-center"><img src="${displayUrl}" class="img-preview mx-auto"></td>
                        <td class="p-4 font-bold text-sm">${i.name}</td>
                        <td class="p-4 text-xs font-bold text-gray-500 uppercase">${catName}</td>
                        <td class="p-4 font-mono text-sm">$${i.pricePerDay}</td>
                        <td class="p-4 flex gap-3 justify-center">
                            <button class="text-blue-600 hover:text-blue-800" onclick="App.handleEditCrudItem('RentalItems', '${i.id}')"><i class="fas fa-edit"></i></button>
                            <button class="text-green-600 hover:text-green-800" onclick="App.handleRentalImages('${i.id}', '${i.name.replace(/'/g, "\\'")}')"><i class="fas fa-images"></i></button>
                            <button class="text-red-600 hover:text-red-800" onclick="App.handleDelete('RentalItems', '${i.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                }).join('');
            
            // Actualizar Encabezado Equipos (Cambiamos Img por PORTADA y centramos acciones)
            const theadItems = document.querySelector('#tab-rental-items thead tr');
            if(theadItems) theadItems.innerHTML = '<th class="p-4 text-center">Orden</th><th class="p-4 text-center">Portada</th><th class="p-4">Nombre</th><th class="p-4">Categoría</th><th class="p-4">Precio</th><th class="p-4 text-center">Acciones</th>';

            // 2. CATEGORÍAS (Encabezados Centrados)
            document.getElementById('rental-categories-table-body').innerHTML = (data.RentalCategories || [])
                .sort((a,b) => (parseInt(a.order)||99)-(parseInt(b.order)||99))
                .map(c => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4 text-xs font-bold text-gray-400 text-center">${c.order}</td>
                    <td class="p-4 font-bold text-sm">${c.name}</td>
                    <td class="p-4 flex gap-3 justify-center">
                        <button class="text-blue-600 hover:text-blue-800" onclick="App.handleEditCrudItem('RentalCategories', '${c.id}')"><i class="fas fa-edit"></i></button>
                        <button class="text-red-600 hover:text-red-800" onclick="App.handleDelete('RentalCategories', '${c.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            
            // Actualizar Encabezado Categorías (Centrado)
            const theadCats = document.querySelector('#tab-rental-cats thead tr');
            if(theadCats) theadCats.innerHTML = '<th class="p-4 text-center">Orden</th><th class="p-4">Nombre</th><th class="p-4 text-center">Acciones</th>';

            // 3. BLOQUEOS (Filtro + Orden Cronológico + Edición)
            const currentFilter = AppState.blockedDatesFilter || 'all';
            
            // a. Filtrar y Ordenar cronológicamente (fecha más próxima arriba)
            let blockedList = (data.BlockedDates || [])
                .sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
            
            if (currentFilter !== 'all') {
                blockedList = blockedList.filter(bl => bl.itemId === currentFilter);
            }

            // b. Renderizar Tabla de Bloqueos (Con botón de Editar)
            document.getElementById('blocked-dates-table-body').innerHTML = blockedList.map(bl => {
                 const item = (data.RentalItems || []).find(i => i.id === bl.itemId);
                 return `<tr class="border-b hover:bg-gray-50">
                    <td class="p-4 font-bold text-sm">${item?.name || 'Desconocido'}</td>
                    <td class="p-4 text-sm">${bl.reason}</td>
                    <td class="p-4 text-xs font-mono">${bl.startDate}</td>
                    <td class="p-4 text-xs font-mono">${bl.endDate}</td>
                    <td class="p-4 flex gap-3 justify-center">
                        <button class="text-blue-600 hover:text-blue-800" onclick="App.handleEditCrudItem('BlockedDates', '${bl.blockId}')"><i class="fas fa-edit"></i></button>
                        <button class="text-red-600 hover:text-red-800" onclick="App.handleDelete('BlockedDates', '${bl.blockId}', 'blockId')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');

            // c. Inyectar el Filtro en el HTML (si no existe)
            const blockTabContainer = document.getElementById('tab-blocked-dates');
            let filterContainer = document.getElementById('blocked-filter-container');
            
            if (!filterContainer) {
                // Buscamos el contenedor del botón "Nuevo Bloqueo" para poner el filtro al lado
                const headerDiv = blockTabContainer.querySelector('.flex.justify-end');
                
                // Modificamos el header existente para que acepte elementos a la izquierda (el filtro)
                headerDiv.className = "flex justify-between items-center mb-4";
                headerDiv.id = "blocked-filter-container"; // Marcamos para no duplicar
                
                // Creamos el select
                const selectHTML = `<select class="form-select text-sm w-64 border-gray-300 rounded shadow-sm" onchange="App.setBlockedFilter(this.value)" id="blocked-filter-select"></select>`;
                headerDiv.insertAdjacentHTML('afterbegin', selectHTML);
            }

            // d. Llenar el Select con los equipos disponibles (Ordenados por nombre)
            const selectEl = document.getElementById('blocked-filter-select');
            if (selectEl) {
                const items = (data.RentalItems || []).sort((a,b) => a.name.localeCompare(b.name));
                const options = items.map(i => `<option value="${i.id}" ${currentFilter === i.id ? 'selected' : ''}>${i.name}</option>`).join('');
                selectEl.innerHTML = `<option value="all">Todos los Equipos</option>${options}`;
            }

        } else if (view === 'bookings') {
            document.getElementById('bookings-list-body').innerHTML = (data.Bookings || []).sort((a,b) => new Date(b.bookingTimestamp) - new Date(a.bookingTimestamp)).map(b => `
                <tr class="border-b hover:bg-gray-50"><td class="p-4 text-xs text-gray-500">${new Date(b.bookingTimestamp).toLocaleDateString()}</td><td class="p-4"><div class="font-bold text-sm">${b.customerName}</div><div class="text-xs text-gray-500">${b.customerEmail}</div></td><td class="p-4 text-sm">${b.itemName}<br><span class="text-xs text-gray-500">${b.startDate} a ${b.endDate}</span></td><td class="p-4 font-mono text-sm font-bold">$${b.totalPrice}</td><td class="p-4"><span class="status-badge status-${b.status}">${b.status}</span></td><td class="p-4 flex gap-2"><select class="form-select text-xs w-auto py-1" onchange="App.quickUpdate('Bookings', '${b.id}', 'status', this.value)"><option value="Pendiente" ${b.status==='Pendiente'?'selected':''}>Pendiente</option><option value="Confirmado" ${b.status==='Confirmado'?'selected':''}>Confirmado</option><option value="Pagado" ${b.status==='Pagado'?'selected':''}>Pagado</option><option value="Cancelado" ${b.status==='Cancelado'?'selected':''}>Cancelado</option></select></td></tr>
            `).join('');
        }
    },

    // --- INICIO CÓDIGO NUEVO LIGHTBOX ---
    lightboxIndex: 0,

    openLightbox: (id) => {
        // Usamos currentModalImages porque es lo que el usuario está viendo/editando
        const index = currentModalImages.findIndex(i => i.id === id);
        if (index === -1) return;
        
        UI.lightboxIndex = index;
        UI.updateLightboxContent();
        const lb = document.getElementById('admin-lightbox');
        lb.classList.remove('hidden');
        lb.classList.add('flex');
    },

    closeLightbox: () => {
        const lb = document.getElementById('admin-lightbox');
        lb.classList.add('hidden');
        lb.classList.remove('flex');
    },

    navLightbox: (dir) => {
        const list = currentModalImages;
        let newIndex = UI.lightboxIndex + dir;
        // Navegación circular
        if (newIndex < 0) newIndex = list.length - 1;
        if (newIndex >= list.length) newIndex = 0;
        
        UI.lightboxIndex = newIndex;
        UI.updateLightboxContent();
    },

    updateLightboxContent() {
        const imgData = currentModalImages[this.lightboxIndex];
        document.getElementById('admin-lb-img').src = imgData.imageUrl;
        
        // AJUSTE: Buscar Nombre del Proyecto (Contexto)
        let contextName = 'Galería';
        if (imgData.projectId && AppState.data.Projects) {
            const p = AppState.data.Projects.find(x => x.id === imgData.projectId);
            if (p) contextName = p.title;
        }
        
        // Formato: "Nombre Proyecto - Pie de Foto"
        const captionText = imgData.caption ? ` - ${imgData.caption}` : '';
        document.getElementById('admin-lb-caption').textContent = `${contextName}${captionText}`;
    }
};
  
// --- LOGICA PRINCIPAL (App) ---
const App = {
    async switchView(viewId) {
        UI.showLoading('Cargando...');
        try {
            await this.ensureDataForView(viewId);
            // Reset de variables temporales al cambiar de vista
            currentModalImages = [];
            pendingDeletions = [];
            UI.renderView(viewId);
        } catch(e) {
            console.error(e);
            UI.showToast("Error cargando datos: " + e.message, "error");
        } finally {
            UI.hideLoading();
        }
    },

    // Lazy Load
    async ensureDataForView(view, force = false) {
        let sheets = []; const d = AppState.data || {};
        const need = (key) => force || !d[key];

        if (view === 'projects' || view === 'portfolio-manager') { 
            if(need('Projects')) sheets.push('Projects');
            if(need('ProjectImages')) sheets.push('ProjectImages'); 
        }
        else if (view === 'rentals') { if(need('RentalItems')) sheets.push('RentalItems','RentalCategories','RentalItemImages','BlockedDates'); }
        else if (view === 'services') { if(need('Services')) sheets.push('Services','ServiceContentBlocks','ServiceImages'); }
        else if (view === 'videos') { if(need('Videos')) sheets.push('Videos'); }
        else if (view === 'bookings') { if(need('Bookings')) sheets.push('Bookings','BlockedDates','RentalItems'); }
        else if (view === 'settings') { if(need('Settings')) sheets.push('Settings','About','ClientLogos'); }
        
        if (sheets.length > 0) { 
            sheets = [...new Set(sheets)];
            const nd = await API.call(`/.netlify/functions/get-admin-data?sheets=${sheets.join(',')}`); 
            AppState.data = { ...AppState.data, ...nd }; 
        }
    },
    
    async loadData(mode = 'all') { 
        const p = mode === 'dashboard' ? '?sheets=Projects,Bookings,ProjectImages' : ''; 
        const nd = await API.call(`/.netlify/functions/get-admin-data${p}`); 
        AppState.data = { ...AppState.data, ...nd }; 
    },

    // LÓGICA DE EDICIÓN LOCAL (BATCHING)
    // 1. Al abrir modal, clonamos datos a memoria
    prepareGalleryData(sourceArray, filterKey, filterValue) {
        currentModalImages = JSON.parse(JSON.stringify(sourceArray.filter(i => i[filterKey] === filterValue)));
        pendingDeletions = [];
    },

    // --- NUEVA FUNCIÓN: Lógica de Reordenamiento Inteligente ---
    reorderGalleryImages(movedImageId, newTargetOrder) {
        // 1. Trabajamos sobre una copia ordenada de la memoria actual
        let list = [...currentModalImages].sort((a, b) => (parseInt(a.order) || 99) - (parseInt(b.order) || 99));
        
        // 2. Extraer el elemento que se mueve
        const currentIndex = list.findIndex(i => i.id === movedImageId);
        if (currentIndex === -1) return;
        const [movedItem] = list.splice(currentIndex, 1);

        // 3. Calcular nueva posición (Array base 0)
        let newIndex = parseInt(newTargetOrder) - 1; 
        if (newIndex < 0) newIndex = 0;
        if (newIndex > list.length) newIndex = list.length;

        // 4. Insertar en el nuevo lugar
        list.splice(newIndex, 0, movedItem);

        // 5. Renumerar todo secuencialmente (1, 2, 3...)
        list.forEach((img, index) => {
            const newOrder = index + 1;
            if (img.order != newOrder) {
                img.order = newOrder;
                img._modified = true; // Marcamos para guardar
            }
        });

        // 6. Actualizar memoria y Renderizar
        currentModalImages = list;
        
        // Detectar contexto para refrescar la vista correcta
        const parentId = movedItem.projectId || movedItem.itemId || movedItem.serviceId;
        let type = 'Projects'; 
        if(movedItem.itemId) type = 'RentalItems';
        if(movedItem.serviceId) type = 'Services';
        
        this.renderGalleryList(currentModalImages, parentId, type);
    },

    // 2. Actualizamos en memoria (rápido, sin llamadas API)
    updateLocalImage(id, key, value, type) {
        if (key === 'order') {
            this.reorderGalleryImages(id, value);
            return; 
        }
        const img = currentModalImages.find(i => i.id === id);
        if (img) {
            if (key === 'isCover' && (value === 'Si' || value === true)) {
                currentModalImages.forEach(i => i.isCover = 'No'); 
            }

            // APPEX: Lógica de Secuencia para Checkbox Individual
            if (key === 'showInPortfolio') {
                const isChecking = (value === 'Si' || value === true);
                if (isChecking) {
                    // 1. Buscar el máximo global en la base de datos
                    let globalMax = 0;
                    if (AppState.data.ProjectImages) {
                        const orders = AppState.data.ProjectImages
                            .filter(i => String(i.showInPortfolio).toLowerCase() === 'si')
                            .map(i => parseInt(i.portfolioOrder) || 0);
                        if (orders.length > 0) globalMax = Math.max(...orders);
                    }

                    // 2. Buscar el máximo local (por si acabamos de marcar otras en este mismo modal)
                    let localMax = 0;
                    const localOrders = currentModalImages
                        .filter(i => String(i.showInPortfolio).toLowerCase() === 'si')
                        .map(i => parseInt(i.portfolioOrder) || 0);
                    if (localOrders.length > 0) localMax = Math.max(...localOrders);

                    // 3. El nuevo número es el mayor de los dos + 1
                    img.portfolioOrder = Math.max(globalMax, localMax) + 1;
                } else {
                    img.portfolioOrder = ''; // <--- AJUSTE: Se limpia el campo (vacío)
                }
            }

            img[key] = (value === true ? 'Si' : (value === false ? 'No' : value));
            img._modified = true; 
        }
        // Re-renderizar solo el modal o lista
        if (type === 'ClientLogos') UI.renderView('settings');
        else {
             // Re-render modal list (necesita el contexto del padre)
             // Simplificación: Re-abrir modal con datos actuales
             const parentId = img.projectId || img.itemId || img.serviceId;
             if(type === 'Projects') this.renderGalleryList(currentModalImages, parentId, 'Projects');
             // ... lógica similar para otros tipos, o un render genérico
             else if(type === 'Services') this.renderGalleryList(currentModalImages, parentId, 'Services');
             else if(type === 'RentalItems') this.renderGalleryList(currentModalImages, parentId, 'RentalItems');
        }
    },

    handleDeleteImageLocal(id, type) {
        const index = currentModalImages.findIndex(i => i.id === id);
        if (index > -1) {
            pendingDeletions.push(currentModalImages[index]);
            currentModalImages.splice(index, 1);
        }
        if (type === 'ClientLogos') UI.renderView('settings');
        else {
            // Buscar el parentId de cualquier imagen restante para renderizar
            const remainingImg = currentModalImages[0] || pendingDeletions[0];
            const parentId = remainingImg ? (remainingImg.projectId || remainingImg.itemId || remainingImg.serviceId) : null;
            if(parentId) this.renderGalleryList(currentModalImages, parentId, type);
        }
    },

    // 3. Guardar TODO de una vez (FIXED V29: UI Blocking & Feedback)
    async saveGalleryChanges(parentId, type) {
        UI.showLoading('Guardando cambios...');
        try {
            // Si es ClientLogos, usamos currentModalImages si existe, o cargamos
            if (type === 'ClientLogos' && currentModalImages.length === 0 && AppState.data.ClientLogos) {
                 currentModalImages = JSON.parse(JSON.stringify(AppState.data.ClientLogos));
            }

            const batch = [];
            const sheetName = type; // 'ProjectImages', 'ClientLogos', etc.

            // Procesar Borrados
            pendingDeletions.forEach(img => {
                // Si la imagen tiene un ID real (no es temporal recién subida y borrada)
                if (img.id && !img.id.startsWith('temp_')) {
                     batch.push({ 
                        sheet: sheetName, 
                        action: 'delete', 
                        criteria: { id: img.id }, 
                        // IMPORTANTE: Aquí pasamos el ID del archivo de Drive para que el backend lo borre
                        data: { fileId: img.fileId } 
                     });
                }
            });

            // Procesar Modificados y Nuevos
            currentModalImages.forEach(img => {
                 // Solo enviamos si se modificó o es nuevo.
                 // Para ClientLogos, como es reordenamiento, enviamos todos para asegurar consistencia si se cambió orden
                 if (img._modified || (img.id && img.id.startsWith('temp_')) || type === 'ClientLogos') {
                    const dataToUpdate = { 
                        order: img.order, 
                        caption: img.caption, 
                        isCover: img.isCover, 
                        showInPortfolio: img.showInPortfolio,
                        portfolioOrder: img.portfolioOrder,
                        clientName: img.clientName 
                     };
                     batch.push({ sheet: sheetName, action: 'update', criteria: { id: img.id }, data: dataToUpdate });
                 }
            });

            if (batch.length > 0) {
                await API.batchUpdate(batch);
                
                // APPEX: Limpiamos memoria para evitar re-enviar si el usuario guarda de nuevo sin cerrar
                pendingDeletions = [];
                currentModalImages.forEach(img => delete img._modified);

                // Sincronizar estado global
                await this.ensureDataForView(AppState.view, true);
                
                UI.renderView(AppState.view);
                
                UI.showToast("Cambios guardados exitosamente");
                
                // APPEX: Cerrar modal SOLO si todo salió bien (excepto en ClientLogos que es vista plana)
               if(type !== 'ClientLogos') UI.closeModal(); 
            } else {
                UI.showToast("No se detectaron cambios para guardar", "info");
            }

        } catch(e) {
            console.error(e);
            // APPEX: Feedback visual mejorado en lugar de alert()
            UI.showToast("Error al guardar: " + e.message, "error"); 
        } finally {
            UI.hideLoading();
        }
    },
    
    async uploadImages(input, parentId, parentTitle, type) {
        const files = Array.from(input.files); if (!files.length) return;
        let driveFolderId = null, sheetTarget='', subfolder='', idField='';
        
        // Mapeo
        if (type === 'Projects') { const row = AppState.data.Projects.find(p => p.id === parentId); driveFolderId = row?.driveFolderId; sheetTarget='ProjectImages'; subfolder='Proyectos'; idField='projectId'; }
        else if (type === 'RentalItems') { const row = AppState.data.RentalItems.find(r => r.id === parentId); driveFolderId = row?.driveFolderId; sheetTarget='RentalItemImages'; subfolder='Alquiler'; idField='itemId'; }
        else if (type === 'Services') { sheetTarget='ServiceImages'; subfolder='Servicios'; idField='serviceId'; parentTitle = parentTitle || 'General'; }
        else if (type === 'ClientLogos') { sheetTarget='ClientLogos'; subfolder='Logos'; parentId='general'; }
        else if (type === 'AboutProfile') { sheetTarget='About'; subfolder='Perfil'; parentId='profile_image'; }
        else if (type === 'SettingImage') { sheetTarget='Settings'; subfolder='Marca'; }

        // Lógica específica para ClientLogos: Pedir nombre
        let clientName = '';
        if (type === 'ClientLogos') {
            clientName = prompt("Nombre del Cliente (Opcional):") || '';
        }

        let successCount = 0;
        
        // Si es galería (no settings), usamos carga optimista
        if(['Projects', 'RentalItems', 'Services', 'ClientLogos'].includes(type)) {
             // Inicializar memoria si está vacía (caso ClientLogos directo)
             if (type === 'ClientLogos' && currentModalImages.length === 0) {
                 currentModalImages = JSON.parse(JSON.stringify(AppState.data.ClientLogos || []));
             }
        }

        for (let i = 0; i < files.length; i++) {
            const file = files[i]; 
            // APPEX UX: Mostrar nombre del archivo
            UI.showLoading(`Subiendo ${i+1}/${files.length}: ${file.name}`);
            try {
                const compressed = await new Promise((resolve, reject) => { new Compressor(file, { quality: 0.8, maxWidth: 1600, success: resolve, error: reject }); });
                const fd = new FormData(); fd.append('file', compressed, file.name); fd.append('targetSubfolder', subfolder); fd.append('targetFolderId', driveFolderId || ''); fd.append('parentFolderName', parentTitle); 
                const upRes = await API.call('/.netlify/functions/upload-image', { method: 'POST', body: fd });
                
                // Guardar ID carpeta padre si es nuevo
                if ((type === 'Projects' || type === 'RentalItems'|| type === 'Services') && upRes.driveFolderId && upRes.driveFolderId !== driveFolderId) {
                    driveFolderId = upRes.driveFolderId;
                    await API.call('/.netlify/functions/update-sheet-data', { method: 'POST', body: { sheet: type, action: 'update', criteria: {id: parentId}, data: {driveFolderId} } });
                }

                

                if (type === 'SettingImage') {
                    await API.call('/.netlify/functions/update-sheet-data', { method: 'POST', body: { sheet: 'Settings', action: 'update', criteria: {key: parentId}, data: {value: upRes.imageUrl} } });
                    document.getElementById(`preview-${parentId}`).src = upRes.imageUrl;
                } else if (type === 'AboutProfile') {
                    await API.call('/.netlify/functions/update-sheet-data', { method: 'POST', body: { sheet: 'About', action: 'update', criteria: {section: 'profile_image'}, data: {content: upRes.imageUrl} } });
                    document.getElementById('about-profile-preview').src = upRes.imageUrl;
                } else {
                // APPEX CORRECCIÓN: Calcular el orden basándonos en el MÁXIMO existente + 1
                    // Esto evita que se reinicie a 1 si currentModalImages está vacío o desactualizado
                    let maxOrder = 0;
                    if (currentModalImages && currentModalImages.length > 0) {
                        maxOrder = Math.max(...currentModalImages.map(img => parseInt(img.order) || 0));
                    }
                    // Además, si estamos subiendo múltiples archivos en este bucle, incrementamos i
                    const nextOrder = maxOrder + 1;
                    
                    const newData = { 
                        id: `img_${Date.now()}_${Math.floor(Math.random()*1000)}`, 
                        imageUrl: upRes.imageUrl, 
                        fileId: upRes.fileId, 
                        order: nextOrder,
                        isCover: 'No', showInPortfolio: 'No',
                        clientName: clientName // Solo aplica si es logo
                    };
                    
                    if (type === 'ClientLogos') { newData.logoUrl = upRes.imageUrl; delete newData.imageUrl; }
                    if(idField) newData[idField] = parentId;

                    await API.call('/.netlify/functions/update-sheet-data', { method: 'POST', body: { sheet: sheetTarget, action: 'add', data: newData } });
                    
                    // Agregar a memoria local
                    currentModalImages.push(newData);

                    // 5. [NUEVO AJUSTE] Sincronizar Memoria Global
                    // Esto asegura que si cierras y abres el modal, la foto siga ahí
                    if (AppState.data[sheetTarget]) {
                        AppState.data[sheetTarget].push(newData);
                    }
                    
                }
                successCount++;
            } catch (e) { console.error(e); UI.showToast('Error: '+e.message, 'error'); }
        }
        
        UI.hideLoading();
        if(successCount) UI.showToast('Subida completa');
        
        // Refrescar visualización
        if (type === 'ClientLogos') UI.renderView('settings');
        else if(['Projects', 'RentalItems', 'Services'].includes(type)) {
             // Re-renderizar modal con los nuevos datos en memoria
             this.renderGalleryList(currentModalImages, parentId, type);
            UI.renderView(AppState.view);
        }
    },

    // ... (Resto de funciones CRUD igual que v22.0) ...
    // IMPORTANTE: Asegurarse de que handleProjectImages y similares usen prepareGalleryData

    async handleProjectImages(id, t) { 
        this.prepareGalleryData(AppState.data.ProjectImages || [], 'projectId', id);
        this.renderGalleryModal(id, t, 'Projects'); 
    },
    async handleServiceImages(id, t) { 
        this.prepareGalleryData(AppState.data.ServiceImages || [], 'serviceId', id);
        this.renderGalleryModal(id, t, 'Services'); 
    },
    async handleRentalImages(id, t) { 
        this.prepareGalleryData(AppState.data.RentalItemImages || [], 'itemId', id);
        this.renderGalleryModal(id, t, 'RentalItems'); 
    },
    async handleClientLogos() { 
        this.prepareGalleryData(AppState.data.ClientLogos || [], 'dummy', 'dummy'); // Truco: cargar todo
        // No abre modal, solo prepara datos para la vista settings
    },

    renderGalleryModal(parentId, title, type) {
        const sheetTarget = type === 'Projects' ? 'ProjectImages' : (type === 'RentalItems' ? 'RentalItemImages' : 'ServiceImages');
        
        // APPEX UX: Integrar el botón "Todo a Portafolio" en el encabezado del modal
        let modalTitle = `<span>${title}</span>`;
        
        if (type === 'Projects') {
            modalTitle = `
                <div class="flex items-center gap-4">
                    <span>${title}</span>
                    <button class="btn btn-secondary py-1 px-3 text-xs font-normal" onclick="App.toggleAllPortfolio()">
                        <i class="fas fa-check-double mr-1"></i> Todo a Portafolio
                    </button>
                </div>
            `;
        }

        // CUERPO: Ahora es 100% limpio, solo la lista de imágenes
        const html = `<div id="gallery-list-container"></div>`;

        // FOOTER: Botón de Subir a la izquierda, Acciones a la derecha
        const footer = `
            <div class="flex justify-between items-center w-full">
                <div>
                    <input type="file" id="up-imgs-modal" multiple accept="image/*" class="hidden" onchange="App.uploadImages(this, '${parentId}', '${title.replace(/'/g,"")}', '${type}')">
                    <button class="btn btn-primary" onclick="document.getElementById('up-imgs-modal').click()"><i class="fas fa-upload mr-2"></i> Subir Imágenes</button>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancelar</button>
                    <button class="btn btn-primary" onclick="App.saveGalleryChanges('${parentId}', '${sheetTarget}')">Guardar Cambios</button>
                </div>
            </div>`;

        UI.showModal(modalTitle, html, footer);
        this.renderGalleryList(currentModalImages, parentId, type);
    },
    
    // Nueva función para marcar todo
    toggleAllPortfolio() {
        // Verificamos si todos están marcados para desmarcar, o viceversa
        const allSelected = currentModalImages.every(i => String(i.showInPortfolio).toLowerCase() === 'si');
        const newState = allSelected ? 'No' : 'Si';

        // APPEX: Calcular el inicio de la secuencia global
        let nextPortfolioOrder = 1;
        if (newState === 'Si' && AppState.data.ProjectImages) {
            // Buscamos el número más alto entre TODAS las fotos de TODOS los proyectos
            const allOrders = AppState.data.ProjectImages
                .filter(img => String(img.showInPortfolio).toLowerCase() === 'si')
                .map(img => parseInt(img.portfolioOrder) || 0);
            
            if (allOrders.length > 0) {
                nextPortfolioOrder = Math.max(...allOrders) + 1;
            }
        }
        
        currentModalImages.forEach(img => {
            // Solo aplicamos cambios si el estado es diferente
            if (img.showInPortfolio !== newState) {
                img.showInPortfolio = newState;
                img._modified = true;
                
                if (newState === 'Si') {
                    img.portfolioOrder = nextPortfolioOrder++; // Asigna y aumenta (11, 12, 13...)
                } else {
                    img.portfolioOrder = 99; // Reinicia si se desmarca
                }
            }
        });
        
        // Re-renderizar la lista actual (buscando el ID del padre desde la primera imagen)
        if(currentModalImages.length > 0) {
            const first = currentModalImages[0];
            const pId = first.projectId || first.itemId || first.serviceId;
            // Asumimos que si hay botón es Projects
            this.renderGalleryList(currentModalImages, pId, 'Projects');
        }
    },

    renderGalleryList(images, parentId, type) {
        const container = document.getElementById('gallery-list-container');
        if(!container) return;

        const sortedImages = images.sort((a, b) => (parseInt(a.order) || 99) - (parseInt(b.order) || 99));
        const getChecked = (val) => String(val).toLowerCase().trim() === 'si' || String(val).toLowerCase().trim() === 'yes' ? 'checked' : '';
        
        container.innerHTML = sortedImages.filter(i => !pendingDeletions.includes(i)).map(i => `
            <div class="flex items-center gap-4 p-3 border rounded mb-2 bg-white transition-all duration-200 hover:shadow-md" 
                 id="img-row-${i.id}" 
                 draggable="true"
                 ondragstart="App.dragStart(event, '${i.id}')"
                 ondragover="App.dragOver(event)"
                 ondrop="App.dragDrop(event, '${i.id}')">

                <div class="cursor-move text-gray-300 hover:text-gray-600 px-2 select-none" title="Arrastrar para reordenar">
                    <i class="fas fa-grip-vertical"></i>
                </div>

                <img src="${i.imageUrl}" 
                     class="w-16 h-16 object-contain rounded bg-gray-100 select-none cursor-zoom-in hover:opacity-80 transition" 
                     onclick="UI.openLightbox('${i.id}')">
                
                <div class="flex-1 grid grid-cols-2 gap-2">
                
                    <label class="text-xs font-bold text-gray-500">Orden 
                        <input type="number" class="border p-1 w-full rounded font-bold text-black" 
                               value="${i.order}" 
                               onchange="App.updateLocalImage('${i.id}', 'order', this.value, '${type}')">
                    </label>
                    ${type==='Projects' ? `<label class="text-xs font-bold text-gray-500">Pie <input type="text" class="border p-1 w-full rounded" value="${i.caption||''}" onchange="App.updateLocalImage('${i.id}', 'caption', this.value, '${type}')"></label>` : ''}
                </div>
                
                <div class="flex flex-col gap-1">
                    ${type !== 'Services' ? `<label class="flex items-center gap-2 text-xs cursor-pointer select-none"><input type="checkbox" ${getChecked(i.isCover)} onchange="App.updateLocalImage('${i.id}', 'isCover', this.checked, '${type}')"> Portada</label>` : ''}
                    ${type === 'Projects' ? `<label class="flex items-center gap-2 text-xs cursor-pointer select-none"><input type="checkbox" ${getChecked(i.showInPortfolio)} onchange="App.updateLocalImage('${i.id}', 'showInPortfolio', this.checked, '${type}')"> Portafolio</label>` : ''}
                </div>
                
                <button class="text-red-500 p-2 hover:bg-red-50 rounded" onclick="App.handleDeleteImageLocal('${i.id}', '${type}')"><i class="fas fa-trash"></i></button>
            </div>
        `).join('');
    },
    // --- NUEVAS FUNCIONES: Drag & Drop Helpers ---
    dragStart(e, id) {
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", id);
        e.target.classList.add('opacity-50', 'bg-gray-50'); // Feedback visual
    },
    dragOver(e) {
        e.preventDefault(); // Necesario para permitir el drop
        e.dataTransfer.dropEffect = "move";
    },
    dragDrop(e, targetId) {
        e.preventDefault();
        // Limpiar estilos visuales
        document.querySelectorAll('[draggable]').forEach(el => el.classList.remove('opacity-50', 'bg-gray-50'));

        const movedId = e.dataTransfer.getData("text/plain");
        if (movedId === targetId) return;

        // Encontrar el orden del elemento sobre el que soltamos
        const targetItem = currentModalImages.find(i => i.id === targetId);
        if (targetItem) {
            // Llamamos al cerebro para que haga la matemática
            this.reorderGalleryImages(movedId, targetItem.order);
        }
    },
    
    async handleEditCrudItem(sheet, id) {
        // Carga perezosa para dependencias (ej. Equipos para Bloqueos)
        if (sheet === 'BlockedDates' && !AppState.data.RentalItems) {
             UI.showLoading('Cargando datos...');
             const d = await API.call('/.netlify/functions/get-admin-data?sheets=RentalItems');
             AppState.data = { ...AppState.data, ...d };
             UI.hideLoading();
        }

        const isNew = !id; 
        let html = '';
        let modalTitle = isNew ? 'Nuevo Registro' : 'Editar Registro';
        let leftButtons = ''; // Botones extra para la izquierda (Galería, Eliminar)

        // --- LÓGICA POR TIPO DE HOJA ---
        
        if(sheet === 'Projects'){
             const p = isNew ? {} : AppState.data.Projects.find(x => x.id === id);
             
             // 1. Título Dinámico
             modalTitle = isNew ? 'Nuevo Proyecto' : `Editar Proyecto ${p.title}`;

             // Lógica de auto-secuencia (que ya teníamos)
             let nextOrder = 1;
             if (isNew && AppState.data.Projects && AppState.data.Projects.length > 0) {
                 const maxOrder = Math.max(...AppState.data.Projects.map(proj => parseInt(proj.order) || 0));
                 nextOrder = maxOrder + 1;
             }
             
             html = `${UI.inputHTML('c','order','Orden',p?.order||nextOrder,'number')} ${UI.inputHTML('c','title','Título',p?.title)} ${UI.textareaHTML('c','description','Descripción',p?.description)}`;

             // 2. Botones de Izquierda (Solo al editar)
            if (!isNew) {
                 leftButtons = `
                    <button class="btn btn-danger h-10 px-4 mr-2" onclick="UI.closeModal(); App.handleDelete('Projects', '${id}')" title="Eliminar Proyecto">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn btn-secondary h-10" onclick="App.handleProjectImages('${id}', '${p.title.replace(/'/g,"")}')" title="Ir a Fotos">
                        <i class="fas fa-images mr-2"></i> Galería
                    </button>
                 `;
             }

            // --- INICIO BLOQUE RESTAURADO DE VIDEOS ---
        } else if(sheet === 'Videos'){
             const v = isNew ? {} : AppState.data.Videos.find(x => x.id === id);
             modalTitle = isNew ? 'Nuevo Video' : 'Editar Video';
             
             // Autocalcular siguiente orden
             let nextOrder = 1;
             if (isNew && AppState.data.Videos && AppState.data.Videos.length > 0) {
                 const maxOrder = Math.max(...AppState.data.Videos.map(vid => parseInt(vid.order) || 0));
                 nextOrder = maxOrder + 1;
             }

             html = `${UI.inputHTML('c','order','Orden', v?.order || nextOrder, 'number')} 
                     ${UI.inputHTML('c','title','Título', v?.title)} 
                     ${UI.inputHTML('c','embedUrl','URL del Video (YouTube)', v?.embedUrl)}`;
        // --- FIN BLOQUE RESTAURADO DE VIDEOS ---

        } else if(sheet === 'Services'){
             const s = isNew ? {} : AppState.data.Services.find(x => x.id === id);



            
             modalTitle = isNew ? 'Nuevo Servicio' : `Editar ${s.title}`;
             
             let nextOrder = 1;
             if (isNew && AppState.data.Services && AppState.data.Services.length > 0) {
                 const maxOrder = Math.max(...AppState.data.Services.map(srv => parseInt(srv.order) || 0));
                 nextOrder = maxOrder + 1;
             }

             // AJUSTE 4: Lista de Iconos Ampliada (+100 iconos curados)
             const iconList = [
                 'fas fa-camera', 'fas fa-camera-retro', 'fas fa-video', 'fas fa-film', 'fas fa-photo-video',
                 'fas fa-ring', 'fas fa-heart', 'fas fa-dove', 'fas fa-glass-cheers', 'fas fa-church',
                 'fas fa-user', 'fas fa-user-friends', 'fas fa-users', 'fas fa-user-tie', 'fas fa-user-graduate',
                 'fas fa-baby', 'fas fa-child', 'fas fa-female', 'fas fa-male', 'fas fa-portrait',
                 'fas fa-building', 'fas fa-city', 'fas fa-home', 'fas fa-store', 'fas fa-hotel',
                 'fas fa-utensils', 'fas fa-wine-glass', 'fas fa-coffee', 'fas fa-birthday-cake', 'fas fa-pizza-slice',
                 'fas fa-plane', 'fas fa-car', 'fas fa-ship', 'fas fa-passport', 'fas fa-map-marked-alt',
                 'fas fa-tree', 'fas fa-mountain', 'fas fa-water', 'fas fa-sun', 'fas fa-leaf',
                 'fa-solid fa-helicopter', 'fas fa-drone', 'fas fa-layer-group', 'fas fa-th-large', 'fas fa-images',
                 'fas fa-book-open', 'fas fa-book', 'fas fa-bookmark', 'fas fa-pencil-alt', 'fas fa-pen-nib',
                 'fas fa-star', 'fas fa-award', 'fas fa-certificate', 'fas fa-medal', 'fas fa-crown',
                 'fas fa-magic', 'fas fa-lightbulb', 'fas fa-bolt', 'fas fa-fire', 'fas fa-gem',
                 'fas fa-laptop', 'fas fa-mobile-alt', 'fas fa-desktop', 'fas fa-mouse-pointer', 'fas fa-code',
                 'fas fa-shopping-bag', 'fas fa-tag', 'fas fa-percentage', 'fas fa-credit-card', 'fas fa-truck',
                 'fas fa-music', 'fas fa-microphone', 'fas fa-headphones', 'fas fa-guitar', 'fas fa-drum'
             ];
             const currentIcon = s?.iconClass || 'fas fa-camera';

             let iconsHtml = `<div class="mb-4"><label class="form-label">Selecciona un Icono</label>`;
             iconsHtml += `<div class="grid grid-cols-8 gap-2 max-h-40 overflow-y-auto p-2 border rounded bg-gray-50">`; // Grid más denso
             iconsHtml += `<input type="hidden" id="c-iconClass" data-key="iconClass" value="${currentIcon}">`;
             
             iconList.forEach(icon => {
                 const isSelected = icon === currentIcon ? 'bg-gray-800 text-white ring-2 ring-offset-1 ring-gray-800' : 'bg-white text-gray-600 hover:bg-gray-200';
                 iconsHtml += `<button type="button" class="icon-option p-1.5 rounded text-center transition-all ${isSelected}" onclick="App.selectIcon(this, '${icon}')"><i class="${icon} text-lg"></i></button>`;
             });
             iconsHtml += `</div></div>`;

             const editorHtml = `<div class="mb-4"><label class="form-label">Introducción (Bio)</label><div id="editor-intro"></div></div>`;

             html = `${UI.inputHTML('c','order','Orden',s?.order||nextOrder,'number')} ${UI.inputHTML('c','title','Título',s?.title)} ${iconsHtml} ${editorHtml}`;
             
             App.selectIcon = (btn, iconClass) => {
                 document.querySelectorAll('.icon-option').forEach(b => b.className = 'icon-option p-1.5 rounded text-center transition-all bg-white text-gray-600 hover:bg-gray-200');
                 btn.className = 'icon-option p-1.5 rounded text-center transition-all bg-gray-800 text-white ring-2 ring-offset-1 ring-gray-800';
                 document.getElementById('c-iconClass').value = iconClass;
             };

            setTimeout(() => {
                 // Configuración de Quill
                 activeQuillEditor = new Quill('#editor-intro', {
                     theme: 'snow',
                     modules: { 
                         toolbar: [
                             ['bold', 'italic', 'underline'], 
                             [{ 'align': [] }], 
                             [{ 'list': 'ordered'}, { 'list': 'bullet' }], 
                             ['clean']
                         ] 
                     }
                 });
                 
                 // AJUSTE: Inyección segura del contenido HTML guardado
                 // Usamos pasteHTML si existe para mantener formato, o innerHTML directo
                 if (s && s.introText) {
                    activeQuillEditor.root.innerHTML = s.introText;
                 }
             }, 100);
            
        } else if(sheet === 'Services'){
             const s=isNew?{}:AppState.data.Services.find(x=>x.id===id);
             modalTitle = isNew ? 'Nuevo Servicio' : `Editar ${s.title}`;
             html=`${UI.inputHTML('c','order','Orden',s?.order||99,'number')} ${UI.inputHTML('c','title','Título',s?.title)} ${UI.inputHTML('c','iconClass','Icono (FontAwesome)',s?.iconClass)} ${UI.textareaHTML('c','introText','Intro',s?.introText)}`;
        
        } else if(sheet === 'RentalItems'){
             const i = isNew ? {} : AppState.data.RentalItems.find(x => x.id === id);
             const cats = AppState.data.RentalCategories || [];
             modalTitle = isNew ? 'Nuevo Equipo' : `Editar ${i.name}`;
             
             // Autocalcular Orden
             let nextOrder = 1;
             if (isNew && AppState.data.RentalItems && AppState.data.RentalItems.length > 0) {
                 const maxOrder = Math.max(...AppState.data.RentalItems.map(it => parseInt(it.order) || 0));
                 nextOrder = maxOrder + 1;
             }

             html = `${UI.inputHTML('c', 'order', 'Orden', i?.order||nextOrder, 'number')} ${UI.inputHTML('c', 'name', 'Nombre', i?.name)} ${UI.selectHTML('c', 'categoryId', 'Categoría', cats, i?.categoryId)} ${UI.inputHTML('c', 'pricePerDay', 'Precio/Día', i?.pricePerDay, 'number')} ${UI.textareaHTML('c', 'description', 'Descripción Corta', i?.description)} ${UI.textareaHTML('c', 'longDescription', 'Descripción Larga', i?.longDescription)}`;
             
             if (!isNew) {
                 leftButtons = `
                    <button class="btn btn-danger mr-2" onclick="UI.closeModal(); App.handleDelete('RentalItems', '${id}')"><i class="fas fa-trash"></i></button>
                    <button class="btn btn-success" onclick="App.handleRentalImages('${id}', '${i.name.replace(/'/g,"")}')"><i class="fas fa-images mr-2"></i> Fotos</button>
                 `;
             }

        } else if(sheet === 'RentalCategories'){
             const c = isNew ? {} : AppState.data.RentalCategories.find(x => x.id === id);
             modalTitle = isNew ? 'Nueva Categoría' : 'Editar Categoría';
             
             // Autocalcular Orden
             let nextOrder = 1;
             if (isNew && AppState.data.RentalCategories && AppState.data.RentalCategories.length > 0) {
                 const maxOrder = Math.max(...AppState.data.RentalCategories.map(cat => parseInt(cat.order) || 0));
                 nextOrder = maxOrder + 1;
             }

             html = `${UI.inputHTML('c', 'order', 'Orden', c?.order||nextOrder, 'number')} ${UI.inputHTML('c', 'name', 'Nombre', c?.name)}`;
            // --- INICIO CÓDIGO NUEVO (FORMULARIO RESERVAS) ---
        } else if(sheet === 'Bookings'){
             // 1. Asegurar que tenemos la lista de equipos para el selector
             if (!AppState.data.RentalItems) {
                 UI.showLoading('Cargando equipos...');
                 const d = await API.call('/.netlify/functions/get-admin-data?sheets=RentalItems');
                 AppState.data = { ...AppState.data, ...d };
                 UI.hideLoading();
             }
             
             const b = isNew ? {} : AppState.data.Bookings.find(x => x.id === id);
             const items = AppState.data.RentalItems || [];
             const statuses = [{id:'Pendiente',name:'Pendiente'}, {id:'Confirmado',name:'Confirmado'}, {id:'Pagado',name:'Pagado'}, {id:'Cancelado',name:'Cancelado'}];
             
             modalTitle = isNew ? 'Nueva Reserva Manual' : `Editar Reserva ${b.id}`;
             
             // 2. Estructura del Formulario
             html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${UI.inputHTML('c', 'customerName', 'Cliente', b?.customerName)}
                    ${UI.inputHTML('c', 'customerEmail', 'Email', b?.customerEmail, 'email')}
                    ${UI.inputHTML('c', 'customerPhone', 'Teléfono', b?.customerPhone)}
                    ${UI.selectHTML('c', 'status', 'Estado', statuses, b?.status || 'Confirmado')}
                </div>
                <hr class="my-4 border-gray-100">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${UI.selectHTML('c', 'itemId', 'Equipo', items, b?.itemId)}
                    ${UI.inputHTML('c', 'totalPrice', 'Total ($)', b?.totalPrice, 'number')}
                    ${UI.inputHTML('c', 'startDate', 'Desde', b?.startDate, 'date')}
                    ${UI.inputHTML('c', 'endDate', 'Hasta', b?.endDate, 'date')}
                </div>
             `;
        // --- FIN CÓDIGO NUEVO ---

            
        } else if(sheet === 'BlockedDates'){
             const items = AppState.data.RentalItems || [];

            
             html = `${UI.selectHTML('c', 'itemId', 'Equipo', items)} ${UI.inputHTML('c', 'reason', 'Motivo')} ${UI.inputHTML('c', 'startDate', 'Desde', '', 'date')} ${UI.inputHTML('c', 'endDate', 'Hasta', '', 'date')}`;
        }

        // 3. Footer Estratégico (Izquierda: Acciones / Derecha: Guardar)
        const footer = `
            <div class="flex justify-between items-center w-full">
                <div class="flex items-center">
                    ${leftButtons}
                </div>
                <div class="flex items-center gap-2">
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancelar</button>
                    <button class="btn btn-primary" onclick="App.saveCrud('${sheet}','${id}')">Guardar</button>
                </div>
            </div>
        `;

        UI.showModal(modalTitle, `<form id="crud-form">${html}</form>`, footer);
    },

   // --- GESTIÓN DE CONTENIDO DE SERVICIOS (SISTEMA MAESTRO-DETALLE) ---

    handleServiceContent(id, title) {
        // 1. Cargar datos a memoria local
        currentServiceBlocks = JSON.parse(JSON.stringify(
            (AppState.data.ServiceContentBlocks || []).filter(b => b.serviceId === id)
        ));
        pendingDeletions = []; 

        // Renderizar la vista de lista inicial
        this.renderServiceBlocksModal(id, title);
    },

    // Renderiza el modal en "Modo Lista"
    renderServiceBlocksModal(serviceId, title) {
        const modalTitle = `Contenido: ${title}`;
        const html = `<div id="service-blocks-container" class="max-h-[60vh] overflow-y-auto mb-4 space-y-2 p-1"></div>`;
        
        const footer = `
            <div class="flex justify-between w-full">
                <button class="btn btn-secondary" onclick="App.addServiceBlockLocal('${serviceId}')">
                    <i class="fas fa-plus mr-2"></i> Nuevo Bloque
                </button>
                <div class="flex gap-2">
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancelar</button>
                    <button class="btn btn-primary" onclick="App.saveServiceBlocks('${serviceId}')">Guardar Todo</button>
                </div>
            </div>`;

        UI.showModal(modalTitle, html, footer);
        this.renderServiceBlocksList(serviceId, title);
    },

    // Renderiza la lista de bloques (Drag & Drop)
    renderServiceBlocksList(serviceId, serviceTitle) {
        const container = document.getElementById('service-blocks-container');
        if (!container) return;

        const sortedBlocks = currentServiceBlocks.sort((a, b) => (parseInt(a.order) || 99) - (parseInt(b.order) || 99));

        if (sortedBlocks.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-400 py-8">No hay contenido aún.</p>';
            return;
        }

        container.innerHTML = sortedBlocks.map(b => `
            <div class="p-4 border rounded bg-white relative group transition-all hover:shadow-md flex items-center gap-4"
                 draggable="true"
                 ondragstart="App.dragStartBlock(event, '${b.id}')"
                 ondragover="App.dragOverBlock(event)"
                 ondrop="App.dragDropBlock(event, '${b.id}')">
                
                <div class="text-gray-300 cursor-move hover:text-gray-600"><i class="fas fa-grip-vertical"></i></div>

                <div class="flex-1">
                    <div class="flex justify-between items-center mb-1">
                        <h4 class="font-bold text-sm">${b.blockTitle || '(Sin Título)'}</h4>
                        <span class="text-xs bg-gray-100 px-2 py-0.5 rounded text-gray-500">Orden: ${b.order}</span>
                    </div>
                    <div class="text-xs text-gray-500 truncate max-w-xs">${b.blockContentHtml?.replace(/<[^>]*>/g, '') || '...'}</div>
                </div>

                <div class="flex gap-2">
                    <button class="text-blue-500 p-2 hover:bg-blue-50 rounded" onclick="App.openBlockEditor('${b.id}', '${serviceId}', '${serviceTitle}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="text-red-400 p-2 hover:bg-red-50 rounded" onclick="App.deleteServiceBlockLocal('${b.id}', '${serviceId}', '${serviceTitle}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    },

    // Abre el "Modo Editor" para un bloque específico (Quill)
    openBlockEditor(blockId, serviceId, serviceTitle) {
        const block = currentServiceBlocks.find(b => b.id === blockId);
        if (!block) return;

        const modalTitle = `Editar Bloque: ${block.blockTitle}`;
        const html = `
            <div class="space-y-4">
                ${UI.inputHTML('blk', 'blockTitle', 'Título de Sección', block.blockTitle)}
                <div class="mb-4">
                    <label class="form-label">Contenido (Texto Rico)</label>
                    <div id="editor-block-content" class="h-64"></div>
                </div>
            </div>`;

        const footer = `
            <div class="flex justify-end gap-2 w-full">
                <button class="btn btn-secondary" onclick="App.renderServiceBlocksModal('${serviceId}', '${serviceTitle}')">Volver</button>
                <button class="btn btn-primary" onclick="App.saveBlockEditor('${blockId}', '${serviceId}', '${serviceTitle}')">Aplicar Cambios</button>
            </div>`;

        UI.showModal(modalTitle, html, footer);

        // Iniciar Quill para el bloque
        setTimeout(() => {
            activeQuillEditor = new Quill('#editor-block-content', {
                theme: 'snow',
                modules: { 
                    toolbar: [
                        ['bold', 'italic', 'underline'], 
                        [{ 'align': [] }], // Alineación añadida
                        [{ 'header': 1 }, { 'header': 2 }], 
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }], 
                        ['clean'] // Limpiar formato
                    ] 
                }
            });
            if (block.blockContentHtml) activeQuillEditor.root.innerHTML = block.blockContentHtml;
        }, 100)
    },

    // Guarda los cambios del editor en memoria y vuelve a la lista
    saveBlockEditor(blockId, serviceId, serviceTitle) {
        const block = currentServiceBlocks.find(b => b.id === blockId);
        if (block && activeQuillEditor) {
            block.blockTitle = document.getElementById('blk-blockTitle').value;
            block.blockContentHtml = activeQuillEditor.root.innerHTML;
            block._modified = true;
        }
        this.renderServiceBlocksModal(serviceId, serviceTitle);
    },

    // Agrega un bloque nuevo y abre su editor inmediatamente
    addServiceBlockLocal(serviceId) {
        let nextOrder = 1;
        if (currentServiceBlocks.length > 0) nextOrder = Math.max(...currentServiceBlocks.map(b => parseInt(b.order) || 0)) + 1;

        const newBlock = {
            id: `blk_${Date.now()}`,
            serviceId: serviceId,
            blockTitle: '',
            blockContentHtml: '',
            order: nextOrder,
            _isNew: true
        };
        currentServiceBlocks.push(newBlock);
        // Obtener título para volver
        const s = AppState.data.Services.find(x => x.id === serviceId);
        this.openBlockEditor(newBlock.id, serviceId, s?.title || '');
    },

    deleteServiceBlockLocal(id, serviceId, serviceTitle) {
        const index = currentServiceBlocks.findIndex(b => b.id === id);
        if (index > -1) {
            const item = currentServiceBlocks[index];
            if (!item._isNew) pendingDeletions.push(item);
            currentServiceBlocks.splice(index, 1);
            this.renderServiceBlocksList(serviceId, serviceTitle); // Repintado inmediato
        }
    },

    // Lógica de Reordenamiento (Drag & Drop para bloques)
    dragStartBlock(e, id) { e.dataTransfer.setData("text/plain", id); },
    dragOverBlock(e) { e.preventDefault(); },
    dragDropBlock(e, targetId) {
        e.preventDefault();
        const movedId = e.dataTransfer.getData("text/plain");
        if (movedId === targetId) return;
        
        // Lógica simple de swap de orden visual
        const movedBlock = currentServiceBlocks.find(b => b.id === movedId);
        const targetBlock = currentServiceBlocks.find(b => b.id === targetId);
        
        if (movedBlock && targetBlock) {
             const tempOrder = movedBlock.order;
             movedBlock.order = targetBlock.order;
             targetBlock.order = tempOrder;
             movedBlock._modified = true;
             targetBlock._modified = true;
             
             const s = AppState.data.Services.find(x => x.id === movedBlock.serviceId);
             this.renderServiceBlocksList(movedBlock.serviceId, s?.title);
        }
    },

    // Guardado Final a API
    async saveServiceBlocks(serviceId) {
        UI.showLoading('Guardando contenido...');
        try {
            const batch = [];
            pendingDeletions.forEach(b => batch.push({ sheet: 'ServiceContentBlocks', action: 'delete', criteria: { id: b.id } }));
            currentServiceBlocks.forEach(b => {
                if (b._modified || b._isNew) {
                    const { _isNew, _modified, ...cleanData } = b;
                    const action = b._isNew ? 'add' : 'update';
                    const criteria = b._isNew ? null : { id: b.id };
                    batch.push({ sheet: 'ServiceContentBlocks', action, criteria, data: cleanData });
                }
            });

            if (batch.length > 0) {
                await API.batchUpdate(batch, "Actualizando contenido...");
                
                // 1. Actualizar datos en memoria desde el servidor
                await App.ensureDataForView('services', true);
                
                // 2. AJUSTE CRÍTICO: Forzar repintado de la tabla para ver los contadores nuevos
                if (AppState.view === 'services') {
                    UI.renderView('services');
                }
                
                UI.showToast('Contenido actualizado');
                UI.closeModal();
            } else {
                UI.showToast('No hay cambios', 'info');
                UI.closeModal();
            }
        } catch(e) { console.error(e); UI.showToast("Error: "+e.message, 'error'); } finally { UI.hideLoading(); }
    },
    
    async addServiceBlock(sid) {
        try { await API.call('/.netlify/functions/update-sheet-data',{method:'POST',body:{sheet:'ServiceContentBlocks',action:'add',data:{id:`blk_${Date.now()}`,serviceId:sid,blockTitle:'Nuevo',blockContentHtml:'',order:99}}}); await App.ensureDataForView('services', true); const s=AppState.data.Services.find(x=>x.id===sid); this.handleServiceContent(sid,s.title); } catch(e){alert(e.message);}
    },

    // --- Helper para Filtro de Bloqueos ---
    setBlockedFilter(val) {
        AppState.blockedDatesFilter = val; // Guardamos el filtro en memoria
        UI.renderView('rentals'); // Refrescamos para ver el cambio
    },

    // --- INICIO CÓDIGO NUEVO ---
    handleManualBooking() {
        this.handleEditCrudItem('Bookings', null);
    },
    // --- FIN CÓDIGO NUEVO ---

    async saveCrud(sheet, id) {
        try {
            const isNew = !id || id === 'null';
            const data = {};
            document.querySelectorAll('#crud-form input, #crud-form textarea, #crud-form select').forEach(el => {
                data[el.id.replace('c-', '')] = el.value;
            });

            // Detectamos si es 'Projects' para aplicar reglas estrictas
            if (sheet === 'Projects') {
                const errors = [];
                const newTitle = data.title ? data.title.trim() : "";

                // Validar Título (Nombre)
                if (!newTitle) {
                    errors.push("Nombre");
                }
                // Validar Orden
                if (!data.order || isNaN(data.order)) {
                    errors.push("Orden");
                }

                // --- AJUSTE: Validación de Nombre Único ---
                // Verificamos si existe otro proyecto con el mismo nombre (ignorando mayúsculas/minúsculas)
                // Excluimos el proyecto actual (p.id !== id) por si solo estamos editando otra cosa del mismo proyecto
                const exists = (AppState.data.Projects || []).some(p => 
                    p.title.trim().toLowerCase() === newTitle.toLowerCase() && p.id !== id
                );

                if (exists) {
                    UI.showToast(`Error: Ya existe un proyecto llamado "${newTitle}". Use otro nombre.`, 'error');
                    return; // DETIENE LA EJECUCIÓN PARA EVITAR CONFLICTO DE CARPETAS
                }
                // -------------------------------------------

                // Si hay errores de campos vacíos, abortamos
                if (errors.length > 0) {
                    UI.showToast(`Faltan campos obligatorios: ${errors.join(', ')}`, 'error');
                    return; // DETIENE LA EJECUCIÓN AQUÍ
                }
            }
            
            const idField = sheet === 'BlockedDates' ? 'blockId' : 'id';
            if (isNew) data[idField] = `${sheet.toLowerCase().slice(0,5)}_${Date.now()}`;

            const itemName = data.title || data.name || 'registro';
            UI.showLoading(`Guardando ${sheet === 'Projects' ? 'proyecto' : ''} ${itemName}...`);

            // --- LOGICA ESPECIAL PARA PROYECTOS (Reordenamiento Inteligente) ---
            if (sheet === 'Projects') {
                // 1. Obtenemos la lista actual (excluyendo el que estamos editando si ya existe)
                let allProjects = [...(AppState.data.Projects || [])].filter(p => p.id !== id);
                
                // 2. Preparamos el objeto del proyecto actual
                const currentProject = { ...data, id: isNew ? data[idField] : id };
                
                // 3. Ordenamos la lista existente por orden para asegurar la secuencia
                allProjects.sort((a, b) => (parseInt(a.order) || 99) - (parseInt(b.order) || 99));

                // 4. Calculamos dónde insertar el proyecto actual (Matemática de Array: base 0 vs base 1)
                let targetOrder = parseInt(data.order) || 1;
                let targetIndex = targetOrder - 1;
                
                // Límites de seguridad
                if (targetIndex < 0) targetIndex = 0;
                if (targetIndex > allProjects.length) targetIndex = allProjects.length;

                // 5. Insertamos el proyecto en la posición deseada (empujando al resto hacia abajo)
                allProjects.splice(targetIndex, 0, currentProject);

                // 6. Renumeramos TODOS y preparamos el lote (Batch) de actualización
                const batch = [];
                allProjects.forEach((p, index) => {
                    const newOrder = index + 1;
                    
                    // Si el orden cambió O es el proyecto que estamos guardando, lo añadimos al lote
                    if (parseInt(p.order) !== newOrder || p.id === currentProject.id) {
                        p.order = newOrder; // Actualizamos memoria local
                        
                        // Definimos los datos a guardar
                        // Si es el proyecto actual, guardamos TODOS sus datos del formulario
                        // Si es un vecino desplazado, solo guardamos su nuevo 'order'
                        const dataToSave = (p.id === currentProject.id) ? p : { order: newOrder };
                        
                        batch.push({
                            sheet: 'Projects',
                            action: (p.id === currentProject.id && isNew) ? 'add' : 'update',
                            criteria: (p.id === currentProject.id && isNew) ? null : { id: p.id },
                            data: dataToSave
                        });
                    }
                });

                // 7. Enviamos todo en una sola petición inteligente
                // Definimos el mensaje fijo "Creando proyecto [Nombre]" o "Guardando..."
                const loadingMsg = `${isNew ? 'Creando' : 'Guardando'} proyecto ${itemName}`;
                
                // Pasamos el mensaje como segundo argumento
                await API.batchUpdate(batch, loadingMsg);

                // Actualizamos memoria global para reflejar cambios inmediatamente
                AppState.data.Projects = allProjects;
                
            } else if (sheet === 'Services') {
                // --- LÓGICA UNIFICADA Y CORREGIDA PARA SERVICIOS ---
                
                // 1. CAPTURA DE INTRO (Blindada):
                // Buscamos físicamente el texto en la pantalla para asegurar que se guarde.
                const editorElement = document.querySelector('#editor-intro .ql-editor');
                if (editorElement) {
                    data.introText = editorElement.innerHTML;
                } else {
                    data.introText = activeQuillEditor ? activeQuillEditor.root.innerHTML : '';
                }

                // 2. VALIDACIONES
                const errors = [];
                if (!data.title || !data.title.trim()) errors.push("Título");
                if (!data.order || isNaN(data.order)) errors.push("Orden");
                if (!data.iconClass) errors.push("Icono");

                const exists = (AppState.data.Services || []).some(s => 
                    s.title.trim().toLowerCase() === data.title.trim().toLowerCase() && s.id !== id
                );
                if (exists) {
                    UI.showToast(`Error: Ya existe un servicio llamado "${data.title}".`, 'error');
                    return;
                }
                if (errors.length > 0) {
                    UI.showToast(`Faltan campos: ${errors.join(', ')}`, 'error');
                    return;
                }

                // 3. REORDENAMIENTO INTELIGENTE
                let allServices = [...(AppState.data.Services || [])].filter(s => s.id !== id);
                const currentService = { ...data, id: isNew ? data[idField] : id };
                
                allServices.sort((a, b) => (parseInt(a.order) || 99) - (parseInt(b.order) || 99));

                let targetOrder = parseInt(data.order) || 1;
                let targetIndex = targetOrder - 1;
                if (targetIndex < 0) targetIndex = 0;
                if (targetIndex > allServices.length) targetIndex = allServices.length;

                allServices.splice(targetIndex, 0, currentService);

                // 4. PREPARAR EL BATCH
                const batch = [];
                allServices.forEach((s, index) => {
                    const newOrder = index + 1;
                    // Si el orden cambió O es el servicio actual
                    if (parseInt(s.order) !== newOrder || s.id === currentService.id) {
                        s.order = newOrder;
                        
                        // CLAVE DEL ÉXITO:
                        // Si es el servicio actual, enviamos 'currentService' (que ya tiene la intro capturada arriba).
                        const dataToSave = (s.id === currentService.id) ? currentService : { order: newOrder };
                        
                        batch.push({
                            sheet: 'Services',
                            action: (s.id === currentService.id && isNew) ? 'add' : 'update',
                            criteria: (s.id === currentService.id && isNew) ? null : { id: s.id },
                            data: dataToSave
                        });
                    }
                });

                // 5. ENVIAR
                const loadingMsg = `${isNew ? 'Creado' : 'Guardando'} servicio ${itemName}`;
                await API.batchUpdate(batch, loadingMsg);
                AppState.data.Services = allServices;


            } else if (sheet === 'RentalItems' || sheet === 'RentalCategories') {
                // --- LÓGICA UNIFICADA PARA ALQUILER (Equipos y Categorías) ---
                const isCat = sheet === 'RentalCategories';
                const listName = isCat ? 'RentalCategories' : 'RentalItems';
                const nameField = isCat ? 'name' : 'name'; // Ambos usan 'name' en este caso
                
                const errors = [];
                if (!data.name || !data.name.trim()) errors.push("Nombre");
                if (!data.order || isNaN(data.order)) errors.push("Orden");
                if (!isCat && !data.pricePerDay) errors.push("Precio");
                if (!isCat && !data.categoryId) errors.push("Categoría");

                // Validación de nombre único
                const exists = (AppState.data[listName] || []).some(item => 
                    item.name.trim().toLowerCase() === data.name.trim().toLowerCase() && item.id !== id
                );
                if (exists) {
                    UI.showToast(`Error: Ya existe ${isCat ? 'una categoría' : 'un equipo'} llamado "${data.name}".`, 'error');
                    return;
                }
                if (errors.length > 0) {
                    UI.showToast(`Faltan campos: ${errors.join(', ')}`, 'error');
                    return;
                }

                // Reordenamiento Inteligente
                let allItems = [...(AppState.data[listName] || [])].filter(x => x.id !== id);
                const currentItem = { ...data, id: isNew ? data[idField] : id };
                
                allItems.sort((a, b) => (parseInt(a.order) || 99) - (parseInt(b.order) || 99));

                let targetOrder = parseInt(data.order) || 1;
                let targetIndex = targetOrder - 1;
                if (targetIndex < 0) targetIndex = 0;
                if (targetIndex > allItems.length) targetIndex = allItems.length;

                allItems.splice(targetIndex, 0, currentItem);

                // Preparar Batch
                const batch = [];
                allItems.forEach((item, index) => {
                    const newOrder = index + 1;
                    if (parseInt(item.order) !== newOrder || item.id === currentItem.id) {
                        item.order = newOrder;
                        const dataToSave = (item.id === currentItem.id) ? currentItem : { order: newOrder };
                        batch.push({
                            sheet: sheet,
                            action: (item.id === currentItem.id && isNew) ? 'add' : 'update',
                            criteria: (item.id === currentItem.id && isNew) ? null : { id: item.id },
                            data: dataToSave
                        });
                    }
                });

                // Mensaje Personalizado
                const typeLabel = isCat ? 'Categoría' : 'Equipo';
                const loadingMsg = `${isNew ? 'Guardando' : 'Editando'} ${typeLabel} ${data.name}`; // Ajustado según solicitud
                
                await API.batchUpdate(batch, loadingMsg);
                AppState.data[listName] = allItems;

                // --- INICIO CÓDIGO NUEVO (GUARDADO RESERVAS) ---
            } else if (sheet === 'Bookings') {
                const errors = [];
                if (!data.customerName) errors.push("Cliente");
                if (!data.itemId) errors.push("Equipo");
                if (!data.startDate || !data.endDate) errors.push("Fechas");
                
                if (errors.length > 0) {
                    UI.showToast(`Faltan campos: ${errors.join(', ')}`, 'error');
                    return;
                }
                
                // Guardar nombre del equipo (Snapshot)
                const item = AppState.data.RentalItems?.find(i => i.id === data.itemId);
                if(item) data.itemName = item.name;
                
                // Fecha de creación automática
                if(isNew) data.bookingTimestamp = new Date().toISOString();

                await API.call('/.netlify/functions/update-sheet-data', { 
                    method: 'POST', 
                    body: { sheet, action: isNew ? 'add' : 'update', criteria: isNew ? null : {[idField]:id}, data } 
                });
            // --- FIN CÓDIGO NUEVO ---
            
            } else if (sheet === 'Videos') {
                // --- LÓGICA ESPECIAL VIDEOS (Validación + Reordenamiento) ---
                
                const errors = [];
                if (!data.title || !data.title.trim()) errors.push("Título");
                if (!data.order || isNaN(data.order)) errors.push("Orden");
                // (La URL no es obligatoria estrictamente por sistema, pero podrías agregarla aquí si quieres)

                // 1. Validación de duplicados (Título único)
                const exists = (AppState.data.Videos || []).some(v => 
                    v.title.trim().toLowerCase() === data.title.trim().toLowerCase() && v.id !== id
                );
                
                if (exists) {
                    UI.showToast(`Error: Ya existe un video llamado "${data.title}".`, 'error');
                    return;
                }
                if (errors.length > 0) {
                    UI.showToast(`Faltan campos: ${errors.join(', ')}`, 'error');
                    return;
                }

                // 2. Reordenamiento Inteligente
                let allVideos = [...(AppState.data.Videos || [])].filter(v => v.id !== id);
                const currentVideo = { ...data, id: isNew ? data[idField] : id };
                
                // Ordenar existentes
                allVideos.sort((a, b) => (parseInt(a.order) || 99) - (parseInt(b.order) || 99));

                // Calcular posición de inserción
                let targetOrder = parseInt(data.order) || 1;
                let targetIndex = targetOrder - 1;
                if (targetIndex < 0) targetIndex = 0;
                if (targetIndex > allVideos.length) targetIndex = allVideos.length;

                // Insertar
                allVideos.splice(targetIndex, 0, currentVideo);

                // 3. Preparar Batch (Renumerar todo)
                const batch = [];
                allVideos.forEach((v, index) => {
                    const newOrder = index + 1;
                    // Si el orden cambia O es el video actual
                    if (parseInt(v.order) !== newOrder || v.id === currentVideo.id) {
                        v.order = newOrder;
                        const dataToSave = (v.id === currentVideo.id) ? currentVideo : { order: newOrder };
                        
                        batch.push({
                            sheet: 'Videos',
                            action: (v.id === currentVideo.id && isNew) ? 'add' : 'update',
                            criteria: (v.id === currentVideo.id && isNew) ? null : { id: v.id },
                            data: dataToSave
                        });
                    }
                });

                // 4. Enviar
                const loadingMsg = `${isNew ? 'Agregando' : 'Actualizando'} video ${data.title}`;
                await API.batchUpdate(batch, loadingMsg);
                AppState.data.Videos = allVideos;
            
            
            } else {
                // --- LÓGICA ESTÁNDAR PARA OTRAS HOJAS (Rentals, Videos, etc.) ---
                await API.call('/.netlify/functions/update-sheet-data', { 
                    method: 'POST', 
                    body: { sheet, action: isNew ? 'add' : 'update', criteria: isNew ? null : {[idField]:id}, data } 
                });
            }

            await App.ensureDataForView(AppState.view, true);
            UI.closeModal(); 
            UI.renderView(AppState.view); 
            UI.showToast('Guardado y reordenado correctamente');

        } catch (e) { 
            console.error(e);
            UI.showToast("Error al guardar: " + e.message, "error");
        } finally { 
            UI.hideLoading(); 
        }
    },
    
    async handleDelete(sheet, id, key='id') { 
        // AJUSTE 5: Verificación de Dependencias (Categorías)
        if (sheet === 'RentalCategories') {
            const hasChildren = (AppState.data.RentalItems || []).some(item => item.categoryId === id);
            if (hasChildren) {
                // Notificación Roja (Error) sin abrir modal
                UI.showToast('No se puede eliminar: Esta categoría tiene equipos asociados.', 'error');
                return; // DETENER PROCESO AQUÍ
            }
        }

        // 1. Calcular nombres y etiquetas
        const item = AppState.data[sheet]?.find(x => x[key] === id);
        const name = item?.title || item?.name || 'Registro';
        
        const typeLabel = sheet === 'Projects' ? 'Proyecto' : 
                         (sheet === 'Services' ? 'Servicio' : 
                         (sheet === 'RentalItems' ? 'Equipo' : 
                         (sheet === 'RentalCategories' ? 'Categoría' : // Nueva etiqueta
                         (sheet === 'Videos' ? 'Video' : 'Registro'))));

        const titleText = `¿Desea eliminar ${typeLabel === 'Categoría' ? 'la' : 'el'} ${typeLabel} ${name}?`;
        const msgText = "Esta acción eliminará también las carpetas y archivos asociados.";

        UI.showConfirm(titleText, msgText, async ()=>{ 
            try {
                const parentItem = AppState.data[sheet]?.find(x => x[key] === id);
                const itemName = parentItem?.title || parentItem?.name || 'elemento';
                
                // Mensaje de carga personalizado
                const loadTypeLabel = typeLabel; // Reutilizamos la lógica de arriba
                const baseMessage = `Eliminando ${loadTypeLabel} ${itemName}`;
                
                UI.showLoading(`${baseMessage}...`);
                
                // 1. Identificar si es un Padre con muchos hijos
                let childSheet = null;
                let childKey = null;

                if (sheet === 'Projects') { childSheet = 'ProjectImages'; childKey = 'projectId'; }
                else if (sheet === 'Services') { childSheet = 'ServiceImages'; childKey = 'serviceId'; }
                else if (sheet === 'RentalItems') { childSheet = 'RentalItemImages'; childKey = 'itemId'; }

                // 2. Borrado en cascada (Lotes)
                if (childSheet && AppState.data[childSheet]) {
                    const children = AppState.data[childSheet].filter(c => c[childKey] === id);
                    if (children.length > 0) {
                        const BATCH_SIZE = 10;
                        let processedCount = 0;
                        for (let i = 0; i < children.length; i += BATCH_SIZE) {
                            const batch = children.slice(i, i + BATCH_SIZE).map(child => ({
                                sheet: childSheet, action: 'delete', criteria: { id: child.id }, data: { fileId: child.fileId }
                            }));
                            processedCount += batch.length;
                            UI.showLoading(`${baseMessage} (Borrando registros ${processedCount}/${children.length})...`);
                            await API.call('/.netlify/functions/update-sheet-data', { method: 'POST', body: batch });
                            if (i + BATCH_SIZE < children.length) await new Promise(r => setTimeout(r, 1000));
                        }
                    }
                }

                UI.showLoading(`${baseMessage} (Finalizando)...`);
                const extraData = parentItem?.driveFolderId ? { fileId: parentItem.driveFolderId } : {}; 

                await API.call('/.netlify/functions/update-sheet-data',{
                    method:'POST', body:{ sheet, action:'delete', criteria:{[key]:id}, data: extraData }
                }); 

                await App.ensureDataForView(AppState.view, true); 
                UI.renderView(AppState.view); 
                UI.showToast('Eliminado correctamente'); 

            } catch(e){ 
                console.error(e);
                alert("Error al eliminar: " + e.message); 
            } finally {
                UI.hideLoading();
            }
        }); 
    },

    async handleDeleteImage(sheet, id, row) { UI.showConfirm("¿Borrar imagen?", async ()=>{ try{ await API.call('/.netlify/functions/update-sheet-data',{method:'POST',body:{sheet,action:'delete',criteria:{id}}}); row.remove(); UI.showToast('Borrada'); }catch(e){alert(e.message);} }); },

    async quickUpdate(sheet, id, key, val) { 
        try {
            const valStr = val === true ? 'Si' : (val === false ? 'No' : val);
            await API.call('/.netlify/functions/update-sheet-data', { method: 'POST', body: { sheet, action: 'update', criteria: {id}, data: {[key]: valStr} } }); 
            if(AppState.data[sheet]) { const item = AppState.data[sheet].find(i => i.id === id); if(item) item[key] = valStr; }
            UI.showToast('Guardado');
        } catch(e) { console.error(e); UI.showToast('Error', 'error'); } 
    },
    
    async handleSaveSettings() { const data={}; document.querySelectorAll('#settings-form-container input').forEach(e=>data[e.dataset.key]=e.value); UI.showLoading('Guardando...'); try{ for(const [k,v] of Object.entries(data)) await API.call('/.netlify/functions/update-sheet-data',{method:'POST',body:{sheet:'Settings',action:'update',criteria:{key:k},data:{value:v}}}); UI.showToast('Listo'); }catch(e){alert(e.message);} finally{UI.hideLoading();} },
    async handleSaveAbout() { const data={}; document.querySelectorAll('#about-form-container textarea').forEach(e=>data[e.dataset.key]=e.value); UI.showLoading('Guardando...'); try{ for(const [k,v] of Object.entries(data)) await API.call('/.netlify/functions/update-sheet-data',{method:'POST',body:{sheet:'About',action:'update',criteria:{section:k},data:{content:v}}}); UI.showToast('Listo'); }catch(e){alert(e.message);} finally{UI.hideLoading();} },


    
    // --- INICIO CÓDIGO NUEVO (Punto 2) ---
    
    // 1. Función Cerebro: Mueve un ítem y renumerar todo el resto
    reorderGlobalPortfolio(movedId, newTargetOrder) {
        // a. Obtener todas las imágenes que están en portfolio
        let portfolioList = (AppState.data.ProjectImages || [])
            .filter(i => String(i.showInPortfolio).toLowerCase().trim() === 'si')
            .sort((a, b) => (parseInt(a.portfolioOrder) || 99) - (parseInt(b.portfolioOrder) || 99));

        // b. Encontrar el ítem que se mueve
        const currentIndex = portfolioList.findIndex(i => i.id === movedId);
        if (currentIndex === -1) return;
        const [movedItem] = portfolioList.splice(currentIndex, 1);

        // c. Calcular nueva posición (Array base 0)
        let newIndex = parseInt(newTargetOrder) - 1;
        if (newIndex < 0) newIndex = 0;
        if (newIndex > portfolioList.length) newIndex = portfolioList.length;

        // d. Insertar
        portfolioList.splice(newIndex, 0, movedItem);

        // e. Renumerar secuencialmente (1, 2, 3, 4...)
        portfolioList.forEach((img, index) => {
            img.portfolioOrder = index + 1;
        });

        // f. Refrescar la vista inmediatamente
        UI.renderView('portfolio-manager');
    },

    // 2. Handlers para Drag & Drop del Portafolio
    dragStartPortfolio(e, id) {
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", id);
        e.target.style.opacity = '0.4';
    },
    dragOverPortfolio(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
    },
    dragDropPortfolio(e, targetId) {
        e.preventDefault();
        document.querySelectorAll('.portfolio-grid-item, .group').forEach(el => el.style.opacity = '1'); // Restaurar opacidad
        
        const movedId = e.dataTransfer.getData("text/plain");
        if (movedId === targetId) return;

        // Buscar el orden del elemento destino
        const targetItem = AppState.data.ProjectImages.find(i => i.id === targetId);
        
        if (targetItem) {
            // Mover el ítem arrastrado a la posición del ítem destino
            this.reorderGlobalPortfolio(movedId, targetItem.portfolioOrder);
        }
    },
    // --- FIN CÓDIGO NUEVO ---
    
    async savePortfolioOrder() { UI.showLoading('Guardando...'); try { const updates = AppState.data.ProjectImages.filter(i => String(i.showInPortfolio).toLowerCase().trim() === 'si').map(i => ({ sheet: 'ProjectImages', action: 'update', criteria: {id: i.id}, data: {portfolioOrder: i.portfolioOrder} })); await API.batchUpdate(updates); UI.showToast('Orden guardado'); } catch(e) { alert(e.message); } finally { UI.hideLoading(); } },
    // CÓDIGO NUEVO (Con Feedback y Limpieza de Orden)
    async removeFromPortfolio(id) { 
        // 1. Feedback Visual Inmediato
        UI.showToast('Removiendo imagen...', 'info'); 
        
        try {
            // 2. Enviar actualización al servidor (Dos campos: No portfolio y Sin orden)
            await API.call('/.netlify/functions/update-sheet-data', { 
                method: 'POST', 
                body: { 
                    sheet: 'ProjectImages', 
                    action: 'update', 
                    criteria: { id: id }, 
                    data: { 
                        showInPortfolio: 'No', 
                        portfolioOrder: '' // <--- ESTO BORRA EL NÚMERO EN EL SHEET
                    } 
                } 
            });

            // 3. Actualizar Memoria Local
            const item = AppState.data.ProjectImages.find(i => i.id === id); 
            if(item) {
                item.showInPortfolio = 'No';
                item.portfolioOrder = ''; // Limpiamos memoria también
            }

            // 4. Refrescar Vista y Confirmar
            UI.renderView('portfolio-manager'); 
            UI.showToast('Guardado');

        } catch(e) {
            console.error(e);
            UI.showToast('Error al remover: ' + e.message, 'error');
        }
    },
};

document.addEventListener('DOMContentLoaded', () => {
    const loginBtn = document.getElementById('google-login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const mainNav = document.getElementById('main-nav');

    if (loginBtn) loginBtn.addEventListener('click', () => Auth.login());
    if (logoutBtn) logoutBtn.addEventListener('click', () => Auth.logout());
    
    if (mainNav) {
        mainNav.addEventListener('click', e => { 
            const link = e.target.closest('.sidebar-link'); 
            if(link) { 
                e.preventDefault(); 
                if (typeof App.switchView === 'function') {
                    App.switchView(link.dataset.view); 
                } else {
                    UI.renderView(link.dataset.view);
                }
            } 
        });
    }

    // --- NUEVO: Soporte de Teclado para Lightbox ---
    document.addEventListener('keydown', (e) => {
        const lb = document.getElementById('admin-lightbox');
        // Solo si el lightbox existe y está visible (no tiene la clase hidden)
        if (lb && !lb.classList.contains('hidden')) {
            if (e.key === 'ArrowLeft') UI.navLightbox(-1);
            if (e.key === 'ArrowRight') UI.navLightbox(1);
            if (e.key === 'Escape') UI.closeLightbox();
        }
    });

    setTimeout(() => Auth.init(), 100);
});
</script>

    <div id="admin-lightbox" class="fixed inset-0 z-[200] bg-black/95 hidden flex-col items-center justify-center select-none" onclick="if(event.target===this) UI.closeLightbox()">
        <button class="absolute top-4 right-6 text-white text-5xl hover:text-gray-300 transition" onclick="UI.closeLightbox()">&times;</button>
        
        <div class="flex items-center justify-between w-full px-4 md:px-12 h-full py-12">
            <button class="text-white text-6xl hover:text-accent-primary transition p-4" onclick="UI.navLightbox(-1)">&#8249;</button>
            
            <div class="flex flex-col items-center justify-center max-h-full max-w-[80vw]">
                <img id="admin-lb-img" class="max-h-[80vh] w-auto object-contain shadow-2xl border border-gray-800 bg-black">
                <p id="admin-lb-caption" class="text-white font-mono text-lg mt-4 text-center bg-black/50 px-4 py-2 rounded min-h-[3rem]"></p>
            </div>

            <button class="text-white text-6xl hover:text-accent-primary transition p-4" onclick="UI.navLightbox(1)">&#8250;</button>
        </div>
    </div>
    
</body>
</html>





































