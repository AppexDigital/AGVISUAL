<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Mando | AG Visual Info</title>
    <link rel="icon" type="image/png" href="https://placehold.co/32x32/1a1a1a/FDFDFD?text=AG">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root { --bg-main: #FDFDFD; --text-dark: #1a1a1a; --text-muted: #52525b; --accent: #3a3a3a; --border-color: #e5e7eb; --status-pending: #f59e0b; --status-confirmed: #10b981; --status-paid: #3b82f6; --status-canceled: #ef4444; }
        body { font-family: 'Montserrat', sans-serif; background-color: var(--bg-main); color: var(--text-dark); }
        h1, h2, h3, .font-display { font-family: 'Cormorant Garamond', serif; }
        
        .loader-circle { width: 50px; height: 50px; border: 4px solid rgba(0,0,0,0.1); border-radius: 50%; border-top-color: var(--accent); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .btn { padding: 0.5rem 1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.75rem; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; cursor: pointer; border-radius: 4px; }
        .btn-primary { background-color: var(--text-dark); color: white; }
        .btn-primary:hover { background-color: var(--accent); }
        .btn-secondary { border: 1px solid var(--text-dark); color: var(--text-dark); background: transparent; }
        .btn-secondary:hover { background: #f3f4f6; }
        .btn-danger { background-color: #ef4444; color: white; }
        
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); font-family: 'Montserrat', sans-serif; font-size: 0.9rem; }
        .form-input:focus { border-color: var(--text-dark); outline: none; }
        .form-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.25rem; display: block; }

        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1.5rem; color: var(--text-muted); border-left: 4px solid transparent; transition: all 0.2s; font-size: 0.9rem; }
        .sidebar-link:hover { background-color: #f3f4f6; color: var(--text-dark); }
        .sidebar-link.active { background-color: #f3f4f6; color: var(--text-dark); border-left-color: var(--text-dark); font-weight: 700; }
        .sidebar-link i { width: 1.5rem; text-align: center; margin-right: 0.75rem; }
        
        .view { display: none; animation: fadeIn 0.3s ease-out; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); transform: scale(0.95); transition: transform 0.2s; border-radius: 8px; }
        .modal-overlay.visible .modal-content { transform: scale(1); }

        .toast { position: fixed; bottom: 2rem; right: 2rem; background: var(--text-dark); color: white; padding: 1rem 1.5rem; z-index: 100; transform: translateY(100px); transition: transform 0.3s; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); font-weight: 600; border-radius: 4px; }
        .toast.visible { transform: translateY(0); }
        .toast.error { background: #ef4444; }
        
        .status-badge { padding: 2px 8px; border-radius: 10px; color: white; font-size: 0.65rem; font-weight: bold; text-transform: uppercase; }
        .status-Pendiente { background: var(--status-pending); }
        .status-Confirmado { background: var(--status-confirmed); }
        .status-Pagado { background: var(--status-paid); }
        .status-Cancelado { background: var(--status-canceled); }

        .portfolio-grid-item { position: relative; aspect-ratio: 1; overflow: hidden; border-radius: 4px; border: 1px solid #eee; background: #f3f4f6; }
        .portfolio-grid-item img { width: 100%; height: 100%; object-fit: cover; }
        .portfolio-grid-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.6); opacity: 0; transition: opacity 0.2s; display: flex; flex-direction: column; justify-content: center; items-center; gap: 10px; }
        .portfolio-grid-item:hover .portfolio-grid-overlay { opacity: 1; }
        .portfolio-badge { position: absolute; top: 5px; right: 5px; background: #10b981; color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: bold; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .img-preview { width: 60px; height: 60px; object-fit: cover; border: 1px solid #e5e7eb; border-radius: 4px; background-color: #f9fafb; }

        /* Tabs */
        .tab-nav { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        .tab-btn { padding: 1rem; color: var(--text-muted); font-weight: 600; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab-btn.active { color: var(--text-dark); border-bottom-color: var(--text-dark); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <div id="loading-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-white">
        <div class="loader-circle"></div>
        <p id="loading-text" class="mt-4 font-display text-xl text-text-dark">Cargando Sistema...</p>
    </div>

    <div id="login-screen" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-gray-100">
        <div class="bg-white p-10 shadow-2xl max-w-md w-full text-center border-t-4 border-text-dark">
            <h1 class="font-display text-4xl font-bold mb-2">AG Visual Info</h1>
            <p class="text-text-muted mb-8 uppercase tracking-widest text-xs">Panel de Control</p>
            <button id="google-login-btn" class="w-full bg-[#4285F4] text-white font-bold py-3 px-4 flex items-center justify-center gap-3 hover:bg-[#3367D6] transition-colors shadow-md rounded">
                <i class="fab fa-google"></i> Iniciar con Google Workspace
            </button>
        </div>
    </div>

    <div id="app-screen" class="hidden flex-1 flex h-full overflow-hidden">
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col flex-shrink-0 shadow-sm z-20">
            <div class="p-6 border-b border-gray-100">
                <h2 class="font-display text-2xl font-bold">AG Admin</h2>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 space-y-1" id="main-nav">
                <a href="#" class="sidebar-link active" data-view="dashboard"><i class="fas fa-home"></i>Inicio</a>
                <a href="#" class="sidebar-link" data-view="projects"><i class="fas fa-camera"></i>Proyectos</a>
                <a href="#" class="sidebar-link" data-view="portfolio-manager"><i class="fas fa-images"></i>Portafolio</a>
                <a href="#" class="sidebar-link" data-view="services"><i class="fas fa-concierge-bell"></i>Servicios</a>
                <a href="#" class="sidebar-link" data-view="rentals"><i class="fas fa-video"></i>Alquiler</a>
                <a href="#" class="sidebar-link" data-view="bookings"><i class="fas fa-calendar-check"></i>Reservas</a>
                <a href="#" class="sidebar-link" data-view="settings"><i class="fas fa-cog"></i>Configuración</a>
            </nav>
            <div class="p-4 border-t border-gray-100">
                <button id="logout-btn" class="w-full text-left px-4 py-2 text-text-muted hover:text-red-600 transition-colors text-xs font-bold uppercase"><i class="fas fa-sign-out-alt mr-2"></i>Salir</button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-gray-50 p-8 relative">
            <div id="view-dashboard" class="view active">
                <h1 class="text-4xl font-display font-bold mb-6">Resumen</h1>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 shadow-sm border border-gray-200 rounded">
                        <h3 class="text-xs text-text-muted uppercase font-bold">Proyectos</h3>
                        <p class="text-4xl font-display font-bold mt-2" id="dash-projects">0</p>
                    </div>
                    <div class="bg-white p-6 shadow-sm border border-gray-200 rounded">
                        <h3 class="text-xs text-text-muted uppercase font-bold">Portafolio</h3>
                        <p class="text-4xl font-display font-bold mt-2" id="dash-portfolio">0</p>
                    </div>
                    <div class="bg-white p-6 shadow-sm border border-gray-200 rounded">
                        <h3 class="text-xs text-text-muted uppercase font-bold">Reservas Pendientes</h3>
                        <p class="text-4xl font-display font-bold mt-2 text-yellow-600" id="dash-bookings">0</p>
                    </div>
                </div>
            </div>

            <div id="view-projects" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-display font-bold">Proyectos</h1>
                    <button class="btn btn-primary" onclick="App.handleEditCrudItem('Projects', null)"><i class="fas fa-plus"></i> Nuevo Proyecto</button>
                </div>
                <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b">
                            <tr><th class="p-4">Orden</th><th class="p-4">Portada</th><th class="p-4">Título</th><th class="p-4">Acciones</th></tr>
                        </thead>
                        <tbody id="projects-table-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-portfolio-manager" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-display font-bold">Portafolio</h1>
                    <button class="btn btn-primary" onclick="App.savePortfolioOrder()"><i class="fas fa-save"></i> Guardar Orden</button>
                </div>
                <p class="text-text-muted mb-6 text-sm">Imágenes seleccionadas para la página principal.</p>
                <div id="portfolio-manager-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
            </div>

            <div id="view-services" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-display font-bold">Servicios</h1>
                    <button class="btn btn-primary" onclick="App.handleEditCrudItem('Services', null)"><i class="fas fa-plus"></i> Nuevo</button>
                </div>
                <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden">
                    <table class="w-full text-left text-sm"><thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b"><tr><th class="p-4">Orden</th><th class="p-4">Título</th><th class="p-4">Acciones</th></tr></thead><tbody id="services-table-body" class="divide-y divide-gray-100"></tbody></table>
                </div>
            </div>

            <div id="view-rentals" class="view">
                <h1 class="text-3xl font-display font-bold mb-6">Alquiler</h1>
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="UI.switchTab('rental-items')">Equipos</button>
                    <button class="tab-btn" onclick="UI.switchTab('rental-cats')">Categorías</button>
                </div>
                
                <div id="tab-rental-items" class="tab-content active">
                    <div class="flex justify-end mb-4"><button class="btn btn-primary" onclick="App.handleEditCrudItem('RentalItems', null)"><i class="fas fa-plus"></i> Nuevo Equipo</button></div>
                    <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden">
                        <table class="w-full text-left text-sm"><thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b"><tr><th class="p-4">Img</th><th class="p-4">Nombre</th><th class="p-4">Categoría</th><th class="p-4">Precio</th><th class="p-4">Acciones</th></tr></thead><tbody id="rental-items-table-body" class="divide-y divide-gray-100"></tbody></table>
                    </div>
                </div>
                
                <div id="tab-rental-cats" class="tab-content">
                    <div class="flex justify-end mb-4"><button class="btn btn-primary" onclick="App.handleEditCrudItem('RentalCategories', null)"><i class="fas fa-plus"></i> Nueva Categoría</button></div>
                    <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden">
                        <table class="w-full text-left text-sm"><thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b"><tr><th class="p-4">Orden</th><th class="p-4">Nombre</th><th class="p-4">Acciones</th></tr></thead><tbody id="rental-categories-table-body" class="divide-y divide-gray-100"></tbody></table>
                    </div>
                </div>
            </div>

            <div id="view-bookings" class="view">
                <h1 class="text-3xl font-display font-bold mb-6">Reservas</h1>
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="UI.switchTab('booking-list')">Solicitudes</button>
                    <button class="tab-btn" onclick="UI.switchTab('blocked-dates')">Bloqueos</button>
                </div>
                <div id="tab-booking-list" class="tab-content active">
                     <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden">
                        <table class="w-full text-left text-sm"><thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b"><tr><th class="p-4">Fecha</th><th class="p-4">Cliente</th><th class="p-4">Equipo</th><th class="p-4">Total</th><th class="p-4">Estado</th><th class="p-4">Acciones</th></tr></thead><tbody id="bookings-list-body" class="divide-y divide-gray-100"></tbody></table>
                    </div>
                </div>
                <div id="tab-blocked-dates" class="tab-content">
                    <div class="flex justify-end mb-4"><button class="btn btn-primary" onclick="App.handleEditCrudItem('BlockedDates', null)"><i class="fas fa-ban"></i> Nuevo Bloqueo</button></div>
                    <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden">
                        <table class="w-full text-left text-sm"><thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b"><tr><th class="p-4">Equipo</th><th class="p-4">Motivo</th><th class="p-4">Desde</th><th class="p-4">Hasta</th><th class="p-4">Acciones</th></tr></thead><tbody id="blocked-dates-table-body" class="divide-y divide-gray-100"></tbody></table>
                    </div>
                </div>
            </div>
            
            <div id="view-settings" class="view">
                <div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-display font-bold">Configuración</h1><button class="btn btn-primary" onclick="App.handleSaveSettings()"><i class="fas fa-save"></i> Guardar</button></div>
                <div id="settings-form-container" class="max-w-3xl space-y-6 bg-white p-6 rounded border border-gray-200"></div>
                <h2 class="text-2xl font-display font-bold mt-10 mb-4">Quién Soy</h2>
                <div id="about-form-container" class="max-w-3xl space-y-6 bg-white p-6 rounded border border-gray-200"></div>
                <div class="mt-4 text-right"><button class="btn btn-primary" onclick="App.handleSaveAbout()"><i class="fas fa-save"></i> Guardar Bio</button></div>
                <h2 class="text-2xl font-display font-bold mt-10 mb-4">Logos Clientes</h2>
                <button class="btn btn-secondary mb-4" onclick="App.handleEditCrudItem('ClientLogos', null)">+ Logo</button>
                <div id="clientlogos-table-body" class="grid grid-cols-2 md:grid-cols-5 gap-4"></div>
            </div>
        </main>
    </div>

    <div id="modal-container"></div>
    <div id="toast-container"></div>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
const GOOGLE_REDIRECT_URI = 'postmessage';
const AppState = { data: null, token: JSON.parse(localStorage.getItem('gAuthToken') || 'null'), view: 'dashboard' };

const API = {
    async call(endpoint, options = {}, isRetry = false) {
        const headers = new Headers(options.headers || {});
        if (AppState.token?.access_token) headers.set('Authorization', `Bearer ${AppState.token.access_token}`);
        if (options.body && !(options.body instanceof FormData)) {
            headers.set('Content-Type', 'application/json');
            options.body = JSON.stringify(options.body);
        }
        try {
            const res = await fetch(endpoint, { ...options, headers });
            if (res.status === 401 && !isRetry) {
                if (await Auth.refresh()) return API.call(endpoint, options, true);
                else { Auth.logout(); throw new Error('Sesión expirada'); }
            }
            if (!res.ok) throw new Error((await res.json()).error || 'Error servidor');
            return await res.json();
        } catch (e) { throw e; }
    }
};

const Auth = {
    async init() {
        if (AppState.token) {
            if (Date.now() >= AppState.token.expires_at) await this.refresh();
            UI.showApp();
        } else UI.showLogin();
    },
    async login() {
        try {
            const config = await fetch('/.netlify/functions/get-auth-config').then(r => r.json());
            google.accounts.oauth2.initCodeClient({
                client_id: config.clientId,
                scope: 'https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/drive',
                callback: (r) => r.code && this.exchangeCode(r.code)
            }).requestCode();
        } catch (e) { alert('Error config: ' + e.message); }
    },
    async exchangeCode(code) {
        UI.showLoading('Autenticando...');
        try {
            const tokens = await fetch('/.netlify/functions/auth-google', { method: 'POST', body: JSON.stringify({ code, redirectUri: GOOGLE_REDIRECT_URI }) }).then(r => r.json());
            if (tokens.error) throw new Error(tokens.error);
            this.setToken(tokens);
            UI.showApp();
        } catch (e) { alert(e.message); UI.showLogin(); }
    },
    async refresh() {
        if (!AppState.token?.refresh_token) return false;
        try {
            const t = await fetch('/.netlify/functions/auth-refresh', { method: 'POST', body: JSON.stringify({ refresh_token: AppState.token.refresh_token }) }).then(r => r.json());
            if (t.error) throw new Error(t.error);
            this.setToken({ ...AppState.token, ...t });
            return true;
        } catch { return false; }
    },
    setToken(t) {
        if (t.expires_in) t.expires_at = Date.now() + (t.expires_in * 1000);
        AppState.token = t;
        localStorage.setItem('gAuthToken', JSON.stringify(t));
    },
    logout() { localStorage.removeItem('gAuthToken'); location.reload(); }
};

const UI = {
    showLogin: () => { document.getElementById('loading-screen').style.display = 'none'; document.getElementById('app-screen').style.display = 'none'; document.getElementById('login-screen').style.display = 'flex'; },
    showApp: async () => {
        document.getElementById('login-screen').style.display = 'none';
        UI.showLoading('Cargando datos...');
        try { await App.loadData(); document.getElementById('loading-screen').style.display = 'none'; document.getElementById('app-screen').style.display = 'flex'; UI.renderView(AppState.view); } 
        catch (e) { alert(e.message); UI.showLogin(); }
    },
    showLoading: (msg) => { document.getElementById('loading-text').innerText = msg; document.getElementById('loading-screen').style.display = 'flex'; },
    hideLoading: () => document.getElementById('loading-screen').style.display = 'none',
    showToast: (msg) => {
        const t = document.createElement('div'); t.className


