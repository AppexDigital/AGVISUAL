<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Mando | AG Visual Info</title>
    <link rel="icon" type="image/png" href="https://placehold.co/32x32/1a1a1a/FDFDFD?text=AG">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --bg-main: #FDFDFD; --text-dark: #1a1a1a; --accent: #3a3a3a; --border: #e5e7eb; }
        body { font-family: 'Montserrat', sans-serif; background: var(--bg-main); color: var(--text-dark); }
        h1, h2, h3, .font-display { font-family: 'Cormorant Garamond', serif; }
        .loader-circle { width: 50px; height: 50px; border: 4px solid rgba(0,0,0,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn { padding: 0.5rem 1rem; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; display: inline-flex; items-center; gap: 0.5rem; border-radius: 4px; transition: 0.2s; }
        .btn-primary { bg: var(--text-dark); color: white; } .btn-primary:hover { bg: var(--accent); }
        .btn-secondary { border: 1px solid var(--text-dark); } .btn-danger { bg: #ef4444; color: white; }
        .sidebar-link { display: flex; padding: 0.75rem 1.5rem; color: #52525b; border-left: 4px solid transparent; transition: 0.2s; }
        .sidebar-link.active { bg: #f3f4f6; color: var(--text-dark); border-left-color: var(--text-dark); font-weight: 700; }
        .view { display: none; } .view.active { display: block; animation: fadeIn 0.3s; } @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }
        .modal-overlay { position: fixed; inset: 0; bg: rgba(0,0,0,0.7); display: flex; justify-content: center; items-center; z-index: 50; opacity: 0; pointer-events: none; transition: 0.2s; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { bg: white; width: 95%; max-width: 900px; max-height: 90vh; overflow-y: auto; border-radius: 8px; transform: scale(0.95); transition: 0.2s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .toast { position: fixed; bottom: 2rem; right: 2rem; bg: var(--text-dark); color: white; padding: 1rem; z-index: 100; transform: translateY(100px); transition: 0.3s; }
        .toast.visible { transform: translateY(0); }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        .gallery-item { position: relative; border: 1px solid #eee; padding: 0.5rem; border-radius: 4px; }
        .gallery-item img { width: 100%; height: 120px; object-fit: cover; border-radius: 2px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="loading-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-white">
        <div class="loader-circle"></div><p class="mt-4 font-display text-xl">Cargando...</p>
    </div>

    <div id="login-screen" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-gray-100">
        <div class="bg-white p-10 shadow-2xl text-center">
            <h1 class="font-display text-4xl font-bold mb-4">AG Visual Info</h1>
            <button id="google-login-btn" class="btn bg-blue-600 text-white py-3 px-6">Iniciar Sesión con Google</button>
        </div>
    </div>

    <div id="app-screen" class="hidden flex-1 flex h-full overflow-hidden">
        <aside class="w-64 bg-white border-r flex-shrink-0 overflow-y-auto">
            <div class="p-6"><h2 class="font-display text-2xl font-bold">AG Admin</h2></div>
            <nav id="main-nav">
                <a href="#" class="sidebar-link active" data-view="dashboard"><i class="fas fa-home mr-2"></i>Inicio</a>
                <a href="#" class="sidebar-link" data-view="projects"><i class="fas fa-camera mr-2"></i>Proyectos</a>
                <a href="#" class="sidebar-link" data-view="portfolio-manager"><i class="fas fa-images mr-2"></i>Portafolio</a>
                <a href="#" class="sidebar-link" data-view="services"><i class="fas fa-concierge-bell mr-2"></i>Servicios</a>
                <a href="#" class="sidebar-link" data-view="videos"><i class="fas fa-video mr-2"></i>Videos</a>
                <a href="#" class="sidebar-link" data-view="rentals"><i class="fas fa-box mr-2"></i>Alquiler</a>
                <a href="#" class="sidebar-link" data-view="bookings"><i class="fas fa-calendar-check mr-2"></i>Reservas</a>
                <a href="#" class="sidebar-link" data-view="settings"><i class="fas fa-cog mr-2"></i>Configuración</a>
            </nav>
            <div class="p-4"><button id="logout-btn" class="text-red-600 text-sm font-bold uppercase">Salir</button></div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-gray-50 p-8">
            <div id="view-dashboard" class="view active">
                <h1 class="text-4xl font-display font-bold mb-6">Resumen</h1>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 shadow rounded"><h3>Proyectos</h3><p class="text-4xl font-bold" id="dash-projects">0</p></div>
                    <div class="bg-white p-6 shadow rounded"><h3>Fotos Portafolio</h3><p class="text-4xl font-bold" id="dash-portfolio">0</p></div>
                    <div class="bg-white p-6 shadow rounded"><h3>Reservas</h3><p class="text-4xl font-bold text-yellow-600" id="dash-bookings">0</p></div>
                </div>
            </div>

            <div id="view-projects" class="view">
                <div class="flex justify-between mb-6"><h1 class="text-3xl font-display font-bold">Proyectos</h1><button class="btn bg-black text-white" onclick="App.editItem('Projects', null)">+ Nuevo</button></div>
                <div id="projects-list" class="bg-white shadow rounded divide-y"></div>
            </div>

            <div id="view-portfolio-manager" class="view">
                <div class="flex justify-between mb-6"><h1 class="text-3xl font-display font-bold">Portafolio Principal</h1></div>
                <p class="mb-4 text-gray-500 text-sm">Gestiona qué fotos aparecen en la web pública. Las fotos se añaden desde la galería de cada proyecto.</p>
                <div id="portfolio-grid" class="grid grid-cols-2 md:grid-cols-5 gap-4"></div>
            </div>

            <div id="view-services" class="view">
                <div class="flex justify-between mb-6"><h1 class="text-3xl font-display font-bold">Servicios</h1><button class="btn bg-black text-white" onclick="App.editItem('Services', null)">+ Nuevo</button></div>
                <div id="services-list" class="bg-white shadow rounded divide-y"></div>
            </div>

            <div id="view-videos" class="view">
                <div class="flex justify-between mb-6"><h1 class="text-3xl font-display font-bold">Videos</h1><button class="btn bg-black text-white" onclick="App.editItem('Videos', null)">+ Nuevo</button></div>
                <div id="videos-list" class="bg-white shadow rounded divide-y"></div>
            </div>

            <div id="view-rentals" class="view">
                <h1 class="text-3xl font-display font-bold mb-6">Alquiler</h1>
                <div class="flex gap-4 mb-4 border-b">
                    <button class="py-2 px-4 font-bold border-b-2 border-black" onclick="UI.showTab('rental-items')">Equipos</button>
                    <button class="py-2 px-4 text-gray-500" onclick="UI.showTab('rental-cats')">Categorías</button>
                </div>
                <div id="tab-rental-items">
                    <div class="text-right mb-4"><button class="btn bg-black text-white" onclick="App.editItem('RentalItems', null)">+ Equipo</button></div>
                    <div id="rental-items-list" class="bg-white shadow rounded divide-y"></div>
                </div>
                <div id="tab-rental-cats" class="hidden">
                    <div class="text-right mb-4"><button class="btn bg-black text-white" onclick="App.editItem('RentalCategories', null)">+ Categoría</button></div>
                    <div id="rental-cats-list" class="bg-white shadow rounded divide-y"></div>
                </div>
            </div>
            
            <div id="view-bookings" class="view">
                <h1 class="text-3xl font-display font-bold mb-6">Calendario</h1>
                 <div class="flex gap-4 mb-4 border-b">
                    <button class="py-2 px-4 font-bold border-b-2 border-black" onclick="UI.showTab('bookings-list')">Reservas</button>
                    <button class="py-2 px-4 text-gray-500" onclick="UI.showTab('blocked-dates')">Bloqueos</button>
                </div>
                <div id="tab-bookings-list">
                    <div id="bookings-list" class="bg-white shadow rounded divide-y"></div>
                </div>
                <div id="tab-blocked-dates" class="hidden">
                     <div class="text-right mb-4"><button class="btn bg-black text-white" onclick="App.editItem('BlockedDates', null)">+ Bloquear Fecha</button></div>
                     <div id="blocked-list" class="bg-white shadow rounded divide-y"></div>
                </div>
            </div>

            <div id="view-settings" class="view">
                <h1 class="text-3xl font-display font-bold mb-6">Configuración</h1>
                <div id="settings-content" class="space-y-8"></div>
            </div>
        </main>
    </div>

    <div id="modal-container"></div>
    <div id="toast-container"></div>

<script>
// --- ESTADO Y UTILIDADES ---
const AppState = { data: {}, pendingBatch: [] };
let currentModalImages = []; // Memoria temporal para edición de galerías

// --- API ---
const API = {
    async call(endpoint, options = {}) {
        const token = JSON.parse(localStorage.getItem('gAuthToken'));
        const headers = { 'Content-Type': 'application/json' };
        if(token) headers['Authorization'] = `Bearer ${token.access_token}`;
        
        try {
            const res = await fetch(endpoint, { ...options, headers });
            if(res.status === 401) { Auth.logout(); return null; } // Token vencido
            if(!res.ok) throw new Error('Error API: ' + res.status);
            return await res.json();
        } catch(e) { 
            console.error(e); 
            UI.showToast("Error de conexión", "error"); 
            return null; 
        }
    },
    // Nueva función para enviar lote
    async batchUpdate(operations) {
        if(operations.length === 0) return;
        UI.showLoading('Guardando cambios...');
        try {
            await API.call('/.netlify/functions/update-sheet-data', {
                method: 'POST',
                body: JSON.stringify(operations)
            });
            UI.showToast("Guardado correctamente");
            // Recargar datos críticos en segundo plano
            App.loadData(['Projects', 'ProjectImages', 'RentalItems']); 
        } catch(e) {
            alert("Error al guardar: " + e.message);
        } finally {
            UI.hideLoading();
        }
    }
};

// --- AUTH ---
const Auth = {
    async init() {
        const token = JSON.parse(localStorage.getItem('gAuthToken'));
        if(token) {
            UI.showApp();
        } else {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
        }
    },
    async login() {
        try {
            const config = await fetch('/.netlify/functions/get-auth-config').then(r => r.json());
            google.accounts.oauth2.initCodeClient({
                client_id: config.clientId,
                scope: 'https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/drive',
                callback: async (r) => {
                    if(r.code) {
                        const tokens = await fetch('/.netlify/functions/auth-google', { 
                            method: 'POST', body: JSON.stringify({ code: r.code, redirectUri: 'postmessage' }) 
                        }).then(res => res.json());
                        localStorage.setItem('gAuthToken', JSON.stringify(tokens));
                        UI.showApp();
                    }
                }
            }).requestCode();
        } catch(e) { alert("Error auth: " + e.message); }
    },
    logout() { localStorage.removeItem('gAuthToken'); location.reload(); }
};

// --- LÓGICA APP ---
const App = {
    async loadData(sheets = null) {
        // Carga Inteligente: Si no se especifica sheets, carga Dashboard
        const query = sheets ? `?sheets=${sheets.join(',')}` : '?sheets=Projects,ProjectImages,Bookings';
        const data = await API.call(`/.netlify/functions/get-admin-data${query}`);
        if(data) {
            AppState.data = { ...AppState.data, ...data };
            UI.renderCurrentView();
        }
    },

    // --- GESTIÓN DE IMÁGENES (Memoria Local Primero) ---
    openGalleryModal(parentId, type, title) {
        // Filtrar imágenes de la memoria
        let images = [];
        if (type === 'Projects') images = (AppState.data.ProjectImages || []).filter(i => i.projectId === parentId);
        else if (type === 'RentalItems') images = (AppState.data.RentalItemImages || []).filter(i => i.itemId === parentId);
        else if (type === 'Services') images = (AppState.data.ServiceImages || []).filter(i => i.serviceId === parentId);
        else if (type === 'ClientLogos') images = (AppState.data.ClientLogos || []);

        // Clonar para edición segura
        currentModalImages = JSON.parse(JSON.stringify(images));
        currentModalImages.sort((a,b) => (a.order||99) - (b.order||99));

        UI.renderGalleryModal(parentId, type, title);
    },

    updateImageLocal(id, key, value, type) {
        const img = currentModalImages.find(i => i.id === id);
        if(!img) return;
        
        // Lógica Portada Única
        if(key === 'isCover' && (value === 'Si' || value === true)) {
            currentModalImages.forEach(i => i.isCover = 'No');
        }
        img[key] = (value === true ? 'Si' : (value === false ? 'No' : value));
        UI.renderGalleryList(currentModalImages, type); // Re-renderizar solo la lista
    },

    markImageForDelete(id, type) {
        const index = currentModalImages.findIndex(i => i.id === id);
        if(index > -1) {
            currentModalImages[index]._deleted = true; // Marcar para borrar
            UI.renderGalleryList(currentModalImages, type);
        }
    },

    async saveGalleryChanges(parentId, type) {
        const batch = [];
        const sheetName = type === 'Projects' ? 'ProjectImages' : (type === 'RentalItems' ? 'RentalItemImages' : (type === 'Services' ? 'ServiceImages' : 'ClientLogos'));

        currentModalImages.forEach(img => {
            if (img._deleted) {
                // Operación de Borrado
                if (img.id && !img.id.startsWith('temp_')) {
                    batch.push({ sheet: sheetName, action: 'delete', criteria: { id: img.id }, data: { fileId: img.fileId } });
                }
            } else if (img._modified || img.id.startsWith('temp_')) {
                // Operación de Actualización o Creación (aunque creación se maneja en upload)
                // Aquí asumimos que upload ya creó la fila, así que es update
                 batch.push({ 
                    sheet: sheetName, 
                    action: 'update', 
                    criteria: { id: img.id }, 
                    data: { 
                        order: img.order, 
                        caption: img.caption, 
                        isCover: img.isCover, 
                        showInPortfolio: img.showInPortfolio,
                        clientName: img.clientName
                    } 
                });
            }
        });
        
        // Detectar cambios (comparar con original es complejo, mejor enviar todo lo que se tocó)
        // Simplificación: Enviamos update para todos los no borrados para asegurar orden
        const updates = currentModalImages.filter(i => !i._deleted).map(img => ({
             sheet: sheetName, 
             action: 'update', 
             criteria: { id: img.id }, 
             data: { 
                order: img.order, 
                caption: img.caption,
                isCover: img.isCover,
                showInPortfolio: img.showInPortfolio,
                clientName: img.clientName
             }
        }));

        await API.batchUpdate([...batch, ...updates]);
        UI.closeModal();
    },

    async uploadImages(input, parentId, type) {
        const files = Array.from(input.files);
        if(!files.length) return;
        
        UI.showLoading(`Subiendo ${files.length} archivos...`);
        let successCount = 0;
        const sheetTarget = type === 'Projects' ? 'ProjectImages' : (type === 'RentalItems' ? 'RentalItemImages' : (type === 'Services' ? 'ServiceImages' : 'ClientLogos'));
        const idField = type === 'Projects' ? 'projectId' : (type === 'RentalItems' ? 'itemId' : 'serviceId');
        
        for (const file of files) {
            try {
                const compressed = await new Promise((resolve) => new Compressor(file, { quality: 0.8, maxWidth: 1600, success: resolve }));
                const fd = new FormData();
                fd.append('file', compressed, file.name);
                fd.append('targetSubfolder', type); 
                
                // Subida física
                const res = await API.call('/.netlify/functions/upload-image', { method: 'POST', body: fd });
                
                // Crear registro en Sheet INMEDIATAMENTE (esto sí debe ser atómico para tener ID)
                const newData = { 
                    imageUrl: res.imageUrl, 
                    fileId: res.fileId, 
                    order: 99,
                    isCover: 'No',
                    showInPortfolio: 'No'
                };
                if(type !== 'ClientLogos') newData[idField] = parentId;
                
                const sheetRes = await API.call('/.netlify/functions/update-sheet-data', {
                    method: 'POST',
                    body: JSON.stringify({ sheet: sheetTarget, action: 'add', data: newData })
                });
                
                // Agregar a memoria local para verlo ya
                if(sheetRes) {
                    newData.id = sheetRes.newId;
                    currentModalImages.push(newData);
                }
                successCount++;
            } catch(e) { console.error(e); }
        }
        UI.hideLoading();
        UI.renderGalleryList(currentModalImages, type); // Refrescar visual
    },

    // --- CRUD GENÉRICO ---
    editItem(sheet, id) {
        const isNew = !id;
        let item = isNew ? {} : AppState.data[sheet].find(i => i.id === id);
        let html = '';
        
        if(sheet === 'Projects') {
            html = UI.fields([
                {label: 'Título', id: 'title', val: item.title},
                {label: 'Orden', id: 'order', val: item.order, type: 'number'},
                {label: 'Descripción', id: 'description', val: item.description, type: 'textarea'}
            ]);
        } else if (sheet === 'Services') {
            html = UI.fields([
                {label: 'Título', id: 'title', val: item.title},
                {label: 'Icono (FontAwesome)', id: 'iconClass', val: item.iconClass},
                {label: 'Intro', id: 'introText', val: item.introText, type: 'textarea'},
                {label: 'Orden', id: 'order', val: item.order, type: 'number'}
            ]);
        } else if (sheet === 'RentalItems') {
             const cats = (AppState.data.RentalCategories || []).map(c => ({val: c.id, text: c.name}));
             html = UI.fields([
                {label: 'Nombre', id: 'name', val: item.name},
                {label: 'Categoría', id: 'categoryId', val: item.categoryId, type: 'select', opts: cats},
                {label: 'Precio', id: 'pricePerDay', val: item.pricePerDay, type: 'number'},
                {label: 'Desc. Corta', id: 'description', val: item.description},
                {label: 'Desc. Larga', id: 'longDescription', val: item.longDescription, type: 'textarea'},
                {label: 'Orden', id: 'order', val: item.order, type: 'number'}
             ]);
        }
        // ... Agrega los demás tipos aquí

        const footer = `<button class="btn btn-secondary mr-2" onclick="UI.closeModal()">Cancelar</button>
                        <button class="btn btn-primary" onclick="App.saveItem('${sheet}', '${id || ''}')">Guardar</button>`;
        
        UI.showModal(isNew ? 'Nuevo' : 'Editar', `<form id="crud-form">${html}</form>`, footer);
    },

    async saveItem(sheet, id) {
        const form = document.getElementById('crud-form');
        const data = {};
        form.querySelectorAll('input, select, textarea').forEach(el => data[el.id] = el.value);
        
        UI.showLoading('Guardando...');
        const action = id ? 'update' : 'add';
        const criteria = id ? { id } : {};
        
        try {
            await API.call('/.netlify/functions/update-sheet-data', {
                method: 'POST',
                body: JSON.stringify({ sheet, action, criteria, data })
            });
            // Recargar datos específicos
            await App.loadData([sheet]);
            UI.closeModal();
            UI.showToast("Guardado");
        } catch(e) {
            alert(e.message);
        } finally {
            UI.hideLoading();
        }
    }
};

// --- UI RENDER ---
const UI = {
    showApp() {
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-screen').style.display = 'flex';
        this.switchView('dashboard');
    },
    switchView(viewId) {
        AppState.view = viewId;
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(`view-${viewId}`).classList.add('active');
        
        // Carga diferida según vista
        let sheets = [];
        if(viewId === 'projects') sheets = ['Projects', 'ProjectImages'];
        if(viewId === 'portfolio-manager') sheets = ['ProjectImages'];
        if(viewId === 'rentals') sheets = ['RentalItems', 'RentalCategories', 'RentalItemImages'];
        if(viewId === 'services') sheets = ['Services', 'ServiceImages'];
        if(viewId === 'settings') sheets = ['Settings', 'About', 'ClientLogos'];
        
        if(sheets.length) {
            document.getElementById('loading-screen').style.display = 'flex';
            App.loadData(sheets).then(() => document.getElementById('loading-screen').style.display = 'none');
        } else {
            this.renderCurrentView();
        }
    },
    renderCurrentView() {
        const d = AppState.data || {};
        const v = AppState.view;
        
        if(v === 'dashboard') {
            document.getElementById('dash-projects').innerText = (d.Projects||[]).length;
            document.getElementById('dash-portfolio').innerText = (d.ProjectImages||[]).filter(i => i.showInPortfolio?.toLowerCase() === 'si').length;
        }
        
        if(v === 'projects') {
            document.getElementById('projects-list').innerHTML = (d.Projects||[]).map(p => {
                 const cover = (d.ProjectImages||[]).find(i => i.projectId === p.id && i.isCover === 'Si');
                 const img = cover ? cover.imageUrl : 'https://placehold.co/50';
                 return `<div class="p-4 flex items-center justify-between">
                    <div class="flex items-center gap-4"><img src="${img}" class="w-16 h-16 object-cover rounded"> <span class="font-bold">${p.title}</span></div>
                    <div class="flex gap-2">
                        <button class="text-blue-600" onclick="App.editItem('Projects', '${p.id}')"><i class="fas fa-edit"></i></button>
                        <button class="text-green-600" onclick="App.openGalleryModal('${p.id}', 'Projects', '${p.title}')"><i class="fas fa-images"></i></button>
                        <button class="text-red-600" onclick="App.deleteItem('Projects', '${p.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                 </div>`;
            }).join('');
        }

        if (v === 'portfolio-manager') {
             const images = (d.ProjectImages||[]).filter(i => i.showInPortfolio === 'Si').sort((a,b) => a.portfolioOrder - b.portfolioOrder);
             document.getElementById('portfolio-grid').innerHTML = images.map(i => `
                <div class="gallery-item">
                    <img src="${i.imageUrl}">
                    <div class="mt-2 flex gap-2">
                        <input type="number" class="border w-12 text-center text-sm" value="${i.portfolioOrder||99}" onchange="App.saveSingleField('ProjectImages', '${i.id}', 'portfolioOrder', this.value)">
                        <button class="text-red-500 text-xs" onclick="App.saveSingleField('ProjectImages', '${i.id}', 'showInPortfolio', 'No')">Quitar</button>
                    </div>
                </div>
             `).join('');
        }
        
        // ... Renderizado de otras vistas (Servicios, Alquiler, etc.) similar ...
        if(v === 'rentals') {
             // Renderizar lista de items
             const itemsList = document.getElementById('rental-items-list');
             itemsList.innerHTML = (d.RentalItems||[]).map(i => `
                <div class="p-4 flex justify-between">
                    <span>${i.name}</span>
                    <div>
                        <button class="text-green-600 mr-2" onclick="App.openGalleryModal('${i.id}', 'RentalItems', '${i.name}')"><i class="fas fa-images"></i></button>
                        <button class="text-blue-600" onclick="App.editItem('RentalItems', '${i.id}')"><i class="fas fa-edit"></i></button>
                    </div>
                </div>
             `).join('');
        }
    },

    renderGalleryModal(parentId, type, title) {
        // Renderiza el modal con los datos de currentModalImages
        const html = `<div id="modal-gallery-list" class="space-y-2 max-h-[60vh] overflow-y-auto"></div>
                      <div class="mt-4 pt-4 border-t text-center">
                         <input type="file" id="upload-input" multiple class="hidden" onchange="App.uploadImages(this, '${parentId}', '${type}')">
                         <button class="btn btn-secondary" onclick="document.getElementById('upload-input').click()">+ Subir Fotos</button>
                      </div>`;
        
        const footer = `<button class="btn btn-secondary" onclick="UI.closeModal()">Cancelar</button> 
                        <button class="btn btn-primary ml-2" onclick="App.saveGalleryChanges('${parentId}', '${type}')">Guardar Cambios</button>`;
        
        UI.showModal(title, html, footer);
        UI.renderGalleryList(currentModalImages, type);
    },

    renderGalleryList(images, type) {
        const container = document.getElementById('modal-gallery-list');
        if(!container) return;
        
        container.innerHTML = images.filter(i => !i._deleted).map(i => `
            <div class="flex gap-4 items-center p-2 border rounded bg-gray-50">
                <img src="${i.imageUrl}" class="w-16 h-16 object-cover">
                <div class="flex-1 grid grid-cols-2 gap-2">
                    <label class="text-xs">Orden <input type="number" class="border w-full p-1" value="${i.order||99}" onchange="App.updateImageLocal('${i.id}', 'order', this.value, '${type}')"></label>
                    ${type==='Projects' ? `<label class="text-xs">Pie <input type="text" class="border w-full p-1" value="${i.caption||''}" onchange="App.updateImageLocal('${i.id}', 'caption', this.value, '${type}')"></label>` : ''}
                     ${type==='ClientLogos' ? `<label class="text-xs">Cliente <input type="text" class="border w-full p-1" value="${i.clientName||''}" onchange="App.updateImageLocal('${i.id}', 'clientName', this.value, '${type}')"></label>` : ''}
                </div>
                <div class="flex flex-col gap-1 text-xs">
                    ${type !== 'ClientLogos' ? `<label><input type="checkbox" ${i.isCover === 'Si' ? 'checked' : ''} onchange="App.updateImageLocal('${i.id}', 'isCover', this.checked, '${type}')"> Portada</label>` : ''}
                    ${type === 'Projects' ? `<label><input type="checkbox" ${i.showInPortfolio === 'Si' ? 'checked' : ''} onchange="App.updateImageLocal('${i.id}', 'showInPortfolio', this.checked, '${type}')"> Portafolio</label>` : ''}
                </div>
                <button class="text-red-500" onclick="App.markImageForDelete('${i.id}', '${type}')"><i class="fas fa-trash"></i></button>
            </div>
        `).join('');
    },

    // Helpers
    fields(list) {
        return list.map(f => {
            if(f.type === 'select') return `<div class="mb-4"><label class="form-label">${f.label}</label><select id="${f.id}" class="form-select">${f.opts.map(o => `<option value="${o.val}" ${o.val==f.val?'selected':''}>${o.text}</option>`).join('')}</select></div>`;
            if(f.type === 'textarea') return `<div class="mb-4"><label class="form-label">${f.label}</label><textarea id="${f.id}" class="form-textarea">${f.val||''}</textarea></div>`;
            return `<div class="mb-4"><label class="form-label">${f.label}</label><input type="${f.type||'text'}" id="${f.id}" value="${f.val||''}" class="form-input"></div>`;
        }).join('');
    },
    showModal(t, b, f) { document.getElementById('modal-container').innerHTML = `<div class="modal-overlay visible"><div class="modal-content"><div class="p-6 border-b flex justify-between"> <h2 class="text-xl font-bold">${t}</h2> <button onclick="UI.closeModal()">×</button> </div> <div class="p-6">${b}</div> <div class="p-6 border-t text-right bg-gray-50">${f}</div> </div></div>`; },
    closeModal() { document.getElementById('modal-container').innerHTML = ''; },
    showLoading(m) { document.getElementById('loading-screen').style.display = 'flex'; document.querySelector('#loading-screen p').innerText = m; },
    hideLoading() { document.getElementById('loading-screen').style.display = 'none'; },
    showToast(m, t='success') { const el = document.createElement('div'); el.className = `toast visible ${t}`; el.innerText = m; document.body.appendChild(el); setTimeout(() => el.remove(), 3000); },
    showTab(id) { 
        document.getElementById('tab-rental-items').classList.add('hidden');
        document.getElementById('tab-rental-cats').classList.add('hidden');
        document.getElementById(id).classList.remove('hidden');
    }
};

// --- INIT ---
document.getElementById('google-login-btn').addEventListener('click', Auth.login);
document.getElementById('logout-btn').addEventListener('click', Auth.logout);
document.getElementById('main-nav').addEventListener('click', (e) => {
    const link = e.target.closest('a');
    if(link) { e.preventDefault(); UI.switchView(link.dataset.view); }
});

Auth.init();
</script>
</body>
</html>





