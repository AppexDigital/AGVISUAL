<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Mando | AG Visual Info</title>
    <link rel="icon" type="image/png" href="https://placehold.co/32x32/1a1a1a/FDFDFD?text=AG">

    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    
    <style>
        /* Estilos para que el editor se vea profesional y limpio */
        .ql-toolbar { border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; background: #f9fafb; border-color: #e5e7eb; }
        .ql-container { border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; background: white; font-family: 'Montserrat', sans-serif; font-size: 0.9rem; border-color: #e5e7eb; }
        .ql-editor { min-height: 120px; } /* Altura mínima para escribir cómodo */
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root { --bg-main: #FDFDFD; --text-dark: #1a1a1a; --text-muted: #52525b; --accent: #3a3a3a; --border-color: #e5e7eb; --status-pending: #f59e0b; --status-confirmed: #10b981; --status-paid: #3b82f6; --status-canceled: #ef4444; }
        body { font-family: 'Montserrat', sans-serif; background-color: var(--bg-main); color: var(--text-dark); }
        h1, h2, h3, .font-display { font-family: 'Cormorant Garamond', serif; }
        
        /* UI Components */
        .loader-circle { width: 50px; height: 50px; border: 4px solid rgba(0,0,0,0.1); border-radius: 50%; border-top-color: var(--accent); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .btn { padding: 0.5rem 1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.75rem; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; cursor: pointer; border-radius: 4px; }
        .btn-primary { background-color: var(--text-dark); color: white; }
        .btn-primary:hover { background-color: var(--accent); }
        .btn-secondary { border: 1px solid var(--text-dark); color: var(--text-dark); background: transparent; }
        .btn-secondary:hover { background: #f3f4f6; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.7rem; }
        
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); font-family: 'Montserrat', sans-serif; font-size: 0.9rem; background: white; }
        .form-input:focus { border-color: var(--text-dark); outline: none; }
        .form-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.25rem; display: block; }
        
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1.5rem; color: var(--text-muted); border-left: 4px solid transparent; transition: all 0.2s; font-size: 0.9rem; }
        .sidebar-link:hover { background-color: #f3f4f6; color: var(--text-dark); }
        .sidebar-link.active { background-color: #f3f4f6; color: var(--text-dark); border-left-color: var(--text-dark); font-weight: 700; }
        .sidebar-link i { width: 1.5rem; text-align: center; margin-right: 0.75rem; }
        
        .view { display: none; animation: fadeIn 0.3s ease-out; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; width: 95%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); transform: scale(0.95); transition: transform 0.2s; border-radius: 8px; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        
        .toast { position: fixed; bottom: 2rem; right: 2rem; background: var(--text-dark); color: white; padding: 1rem 1.5rem; z-index: 100; transform: translateY(100px); transition: transform 0.3s; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); font-weight: 600; border-radius: 4px; }
        .toast.visible { transform: translateY(0); }
        .toast.error { background: #ef4444; }
        
        .img-preview { width: 60px; height: 60px; object-fit: cover; border: 1px solid #e5e7eb; border-radius: 4px; background-color: #f9fafb; }
        
        .tab-nav { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        .tab-btn { padding: 1rem; color: var(--text-muted); font-weight: 600; border-bottom: 2px solid transparent; transition: all 0.2s; cursor: pointer; }
        .tab-btn.active { color: var(--text-dark); border-bottom-color: var(--text-dark); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .portfolio-grid-item { position: relative; aspect-ratio: 1; overflow: hidden; border-radius: 4px; border: 1px solid #eee; background: #f3f4f6; transition: transform 0.2s; }
        .portfolio-grid-item img { width: 100%; height: 100%; object-fit: cover; }
        .portfolio-grid-overlay { 
            position: absolute; inset: 0; background: rgba(0,0,0,0.8); 
            opacity: 0; transition: opacity 0.2s; 
            display: flex; flex-direction: column; justify-content: center; items-center; gap: 10px; 
        }
        .portfolio-grid-item:hover .portfolio-grid-overlay { opacity: 1; }
        .portfolio-badge { position: absolute; top: 5px; right: 5px; background: #10b981; color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: bold; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        .status-badge { padding: 2px 8px; border-radius: 10px; color: white; font-size: 0.65rem; font-weight: bold; text-transform: uppercase; }
        .status-Pendiente { background: var(--status-pending); }
        .status-Confirmado { background: var(--status-confirmed); }
        .status-Pagado { background: var(--status-paid); }
        .status-Cancelado { background: var(--status-canceled); }



        

        /* --- FIX V12: SOLUCIÓN FINAL SCROLL Y FULLSCREEN --- */

        /* 1. ELIMINAR EL CONTENEDOR BLANCO Y SU SCROLL (ESTADO NORMAL) */
        /* Esto fuerza al modal genérico a ser transparente y ajustarse a nuestro diseño */
        .modal-content:has(#reservation-modal-content) {
            position: fixed !important;
            inset: 0 !important; /* Top, Right, Bottom, Left = 0 */
            width: 100vw !important;
            height: 100vh !important;
            max-width: none !important;
            max-height: none !important;
            margin: 0 !important;
            padding: 0 !important;
            border-radius: 0 !important;
            border: none !important;
            box-shadow: none !important;
            background-color: #0a0a0a !important; /* Fondo negro total */
            z-index: 99999 !important;
            
            /* Estructura para el hijo */
            display: flex !important;
            flex-direction: column !important;
            overflow: hidden !important; /* Evitar scroll en el padre */
        }

        /* 2. ELIMINAR EL PADDING DEL OVERLAY */
        .modal-overlay:has(#reservation-modal-content) {
            padding: 0 !important;
            display: block !important; /* Rompe el centrado flex para permitir full cover */
        }
        
        /* Ocultar elementos basura del modal genérico */
        .modal-content:has(#reservation-modal-content) > .border-b,
        .modal-content:has(#reservation-modal-content) > .bg-gray-50 {
            display: none !important;
        }

        
        /* 3. ESTILOS INTERNOS (Mantener diseño bonito) */
        .booking-grid-header { background-color: #1a1a1a; color: #9ca3af; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .grid-input { background: transparent; border: none; border-bottom: 1px solid #4b5563; color: white; width: 100%; outline: none; transition: border-color 0.2s; }
        .grid-input:focus, .focus-gold:focus { border-color: #ffffff !important; }
        select.dark-select { 
            background-color: #1a1a1a !important; 
            color: white !important; 
            border-color: rgba(255, 255, 255, 0.1) !important; /* Mismo borde sutil del resto */
        }
        select.dark-select option { 
            background-color: #1a1a1a !important; 
            color: white !important; 
        }
        .font-total { font-family: 'Inter', sans-serif; font-weight: 800; letter-spacing: -0.05em; font-variant-numeric: tabular-nums; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #B8860B; }
        .no-resize { resize: none; }

        /* SCROLLBAR NEGRO (Para que no se vea) */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; } 
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: #000000; /* NEGRO TOTAL: Se pierde con el fondo */
            border-radius: 3px;
        }
        /* Al pasar el mouse sigue negro para no delatar su posición */
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #000000; }



        /* --- ESTILOS DEL EDITOR DE COTIZACIÓN (VISTA PREVIA) --- */
        #quote-editor-overlay {
            position: fixed; inset: 0; z-index: 100000; background: #e5e7eb;
            display: none; flex-direction: column; font-family: 'Inter', sans-serif;
        }
        #editor-toolbar-strip {
            background: #f3f4f6; border-bottom: 1px solid #d1d5db; padding: 0.5rem 1rem;
            display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .toolbar-btn {
            background: white; border: 1px solid #d1d5db; color: #374151; cursor: pointer;
            padding: 0.25rem; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center;
            width: 32px; height: 32px; transition: all 0.2s;
        }
        .toolbar-btn:hover { background: #e5e7eb; border-color: #9ca3af; }
        .toolbar-select {
            height: 32px; border: 1px solid #d1d5db; border-radius: 4px; padding: 0 0.5rem;
            font-size: 0.8rem; background: white; cursor: pointer; outline: none;
        }
        .toolbar-separator { width: 1px; height: 24px; background: #d1d5db; margin: 0 0.25rem; }
        
        #quote-editor-scroll {
            flex: 1; overflow-y: auto; padding: 2rem; display: flex; justify-content: center;
        }
        /* AJUSTE VISUAL: Editor Transparente e Infinito */
        #quote-editor-page {
            background: transparent !important; /* Fondo transparente */
            box-shadow: none !important;        /* Sin sombra */
            width: 100%; 
            max-width: 800px; 
            min-height: auto !important;        /* Altura automática */
            height: auto !important;            /* Crece con el contenido */
            padding: 20px 0; 
            color: #000;
            margin: 0 auto;
        }

        /* Asegura que el contenedor permita scroll sin cortes */
        #quote-editor-scroll {
            align-items: flex-start; /* Alineación superior para evitar cortes */
            padding-bottom: 100px;   /* Espacio extra al final */
        }
        
        /* Ocultar elementos al imprimir desde el navegador */
        @media print {
            #quote-editor-overlay { position: static; display: block; height: auto; overflow: visible; background: white; }
            #editor-header, #editor-toolbar-strip { display: none !important; }
            #quote-editor-scroll { padding: 0; display: block; overflow: visible; }
            #quote-editor-page { box-shadow: none; max-width: none; min-height: 0; padding: 0; margin: 0; }
            body > *:not(#quote-editor-overlay) { display: none !important; }
        }

        
        
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <div id="loading-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-white">
        <div class="loader-circle"></div>
        <p id="loading-text" class="mt-4 font-display text-xl text-text-dark">Cargando Sistema...</p>
        <button onclick="UI.forceReload()" class="mt-4 text-sm text-gray-400 underline hover:text-gray-600 hidden" id="reload-btn">Recargar</button>
    </div>

    <div id="login-screen" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-gray-100">
        <div class="bg-white p-10 shadow-2xl max-w-md w-full text-center border-t-4 border-text-dark">
            <h1 class="font-display text-4xl font-bold mb-2">AG Visual Info</h1>
            <p class="text-text-muted mb-8 uppercase tracking-widest text-xs">Panel de Control</p>
            <button id="google-login-btn" class="w-full bg-[#4285F4] text-white font-bold py-3 px-4 flex items-center justify-center gap-3 hover:bg-[#3367D6] transition-colors shadow-md rounded">
                <i class="fab fa-google"></i> Iniciar con Google Workspace
            </button>
        </div>
    </div>

    <div id="app-screen" class="hidden flex-1 flex h-full overflow-hidden">
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col flex-shrink-0 shadow-sm z-20">
            <div class="p-6 border-b border-gray-100">
                <h2 class="font-display text-2xl font-bold">AG Admin</h2>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 space-y-1" id="main-nav">
                <a href="#" class="sidebar-link active" data-view="dashboard"><i class="fas fa-home"></i>Inicio</a>
                <a href="#" class="sidebar-link" data-view="projects"><i class="fas fa-camera"></i>Proyectos</a>
                <a href="#" class="sidebar-link" data-view="portfolio-manager"><i class="fas fa-images"></i>Portafolio</a>
                <a href="#" class="sidebar-link" data-view="services"><i class="fas fa-concierge-bell"></i>Servicios</a>
                <a href="#" class="sidebar-link" data-view="videos"><i class="fas fa-video"></i>Videos</a>
                <a href="#" class="sidebar-link" data-view="rentals"><i class="fas fa-box"></i>Alquiler</a>
                <a href="#" class="sidebar-link" data-view="bookings"><i class="fas fa-calendar-check"></i>Reservas</a>
                <a href="#" class="sidebar-link" data-view="client-logos"><i class="fas fa-star"></i>Logos Clientes</a>
                <a href="#" class="sidebar-link" data-view="identity"><i class="fas fa-id-card"></i>Identidad</a>
            </nav>
            <div class="p-4 border-t border-gray-100">
                <button id="logout-btn" class="w-full text-left px-4 py-2 text-text-muted hover:text-red-600 transition-colors text-xs font-bold uppercase"><i class="fas fa-sign-out-alt mr-2"></i>Salir</button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-gray-50 p-8 relative">


            
            
            <div id="view-dashboard" class="view active">
                
                <div class="flex flex-col xl:flex-row justify-between items-start xl:items-end mb-6 gap-6">
                    <div>
                        <h1 class="text-4xl font-display font-bold text-gray-900 tracking-tight">Centro de Control</h1>
                        <p class="text-gray-500 text-sm mt-1">Visión global del negocio</p>
                    </div>
                    
                    <div class="bg-white p-2 border border-gray-200 flex flex-wrap items-center gap-2 w-full xl:w-auto shadow-sm">
                        <div class="flex gap-2 border-r border-gray-200 pr-3 mr-1">
                            <button onclick="App.handleManualBooking()" class="btn btn-sm bg-blue-50 text-blue-600 hover:bg-blue-100 border-none shadow-none font-bold" title="Nueva Reserva">
                                <i class="fas fa-plus mr-1"></i> Reserva
                            </button>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-filter text-gray-400 text-xs ml-1"></i>
                            <select id="dash-time-filter" class="form-select text-sm py-1.5 pl-2 pr-8 border-gray-300 bg-gray-50 focus:bg-white transition w-40 cursor-pointer" onchange="App.handleFilterChange(this)">
                                <optgroup label="Histórico">
                                    <option value="current_month" selected>Este Mes</option>
                                    <option value="3">Últimos 3 Meses</option>
                                    <option value="6">Últimos 6 Meses</option>
                                    <option value="12">Último Año</option>
                                    <option value="all">Todo el Histórico</option>
                                </optgroup>
                                <optgroup label="Futuro">
                                    <option value="future">Proyección (Futuro)</option>
                                </optgroup>
                                <optgroup label="Específico">
                                    <option value="custom">Rango Personalizado</option>
                                </optgroup>
                            </select>
                        </div>
                        <div id="dash-custom-dates" class="hidden flex-wrap items-center gap-2 border-l border-gray-200 pl-3">
                            <input type="text" id="dash-date-start" class="form-input text-sm w-28 py-1.5 bg-gray-50" placeholder="Desde">
                            <span class="text-gray-400">-</span>
                            <input type="text" id="dash-date-end" class="form-input text-sm w-28 py-1.5 bg-gray-50" placeholder="Hasta">
                            <button onclick="UI.renderView('dashboard')" class="btn btn-sm btn-primary py-1.5"><i class="fas fa-check"></i></button>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    
                    <div class="bg-gradient-to-br from-white to-gray-50 p-5 border border-gray-200 shadow-sm relative overflow-hidden group">
                        <div class="flex justify-between items-start mb-2">
                            <p class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">Total Generado</p>
                            <div class="p-1.5 bg-gray-200 text-gray-600 text-xs"><i class="fas fa-dollar-sign"></i></div>
                        </div>
                        <h3 class="text-3xl font-bold font-sans text-gray-800 tracking-normal" id="kpi-rev-total">$0.00</h3>
                        
                        <div class="mt-3 flex items-center gap-2 text-[10px] font-medium">
                            <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded-sm">Pagada: <span id="kpi-rev-paid">$0</span></span>
                            <span class="px-2 py-0.5 bg-green-100 text-green-700 rounded-sm">Confirmado: <span id="kpi-rev-confirmed">$0</span></span>
                        </div>
                    </div>

                    <div class="bg-white p-5 border border-yellow-100 shadow-sm relative overflow-hidden">
                        <div class="flex justify-between items-start mb-2">
                            <p class="text-[10px] font-bold text-yellow-600 uppercase tracking-wider">Pendiente</p>
                            <i class="fas fa-hourglass-half text-yellow-400"></i>
                        </div>
                        <h3 class="text-3xl font-bold font-sans text-gray-800 tracking-normal mt-5" id="kpi-rev-pending">$0.00</h3>
                    </div>

                    <div class="bg-white p-5 border border-red-50 shadow-sm relative overflow-hidden">
                        <div class="flex justify-between items-start mb-2">
                            <p class="text-[10px] font-bold text-red-400 uppercase tracking-wider">Cancelado</p>
                            <i class="fas fa-ban text-red-200"></i>
                        </div>
                        <h3 class="text-3xl font-bold font-sans text-gray-400 tracking-normal mt-5" id="kpi-rev-lost">$0.00</h3>
                    </div>

                    <div class="bg-white p-5 border border-gray-200 shadow-sm flex flex-col justify-center items-center text-center">
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Reservas</p>
                        <h3 class="text-4xl font-bold font-sans text-gray-800 tracking-normal" id="kpi-count-total">0</h3>
                        <p class="text-[10px] text-gray-400">En periodo seleccionado</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6 items-stretch">
                    
                    <div class="lg:col-span-2 bg-white p-6 shadow-sm border border-gray-200 flex flex-col h-[22rem]">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-800 text-sm">Tendencia de Ingresos</h3>
                            <span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 uppercase font-bold" id="chart-label-period">Vista Dinámica</span>
                        </div>
                        <div class="relative flex-1 w-full min-h-0">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>

                    <div class="bg-white p-6 shadow-sm border border-gray-200 flex flex-col h-[22rem] relative">
                        <h3 class="font-bold text-gray-800 text-xs text-center mb-4 uppercase">Estado de Reservas</h3>
                        <div class="relative flex-1 w-full flex items-center justify-center">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>

                <hr class="border-gray-200 my-8 border-dashed">

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8 items-start">
                    
                    <div class="bg-white shadow-sm border border-gray-200 flex flex-col">
                        <div class="p-4 border-b bg-gradient-to-r from-blue-50 to-white flex justify-between items-center shrink-0">
                            <h3 class="font-bold text-blue-900 text-sm flex items-center gap-2">
                                <i class="fas fa-calendar-day text-blue-500"></i> Próximas Entregas
                            </h3>
                            <span class="text-[10px] font-bold text-blue-400 uppercase">Confirmadas</span>
                        </div>
                        <div class="p-3 space-y-2 bg-gray-50/30" id="dashboard-agenda-list">
                            </div>
                    </div>

                    <div class="bg-white shadow-sm border border-gray-200 flex flex-col relative">
                        <div class="absolute top-0 left-0 w-1 h-full bg-yellow-400 z-10"></div>
                        <div class="p-4 border-b bg-white flex justify-between items-center shrink-0 pl-6">
                            <h3 class="font-bold text-gray-800 text-sm flex items-center gap-2">
                                <i class="fas fa-inbox text-yellow-500"></i> Solicitudes Recientes
                            </h3>
                            <span class="bg-yellow-100 text-yellow-700 text-xs font-bold px-2 py-0.5" id="kpi-pending-badge">0</span>
                        </div>
                        <div class="p-3 space-y-2" id="dashboard-pending-list">
                             </div>
                    </div>

                    <div class="bg-white shadow-sm border border-gray-200 flex flex-col">
                        <div class="p-4 border-b bg-gray-50 flex justify-between items-center shrink-0">
                            <h3 class="font-bold text-gray-800 text-sm">Resumen del Sistema</h3>
                            <i class="fas fa-network-wired text-gray-300"></i>
                        </div>
                        <div class="p-4 grid grid-cols-2 gap-3 text-xs">
                            
                            <div onclick="App.switchView('projects')" class="p-2 bg-white border border-gray-100 hover:border-purple-200 hover:bg-purple-50 cursor-pointer transition text-center group relative">
                                <i class="fas fa-camera text-purple-500 text-xl mb-1 block"></i>
                                <span class="font-bold block text-gray-800 text-lg" id="stat-projects">0</span>
                                <span class="text-gray-500 block text-[10px]">Proyectos</span>
                                <div class="absolute top-1 right-1 text-[8px] bg-purple-100 text-purple-600 px-1" id="stat-projects-img">0 Fotos</div>
                            </div>

                            <div onclick="App.switchView('portfolio-manager')" class="p-2 bg-white border border-gray-100 hover:border-pink-200 hover:bg-pink-50 cursor-pointer transition text-center group">
                                <i class="fas fa-images text-pink-500 text-xl mb-1 block"></i>
                                <span class="font-bold block text-gray-800 text-lg" id="stat-portfolio">0</span>
                                <span class="text-gray-500 block text-[10px]">Portafolio</span>
                            </div>

                            <div onclick="App.switchView('services')" class="p-2 bg-white border border-gray-100 hover:border-blue-200 hover:bg-blue-50 cursor-pointer transition text-center group relative">
                                <i class="fas fa-concierge-bell text-blue-500 text-xl mb-1 block"></i>
                                <span class="font-bold block text-gray-800 text-lg" id="stat-services">0</span>
                                <span class="text-gray-500 block text-[10px]">Servicios</span>
                                <div class="absolute top-1 right-1 text-[8px] bg-blue-100 text-blue-600 px-1" id="stat-services-img">0 Fotos</div>
                            </div>

                            <div onclick="App.switchView('videos')" class="p-2 bg-white border border-gray-100 hover:border-red-200 hover:bg-red-50 cursor-pointer transition text-center group">
                                <i class="fas fa-video text-red-500 text-xl mb-1 block"></i>
                                <span class="font-bold block text-gray-800 text-lg" id="stat-videos">0</span>
                                <span class="text-gray-500 block text-[10px]">Videos</span>
                            </div>

                            <div onclick="App.switchView('rentals').then(() => UI.switchTab('rental-items'))" class="p-2 bg-white border border-gray-100 hover:border-gray-300 hover:bg-gray-50 cursor-pointer transition text-center group relative">
                                <i class="fas fa-box text-gray-600 text-xl mb-1 block"></i>
                                <span class="font-bold block text-gray-800 text-lg" id="stat-items">0</span>
                                <span class="text-gray-500 block text-[10px]">Equipos</span>
                                <div class="absolute top-1 right-1 text-[8px] bg-gray-200 text-gray-600 px-1" id="stat-items-img">0 Fotos</div>
                            </div>

                            <div onclick="App.switchView('rentals').then(() => UI.switchTab('rental-cats'))" class="p-2 bg-white border border-gray-100 hover:border-gray-300 hover:bg-gray-50 cursor-pointer transition text-center group">
                                <i class="fas fa-tags text-gray-400 text-xl mb-1 block"></i>
                                <span class="font-bold block text-gray-800 text-lg" id="stat-cats">0</span>
                                <span class="text-gray-500 block text-[10px]">Categorías</span>
                            </div>

                            <div onclick="App.switchView('bookings')" class="p-2 bg-white border border-gray-100 hover:border-green-200 hover:bg-green-50 cursor-pointer transition text-center group">
                                <i class="fas fa-calendar-check text-green-500 text-xl mb-1 block"></i>
                                <span class="font-bold block text-gray-800 text-lg" id="stat-bookings">0</span>
                                <span class="text-gray-500 block text-[10px]">Reservas</span>
                            </div>

                            <div onclick="App.switchView('rentals').then(() => UI.switchTab('blocked-dates'))" class="p-2 bg-white border border-gray-100 hover:border-orange-200 hover:bg-orange-50 cursor-pointer transition text-center group">
                                <i class="fas fa-ban text-orange-500 text-xl mb-1 block"></i>
                                <span class="font-bold block text-gray-800 text-lg" id="stat-blocked">0</span>
                                <span class="text-gray-500 block text-[10px]">Bloqueos</span>
                            </div>
                            
                            <div onclick="App.switchView('client-logos')" class="p-2 bg-white border border-gray-100 hover:border-yellow-200 hover:bg-yellow-50 cursor-pointer transition text-center group">
                                <i class="fas fa-star text-yellow-500 text-xl mb-1 block"></i>
                                <span class="font-bold block text-gray-800 text-lg" id="stat-logos">0</span>
                                <span class="text-gray-500 block text-[10px]">Clientes</span>
                            </div>

                            <div onclick="App.switchView('identity')" class="p-2 bg-white border border-gray-100 hover:border-teal-200 hover:bg-teal-50 cursor-pointer transition text-center group relative">
                                <i class="fas fa-id-card text-teal-500 text-xl mb-1 block"></i>
                                <span class="font-bold block text-gray-800 text-lg" id="stat-identity">1</span>
                                <span class="text-gray-500 block text-[10px]">Identidad</span>
                                <div class="absolute top-1 right-1 text-[8px] bg-teal-100 text-teal-600 px-1" id="stat-identity-img">0 Fotos</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            

            <div id="view-projects" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-display font-bold">Proyectos</h1>
                    <button class="btn btn-primary" onclick="App.handleEditCrudItem('Projects', null)"><i class="fas fa-plus"></i> Nuevo</button>
                </div>
                <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b">
                            <tr>
                                <th class="p-4 text-center">Orden</th> <th class="p-4">Portada</th>
                                <th class="p-4">Título</th>
                                <th class="p-4 text-center">Fotos</th>
                                <th class="p-4 text-center">Acciones</th> </tr>
                        </thead>
                        <tbody id="projects-table-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-portfolio-manager" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-display font-bold">Portafolio</h1>
                    <button class="btn btn-primary" onclick="App.savePortfolioOrder()"><i class="fas fa-save"></i> Guardar Orden</button>
                </div>
                <div id="portfolio-manager-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
            </div>

            <div id="view-videos" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-display font-bold">Videos</h1>
                    <button class="btn btn-primary" onclick="App.handleEditCrudItem('Videos', null)"><i class="fas fa-plus"></i> Nuevo</button>
                </div>
                <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b">
                            <tr><th class="p-4">Orden</th><th class="p-4">Título</th><th class="p-4">URL</th><th class="p-4">Acciones</th></tr>
                        </thead>
                        <tbody id="videos-table-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-services" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-display font-bold">Servicios</h1>
                    <button class="btn btn-primary" onclick="App.handleEditCrudItem('Services', null)"><i class="fas fa-plus"></i> Nuevo</button>
                </div>
                <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b">
                            <tr><th class="p-4">Orden</th><th class="p-4">Título</th><th class="p-4">Acciones</th></tr>
                        </thead>
                        <tbody id="services-table-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

           <div id="view-rentals" class="view">
                <h1 class="text-3xl font-display font-bold mb-6">Alquiler</h1>
                
                <div class="tab-nav">
                    <button class="tab-btn" onclick="UI.switchTab('rental-cats')">Categorías</button>
                    <button class="tab-btn active" onclick="UI.switchTab('rental-items')">Equipos</button>
                    <button class="tab-btn" onclick="UI.switchTab('blocked-dates')">Bloqueos</button>
                </div>

                <div id="tab-rental-cats" class="tab-content">
                    <div class="flex justify-end mb-4">
                        <button class="btn btn-primary" onclick="App.handleEditCrudItem('RentalCategories', null)"><i class="fas fa-plus"></i> Nueva Categoría</button>
                    </div>
                    <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b">
                                <tr><th class="p-4">Orden</th><th class="p-4">Nombre</th><th class="p-4">Acciones</th></tr>
                            </thead>
                            <tbody id="rental-categories-table-body" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-rental-items" class="tab-content active">
                    <div class="flex justify-end mb-4">
                        <button class="btn btn-primary" onclick="App.handleEditCrudItem('RentalItems', null)"><i class="fas fa-plus"></i> Nuevo Equipo</button>
                    </div>
                    <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b">
                                <tr><th class="p-4">Img</th><th class="p-4">Nombre</th><th class="p-4">Categoría</th><th class="p-4">Precio</th><th class="p-4">Acciones</th></tr>
                            </thead>
                            <tbody id="rental-items-table-body" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="tab-blocked-dates" class="tab-content">
                    <div class="flex justify-end mb-4">
                        <button class="btn btn-primary" onclick="App.handleEditCrudItem('BlockedDates', null)"><i class="fas fa-ban"></i> Nuevo Bloqueo</button>
                    </div>
                    <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b">
                                <tr><th class="p-4">Equipo</th><th class="p-4">Motivo</th><th class="p-4">Desde</th><th class="p-4">Hasta</th><th class="p-4">Acciones</th></tr>
                            </thead>
                            <tbody id="blocked-dates-table-body" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="view-bookings" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-display font-bold">Reservas</h1>
                    <button class="btn btn-primary" onclick="App.handleManualBooking()"><i class="fas fa-plus"></i> Nueva Reserva</button>
                </div>
                
                <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b">
                            <tr><th class="p-4">Fecha</th><th class="p-4">Cliente</th><th class="p-4">Equipo</th><th class="p-4">Total</th><th class="p-4">Estado</th><th class="p-4">Acciones</th></tr>
                        </thead>
                        <tbody id="bookings-list-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
            <div id="view-client-logos" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-display font-bold">Logos de Clientes</h1>
                    <button class="btn btn-primary" onclick="App.handleEditCrudItem('LogosClientes', null)">
                        <i class="fas fa-plus"></i> Nuevo Logo
                    </button>
                </div>
                <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b">
                            <tr>
                                <th class="p-4 text-center w-16">Orden</th>
                                <th class="p-4 text-center w-24">Logo</th>
                                <th class="p-4">Cliente</th>
                                <th class="p-4 text-center">ID Archivo</th> <th class="p-4 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="client-logos-table-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="view-identity" class="view">
                <h1 class="text-3xl font-display font-bold mb-6">Identidad</h1>
                
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="UI.switchTab('id-general')">Identidad y Redes</button>
                    <button class="tab-btn" onclick="UI.switchTab('id-whoami')">Quién Soy</button>
                    <button class="tab-btn" onclick="UI.switchTab('id-legal')">Información Legal</button>
                </div>
                
                <div id="tab-id-general" class="tab-content active space-y-8">
                     <div class="bg-white p-6 rounded border border-gray-200">
                         <h3 class="font-bold text-lg mb-4 border-b pb-2">Activos de Marca</h3>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                             <div class="text-center">
                                <p class="text-xs font-bold text-gray-500 mb-2">Logo Negro</p>
                                <div class="h-24 bg-gray-50 border flex items-center justify-center mb-2 relative group cursor-pointer" onclick="document.getElementById('upl-logo_black').click()">
                                    <img id="prev-logo_black" src="https://placehold.co/100x50?text=Vacio" class="max-h-20 max-w-full object-contain" referrerpolicy="no-referrer">
                                    <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center text-white"><i class="fas fa-upload"></i></div>
                                </div>
                                <input type="file" id="upl-logo_black" class="hidden" accept="image/*" onchange="App.uploadSystemImage(this, 'logo_black')">
                            </div>
                             <div class="text-center">
                                <p class="text-xs font-bold text-gray-500 mb-2">Logo Blanco</p>
                                <div class="h-24 bg-gray-900 border flex items-center justify-center mb-2 relative group cursor-pointer" onclick="document.getElementById('upl-logo_white').click()">
                                    <img id="prev-logo_white" src="https://placehold.co/100x50?text=Vacio" class="max-h-20 max-w-full object-contain" referrerpolicy="no-referrer">
                                    <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center text-white"><i class="fas fa-upload"></i></div>
                                </div>
                                <input type="file" id="upl-logo_white" class="hidden" accept="image/*" onchange="App.uploadSystemImage(this, 'logo_white')">
                            </div>
                             <div class="text-center">
                                <p class="text-xs font-bold text-gray-500 mb-2">Favicon</p>
                                <div class="h-24 bg-white border flex items-center justify-center mb-2 relative group cursor-pointer" onclick="document.getElementById('upl-favicon').click()">
                                    <img id="prev-favicon" src="https://placehold.co/32?text=ICO" class="w-8 h-8 object-contain" referrerpolicy="no-referrer">
                                    <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center text-white"><i class="fas fa-upload"></i></div>
                                </div>
                                <input type="file" id="upl-favicon" class="hidden" accept="image/*" onchange="App.uploadSystemImage(this, 'favicon')">
                            </div>
                         </div>
                     </div>
                     
                     <div id="identity-form-container" class="bg-white p-6 rounded border border-gray-200">
                         </div>
                </div>
            
                <div id="tab-id-whoami" class="tab-content">
                    <div class="bg-white p-6 rounded border border-gray-200 max-w-4xl">
                        <div class="flex flex-col md:flex-row gap-8 mb-6">
                            <div class="flex-shrink-0 text-center md:text-left">
                                <p class="text-xs font-bold text-gray-500 mb-2 uppercase">Foto de Perfil</p>
                                <div class="relative group w-48 h-48 mx-auto md:mx-0 cursor-pointer" onclick="document.getElementById('upl-profile_pic').click()">
                                    <img id="prev-profile_pic" src="https://placehold.co/200" class="w-full h-full object-cover border shadow-sm" referrerpolicy="no-referrer">
                                    <div class="absolute inset-0 bg-black/50 rounded-lg hidden group-hover:flex items-center justify-center text-white rounded"><i class="fas fa-camera text-2xl"></i></div>
                                </div>
                                <input type="file" id="upl-profile_pic" class="hidden" accept="image/*" onchange="App.uploadSystemImage(this, 'profile_pic')">
                            </div>
                            
                            <div class="flex-1 space-y-4" id="whoami-form-container">
                                </div>
                        </div>
                    </div>
                </div>

                <div id="tab-id-legal" class="tab-content">
                    <div class="bg-white p-6 rounded border border-gray-200 max-w-4xl">
                        <h3 class="font-bold text-lg mb-4 border-b pb-2">Datos de Facturación y Cotizaciones</h3>
                        <p class="text-xs text-gray-500 mb-6">Esta información aparecerá en los encabezados de los PDF.</p>
                        
                        <div id="legal-form-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="mb-4">
                                <label class="form-label">Nombre Comercial</label>
                                <input type="text" id="leg-legal_commercial_name" data-key="legal_commercial_name" class="form-input" placeholder="Ej: AG Visual">
                            </div>
                            <div class="mb-4">
                                <label class="form-label">Razón Social (Nombre Legal)</label>
                                <input type="text" id="leg-legal_name" data-key="legal_name" class="form-input" placeholder="Nombre en Hacienda">
                            </div>
                            <div class="mb-4">
                                <label class="form-label">Cédula Jurídica / Física</label>
                                <input type="text" id="leg-legal_id" data-key="legal_id" class="form-input" placeholder="0-0000-0000">
                            </div>
                            <div class="mb-4">
                                <label class="form-label">Teléfono Facturación</label>
                                <input type="text" id="leg-legal_phone" data-key="legal_phone" class="form-input">
                            </div>
                            <div class="mb-4 md:col-span-2">
                                <label class="form-label">Correo Electrónico (Facturas)</label>
                                <input type="text" id="leg-legal_email" data-key="legal_email" class="form-input">
                            </div>
                            <div class="mb-4 md:col-span-2">
                                <label class="form-label">Dirección Fiscal Completa</label>
                                <textarea id="leg-legal_address" data-key="legal_address" class="form-textarea" rows="2"></textarea>
                            </div>
                        </div>
                        
                        <div class="mt-6 flex justify-end">
                            <button class="btn btn-primary" onclick="App.handleSaveIdentityText('legal')">Guardar</button>
                        </div>
                    </div>
                </div>
            </div> 
        </main>
    </div>

    <div id="modal-container"></div>
    <div id="toast-container"></div>
    <div id="confirm-modal-overlay" class="modal-overlay">
        <div id="confirm-modal-content" class="modal-content p-6 bg-white rounded-lg max-w-md text-center">
            <h3 id="confirm-title" class="text-xl font-bold mb-2">Confirmar</h3>
            <p id="confirm-message" class="text-gray-600 mb-6">Mensaje...</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="btn btn-secondary flex-1 justify-center">Cancelar</button>
                <button id="confirm-ok-btn" class="btn btn-danger flex-1 justify-center">Eliminar</button>
            </div>
        </div>
    </div>


   <template id="reservation-modal-template">
        <div id="reservation-modal-content" class="w-full h-full flex flex-col relative bg-[#0a0a0a] text-white overflow-hidden p-0">
            
            <div class="flex justify-between items-center bg-[#111] border-b border-white/10 p-4 px-6 flex-shrink-0 z-20">
                <div>
                    <h2 class="modal-title font-display text-2xl text-accent-gold text-white">Gestión de Reserva</h2>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-[10px] text-gray-500 uppercase tracking-widest">REF:</span>
                        <span id="header-ref-display" class="font-mono text-xs font-bold text-accent-primary tracking-wider">---</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <button type="button" onclick="App.openQuoteEditor()" class="text-gray-400 hover:text-white transition p-2 rounded hover:bg-white/10 mr-2" title="Generar Documento / Factura">
                        <i class="fas fa-file-invoice-dollar fa-lg"></i>
                    </button>
                    
                    <div class="h-6 w-px bg-white/10"></div>

                    <button type="button" onclick="UI.closeModal()" class="text-gray-400 hover:text-red-500 transition p-2 rounded hover:bg-white/10 ml-2" title="Cerrar">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>
            </div>
    
            <form id="reservation-form" onsubmit="App.handleSaveBooking(event)" class="flex flex-col flex-grow overflow-hidden">
                <input type="hidden" name="id" id="input-reserva-id">
                
                <div class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-6">
                    
                    <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                            <div class="md:col-span-6">
                                <label class="text-[10px] uppercase font-bold text-gray-500 block mb-1">Cliente</label>
                                <input type="text" id="c-customerName" class="grid-input font-bold text-xl w-full bg-transparent border-b border-gray-600 focus-gold outline-none py-1" placeholder="Nombre del Cliente" required>
                            </div>
                            <div class="md:col-span-3">
                                <label class="text-[10px] uppercase font-bold text-gray-500 block mb-1">Cédula / ID</label>
                                <input type="text" id="c-customerCedula" class="grid-input bg-transparent border-b border-gray-600 w-full text-base py-1 font-mono text-gray-300" placeholder="---">
                            </div>
                            <div class="md:col-span-3">
                                <label class="text-[10px] uppercase font-bold text-gray-500 block mb-1">Estado</label>
                                <select id="c-status" class="dark-select w-full p-1.5 rounded border border-gray-700 text-sm font-bold bg-[#1f2937] text-white">
                                    <option value="Pendiente">Pendiente</option>
                                    <option value="Confirmado">Confirmado</option>
                                    <option value="Pagado">Pagado</option>
                                    <option value="Cancelado">Cancelado</option>
                                </select>
                            </div>
                            <div class="md:col-span-4">
                                <label class="text-[10px] uppercase font-bold text-gray-500 block mb-1">Teléfono</label>
                                <input type="text" id="c-customerPhone" class="grid-input bg-transparent border-b border-gray-600 w-full text-sm py-1 focus-gold" placeholder="---">
                            </div>
                            <div class="md:col-span-4">
                                <label class="text-[10px] uppercase font-bold text-gray-500 block mb-1">Email</label>
                                <input type="email" id="c-customerEmail" class="grid-input bg-transparent border-b border-gray-600 w-full text-sm py-1 focus-gold" placeholder="---">
                            </div>
                            <div class="md:col-span-4">
                                <label class="text-[10px] uppercase font-bold text-gray-500 block mb-1">Dirección</label>
                                <input type="text" id="c-customerAddress" class="grid-input bg-transparent border-b border-gray-600 w-full text-sm py-1 focus-gold" placeholder="Dirección (Opcional)...">
                            </div>
                        </div>
                    </div>
    
                    <div class="border border-white/10 rounded-lg bg-[#0f0f0f] overflow-hidden">
                        <div class="grid grid-cols-12 gap-2 bg-[#1a1a1a] p-3 booking-grid-header border-b border-white/10 pr-4">
                            <div class="col-span-4">Artículo / Nota</div>
                            <div class="col-span-3">Vigencia</div>
                            <div class="col-span-3">Descuento</div>
                            <div class="col-span-1 text-right">Total</div>
                            <div class="col-span-1 text-center">Borrar</div>
                        </div>
                        <div id="lines-container" class="p-2 space-y-1"></div>
                        <div class="p-3 border-t border-white/10 bg-[#141414] text-center">
                            <button type="button" id="btn-add-line" class="text-gray-500 hover:text-white text-xs font-bold border border-gray-700 hover:border-white rounded px-6 py-2 transition-all hover:bg-white/5">
                                <i class="fas fa-plus mr-1"></i> AGREGAR ARTÍCULO
                            </button>
                        </div>
                    </div>
    
                    <div class="bg-[#121212] border border-white/10 rounded-lg flex flex-col md:flex-row overflow-hidden mb-4">
                        <div class="w-full md:w-1/2 border-r border-white/10 p-5">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-[10px] uppercase font-bold text-gray-500">Notas Generales</label>
                                <i class="fas fa-pen text-[10px] text-gray-600"></i>
                            </div>
                            <textarea id="c-globalNotes" class="w-full h-32 bg-transparent text-gray-300 text-sm resize-none outline-none subtle-scrollbar placeholder-gray-700 leading-relaxed" placeholder="Detalles..."></textarea>
                        </div>
                        <div class="w-full md:w-1/2 p-5 bg-[#161616] space-y-3">
                            <div class="flex justify-between items-center mb-3">
                                <label class="text-xs uppercase font-bold text-gray-500">Desc. Global</label>
                                <div class="flex rounded bg-[#1a1a1a] border border-white/10 w-36 h-8">
                                    <select id="c-globalDiscType" class="dark-select text-xs px-2 border-r border-white/10 outline-none h-full bg-transparent text-white">
                                        <option value="percent">%</option>
                                        <option value="money">$</option>
                                    </select>
                                    <input type="number" id="c-globalDiscVal" step="0.01" class="bg-transparent text-white text-right text-sm px-2 w-full outline-none h-full font-mono" value="0">
                                </div>
                            </div>
                            <div class="border-t border-white/10"></div>
                            <div class="flex justify-between text-sm text-gray-400 mt-2"><span>Subtotal:</span><span id="lbl-global-subtotal" class="font-mono text-white">$0.00</span></div>
                            <div class="flex justify-between text-sm text-green-500"><span>Descuento:</span><span id="lbl-global-discount" class="font-mono">-$0.00</span></div>
                            <div class="flex justify-between text-sm text-gray-400"><span>IVA (13%):</span><span id="lbl-global-tax" class="font-mono text-white">$0.00</span></div>
                            <div class="flex justify-between items-end pt-4 border-t border-white/10 mt-3">
                                <div class="text-xs text-gray-600 text-left leading-tight">Rango: <span id="disp-date-range" class="text-gray-500">--</span></div>
                                <div class="text-right">
                                    <span class="block text-xs text-gray-500 uppercase font-bold mb-1">Total Final</span>
                                    <span id="lbl-global-total" class="font-total text-5xl text-white leading-none tracking-tight">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
    
                <div class="flex justify-end items-center p-4 bg-[#111] border-t border-white/10 gap-3 flex-shrink-0 z-20">
                    <button type="button" id="btn-delete-booking" class="text-red-500 hover:text-red-400 text-xs font-bold uppercase tracking-wider mr-auto hidden px-2 transition-colors">
                        <i class="fas fa-trash-alt mr-1"></i> Eliminar
                    </button>
                    <button type="button" class="px-6 py-2 rounded text-sm font-bold text-gray-400 hover:text-white transition-colors" onclick="UI.closeModal()">Cancelar</button>
                    <button type="submit" class="bg-white text-black font-bold py-2 px-8 rounded shadow hover:bg-gray-200 transition-all text-sm uppercase tracking-wide">Guardar</button>
                </div>
            </form>
        </div>
    </template>
    
<script>
const GOOGLE_REDIRECT_URI = 'postmessage';
// Estado Global + Memoria para Edición en Batch
const AppState = { data: {}, token: JSON.parse(localStorage.getItem('gAuthToken') || 'null'), view: 'dashboard' };

let currentModalImages = []; 
let currentServiceBlocks = []; // Memoria para bloques de servicio
let activeQuillEditor = null;  // Instancia del editor de texto
let pendingDeletions = [];

// --- API (Con soporte Batch) ---
const API = {
    async call(endpoint, options = {}) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 60000);
        const headers = new Headers(options.headers || {});
        if (AppState.token?.access_token) headers.set('Authorization', `Bearer ${AppState.token.access_token}`);
        if (options.body && !(options.body instanceof FormData)) {
            headers.set('Content-Type', 'application/json');
            options.body = JSON.stringify(options.body);
        }
        try {
            const sep = endpoint.includes('?') ? '&' : '?';
            const res = await fetch(`${endpoint}${sep}t=${Date.now()}`, { ...options, headers, signal: controller.signal });
            clearTimeout(timeoutId);
            if (res.status === 401) {
                if (await Auth.refresh()) return API.call(endpoint, options);
                else { Auth.logout(); throw new Error('Sesión expirada'); }
            }
            const text = await res.text();
            let data;
            try { data = JSON.parse(text); } catch (e) { throw new Error(`Error Servidor: ${text.substring(0,50)}`); }
            if (!res.ok) throw new Error(data.error || data.message || 'Error desconocido');
            return data;
        } catch (e) { clearTimeout(timeoutId); throw e; }
    },
    
    // Función inteligente para guardar en lotes (Chuncking) y evitar Timeout
    // Se añade el parámetro customLoadingMessage = null
    async batchUpdate(operations, customLoadingMessage = null) {
        if(operations.length === 0) return;

        const BATCH_SIZE = 10; 
        
        // Si no hay mensaje personalizado, usa el genérico. Si hay, usa ese.
        if (!customLoadingMessage) {
            UI.showLoading(`Procesando ${operations.length} cambios...`);
        } else {
            UI.showLoading(customLoadingMessage);
        }

        for (let i = 0; i < operations.length; i += BATCH_SIZE) {
            const batch = operations.slice(i, i + BATCH_SIZE);
            
            // SOLO actualiza el contador si NO hay mensaje personalizado fijo
            if (!customLoadingMessage) {
                const currentCount = Math.min(i + BATCH_SIZE, operations.length);
                UI.showLoading(`Procesando ${currentCount}/${operations.length} cambios...`);
            }

            try {
                await API.call('/.netlify/functions/update-sheet-data', {
                    method: 'POST',
                    body: batch // Enviamos el lote
                });
                
                // Pequeña pausa de seguridad entre lotes (2 segundos)
                if (i + BATCH_SIZE < operations.length) {
                    await new Promise(resolve => setTimeout(resolve, 10000));
                }
            } catch (e) {
                const batchNum = Math.floor(i / BATCH_SIZE) + 1; // Definir la variable
                console.error(`Error en lote ${batchNum}:`, e);
                throw new Error(`Fallo al guardar el lote ${batchNum}. Intenta de nuevo.`);
            }
        }
    }
};

// --- AUTH ---
const Auth = {
    async init() { if (AppState.token) { if (Date.now() >= AppState.token.expires_at) await this.refresh(); UI.showApp(); } else UI.showLogin(); },
    async login() { 
        if (typeof google === 'undefined') { alert("Error: Google JS no cargó."); return; }
        try { const c = await fetch('/.netlify/functions/get-auth-config').then(r=>r.json()); google.accounts.oauth2.initCodeClient({ client_id: c.clientId, scope: 'https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/drive', callback: (r) => r.code && this.exchangeCode(r.code) }).requestCode(); } catch(e){alert(e.message);} 
    },
    async exchangeCode(code) { UI.showLoading('Autenticando...'); try { const t = await fetch('/.netlify/functions/auth-google', { method: 'POST', body: JSON.stringify({ code, redirectUri: GOOGLE_REDIRECT_URI }) }).then(r=>r.json()); if(t.error) throw new Error(t.error); this.setToken(t); UI.showApp(); } catch(e){alert(e.message); UI.showLogin();} },
    async refresh() { if(!AppState.token?.refresh_token) return false; try{ const t = await fetch('/.netlify/functions/auth-refresh', { method: 'POST', body: JSON.stringify({ refresh_token: AppState.token.refresh_token }) }).then(r=>r.json()); if(t.error) throw new Error; this.setToken({...AppState.token, ...t}); return true; }catch{return false;} },
    setToken(t) { if(t.expires_in) t.expires_at = Date.now()+(t.expires_in*1000); AppState.token=t; localStorage.setItem('gAuthToken', JSON.stringify(t)); },
    logout() { localStorage.removeItem('gAuthToken'); location.reload(); }
};

// --- UI ---
const UI = {
    showLogin: () => { document.getElementById('loading-screen').style.display='none'; document.getElementById('app-screen').style.display='none'; document.getElementById('login-screen').style.display='flex'; },
    showApp: async () => {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('loading-screen').style.display = 'flex';
        try {
            await App.loadData('dashboard');
            document.getElementById('app-screen').style.display = 'flex';
            document.getElementById('loading-screen').style.display = 'none';
            App.switchView('dashboard'); 
        } catch (e) {
            document.getElementById('loading-screen').style.display = 'none';
            alert("Error inicio: " + e.message);
            document.getElementById('login-screen').style.display = 'flex';
        }
    },
    forceReload: () => location.reload(),
    showLoading: (msg) => { 
        const txt = document.getElementById('loading-text'); if(txt) txt.innerText=msg;
        const scr = document.getElementById('loading-screen'); if(scr) scr.style.display='flex';
        const btn = document.getElementById('reload-btn'); if(btn) btn.classList.add('hidden');
    },
    hideLoading: () => { const scr = document.getElementById('loading-screen'); if(scr) scr.style.display='none'; },
    showToast: (msg, type='success') => { const t=document.createElement('div'); t.className=`toast ${type}`; t.innerText=msg; document.getElementById('toast-container').appendChild(t); setTimeout(()=>t.classList.add('visible'),10); setTimeout(()=>t.remove(),3000); },
    showConfirm: (title, msg, cb) => { 
        const o = document.getElementById('confirm-modal-overlay');
        // Actualizamos Título y Mensaje
        document.getElementById('confirm-title').textContent = title;
        document.getElementById('confirm-message').textContent = msg;
        
        const ok = document.getElementById('confirm-ok-btn');
        const ca = document.getElementById('confirm-cancel-btn');
        
        // Clonamos botones para limpiar eventos anteriores
        const nok = ok.cloneNode(true); 
        const nca = ca.cloneNode(true);
        
        ok.parentNode.replaceChild(nok, ok); 
        ca.parentNode.replaceChild(nca, ca);
        
        nok.addEventListener('click', () => { o.classList.remove('visible'); cb(); });
        nca.addEventListener('click', () => { o.classList.remove('visible'); });
        
        o.classList.add('visible'); 
    },
    switchTab(id) { const v=document.querySelector('.view.active'); if(!v)return; v.querySelectorAll('.tab-btn,.tab-content').forEach(e=>e.classList.remove('active')); v.querySelectorAll(`.tab-btn[onclick*="${id}"]`).forEach(b=>b.classList.add('active')); document.getElementById(`tab-${id}`).classList.add('active'); },
    
    inputHTML: (p,k,l,v='',t='text') => `<div class="mb-4"><label class="form-label">${l}</label><input type="${t}" id="${p}-${k}" data-key="${k}" class="form-input" value="${v||''}"></div>`,
    textareaHTML: (p,k,l,v='') => `<div class="mb-4"><label class="form-label">${l}</label><textarea id="${p}-${k}" data-key="${k}" class="form-textarea" rows="4">${v||''}</textarea></div>`,
    selectHTML: (p,k,l,opts,v='') => `<div class="mb-4"><label class="form-label">${l}</label><select id="${p}-${k}" data-key="${k}" class="form-select">${opts.map(o=>`<option value="${o.id}" ${o.id==v?'selected':''}>${o.name}</option>`).join('')}</select></div>`,
    showModal: (t,b,f) => { document.getElementById('modal-container').innerHTML=`<div class="modal-overlay visible"><div class="modal-content"><div class="p-6 border-b flex justify-between items-center bg-gray-50 flex-shrink-0"><h2 class="text-xl font-display font-bold">${t}</h2><button onclick="UI.closeModal()" class="text-2xl">&times;</button></div><div class="p-6 flex-1 overflow-y-auto">${b}</div><div class="p-6 bg-gray-50 border-t flex-shrink-0">${f}</div></div></div>`; },
    closeModal: () => document.getElementById('modal-container').innerHTML='',
    
    renderView: (view) => {
        AppState.view = view;
        document.querySelectorAll('.view, .sidebar-link').forEach(e => e.classList.remove('active'));
        document.getElementById(`view-${view}`).classList.add('active');
        document.querySelector(`[data-view="${view}"]`)?.classList.add('active');
        const data = AppState.data;

        const getVal = (item, key) => {
            const foundKey = Object.keys(item).find(k => k.toLowerCase().trim() === key.toLowerCase().trim());
            return foundKey ? item[foundKey] : undefined;
        };

        const countPortfolio = (data.ProjectImages||[]).filter(i => {
            const val = String(getVal(i, 'showInPortfolio')).toLowerCase().trim();
            return val === 'si' || val === 'yes' || val === 'true' || val === '1';
        }).length;




        

        
        if (view === 'dashboard') {
            const bookings = data.Bookings || [];
            const items = data.RentalItems || [];
            
            // 1. LOGICA DE FILTRADO TEMPORAL
            const filterEl = document.getElementById('dash-time-filter');
            const filterVal = filterEl ? filterEl.value : 'current_month';
            
            let filteredBookings = [];
            let chartLabels = [];
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const todayStr = today.toISOString().split('T')[0];
            const currentMonthPrefix = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            const endOfMonthDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            const endOfMonthStr = endOfMonthDate.toISOString().split('T')[0];

            const parseDate = (str) => {
                const parts = str.split('-');
                return new Date(parts[0], parts[1]-1, parts[2]);
            };

            if (filterVal === 'future') {
                filteredBookings = bookings.filter(b => b.startDate >= todayStr && b.status !== 'Cancelado');
                document.getElementById('chart-label-period').innerText = "Proyección Futura";
                for(let i=0; i<6; i++) {
                    const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
                    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                    chartLabels.push({ label: d.toLocaleString('es-ES', { month: 'short' }), key: key, mode: 'month' });
                }
            } else if (filterVal === 'current_month') {
                filteredBookings = bookings.filter(b => b.startDate && b.startDate.startsWith(currentMonthPrefix));
                document.getElementById('chart-label-period').innerText = "Mes Actual";
                const daysInMonth = endOfMonthDate.getDate();
                for(let i=1; i<=daysInMonth; i++) {
                    const dayStr = String(i).padStart(2,'0');
                    chartLabels.push({ label: i, key: `${currentMonthPrefix}-${dayStr}`, mode: 'day' });
                }
            } else if (filterVal === 'custom') {
                const sVal = document.getElementById('dash-date-start')?.value;
                const eVal = document.getElementById('dash-date-end')?.value;
                if (sVal && eVal) {
                    filteredBookings = bookings.filter(b => b.startDate >= sVal && b.startDate <= eVal);
                    document.getElementById('chart-label-period').innerText = `${sVal} a ${eVal}`;
                    const dStart = parseDate(sVal); const dEnd = parseDate(eVal);
                    const diffDays = Math.ceil((dEnd - dStart) / (1000 * 60 * 60 * 24));
                    let dCursor = new Date(dStart);
                    if (diffDays <= 45) { 
                        while (dCursor <= dEnd) {
                            chartLabels.push({ label: dCursor.getDate(), key: dCursor.toISOString().split('T')[0], mode: 'day' });
                            dCursor.setDate(dCursor.getDate() + 1);
                        }
                    } else {
                        dCursor.setDate(1); 
                        while (dCursor <= dEnd || (dCursor.getMonth() === dEnd.getMonth() && dCursor.getFullYear() === dEnd.getFullYear())) {
                             const key = `${dCursor.getFullYear()}-${String(dCursor.getMonth()+1).padStart(2,'0')}`;
                             chartLabels.push({ label: dCursor.toLocaleString('es-ES', { month: 'short' }), key: key, mode: 'month' });
                             dCursor.setMonth(dCursor.getMonth() + 1);
                        }
                    }
                } else {
                    document.getElementById('chart-label-period').innerText = "Seleccione fechas";
                }
            } else {
                const monthsBack = filterVal === 'all' ? 24 : parseInt(filterVal);
                document.getElementById('chart-label-period').innerText = `Últimos ${monthsBack} Meses`;
                for (let i = monthsBack - 1; i >= 0; i--) {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                    chartLabels.push({ label: d.toLocaleString('es-ES', { month: 'short' }), key: key, mode: 'month' });
                }
                const startKey = chartLabels[0]?.key || '1999-01';
                filteredBookings = bookings.filter(b => b.startDate >= startKey + '-01' && b.startDate <= endOfMonthStr);
            }

            // 2. KPIs
            const sumMoney = (list) => list.reduce((s, b) => s + (parseFloat(b.totalPrice) || 0), 0);
            const kpiConfirmed = sumMoney(filteredBookings.filter(b => b.status === 'Confirmado'));
            const kpiPaid = sumMoney(filteredBookings.filter(b => b.status === 'Pagado'));
            const kpiPending = sumMoney(filteredBookings.filter(b => b.status === 'Pendiente'));
            const kpiLost = sumMoney(filteredBookings.filter(b => b.status === 'Cancelado'));
            const fmt = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 });

            document.getElementById('kpi-rev-total').innerText = fmt.format(kpiConfirmed + kpiPaid);
            document.getElementById('kpi-rev-paid').innerText = fmt.format(kpiPaid);
            document.getElementById('kpi-rev-confirmed').innerText = fmt.format(kpiConfirmed);
            document.getElementById('kpi-rev-pending').innerText = fmt.format(kpiPending);
            document.getElementById('kpi-rev-lost').innerText = fmt.format(kpiLost);
            document.getElementById('kpi-count-total').innerText = filteredBookings.length;

            // 3. OPERATIVA
            const agenda = bookings
                .filter(b => b.startDate >= todayStr && (b.status === 'Confirmado' || b.status === 'Pagado'))
                .sort((a,b) => new Date(a.startDate) - new Date(b.startDate)); 
            
            const agendaContainer = document.getElementById('dashboard-agenda-list');
            if (agenda.length === 0) {
                agendaContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-400 text-xs"><i class="fas fa-mug-hot text-2xl mb-2 opacity-50"></i>Agenda libre.</div>';
            } else {
                agendaContainer.innerHTML = agenda.map(b => {
                    const d = new Date(b.startDate + 'T12:00:00');
                    const dateTxt = d.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                    const isToday = b.startDate === todayStr;
                    return `
                    <div class="flex items-center justify-between p-2 border-b border-gray-100 hover:bg-blue-50/50 transition cursor-pointer group last:border-0" onclick="App.handleEditCrudItem('Bookings', '${b.id}')">
                        <div class="flex items-center gap-3">
                            <div class="text-center w-8 ${isToday ? 'text-blue-600' : 'text-gray-500'}">
                                <span class="block text-[8px] uppercase font-bold tracking-wider">${isToday ? 'HOY' : dateTxt}</span>
                                <span class="block text-lg font-bold leading-none">${d.getDate()}</span>
                            </div>
                            <div>
                                <h4 class="font-bold text-xs text-gray-800 group-hover:text-blue-700 transition">${b.customerName}</h4>
                                <p class="text-[10px] text-gray-500 truncate max-w-[120px]">${b.itemName || 'Equipo'}</p>
                            </div>
                        </div>
                        <span class="text-[9px] font-bold px-2 py-0.5 ${b.status==='Pagado'?'bg-blue-100 text-blue-700':'bg-green-100 text-green-700'}">${b.status}</span>
                    </div>`;
                }).join('');
            }

            const pending = bookings.filter(b => b.status === 'Pendiente').sort((a,b) => new Date(b.bookingTimestamp||0) - new Date(a.bookingTimestamp||0));
            document.getElementById('kpi-pending-badge').innerText = pending.length;
            const pendingContainer = document.getElementById('dashboard-pending-list');
            if (pending.length === 0) {
                pendingContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-400 text-xs"><i class="fas fa-check-circle text-green-500 text-2xl mb-2 opacity-50"></i>Todo al día.</div>';
            } else {
                pendingContainer.innerHTML = pending.map(b => `
                    <div class="p-2 border border-yellow-100 bg-yellow-50 hover:bg-yellow-100 transition cursor-pointer flex justify-between items-center group shadow-sm mb-1" onclick="App.handleEditCrudItem('Bookings', '${b.id}')">
                        <div>
                            <h4 class="font-bold text-xs text-gray-900 group-hover:text-yellow-800">${b.customerName}</h4>
                            <p class="text-[10px] text-gray-600">${b.itemName}</p>
                        </div>
                        <i class="fas fa-chevron-right text-[10px] text-yellow-400"></i>
                    </div>
                `).join('');
            }

            // 4. RESUMEN
            document.getElementById('stat-projects').innerText = (data.Projects||[]).length;
            document.getElementById('stat-projects-img').innerText = (data.ProjectImages||[]).length + ' Fotos';
            document.getElementById('stat-portfolio').innerText = countPortfolio;
            document.getElementById('stat-services').innerText = (data.Services||[]).length;
            document.getElementById('stat-services-img').innerText = (data.ServiceImages||[]).length + ' Fotos';
            document.getElementById('stat-videos').innerText = (data.Videos||[]).length;
            document.getElementById('stat-items').innerText = items.length;
            document.getElementById('stat-items-img').innerText = (data.RentalItemImages||[]).length + ' Fotos';
            document.getElementById('stat-cats').innerText = (data.RentalCategories||[]).length;
            document.getElementById('stat-bookings').innerText = bookings.length;
            document.getElementById('stat-blocked').innerText = (data.BlockedDates||[]).length;
            document.getElementById('stat-logos').innerText = (data.LogosClientes||[]).length;
            const idImagesCount = (data.ImagenesIdentidad||[]).length;
            document.getElementById('stat-identity-img').innerText = idImagesCount + ' Fotos';

            // 5. GRÁFICOS (Solo Ingresos y Estado)
            if (UI.charts) { UI.charts.forEach(c => c.destroy()); }
            UI.charts = [];
            Chart.defaults.font.family = "'Montserrat', sans-serif";

            // A. Ingresos
            const chartDataValues = chartLabels.map(lbl => {
                return filteredBookings
                    .filter(b => {
                        if (lbl.mode === 'day') return b.startDate === lbl.key;
                        return b.startDate && b.startDate.startsWith(lbl.key);
                    })
                    .filter(b => b.status === 'Pagado' || b.status === 'Confirmado')
                    .reduce((s, b) => s + (parseFloat(b.totalPrice) || 0), 0);
            });

            const ctxRev = document.getElementById('revenueChart').getContext('2d');
            const gradRev = ctxRev.createLinearGradient(0, 0, 0, 400);
            gradRev.addColorStop(0, 'rgba(16, 185, 129, 0.2)'); gradRev.addColorStop(1, 'rgba(16, 185, 129, 0.0)');

            // CÁLCULO DINÁMICO DEL MÁXIMO
            const maxVal = Math.max(...chartDataValues, 0);
            
            UI.charts.push(new Chart(ctxRev, {
                type: 'line',
                data: {
                    labels: chartLabels.map(l => l.label),
                    datasets: [{
                        label: 'Ingresos',
                        data: chartDataValues,
                        borderColor: '#10b981',
                        backgroundColor: gradRev,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5
                    }]
                },
                plugins: [ChartDataLabels],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 30,   // Altura extra para el pico más alto
                            right: 35, // AUMENTADO: Aire a la derecha para la última etiqueta
                            left: 35,  // AUMENTADO: Aire a la izquierda para la primera etiqueta
                            bottom: 0
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            align: 'top',
                            anchor: 'end',
                            color: '#059669',
                            font: { weight: 'bold' },
                            // Formato inteligente
                            formatter: (v) => {
                                if (v === 0) return '';
                                if (v >= 1000000) return '$' + (v / 1000000).toFixed(1) + 'M';
                                if (v >= 1000) return '$' + (v / 1000).toFixed(1) + 'k';
                                return '$' + v;
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            display: false,
                            // Mantenemos el techo alto (20% extra)
                            suggestedMax: maxVal * 1.2
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            }));

            // B. Estado
            const stCounts = { 'Pendiente': 0, 'Confirmado': 0, 'Pagado': 0, 'Cancelado': 0 };
            filteredBookings.forEach(b => { if(stCounts[b.status]!==undefined) stCounts[b.status]++; });
            const ctxStatus = document.getElementById('statusChart').getContext('2d');
            UI.charts.push(new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: ['Pendiente', 'Confirmado', 'Pagado', 'Cancelado'],
                    datasets: [{ data: [stCounts['Pendiente'], stCounts['Confirmado'], stCounts['Pagado'], stCounts['Cancelado']], backgroundColor: ['#fcd34d', '#10b981', '#3b82f6', '#ef4444'], borderWidth: 0 }]
                },
                plugins: [ChartDataLabels],
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '70%',
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 8, padding: 5, font: {size: 9} } }, datalabels: { color: '#fff', font: { weight: 'bold' }, formatter: (v) => v > 0 ? v : '' } }
                }
            }));
        }




            
        
        else if (view === 'client-logos') {
            const list = (data.LogosClientes || []).sort((a,b) => (parseInt(a.order)||99) - (parseInt(b.order)||99));
            
            // Ajustar encabezados dinámicamente para quitar ID si existe en HTML estático
            const tableHead = document.querySelector('#view-client-logos thead tr');
            if(tableHead) tableHead.innerHTML = '<th class="p-4 text-center w-16">Orden</th><th class="p-4 text-center w-24">Logo</th><th class="p-4">Cliente</th><th class="p-4 text-center">Acciones</th>';
        
            document.getElementById('client-logos-table-body').innerHTML = list.map(l => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4 text-center font-mono text-xs text-gray-500">${l.order||99}</td>
                    <td class="p-4 text-center"><img src="${l.logoUrl}" class="h-10 w-auto object-contain mx-auto bg-gray-100 rounded p-1" referrerpolicy="no-referrer"></td>
                    <td class="p-4 font-bold text-sm text-gray-800">${l.clientName}</td>
                    <td class="p-4 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <button class="text-blue-600 hover:text-blue-800 p-1" onclick="App.handleEditCrudItem('LogosClientes', '${l.id}')"><i class="fas fa-edit"></i></button>
                            <button class="text-red-600 hover:text-red-800 p-1" onclick="App.handleDelete('LogosClientes', '${l.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        
        } else if (view === 'identity') {
            const ident = (data.Identidad || []).reduce((acc, i) => ({...acc, [i.key]: i.value}), {});
            const about = (data.About || []).reduce((acc, i) => ({...acc, [i.key]: i.value}), {});
            const sysImages = (data.ImagenesIdentidad || []).reduce((acc, i) => ({...acc, [i.key]: i.imageUrl}), {});
        
            if(sysImages.logo_black) document.getElementById('prev-logo_black').src = sysImages.logo_black;
            if(sysImages.logo_white) document.getElementById('prev-logo_white').src = sysImages.logo_white;
            if(sysImages.favicon) document.getElementById('prev-favicon').src = sysImages.favicon;
            if(sysImages.profile_pic) document.getElementById('prev-profile_pic').src = sysImages.profile_pic;
        
            // 1. Ajuste Contenedores Cuadrados (Quitamos 'rounded')
            document.querySelectorAll('#tab-id-general .h-24, #tab-id-whoami .w-48').forEach(el => {
                el.classList.remove('rounded', 'rounded-lg');
            });
            document.querySelectorAll('#tab-id-whoami img').forEach(el => el.classList.remove('rounded-lg'));

            // 2. Formulario Identidad (Con Mapa agregado)
            document.getElementById('identity-form-container').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${UI.inputHTML('id', 'contact_email', 'Email Contacto', ident.contact_email, 'email')}
                    ${UI.inputHTML('id', 'contact_phone', 'Teléfono', ident.contact_phone)}
                </div>
                <hr class="my-6 border-gray-100">
                <h4 class="font-bold text-xs text-gray-400 uppercase tracking-wider mb-4">Redes Sociales y Ubicación</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${UI.inputHTML('id', 'social_instagram', 'Instagram', ident.social_instagram)}
                    ${UI.inputHTML('id', 'social_facebook', 'Facebook', ident.social_facebook)}
                    ${UI.inputHTML('id', 'social_youtube', 'YouTube', ident.social_youtube)}
                    ${UI.inputHTML('id', 'social_whatsapp', 'WhatsApp', ident.social_whatsapp)}
                    ${UI.inputHTML('id', 'social_maps', 'Link Google Maps', ident.social_maps)} </div>
                <div class="mt-6 flex justify-end">
                    <button class="btn btn-primary" onclick="App.handleSaveIdentityText('general')">Guardar</button>
                </div>
            `;
        
            // 3. Formulario Quién Soy (Campos Reducidos, Botón simple)
            document.getElementById('whoami-form-container').innerHTML = `
                <div class="mb-4">
                    <label class="form-label">Frase Introductoria</label>
                    <input type="text" id="ab-intro_phrase" data-key="intro_phrase" class="form-input" value="${about.intro_phrase||''}" placeholder="Ej: Transformando ideas en realidad...">
                </div>
                ${UI.textareaHTML('ab', 'bio', 'Mi Filosofía', about.bio)}
                ${UI.textareaHTML('ab', 'process', 'Mi Proceso', about.process)}
                <div class="mt-4">
                    <button class="btn btn-primary w-full md:w-auto" onclick="App.handleSaveIdentityText('whoami')">Guardar</button>
                </div>
            `;

            // NUEVO: Llenar Formulario Legal (usando la variable 'ident' que ya tienes arriba)
            const legalContainer = document.getElementById('legal-form-container');
            if (legalContainer) {
                const fields = ['legal_commercial_name', 'legal_name', 'legal_id', 'legal_phone', 'legal_email', 'legal_address'];
                fields.forEach(f => {
                    const input = document.getElementById(`leg-${f}`);
                    if(input) input.value = ident[f] || '';
                });
            }
            
        } else if (view === 'projects') {

            document.getElementById('projects-table-body').innerHTML = (data.Projects||[]).sort((a,b)=>(a.order||99)-(b.order||99)).map(p => {
                
                // Lógica de Portada
                const cover = (data.ProjectImages||[]).find(i => {
                    const pid = getVal(i, 'projectId') || getVal(i, 'projectID');
                    const isCov = String(getVal(i, 'isCover')).toLowerCase().trim();
                    return pid === p.id && (isCov === 'si' || isCov === 'yes');
                });
                
                // Conteo de fotos
                const imageCount = (data.ProjectImages || []).filter(i => {
                     const pid = getVal(i, 'projectId') || getVal(i, 'projectID');
                     return pid === p.id;
                }).length;

                return `<tr class="border-b hover:bg-gray-50">
                    <td class="p-4 font-mono text-xs text-center">${p.order||99}</td> 
                    <td class="p-4"><img src="${cover?.imageUrl||'https://placehold.co/50'}" class="img-preview" referrerpolicy="no-referrer" ></td>
                    <td class="p-4 font-bold text-sm">${p.title}</td>
                    <td class="p-4 text-center text-xs uppercase font-bold ${p.status === 'hidden' ? 'text-gray-400' : 'text-green-600'}">${p.status === 'hidden' ? 'Oculto' : 'Visible'}</td>
                    <td class="p-4 text-center font-mono text-sm text-gray-500">${imageCount}</td>
                    <td class="p-4 align-middle">
                        <div class="flex items-center justify-center gap-3">
                            <button class="text-blue-600" onclick="App.handleEditCrudItem('Projects','${p.id}')"><i class="fas fa-edit"></i></button>
                            <button class="text-green-600" onclick="App.handleProjectImages('${p.id}','${p.title.replace(/'/g,"")}')"><i class="fas fa-images"></i></button>
                            <button class="text-red-600" onclick="App.handleDelete('Projects','${p.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
            const thead = document.querySelector('#view-projects thead tr');
            if(thead) {
                thead.innerHTML = '<th class="p-4 text-center">Orden</th><th class="p-4">Portada</th><th class="p-4">Título</th><th class="p-4 text-center">Estado</th><th class="p-4 text-center">Fotos</th><th class="p-4 text-center">Acciones</th>';
            }
            
        } else if (view === 'portfolio-manager') {
            // En portfolio, usamos currentModalImages SI es que se está editando, sino data directa
            // Pero Portfolio no es un modal, es una vista. Podemos usar batching aquí también?
            // Sí, pero requiere que 'Guardar Cambios' sea global para la vista.
            // Vamos a simplificar: en Portfolio, 'Guardar Orden' ya es un botón manual.
            // Usaremos una lógica similar a la del modal.
            
            // NOTA: Para portfolio, usaremos AppState.data directamente, pero modificaremos 'localmente' 
            // y luego 'Guardar' enviará todo.
            const images = (data.ProjectImages || [])
                .filter(i => {
                    const v = String(getVal(i, 'showInPortfolio')).toLowerCase().trim();
                    return v === 'si' || v === 'yes' || v === 'true' || v === '1';
                })
                .sort((a,b) => (parseInt(a.portfolioOrder)||99)-(parseInt(b.portfolioOrder)||99));
            
            // AJUSTE: Retorno a Collage (Masonry) y arreglo de Clic
            currentModalImages = images; 

            const container = document.getElementById('portfolio-manager-grid');
            // Usamos 'columns' para efecto collage y 'block' para evitar saltos raros
            container.className = "columns-2 md:columns-4 gap-4 p-4 space-y-4 block"; 

            container.innerHTML = images.length ? images.map(i => `
                <div class="relative group break-inside-avoid mb-4 border border-gray-200 bg-white shadow-sm transition-all hover:shadow-lg cursor-zoom-in"
                     draggable="true"
                     ondragstart="App.dragStartPortfolio(event, '${i.id}')"
                     ondragover="App.dragOverPortfolio(event)"
                     ondrop="App.dragDropPortfolio(event, '${i.id}')"
                     onclick="UI.openLightbox('${i.id}')"> <img src="${i.imageUrl}" class="w-full h-auto block" referrerpolicy="no-referrer" >
                    
                    <div class="portfolio-grid-overlay absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center gap-2">
                        <div class="text-white font-bold text-xs uppercase tracking-widest mb-1">Orden</div>
                        
                        <input type="number" class="w-16 p-2 text-center text-lg rounded-none border-none text-black font-bold shadow-lg square" 
                               value="${i.portfolioOrder||99}" 
                               onclick="event.stopPropagation()" 
                               onchange="App.reorderGlobalPortfolio('${i.id}', this.value)">
                        
                        <button class="mt-2 bg-red-500 text-white px-3 py-1 rounded-none text-xs font-bold hover:bg-red-600 transition" 
                                onclick="event.stopPropagation(); App.removeFromPortfolio('${i.id}')">
                            <i class="fas fa-times mr-1"></i> Quitar
                        </button>
                    </div>
                    <span class="portfolio-badge absolute top-2 right-2 bg-black/70 text-white px-2 py-1 rounded text-xs font-mono">#${i.portfolioOrder||99}</span>
                </div>
            `).join('') : '<p class="col-span-full text-center text-gray-500 py-10 w-full">No hay imágenes marcadas para el portafolio.</p>';
        
        } else if (view === 'videos') {
            document.getElementById('videos-table-body').innerHTML = (data.Videos || []).sort((a,b) => (a.order||99)-(b.order||99)).map(v => `
                <tr class="border-b hover:bg-gray-50"><td class="p-4 font-mono text-xs">${v.order||99}</td><td class="p-4 font-bold text-sm">${v.title}</td><td class="p-4 text-xs text-blue-500 truncate max-w-xs"><a href="${v.embedUrl}" target="_blank">${v.embedUrl}</a></td><td class="p-4 flex gap-3"><button class="text-blue-600" onclick="App.handleEditCrudItem('Videos', '${v.id}')"><i class="fas fa-edit"></i></button><button class="text-red-600" onclick="App.handleDelete('Videos', '${v.id}')"><i class="fas fa-trash"></i></button></td></tr>
            `).join('');
            
        } else if (view === 'services') {
             // AJUSTE: Tabla Rediseñada con Contadores
             document.getElementById('services-table-body').innerHTML = (data.Services || []).sort((a,b) => (a.order||99)-(b.order||99)).map(s => {
                
                // Cálculos en tiempo real
                const blockCount = (data.ServiceContentBlocks || []).filter(b => b.serviceId === s.id).length;
                const imageCount = (data.ServiceImages || []).filter(i => i.serviceId === s.id).length;

                return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4 font-mono text-xs w-16 text-center">${s.order||99}</td>
                    <td class="p-4 w-16 text-center text-xl text-gray-600"><i class="${s.iconClass || 'fas fa-circle-question'}"></i></td>
                    <td class="p-4 font-bold text-sm">${s.title}</td>
                    <td class="p-4 text-center text-xs uppercase font-bold ${s.status === 'hidden' ? 'text-gray-400' : 'text-green-600'}">${s.status === 'hidden' ? 'Oculto' : 'Visible'}</td>
                    <td class="p-4 text-center font-mono text-sm text-gray-500">
                        <span class="bg-gray-100 px-2 py-1 rounded">${blockCount} Bloques</span>
                    </td>
                    <td class="p-4 text-center font-mono text-sm text-gray-500">
                        <span class="bg-gray-100 px-2 py-1 rounded">${imageCount} Fotos</span>
                    </td>

                    <td class="p-4 flex gap-3 justify-center"> 
                        <button class="text-blue-600 hover:text-blue-800 p-2" onclick="App.handleEditCrudItem('Services', '${s.id}')"><i class="fas fa-edit"></i></button>
                        <button class="text-indigo-600 hover:text-indigo-800 p-2" onclick="App.handleServiceContent('${s.id}', '${s.title}')" title="Contenido"><i class="fas fa-align-left"></i></button>
                        <button class="text-green-600 hover:text-green-800 p-2" onclick="App.handleServiceImages('${s.id}', '${s.title}')" title="Galería"><i class="fas fa-images"></i></button>
                        <button class="text-red-600 hover:text-red-800 p-2" onclick="App.handleDelete('Services', '${s.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');
            
            // Actualizar Encabezados de Tabla
            const thead = document.querySelector('#view-services thead tr');
            if(thead) thead.innerHTML = '<th class="p-4 text-center">Orden</th><th class="p-4 text-center">Icono</th><th class="p-4">Título</th><th class="p-4 text-center">Estado</th><th class="p-4 text-center">Contenido</th><th class="p-4 text-center">Galería</th><th class="p-4 text-center">Acciones</th>';
            
        } else if (view === 'rentals') { 
             // 1. EQUIPOS (Con Portada Real)
            document.getElementById('rental-items-table-body').innerHTML = (data.RentalItems || [])
                .sort((a,b) => (parseInt(a.order)||99)-(parseInt(b.order)||99))
                .map(i => {
                    const images = data.RentalItemImages || [];
                    const coverObj = images.find(im => im.itemId === i.id && String(im.isCover).toLowerCase() === 'si');
                    const firstObj = images.find(im => im.itemId === i.id);
                    const displayUrl = coverObj ? coverObj.imageUrl : (firstObj ? firstObj.imageUrl : 'https://placehold.co/50?text=No+Img');
                    const catName = (data.RentalCategories || []).find(c => c.id === i.categoryId)?.name || 'Sin Categoría';
                    
                    // --- CÁLCULOS (SOLO AQUÍ, AFUERA DEL HTML) ---
                    const basePrice = parseFloat(i.pricePerDay) || 0;
                    const hasTax = String(i.hasTax).toUpperCase() === 'TRUE';
                    const finalPrice = hasTax ? (basePrice * 1.13) : basePrice;
                    const taxBadge = hasTax ? '<span class="ml-1 text-[10px] font-bold text-blue-600 bg-blue-100 px-1 rounded">+IVI</span>' : '';

                    return `<tr class="border-b hover:bg-gray-50">
                        <td class="p-4 font-mono text-xs text-center">${i.order||99}</td>
                        <td class="p-4 text-center"><img src="${displayUrl}" class="img-preview mx-auto" referrerpolicy="no-referrer" ></td>
                        <td class="p-4 font-bold text-sm">${i.name}</td>
                        <td class="p-4 text-center text-xs uppercase font-bold ${i.status==='blocked'?'text-red-500':(i.status==='hidden'?'text-gray-400':'text-green-600')}">${i.status === 'hidden' ? 'Oculto' : (i.status === 'blocked' ? 'Bloqueado' : 'Visible')}</td>
                        <td class="p-4 text-xs font-bold text-gray-500 uppercase">${catName}</td>
                        
                        <td class="p-4 font-mono text-sm font-bold text-center text-gray-700">
                            $${finalPrice.toFixed(2)} ${taxBadge}
                        </td>

                        <td class="p-4 flex gap-3 justify-center">
                            <button class="text-blue-600 hover:text-blue-800" onclick="App.handleEditCrudItem('RentalItems', '${i.id}')"><i class="fas fa-edit"></i></button>
                            <button class="text-green-600 hover:text-green-800" onclick="App.handleRentalImages('${i.id}', '${i.name.replace(/'/g, "\\'")}')"><i class="fas fa-images"></i></button>
                            <button class="text-red-600 hover:text-red-800" onclick="App.handleDelete('RentalItems', '${i.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                }).join('');
            // Actualizar Encabezado Equipos (Cambiamos Img por PORTADA y centramos acciones)
            const theadItems = document.querySelector('#tab-rental-items thead tr');
            if(theadItems) theadItems.innerHTML = '<th class="p-4 text-center">Orden</th><th class="p-4 text-center">Portada</th><th class="p-4">Nombre</th><th class="p-4 text-center">Estado</th><th class="p-4">Categoría</th><th class="p-4 text-center">Precio</th><th class="p-4 text-center">Acciones</th>';

            // 2. CATEGORÍAS (Encabezados Centrados)
            document.getElementById('rental-categories-table-body').innerHTML = (data.RentalCategories || [])
                .sort((a,b) => (parseInt(a.order)||99)-(parseInt(b.order)||99))
                .map(c => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4 text-xs font-bold text-gray-400 text-center">${c.order}</td>
                    <td class="p-4 font-bold text-sm">${c.name}</td>
                    <td class="p-4 flex gap-3 justify-center">
                        <button class="text-blue-600 hover:text-blue-800" onclick="App.handleEditCrudItem('RentalCategories', '${c.id}')"><i class="fas fa-edit"></i></button>
                        <button class="text-red-600 hover:text-red-800" onclick="App.handleDelete('RentalCategories', '${c.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            
            // Actualizar Encabezado Categorías (Centrado)
            const theadCats = document.querySelector('#tab-rental-cats thead tr');
            if(theadCats) theadCats.innerHTML = '<th class="p-4 text-center">Orden</th><th class="p-4">Nombre</th><th class="p-4 text-center">Acciones</th>';

            // 3. BLOQUEOS (Filtro + Orden Cronológico + Edición)
            const currentFilter = AppState.blockedDatesFilter || 'all';
            
            // a. Filtrar y Ordenar cronológicamente (fecha más próxima arriba)
            let blockedList = (data.BlockedDates || [])
                .sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
            
            if (currentFilter !== 'all') {
                blockedList = blockedList.filter(bl => bl.itemId === currentFilter);
            }

            // b. Renderizar Tabla de Bloqueos (Con botón de Editar)
            document.getElementById('blocked-dates-table-body').innerHTML = blockedList.map(bl => {
                 const item = (data.RentalItems || []).find(i => i.id === bl.itemId);
                 return `<tr class="border-b hover:bg-gray-50">
                    <td class="p-4 font-bold text-sm">${item?.name || 'Desconocido'}</td>
                    <td class="p-4 text-sm">${bl.reason}</td>
                    <td class="p-4 text-xs font-mono">${bl.startDate}</td>
                    <td class="p-4 text-xs font-mono">${bl.endDate}</td>
                    <td class="p-4 flex gap-3 justify-center">
                        <button class="text-blue-600 hover:text-blue-800" onclick="App.handleEditCrudItem('BlockedDates', '${bl.blockId}')"><i class="fas fa-edit"></i></button>
                        <button class="text-red-600 hover:text-red-800" onclick="App.handleDelete('BlockedDates', '${bl.blockId}', 'blockId')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');

            // c. Inyectar el Filtro en el HTML (si no existe)
            const blockTabContainer = document.getElementById('tab-blocked-dates');
            let filterContainer = document.getElementById('blocked-filter-container');
            
            if (!filterContainer) {
                // Buscamos el contenedor del botón "Nuevo Bloqueo" para poner el filtro al lado
                const headerDiv = blockTabContainer.querySelector('.flex.justify-end');
                
                // Modificamos el header existente para que acepte elementos a la izquierda (el filtro)
                headerDiv.className = "flex justify-between items-center mb-4";
                headerDiv.id = "blocked-filter-container"; // Marcamos para no duplicar
                
                // Creamos el select
                const selectHTML = `<select class="form-select text-sm w-64 border-gray-300 rounded shadow-sm" onchange="App.setBlockedFilter(this.value)" id="blocked-filter-select"></select>`;
                headerDiv.insertAdjacentHTML('afterbegin', selectHTML);
            }

            // d. Llenar el Select con los equipos disponibles (Ordenados por nombre)
            const selectEl = document.getElementById('blocked-filter-select');
            if (selectEl) {
                const items = (data.RentalItems || []).sort((a,b) => a.name.localeCompare(b.name));
                const options = items.map(i => `<option value="${i.id}" ${currentFilter === i.id ? 'selected' : ''}>${i.name}</option>`).join('');
                selectEl.innerHTML = `<option value="all">Todos los Equipos</option>${options}`;
            }

        } else if (view === 'bookings') {
            const allBookings = AppState.data.Bookings || [];
            const searchTerm = (AppState.bookingSearch || '').toLowerCase();
            const timeFilter = AppState.bookingTimeFilter || 'active';
            const statusFilter = AppState.bookingStatusFilter || 'all';

            // Helper para fechas sin desfase horario (UTC puro)
            const formatDateSafe = (isoStr) => {
                if(!isoStr) return '';
                const [y, m, d] = isoStr.split('-');
                return `${d}/${m}/${y}`;
            };

            // --- Lógica de Filtrado ---
            let filtered = allBookings.filter(b => {
                const textMatch = !searchTerm || 
                    (b.customerName||'').toLowerCase().includes(searchTerm) ||
                    (b.customerEmail||'').toLowerCase().includes(searchTerm) ||
                    (b.customerCedula||'').toLowerCase().includes(searchTerm) ||
                    (b.id||'').toLowerCase().includes(searchTerm);
                if (!textMatch) return false;

                const isCanceled = b.status === 'Cancelado';
                const today = new Date().toISOString().split('T')[0];
                const isPast = b.endDate < today;

                if (timeFilter === 'active') { if (isCanceled || isPast) return false; }
                else if (timeFilter === 'inactive') { if (!isCanceled && !isPast) return false; }
                if (statusFilter !== 'all' && b.status !== statusFilter) return false;
                return true;
            });

            filtered.sort((a,b) => new Date(a.startDate) - new Date(b.startDate));

            // --- Inyectar Controles con Título ---
            const viewContainer = document.getElementById('view-bookings');
            
            // 1. LIMPIEZA: Eliminar controles viejos si existen (al recargar vista)
            const oldControls = document.getElementById('booking-controls');
            if (oldControls) oldControls.remove();

            // 1. LIMPIEZA: Eliminar el encabezado estático viejo (si existe)
            const staticHeader = Array.from(viewContainer.children).find(el => el.querySelector('h1') && el.id !== 'booking-controls');
            if (staticHeader) staticHeader.remove();
            
            // 2. INYECTAR CONTROLES SOLO SI NO EXISTEN
            // Esto evita que se sobrescriba el input mientras escribes
            if (!document.getElementById('booking-controls')) {
                const controlsHTML = `
                    <div id="booking-controls" class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h1 class="text-3xl font-display font-bold">Reservas</h1>
                            <button class="btn btn-primary" onclick="App.handleManualBooking()"><i class="fas fa-plus mr-2"></i> Nueva Reserva</button>
                        </div>
                        <div class="bg-white p-4 rounded border shadow-sm grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input id="booking-search-input" type="text" class="form-input" placeholder="Buscar Cliente, ID, Email..." value="${AppState.bookingSearch||''}" onkeyup="App.setBookingFilter('search', this.value)">
                            
                            <select id="booking-time-filter" class="form-select" onchange="App.setBookingFilter('time', this.value)">
                                <option value="active" ${timeFilter==='active'?'selected':''}>Activas (Futuras)</option>
                                <option value="inactive" ${timeFilter==='inactive'?'selected':''}>Histórico / Canceladas</option>
                                <option value="all" ${timeFilter==='all'?'selected':''}>Todas</option>
                            </select>
                            <select id="booking-status-filter" class="form-select" onchange="App.setBookingFilter('status', this.value)">
                                <option value="all">Todos los Estados</option>
                                <option value="Pendiente" ${statusFilter==='Pendiente'?'selected':''}>Pendiente</option>
                                <option value="Confirmado" ${statusFilter==='Confirmado'?'selected':''}>Confirmado</option>
                                <option value="Pagado" ${statusFilter==='Pagado'?'selected':''}>Pagado</option>
                                <option value="Cancelado" ${statusFilter==='Cancelado'?'selected':''}>Cancelado</option>
                            </select>
                        </div>
                    </div>
                `;
                viewContainer.insertAdjacentHTML('afterbegin', controlsHTML);
                
                // Truco: Poner el cursor al final si acabamos de renderizar y hay texto
                const input = document.getElementById('booking-search-input');
                if(input && AppState.bookingSearch) { 
                    input.focus(); 
                    var val = input.value; input.value = ''; input.value = val; 
                }
            } else {
                // Si ya existe, solo sincronizamos si el foco NO está en el buscador
                // Esto permite que los selectores de filtro funcionen bien
                if (document.activeElement.id !== 'booking-search-input') {
                    document.getElementById('booking-search-input').value = AppState.bookingSearch||'';
                }
            }
            
            App.setBookingFilter = (t, v) => {
                if(t==='search') AppState.bookingSearch=v; if(t==='time') AppState.bookingTimeFilter=v; if(t==='status') AppState.bookingStatusFilter=v;
                UI.renderView('bookings');
            };
            // --- Renderizar Tabla (Botones Estandarizados y Fechas Ok) ---
            document.getElementById('bookings-list-body').innerHTML = filtered.map(b => `
                <tr class="border-b hover:bg-gray-50 align-top">
                    <td class="p-4 font-mono text-xs font-bold text-gray-500 pt-5">
                        ${b.id}
                    </td>
                    <td class="p-4 whitespace-nowrap">
                        <div class="font-bold text-sm">${formatDateSafe(b.startDate)}</div>
                        <div class="text-xs text-gray-400">hasta ${formatDateSafe(b.endDate)}</div>
                    </td>
                    <td class="p-4">
                        <div class="font-bold text-sm text-gray-900">${b.customerName}</div>
                        ${b.customerCedula ? `<div class="text-xs text-gray-600 font-mono">ID: ${b.customerCedula}</div>` : ''}
                        <div class="text-xs text-blue-600 truncate max-w-[150px]" title="${b.customerEmail}">${b.customerEmail || '-'}</div>
                        ${b.customerPhone ? `<div class="text-xs text-gray-500">${b.customerPhone}</div>` : ''}
                    </td>
                    <td class="p-4">
                        <div class="text-xs text-gray-600 whitespace-normal max-w-[180px] leading-tight">
                            ${b.customerAddress || '<span class="text-gray-300 italic">Sin dirección</span>'}
                        </div>
                    </td>
                    <td class="p-4 text-sm font-medium">
                        ${b.itemName}
                    </td>
                    <td class="p-4 font-mono text-sm font-bold text-right">$${b.totalPrice}</td>
                    <td class="p-4"><span class="status-badge status-${b.status}">${b.status}</span></td>
                    <td class="p-4 flex gap-3 justify-center">
                        <button class="text-blue-600 hover:text-blue-800" onclick="App.handleEditCrudItem('Bookings', '${b.id}')"><i class="fas fa-edit"></i></button>
                        <button class="text-red-600 hover:text-red-800" onclick="App.handleDelete('Bookings', '${b.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            
            const thead = document.querySelector('#view-bookings thead tr');
            if(thead) thead.innerHTML = '<th class="p-4">REF</th><th class="p-4">Fechas</th><th class="p-4">Cliente</th><th class="p-4">Dirección</th><th class="p-4">Equipo</th><th class="p-4 text-right">Total</th><th class="p-4">Estado</th><th class="p-4 text-center">Acciones</th>';
        }
    },

    // --- INICIO CÓDIGO NUEVO LIGHTBOX ---
    lightboxIndex: 0,

    openLightbox: (id) => {
        // Usamos currentModalImages porque es lo que el usuario está viendo/editando
        const index = currentModalImages.findIndex(i => i.id === id);
        if (index === -1) return;
        
        UI.lightboxIndex = index;
        UI.updateLightboxContent();
        const lb = document.getElementById('admin-lightbox');
        lb.classList.remove('hidden');
        lb.classList.add('flex');
    },

    closeLightbox: () => {
        const lb = document.getElementById('admin-lightbox');
        lb.classList.add('hidden');
        lb.classList.remove('flex');
    },

    navLightbox: (dir) => {
        const list = currentModalImages;
        let newIndex = UI.lightboxIndex + dir;
        // Navegación circular
        if (newIndex < 0) newIndex = list.length - 1;
        if (newIndex >= list.length) newIndex = 0;
        
        UI.lightboxIndex = newIndex;
        UI.updateLightboxContent();
    },

    updateLightboxContent() {
        const imgData = currentModalImages[this.lightboxIndex];
        document.getElementById('admin-lb-img').src = imgData.imageUrl;
        
        // AJUSTE: Buscar Nombre del Proyecto (Contexto)
        let contextName = 'Galería';
        if (imgData.projectId && AppState.data.Projects) {
            const p = AppState.data.Projects.find(x => x.id === imgData.projectId);
            if (p) contextName = p.title;
        }
        
        // Formato: "Nombre Proyecto - Pie de Foto"
        const captionText = imgData.caption ? ` - ${imgData.caption}` : '';
        document.getElementById('admin-lb-caption').textContent = `${contextName}${captionText}`;
    }
};
  
// --- LOGICA PRINCIPAL (App) ---
const App = {
    // PEGA AQUÍ TU CÓDIGO BASE64 LARGO ENTRE LAS COMILLAS
    LOGO_BASE64: "",
    
    /// NUEVO ESTADO: Guardamos el archivo pendiente en memoria, NO en Drive
    pendingLogoFile: null,

    // Función auxiliar para borrar archivos viejos al reemplazar (Usa tu backend actual)
    async deleteFileDirectly(fileId) {
        if (!fileId) return;
        API.call('/.netlify/functions/update-sheet-data', { 
            method: 'POST', 
            body: { sheet: 'LogosClientes', action: 'delete_file_only', data: { fileId: fileId } } 
        }).catch(e => console.warn("Limpieza background:", e));
    },
    
    async switchView(viewId) {
        UI.showLoading('Cargando...');
        try {
            await this.ensureDataForView(viewId);
            // Reset de variables temporales al cambiar de vista
            currentModalImages = [];
            pendingDeletions = [];
            UI.renderView(viewId);
        } catch(e) {
            console.error(e);
            UI.showToast("Error cargando datos: " + e.message, "error");
        } finally {
            UI.hideLoading();
        }
    },

    // Lazy Load (CON CORRECCIÓN PARA DASHBOARD)
    async ensureDataForView(view, force = false) {
        // AJUSTE CRÍTICO: Si estamos en Dashboard y se fuerza actualización (al guardar), 
        // recargamos los datos usando la lógica maestra de loadData.
        if (view === 'dashboard' && force) {
            await this.loadData('dashboard');
            return;
        }

        let sheets = []; const d = AppState.data || {};
        const need = (key) => force || !d[key];

        if (view === 'projects' || view === 'portfolio-manager') { 
            if(need('Projects')) sheets.push('Projects');
            if(need('ProjectImages')) sheets.push('ProjectImages'); 
        }
        else if (view === 'rentals') { if(need('RentalItems')) sheets.push('RentalItems','RentalCategories','RentalItemImages','BlockedDates'); }
        else if (view === 'services') { if(need('Services')) sheets.push('Services','ServiceContentBlocks','ServiceImages'); }
        else if (view === 'videos') { if(need('Videos')) sheets.push('Videos'); }
        else if (view === 'bookings') { if(need('Bookings')) sheets.push('Bookings','BlockedDates','RentalItems'); }
        else if (view === 'client-logos') { if(need('LogosClientes')) sheets.push('LogosClientes'); }
        else if (view === 'identity') { 
            if(need('Identidad')) sheets.push('Identidad'); 
            if(need('About')) sheets.push('About'); 
            if(need('ImagenesIdentidad')) sheets.push('ImagenesIdentidad'); 
        }
        if (sheets.length > 0) { 
            sheets = [...new Set(sheets)];
            const nd = await API.call(`/.netlify/functions/get-admin-data?sheets=${sheets.join(',')}`); 
            AppState.data = { ...AppState.data, ...nd }; 
        }
    },
    
    async loadData(mode = 'dashboard') { 
        // DEFINICIÓN DE ESTRATEGIAS DE CARGA
        const loadStrategies = {
            // A. Carga Pesada (Solo al inicio): Necesaria para que los contadores del Dashboard (KPIs) marquen los números correctos
            'dashboard': 'Projects,Bookings,BookingsDetails,ProjectImages,Services,ServiceImages,Videos,RentalItems,RentalItemImages,RentalCategories,BlockedDates,LogosClientes,ImagenesIdentidad,Identidad',
            
            // B. Carga Quirúrgica (Al guardar Reserva): Solo recarga reservas, detalles, bloqueos y datos legales (PDF)
            'bookings_refresh': 'Bookings,BookingsDetails,BlockedDates,Identidad'
        };

        // Seleccionamos la estrategia, o usamos dashboard por defecto
        const sheets = loadStrategies[mode] || loadStrategies['dashboard'];
        
        const nd = await API.call(`/.netlify/functions/get-admin-data?sheets=${sheets}`); 
        
        // Fusión inteligente de datos
        AppState.data = { ...AppState.data, ...nd }; 
    },

    // LÓGICA DE EDICIÓN LOCAL (BATCHING)
    // 1. Al abrir modal, clonamos datos a memoria
    prepareGalleryData(sourceArray, filterKey, filterValue) {
        currentModalImages = JSON.parse(JSON.stringify(sourceArray.filter(i => i[filterKey] === filterValue)));
        pendingDeletions = [];
    },

    // --- NUEVA FUNCIÓN: Lógica de Reordenamiento Inteligente ---
    reorderGalleryImages(movedImageId, newTargetOrder) {
        // 1. Trabajamos sobre una copia ordenada de la memoria actual
        let list = [...currentModalImages].sort((a, b) => (parseInt(a.order) || 99) - (parseInt(b.order) || 99));
        
        // 2. Extraer el elemento que se mueve
        const currentIndex = list.findIndex(i => i.id === movedImageId);
        if (currentIndex === -1) return;
        const [movedItem] = list.splice(currentIndex, 1);

        // 3. Calcular nueva posición (Array base 0)
        let newIndex = parseInt(newTargetOrder) - 1; 
        if (newIndex < 0) newIndex = 0;
        if (newIndex > list.length) newIndex = list.length;

        // 4. Insertar en el nuevo lugar
        list.splice(newIndex, 0, movedItem);

        // 5. Renumerar todo secuencialmente (1, 2, 3...)
        list.forEach((img, index) => {
            const newOrder = index + 1;
            if (img.order != newOrder) {
                img.order = newOrder;
                img._modified = true; // Marcamos para guardar
            }
        });

        // 6. Actualizar memoria y Renderizar
        currentModalImages = list;
        
        // Detectar contexto para refrescar la vista correcta
        const parentId = movedItem.projectId || movedItem.itemId || movedItem.serviceId;
        let type = 'Projects'; 
        if(movedItem.itemId) type = 'RentalItems';
        if(movedItem.serviceId) type = 'Services';
        
        this.renderGalleryList(currentModalImages, parentId, type);
    },

    // 2. Actualizamos en memoria (rápido, sin llamadas API)
    updateLocalImage(id, key, value, type) {
        if (key === 'order') {
            this.reorderGalleryImages(id, value);
            return; 
        }
        const img = currentModalImages.find(i => i.id === id);
        if (img) {
            if (key === 'isCover' && (value === 'Si' || value === true)) {
                currentModalImages.forEach(i => i.isCover = 'No'); 
            }

            // APPEX: Lógica de Secuencia para Checkbox Individual
            if (key === 'showInPortfolio') {
                const isChecking = (value === 'Si' || value === true);
                if (isChecking) {
                    // 1. Buscar el máximo global en la base de datos
                    let globalMax = 0;
                    if (AppState.data.ProjectImages) {
                        const orders = AppState.data.ProjectImages
                            .filter(i => String(i.showInPortfolio).toLowerCase() === 'si')
                            .map(i => parseInt(i.portfolioOrder) || 0);
                        if (orders.length > 0) globalMax = Math.max(...orders);
                    }

                    // 2. Buscar el máximo local (por si acabamos de marcar otras en este mismo modal)
                    let localMax = 0;
                    const localOrders = currentModalImages
                        .filter(i => String(i.showInPortfolio).toLowerCase() === 'si')
                        .map(i => parseInt(i.portfolioOrder) || 0);
                    if (localOrders.length > 0) localMax = Math.max(...localOrders);

                    // 3. El nuevo número es el mayor de los dos + 1
                    img.portfolioOrder = Math.max(globalMax, localMax) + 1;
                } else {
                    img.portfolioOrder = ''; // <--- AJUSTE: Se limpia el campo (vacío)
                }
            }

            img[key] = (value === true ? 'Si' : (value === false ? 'No' : value));
            img._modified = true; 
        }
        // Re-renderizar solo el modal o lista
        if (type === 'ClientLogos') UI.renderView('settings');
        else {
             // Re-render modal list (necesita el contexto del padre)
             // Simplificación: Re-abrir modal con datos actuales
             const parentId = img.projectId || img.itemId || img.serviceId;
             if(type === 'Projects') this.renderGalleryList(currentModalImages, parentId, 'Projects');
             // ... lógica similar para otros tipos, o un render genérico
             else if(type === 'Services') this.renderGalleryList(currentModalImages, parentId, 'Services');
             else if(type === 'RentalItems') this.renderGalleryList(currentModalImages, parentId, 'RentalItems');
        }
    },

    handleDeleteImageLocal(id, type) {
        const index = currentModalImages.findIndex(i => i.id === id);
        if (index > -1) {
            pendingDeletions.push(currentModalImages[index]);
            currentModalImages.splice(index, 1);
        }
        if (type === 'ClientLogos') UI.renderView('settings');
        else {
            // Buscar el parentId de cualquier imagen restante para renderizar
            const remainingImg = currentModalImages[0] || pendingDeletions[0];
            const parentId = remainingImg ? (remainingImg.projectId || remainingImg.itemId || remainingImg.serviceId) : null;
            if(parentId) this.renderGalleryList(currentModalImages, parentId, type);
        }
    },

    // 3. Guardar TODO de una vez (FIXED V29: UI Blocking & Feedback)
    async saveGalleryChanges(parentId, type) {
        UI.showLoading('Guardando cambios...');
        try {
            // Si es ClientLogos, usamos currentModalImages si existe, o cargamos
            if (type === 'ClientLogos' && currentModalImages.length === 0 && AppState.data.ClientLogos) {
                 currentModalImages = JSON.parse(JSON.stringify(AppState.data.ClientLogos));
            }

            const batch = [];
            const sheetName = type; // 'ProjectImages', 'ClientLogos', etc.

            // Procesar Borrados
            pendingDeletions.forEach(img => {
                // Si la imagen tiene un ID real (no es temporal recién subida y borrada)
                if (img.id && !img.id.startsWith('temp_')) {
                     batch.push({ 
                        sheet: sheetName, 
                        action: 'delete', 
                        criteria: { id: img.id }, 
                        // IMPORTANTE: Aquí pasamos el ID del archivo de Drive para que el backend lo borre
                        data: { fileId: img.fileId } 
                     });
                }
            });

            // Procesar Modificados y Nuevos
            currentModalImages.forEach(img => {
                 // Solo enviamos si se modificó o es nuevo.
                 // Para ClientLogos, como es reordenamiento, enviamos todos para asegurar consistencia si se cambió orden
                 if (img._modified || (img.id && img.id.startsWith('temp_')) || type === 'ClientLogos') {
                    const dataToUpdate = { 
                        order: img.order, 
                        caption: img.caption, 
                        isCover: img.isCover, 
                        showInPortfolio: img.showInPortfolio,
                        portfolioOrder: img.portfolioOrder,
                        clientName: img.clientName 
                     };
                     batch.push({ sheet: sheetName, action: 'update', criteria: { id: img.id }, data: dataToUpdate });
                 }
            });

            if (batch.length > 0) {
                await API.batchUpdate(batch);
                
                // APPEX: Limpiamos memoria para evitar re-enviar si el usuario guarda de nuevo sin cerrar
                pendingDeletions = [];
                currentModalImages.forEach(img => delete img._modified);

                // Sincronizar estado global
                await this.ensureDataForView(AppState.view, true);
                
                UI.renderView(AppState.view);
                
                UI.showToast("Cambios guardados exitosamente");
                
                // APPEX: Cerrar modal SOLO si todo salió bien (excepto en ClientLogos que es vista plana)
               if(type !== 'ClientLogos') UI.closeModal(); 
            } else {
                UI.showToast("No se detectaron cambios para guardar", "info");
            }

        } catch(e) {
            console.error(e);
            // APPEX: Feedback visual mejorado en lugar de alert()
            UI.showToast("Error al guardar: " + e.message, "error"); 
        } finally {
            UI.hideLoading();
        }
    },
    
    async uploadImages(input, parentId, parentTitle, type) {
        const files = Array.from(input.files); if (!files.length) return;
        let driveFolderId = null, sheetTarget='', subfolder='', idField='';
        
        // Mapeo
        if (type === 'Projects') { const row = AppState.data.Projects.find(p => p.id === parentId); driveFolderId = row?.driveFolderId; sheetTarget='ProjectImages'; subfolder='Proyectos'; idField='projectId'; }
        else if (type === 'RentalItems') { const row = AppState.data.RentalItems.find(r => r.id === parentId); driveFolderId = row?.driveFolderId; sheetTarget='RentalItemImages'; subfolder='Alquiler'; idField='itemId'; }
        else if (type === 'Services') { sheetTarget='ServiceImages'; subfolder='Servicios'; idField='serviceId'; parentTitle = parentTitle || 'General'; }
        else if (type === 'ClientLogos') { sheetTarget='ClientLogos'; subfolder='Logos'; parentId='general'; }
        else if (type === 'AboutProfile') { sheetTarget='About'; subfolder='Perfil'; parentId='profile_image'; }
        else if (type === 'SettingImage') { sheetTarget='Settings'; subfolder='Marca'; }

        // Lógica específica para ClientLogos: Pedir nombre
        let clientName = '';
        if (type === 'ClientLogos') {
            clientName = prompt("Nombre del Cliente (Opcional):") || '';
        }

        let successCount = 0;
        
        // Si es galería (no settings), usamos carga optimista
        if(['Projects', 'RentalItems', 'Services', 'ClientLogos'].includes(type)) {
             // Inicializar memoria si está vacía (caso ClientLogos directo)
             if (type === 'ClientLogos' && currentModalImages.length === 0) {
                 currentModalImages = JSON.parse(JSON.stringify(AppState.data.ClientLogos || []));
             }
        }

        for (let i = 0; i < files.length; i++) {
            const file = files[i]; 
            // APPEX UX: Mostrar nombre del archivo
            UI.showLoading(`Subiendo ${i+1}/${files.length}: ${file.name}`);
            try {
                const compressed = await new Promise((resolve, reject) => { new Compressor(file, { quality: 0.8, maxWidth: 1600, success: resolve, error: reject }); });
                const fd = new FormData(); fd.append('file', compressed, file.name); fd.append('targetSubfolder', subfolder); fd.append('targetFolderId', driveFolderId || ''); fd.append('parentFolderName', parentTitle); 
                const upRes = await API.call('/.netlify/functions/upload-image', { method: 'POST', body: fd });
                
                // Guardar ID carpeta padre si es nuevo
                if ((type === 'Projects' || type === 'RentalItems'|| type === 'Services') && upRes.driveFolderId && upRes.driveFolderId !== driveFolderId) {
                    driveFolderId = upRes.driveFolderId;
                    await API.call('/.netlify/functions/update-sheet-data', { method: 'POST', body: { sheet: type, action: 'update', criteria: {id: parentId}, data: {driveFolderId} } });
                }

                

                if (type === 'SettingImage') {
                    await API.call('/.netlify/functions/update-sheet-data', { method: 'POST', body: { sheet: 'Settings', action: 'update', criteria: {key: parentId}, data: {value: upRes.imageUrl} } });
                    document.getElementById(`preview-${parentId}`).src = upRes.imageUrl;
                } else if (type === 'AboutProfile') {
                    await API.call('/.netlify/functions/update-sheet-data', { method: 'POST', body: { sheet: 'About', action: 'update', criteria: {section: 'profile_image'}, data: {content: upRes.imageUrl} } });
                    document.getElementById('about-profile-preview').src = upRes.imageUrl;
                } else {
                // APPEX CORRECCIÓN: Calcular el orden basándonos en el MÁXIMO existente + 1
                    // Esto evita que se reinicie a 1 si currentModalImages está vacío o desactualizado
                    let maxOrder = 0;
                    if (currentModalImages && currentModalImages.length > 0) {
                        maxOrder = Math.max(...currentModalImages.map(img => parseInt(img.order) || 0));
                    }
                    // Además, si estamos subiendo múltiples archivos en este bucle, incrementamos i
                    const nextOrder = maxOrder + 1;
                    
                    const newData = { 
                        id: `img_${Date.now()}_${Math.floor(Math.random()*1000)}`, 
                        imageUrl: upRes.imageUrl, 
                        fileId: upRes.fileId, 
                        order: nextOrder,
                        isCover: 'No', showInPortfolio: 'No',
                        clientName: clientName // Solo aplica si es logo
                    };
                    
                    if (type === 'ClientLogos') { newData.logoUrl = upRes.imageUrl; delete newData.imageUrl; }
                    if(idField) newData[idField] = parentId;

                    await API.call('/.netlify/functions/update-sheet-data', { method: 'POST', body: { sheet: sheetTarget, action: 'add', data: newData } });
                    
                    // Agregar a memoria local
                    currentModalImages.push(newData);

                    // 5. [NUEVO AJUSTE] Sincronizar Memoria Global
                    // Esto asegura que si cierras y abres el modal, la foto siga ahí
                    if (AppState.data[sheetTarget]) {
                        AppState.data[sheetTarget].push(newData);
                    }
                    
                }
                successCount++;
            } catch (e) { console.error(e); UI.showToast('Error: '+e.message, 'error'); }
        }
        
        UI.hideLoading();
        if(successCount) UI.showToast('Subida completa');
        
        // Refrescar visualización
        if (type === 'ClientLogos') UI.renderView('settings');
        else if(['Projects', 'RentalItems', 'Services'].includes(type)) {
             // Re-renderizar modal con los nuevos datos en memoria
             this.renderGalleryList(currentModalImages, parentId, type);
            UI.renderView(AppState.view);
        }
    },

    // ... (Resto de funciones CRUD igual que v22.0) ...
    // IMPORTANTE: Asegurarse de que handleProjectImages y similares usen prepareGalleryData

    async handleProjectImages(id, t) { 
        this.prepareGalleryData(AppState.data.ProjectImages || [], 'projectId', id);
        this.renderGalleryModal(id, t, 'Projects'); 
    },
    async handleServiceImages(id, t) { 
        this.prepareGalleryData(AppState.data.ServiceImages || [], 'serviceId', id);
        this.renderGalleryModal(id, t, 'Services'); 
    },
    async handleRentalImages(id, t) { 
        this.prepareGalleryData(AppState.data.RentalItemImages || [], 'itemId', id);
        this.renderGalleryModal(id, t, 'RentalItems'); 
    },
    async handleClientLogos() { 
        this.prepareGalleryData(AppState.data.ClientLogos || [], 'dummy', 'dummy'); // Truco: cargar todo
        // No abre modal, solo prepara datos para la vista settings
    },

    renderGalleryModal(parentId, title, type) {
        const sheetTarget = type === 'Projects' ? 'ProjectImages' : (type === 'RentalItems' ? 'RentalItemImages' : 'ServiceImages');
        
        // APPEX UX: Integrar el botón "Todo a Portafolio" en el encabezado del modal
        let modalTitle = `<span>${title}</span>`;
        
        if (type === 'Projects') {
            modalTitle = `
                <div class="flex items-center gap-4">
                    <span>${title}</span>
                    <button class="btn btn-secondary py-1 px-3 text-xs font-normal" onclick="App.toggleAllPortfolio()">
                        <i class="fas fa-check-double mr-1"></i> Todo a Portafolio
                    </button>
                </div>
            `;
        }

        // CUERPO: Ahora es 100% limpio, solo la lista de imágenes
        const html = `<div id="gallery-list-container"></div>`;

        // FOOTER: Botón de Subir a la izquierda, Acciones a la derecha
        const footer = `
            <div class="flex justify-between items-center w-full">
                <div>
                    <input type="file" id="up-imgs-modal" multiple accept="image/*" class="hidden" onchange="App.uploadImages(this, '${parentId}', '${title.replace(/'/g,"")}', '${type}')">
                    <button class="btn btn-primary" onclick="document.getElementById('up-imgs-modal').click()"><i class="fas fa-upload mr-2"></i> Subir Imágenes</button>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancelar</button>
                    <button class="btn btn-primary" onclick="App.saveGalleryChanges('${parentId}', '${sheetTarget}')">Guardar Cambios</button>
                </div>
            </div>`;

        UI.showModal(modalTitle, html, footer);
        this.renderGalleryList(currentModalImages, parentId, type);
    },
    
    // Nueva función para marcar todo
    toggleAllPortfolio() {
        // Verificamos si todos están marcados para desmarcar, o viceversa
        const allSelected = currentModalImages.every(i => String(i.showInPortfolio).toLowerCase() === 'si');
        const newState = allSelected ? 'No' : 'Si';

        // APPEX: Calcular el inicio de la secuencia global
        let nextPortfolioOrder = 1;
        if (newState === 'Si' && AppState.data.ProjectImages) {
            // Buscamos el número más alto entre TODAS las fotos de TODOS los proyectos
            const allOrders = AppState.data.ProjectImages
                .filter(img => String(img.showInPortfolio).toLowerCase() === 'si')
                .map(img => parseInt(img.portfolioOrder) || 0);
            
            if (allOrders.length > 0) {
                nextPortfolioOrder = Math.max(...allOrders) + 1;
            }
        }
        
        currentModalImages.forEach(img => {
            // Solo aplicamos cambios si el estado es diferente
            if (img.showInPortfolio !== newState) {
                img.showInPortfolio = newState;
                img._modified = true;
                
                if (newState === 'Si') {
                    img.portfolioOrder = nextPortfolioOrder++; // Asigna y aumenta (11, 12, 13...)
                } else {
                    img.portfolioOrder = 99; // Reinicia si se desmarca
                }
            }
        });
        
        // Re-renderizar la lista actual (buscando el ID del padre desde la primera imagen)
        if(currentModalImages.length > 0) {
            const first = currentModalImages[0];
            const pId = first.projectId || first.itemId || first.serviceId;
            // Asumimos que si hay botón es Projects
            this.renderGalleryList(currentModalImages, pId, 'Projects');
        }
    },

    renderGalleryList(images, parentId, type) {
        const container = document.getElementById('gallery-list-container');
        if(!container) return;

        const sortedImages = images.sort((a, b) => (parseInt(a.order) || 99) - (parseInt(b.order) || 99));
        const getChecked = (val) => String(val).toLowerCase().trim() === 'si' || String(val).toLowerCase().trim() === 'yes' ? 'checked' : '';
        
        container.innerHTML = sortedImages.filter(i => !pendingDeletions.includes(i)).map(i => `
            <div class="flex items-center gap-4 p-3 border rounded mb-2 bg-white transition-all duration-200 hover:shadow-md" 
                 id="img-row-${i.id}" 
                 draggable="true"
                 ondragstart="App.dragStart(event, '${i.id}')"
                 ondragover="App.dragOver(event)"
                 ondrop="App.dragDrop(event, '${i.id}')">

                <div class="cursor-move text-gray-300 hover:text-gray-600 px-2 select-none" title="Arrastrar para reordenar">
                    <i class="fas fa-grip-vertical"></i>
                </div>

                <img src="${i.imageUrl}" 
                     class="w-16 h-16 object-contain rounded bg-gray-100 select-none cursor-zoom-in hover:opacity-80 transition" 
                     onclick="UI.openLightbox('${i.id}')"
                     referrerpolicy="no-referrer" 
                     >
                
                <div class="flex-1 grid grid-cols-2 gap-2">
                
                    <label class="text-xs font-bold text-gray-500">Orden 
                        <input type="number" class="border p-1 w-full rounded font-bold text-black" 
                               value="${i.order}" 
                               onchange="App.updateLocalImage('${i.id}', 'order', this.value, '${type}')">
                    </label>
                    ${type==='Projects' ? `<label class="text-xs font-bold text-gray-500">Pie <input type="text" class="border p-1 w-full rounded" value="${i.caption||''}" onchange="App.updateLocalImage('${i.id}', 'caption', this.value, '${type}')"></label>` : ''}
                </div>
                
                <div class="flex flex-col gap-1">
                    ${type !== 'Services' ? `<label class="flex items-center gap-2 text-xs cursor-pointer select-none"><input type="checkbox" ${getChecked(i.isCover)} onchange="App.updateLocalImage('${i.id}', 'isCover', this.checked, '${type}')"> Portada</label>` : ''}
                    ${type === 'Projects' ? `<label class="flex items-center gap-2 text-xs cursor-pointer select-none"><input type="checkbox" ${getChecked(i.showInPortfolio)} onchange="App.updateLocalImage('${i.id}', 'showInPortfolio', this.checked, '${type}')"> Portafolio</label>` : ''}
                </div>
                
                <button class="text-red-500 p-2 hover:bg-red-50 rounded" onclick="App.handleDeleteImageLocal('${i.id}', '${type}')"><i class="fas fa-trash"></i></button>
            </div>
        `).join('');
    },
    // --- NUEVAS FUNCIONES: Drag & Drop Helpers ---
    dragStart(e, id) {
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", id);
        e.target.classList.add('opacity-50', 'bg-gray-50'); // Feedback visual
    },
    dragOver(e) {
        e.preventDefault(); // Necesario para permitir el drop
        e.dataTransfer.dropEffect = "move";
    },
    dragDrop(e, targetId) {
        e.preventDefault();
        // Limpiar estilos visuales
        document.querySelectorAll('[draggable]').forEach(el => el.classList.remove('opacity-50', 'bg-gray-50'));

        const movedId = e.dataTransfer.getData("text/plain");
        if (movedId === targetId) return;

        // Encontrar el orden del elemento sobre el que soltamos
        const targetItem = currentModalImages.find(i => i.id === targetId);
        if (targetItem) {
            // Llamamos al cerebro para que haga la matemática
            this.reorderGalleryImages(movedId, targetItem.order);
        }
    },
    
    async handleEditCrudItem(sheet, id) {
        // Carga perezosa para dependencias (ej. Equipos para Bloqueos)
        if (sheet === 'BlockedDates' && !AppState.data.RentalItems) {
             UI.showLoading('Cargando datos...');
             const d = await API.call('/.netlify/functions/get-admin-data?sheets=RentalItems');
             AppState.data = { ...AppState.data, ...d };
             UI.hideLoading();
        }

        const isNew = !id; 
        let html = '';
        let modalTitle = isNew ? 'Nuevo Registro' : 'Editar Registro';
        let leftButtons = ''; // Botones extra para la izquierda (Galería, Eliminar)

        // --- LÓGICA POR TIPO DE HOJA ---
        
        if(sheet === 'Projects'){
             const p = isNew ? {} : AppState.data.Projects.find(x => String(x.id) === String(id));
             
             // 1. Título Dinámico
             modalTitle = isNew ? 'Nuevo Proyecto' : `Editar Proyecto ${p.title}`;

             // Lógica de auto-secuencia (que ya teníamos)
             let nextOrder = 1;
             if (isNew && AppState.data.Projects && AppState.data.Projects.length > 0) {
                 const maxOrder = Math.max(...AppState.data.Projects.map(proj => parseInt(proj.order) || 0));
                 nextOrder = maxOrder + 1;
             }
             
            // Definimos las opciones de estado
             const statusOpts = [{id:'active', name:'Visible'}, {id:'hidden', name:'Oculto'}];
             
             // Agregamos el selector al HTML
             html = `${UI.inputHTML('c','order','Orden',p?.order||nextOrder,'number')} 
                     ${UI.selectHTML('c','status','Visibilidad Web', statusOpts, p?.status||'active')}
                     ${UI.inputHTML('c','title','Título',p?.title)} 
                     ${UI.textareaHTML('c','description','Descripción',p?.description)}`;
            
             // 2. Botones de Izquierda (Solo al editar)
            if (!isNew) {
                 leftButtons = `
                    <button class="btn btn-danger h-10 px-4 mr-2" onclick="UI.closeModal(); App.handleDelete('Projects', '${id}')" title="Eliminar Proyecto">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn btn-secondary h-10" onclick="App.handleProjectImages('${id}', '${p.title.replace(/'/g,"")}')" title="Ir a Fotos">
                        <i class="fas fa-images mr-2"></i> Galería
                    </button>
                 `;
             }

            // --- INICIO BLOQUE RESTAURADO DE VIDEOS ---
        } else if(sheet === 'Videos'){
             const v = isNew ? {} : AppState.data.Videos.find(x => String(x.id) === String(id));
             modalTitle = isNew ? 'Nuevo Video' : 'Editar Video';
             
             // Autocalcular siguiente orden
             let nextOrder = 1;
             if (isNew && AppState.data.Videos && AppState.data.Videos.length > 0) {
                 const maxOrder = Math.max(...AppState.data.Videos.map(vid => parseInt(vid.order) || 0));
                 nextOrder = maxOrder + 1;
             }

             html = `${UI.inputHTML('c','order','Orden', v?.order || nextOrder, 'number')} 
                     ${UI.inputHTML('c','title','Título', v?.title)} 
                     ${UI.inputHTML('c','embedUrl','URL del Video (YouTube)', v?.embedUrl)}`;
        // --- FIN BLOQUE RESTAURADO DE VIDEOS ---

        } else if(sheet === 'Services'){
             const s = isNew ? {} : AppState.data.Services.find(x => String(x.id) === String(id));
             
             // 1. Título Ajustado
             modalTitle = isNew ? 'Nuevo Servicio' : `Editar Servicio ${s.title}`;
             
             let nextOrder = 1;
             if (isNew && AppState.data.Services && AppState.data.Services.length > 0) {
                 const maxOrder = Math.max(...AppState.data.Services.map(srv => parseInt(srv.order) || 0));
                 nextOrder = maxOrder + 1;
             }

             // Lista de Iconos
             const iconList = [
                 'fas fa-camera', 'fas fa-camera-retro', 'fas fa-video', 'fas fa-film', 'fas fa-photo-video',
                 'fas fa-ring', 'fas fa-heart', 'fas fa-dove', 'fas fa-glass-cheers', 'fas fa-church',
                 'fas fa-user', 'fas fa-user-friends', 'fas fa-users', 'fas fa-user-tie', 'fas fa-user-graduate',
                 'fas fa-baby', 'fas fa-child', 'fas fa-female', 'fas fa-male', 'fas fa-portrait',
                 'fas fa-building', 'fas fa-city', 'fas fa-home', 'fas fa-store', 'fas fa-hotel',
                 'fas fa-utensils', 'fas fa-wine-glass', 'fas fa-coffee', 'fas fa-birthday-cake', 'fas fa-pizza-slice',
                 'fas fa-plane', 'fas fa-car', 'fas fa-ship', 'fas fa-passport', 'fas fa-map-marked-alt',
                 'fas fa-tree', 'fas fa-mountain', 'fas fa-water', 'fas fa-sun', 'fas fa-leaf',
                 'fa-solid fa-helicopter', 'fas fa-drone', 'fas fa-layer-group', 'fas fa-th-large', 'fas fa-images',
                 'fas fa-book-open', 'fas fa-book', 'fas fa-bookmark', 'fas fa-pencil-alt', 'fas fa-pen-nib',
                 'fas fa-star', 'fas fa-award', 'fas fa-certificate', 'fas fa-medal', 'fas fa-crown',
                 'fas fa-magic', 'fas fa-lightbulb', 'fas fa-bolt', 'fas fa-fire', 'fas fa-gem',
                 'fas fa-laptop', 'fas fa-mobile-alt', 'fas fa-desktop', 'fas fa-mouse-pointer', 'fas fa-code',
                 'fas fa-shopping-bag', 'fas fa-tag', 'fas fa-percentage', 'fas fa-credit-card', 'fas fa-truck',
                 'fas fa-music', 'fas fa-microphone', 'fas fa-headphones', 'fas fa-guitar', 'fas fa-drum'
             ];
             const currentIcon = s?.iconClass || 'fas fa-camera';

             let iconsHtml = `<div class="mb-4"><label class="form-label">Selecciona un Icono</label>`;
             iconsHtml += `<div class="grid grid-cols-8 gap-2 max-h-40 overflow-y-auto p-2 border rounded bg-gray-50">`; 
             iconsHtml += `<input type="hidden" id="c-iconClass" data-key="iconClass" value="${currentIcon}">`;
             
             iconList.forEach(icon => {
                 const isSelected = icon === currentIcon ? 'bg-gray-800 text-white ring-2 ring-offset-1 ring-gray-800' : 'bg-white text-gray-600 hover:bg-gray-200';
                 iconsHtml += `<button type="button" class="icon-option p-1.5 rounded text-center transition-all ${isSelected}" onclick="App.selectIcon(this, '${icon}')"><i class="${icon} text-lg"></i></button>`;
             });
             iconsHtml += `</div></div>`;

            const editorHtml = `<div class="mb-4"><label class="form-label">Introducción (Bio)</label><div id="editor-intro"></div></div>`;

             // Definimos opciones LIMPIAS
             const statusOpts = [{id:'active', name:'Visible'}, {id:'hidden', name:'Oculto'}];

             // Agregamos el selector al HTML
             html = `${UI.inputHTML('c','order','Orden',s?.order||nextOrder,'number')} 
                     ${UI.selectHTML('c','status','Visibilidad Web', statusOpts, s?.status||'active')}
                     ${UI.inputHTML('c','title','Título',s?.title)} 
                     ${iconsHtml} ${editorHtml}`;
            
             App.selectIcon = (btn, iconClass) => {
                 document.querySelectorAll('.icon-option').forEach(b => b.className = 'icon-option p-1.5 rounded text-center transition-all bg-white text-gray-600 hover:bg-gray-200');
                 btn.className = 'icon-option p-1.5 rounded text-center transition-all bg-gray-800 text-white ring-2 ring-offset-1 ring-gray-800';
                 document.getElementById('c-iconClass').value = iconClass;
             };

            // Inicializar Editor Quill
            setTimeout(() => {
                 activeQuillEditor = new Quill('#editor-intro', {
                     theme: 'snow',
                     modules: { 
                         toolbar: [
                             ['bold', 'italic', 'underline'], 
                             [{ 'align': [] }], 
                             [{ 'list': 'ordered'}, { 'list': 'bullet' }], 
                             ['clean']
                         ] 
                     }
                 });
                 if (s && s.introText) {
                    activeQuillEditor.root.innerHTML = s.introText;
                 }
             }, 100);

            // 2. Botones de Izquierda (Con Texto Visible)
             if (!isNew) {
                 leftButtons = `
                    <button class="btn btn-danger h-10 px-3 mr-1" onclick="UI.closeModal(); App.handleDelete('Services', '${id}')" title="Eliminar Servicio">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn btn-secondary h-10 px-3 mr-1" onclick="App.handleServiceImages('${id}', '${s.title.replace(/'/g,"")}')">
                        <i class="fas fa-images mr-2"></i> Galería
                    </button>
                    <button class="btn btn-secondary h-10 px-3" onclick="App.handleServiceContent('${id}', '${s.title.replace(/'/g,"")}')">
                        <i class="fas fa-layer-group mr-2"></i> Contenido
                    </button>
                 `;
             } 
         } else if(sheet === 'RentalItems'){
             const i = isNew ? {} : AppState.data.RentalItems.find(x => String(x.id) === String(id));
             const cats = AppState.data.RentalCategories || [];
             
             // 1. Título Ajustado
             modalTitle = isNew ? 'Nuevo Equipo' : `Editar Equipo ${i.name}`;
             
             let nextOrder = 1;
             if (isNew && AppState.data.RentalItems && AppState.data.RentalItems.length > 0) {
                 const maxOrder = Math.max(...AppState.data.RentalItems.map(it => parseInt(it.order) || 0));
                 nextOrder = maxOrder + 1;
             }

             // 2. Checkbox de Impuesto y Calculadora
             const hasTaxChecked = String(i?.hasTax).toUpperCase() === 'TRUE' ? 'checked' : '';
             
            const taxHtml = `
                <div class="mb-4 bg-gray-50 p-3 rounded border">
                    <div class="flex items-center mb-2">
                        <input type="checkbox" id="c-hasTax" class="w-4 h-4 text-blue-600 rounded cursor-pointer" ${hasTaxChecked}>
                        <label for="c-hasTax" class="ml-2 text-sm font-bold text-gray-700 cursor-pointer select-none">Aplicar Impuesto de Venta (13%)</label>
                    </div>
                    <div id="tax-calc-display" class="hidden mt-2 pt-2 border-t border-gray-200">
                        <label class="text-xs font-bold text-gray-500 uppercase">Precio Final al Cliente</label>
                        <div class="text-xl font-mono font-bold text-blue-700" id="tax-calc-result">$0.00</div>
                    </div>
                </div>
             `;

             // Definimos los 3 estados
             const statusOpts = [
                {id:'active', name:'Visible'}, 
                {id:'hidden', name:'Oculto'}, 
                {id:'blocked', name:'Bloqueado'}
            ];

             html = `${UI.inputHTML('c', 'order', 'Orden', i?.order||nextOrder, 'number')} 
                     ${UI.selectHTML('c', 'status', 'Estado del Equipo', statusOpts, i?.status||'active')}
                     ${UI.inputHTML('c', 'name', 'Nombre', i?.name)} 
                     ${UI.selectHTML('c', 'categoryId', 'Categoría', cats, i?.categoryId)} 
                     ${UI.inputHTML('c', 'pricePerDay', 'Precio Base (Sin Impuesto)', i?.pricePerDay, 'number')} 
                     ${taxHtml} 
                     ${UI.textareaHTML('c', 'description', 'Descripción Corta', i?.description)} 
                     ${UI.textareaHTML('c', 'longDescription', 'Descripción Larga', i?.longDescription)}`;
             // 3. Botones Estandarizados
             if (!isNew) {
                 leftButtons = `
                    <button class="btn btn-danger h-10 px-3 mr-2" onclick="UI.closeModal(); App.handleDelete('RentalItems', '${id}')" title="Eliminar Equipo">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn btn-secondary h-10 px-3" onclick="App.handleRentalImages('${id}', '${i.name.replace(/'/g,"")}')" title="Galería">
                        <i class="fas fa-images mr-2"></i> Galería
                    </button>
                 `;
             }

             // 4. LÓGICA DE CÁLCULO EN VIVO
             setTimeout(() => {
                const priceInput = document.getElementById('c-pricePerDay');
                const taxCheck = document.getElementById('c-hasTax');
                const displayDiv = document.getElementById('tax-calc-display');
                const resultText = document.getElementById('tax-calc-result');
        
                const calculate = () => {
                    const base = parseFloat(priceInput.value) || 0;
                    if (taxCheck.checked) {
                        displayDiv.classList.remove('hidden');
                        const total = base * 1.13;
                        resultText.innerText = `$${total.toFixed(2)}`;
                    } else {
                        displayDiv.classList.add('hidden');
                    }
                };
        
                // Escuchar cambios
                priceInput.addEventListener('input', calculate);
                taxCheck.addEventListener('change', calculate);
                // Ejecutar una vez al abrir
                calculate();
            }, 50);
        } else if(sheet === 'RentalCategories'){
             const c = isNew ? {} : AppState.data.RentalCategories.find(x => String(x.id) === String(id));
             modalTitle = isNew ? 'Nueva Categoría' : 'Editar Categoría';
             
             // Autocalcular Orden
             let nextOrder = 1;
             if (isNew && AppState.data.RentalCategories && AppState.data.RentalCategories.length > 0) {
                 const maxOrder = Math.max(...AppState.data.RentalCategories.map(cat => parseInt(cat.order) || 0));
                 nextOrder = maxOrder + 1;
             }

             html = `${UI.inputHTML('c', 'order', 'Orden', c?.order||nextOrder, 'number')} ${UI.inputHTML('c', 'name', 'Nombre', c?.name)}`;
            // --- INICIO CÓDIGO NUEVO (FORMULARIO RESERVAS) ---
        } else if(sheet === 'Bookings'){
            // 1. Carga de Dependencias
            if (!AppState.data.RentalItems || !AppState.data.BlockedDates || !AppState.data.BookingsDetails) {
                UI.showLoading('Cargando sistema...');
                const d = await API.call('/.netlify/functions/get-admin-data?sheets=RentalItems,BlockedDates,BookingsDetails');
                AppState.data = { ...AppState.data, ...d };
                UI.hideLoading();
            }
        
            // 2. Preparar Datos
            const b = isNew ? {} : AppState.data.Bookings.find(x => String(x.id) === String(id));
            
            let currentLines = [];
            if (!isNew && AppState.data.BookingsDetails) {
                currentLines = AppState.data.BookingsDetails.filter(d => String(d.bookingId) === String(id));
            }
            
            if (!isNew && currentLines.length === 0 && b.itemId) {
                currentLines.push({
                    uuid: 'legacy_' + Date.now(), itemId: b.itemId, itemName: b.itemName,
                    startDate: b.startDate, endDate: b.endDate, basePrice: 0,
                    discountType: 'percent', discountVal: 0, manualAdj: 0, lineNote: 'Migrado'
                });
            }
        
            window.tempBookingLines = currentLines.map(l => ({
                uuid: l.uuid || `line_${Math.random().toString(36).substr(2,9)}`,
                itemId: l.itemId, startDate: l.startDate, endDate: l.endDate,
                basePrice: parseFloat(l.basePrice) || 0,
                discountType: l.lineDiscountType || 'percent',
                discountVal: parseFloat(l.lineDiscountVal) || 0,
                manualAdj: parseFloat(l.manualAdjustment) || 0,
                note: l.lineNote || ''
            }));
        
            // 3. Renderizar Modal (Full Screen Directo)
            const tpl = document.getElementById('reservation-modal-template');
            const clone = tpl.content.cloneNode(true);
            const divTemp = document.createElement('div');
            divTemp.appendChild(clone);
            let htmlContent = divTemp.innerHTML;
        
            const displayId = isNew ? 'NUEVA' : (b.id || '---');
            htmlContent = htmlContent.replace('id="input-reserva-id">', `id="input-reserva-id" value="${id||''}">`);
        
            // Mostrar Modal
            UI.showModal('', htmlContent, ''); 
            
            // Inyectar ID visual
            setTimeout(() => {
                const headerRef = document.getElementById('header-ref-display');
                if(headerRef) headerRef.textContent = displayId;
            }, 0);
        
            // 4. LÓGICA DE DATOS Y PROTECCIÓN DE CIERRE
            setTimeout(() => {
                // A. Llenado de Campos Inicial
                const setVal = (id, v) => { const el = document.getElementById(id); if(el) el.value = v||''; };
                if (!isNew) {
                    setVal('c-customerName', b.customerName);
                    setVal('c-customerPhone', b.customerPhone);
                    setVal('c-customerEmail', b.customerEmail);
                    setVal('c-customerCedula', b.customerCedula);
                    setVal('c-customerAddress', b.customerAddress);
                    setVal('c-globalNotes', b.globalNotes);
                    setVal('c-status', b.status || 'Confirmado');
                    setVal('c-globalDiscType', b.globalDiscountType || 'percent');
                    setVal('c-globalDiscVal', b.globalDiscountVal || 0);
                    
                    const btnDel = document.getElementById('btn-delete-booking');
                    if(btnDel) {
                        btnDel.classList.remove('hidden');
                        btnDel.onclick = () => { UI.closeModal(); App.handleDelete('Bookings', id); };
                    }
                }
        
                // --- SISTEMA DE PROTECCIÓN DE CAMBIOS V1 ---
                
                // 1. Función para tomar una "Foto" del estado actual del formulario
                const getFormSnapshot = () => {
                    return JSON.stringify({
                        cust: document.getElementById('c-customerName')?.value,
                        ced: document.getElementById('c-customerCedula')?.value,
                        stat: document.getElementById('c-status')?.value,
                        tel: document.getElementById('c-customerPhone')?.value,
                        email: document.getElementById('c-customerEmail')?.value,
                        addr: document.getElementById('c-customerAddress')?.value,
                        notes: document.getElementById('c-globalNotes')?.value,
                        discT: document.getElementById('c-globalDiscType')?.value,
                        discV: document.getElementById('c-globalDiscVal')?.value,
                        lines: window.tempBookingLines // Esto detecta cambios en items, precios, fechas, etc.
                    });
                };
        
                // 2. Guardamos el estado inicial (Original)
                const initialState = getFormSnapshot();
        
                // 3. Función Segura de Cierre (CON MODAL PROPIO)
                App.attemptCloseBooking = () => {
                    const currentState = getFormSnapshot();
                    
                    // Si no hay cambios, cerramos normal
                    if (currentState === initialState) {
                        UI.closeModal();
                        return;
                    }
        
                    // SI HAY CAMBIOS: Mostramos Modal Personalizado (Z-Index Superior)
                    // Creamos el overlay dinámicamente
                    const overlay = document.createElement('div');
                    overlay.className = "fixed inset-0 z-[100000] bg-black/80 backdrop-blur-sm flex items-center justify-center opacity-0 transition-opacity duration-200";
                    
                    // HTML del Modal (Estilo idéntico a tu sistema)
                    overlay.innerHTML = `
                        <div class="bg-[#0a0a0a] border border-white/10 rounded-xl p-6 w-[90%] max-w-sm shadow-2xl transform scale-95 transition-transform duration-200">
                            <div class="text-center mb-5">
                                <div class="w-12 h-12 rounded-full bg-red-500/10 flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                                </div>
                                <h3 class="text-white font-bold text-lg mb-2">Cambios sin guardar</h3>
                                <p class="text-gray-400 text-sm leading-relaxed">
                                    Tienes modificaciones pendientes en esta reserva. Si sales ahora, perderás todos los cambios no guardados.
                                </p>
                            </div>
                            <div class="flex gap-3">
                                <button id="btn-alert-stay" class="flex-1 px-4 py-2 rounded text-sm font-bold text-gray-400 hover:text-white border border-white/10 hover:border-white transition-colors">
                                    Seguir Editando
                                </button>
                                <button id="btn-alert-leave" class="flex-1 px-4 py-2 rounded text-sm font-bold text-white bg-red-600 hover:bg-red-700 shadow-lg transition-colors">
                                    Salir y Perder
                                </button>
                            </div>
                        </div>
                    `;
        
                    document.body.appendChild(overlay);
        
                    // Animación de entrada
                    requestAnimationFrame(() => {
                        overlay.classList.remove('opacity-0');
                        overlay.querySelector('div').classList.remove('scale-95');
                        overlay.querySelector('div').classList.add('scale-100');
                    });
        
                    // Acción: QUEDARSE
                    overlay.querySelector('#btn-alert-stay').onclick = () => {
                        overlay.classList.add('opacity-0');
                        setTimeout(() => overlay.remove(), 200);
                    };
        
                    // Acción: SALIR (Destruye todo)
                    overlay.querySelector('#btn-alert-leave').onclick = () => {
                        overlay.remove();
                        UI.closeModal(); // Cierra el modal principal de reserva
                    };
                };
        
                // 4. Interceptamos los botones de Cerrar y Cancelar del HTML
                // Buscamos cualquier botón que tenga onclick="UI.closeModal()" y lo reemplazamos
                const closeButtons = document.querySelectorAll('#reservation-modal-content button[onclick="UI.closeModal()"]');
                closeButtons.forEach(btn => {
                    btn.removeAttribute('onclick'); // Quitar el viejo
                    btn.onclick = (e) => {
                        e.preventDefault();
                        App.attemptCloseBooking(); // Poner el nuevo protegido
                    };
                });
        
        
                // --- FIN SISTEMA PROTECCIÓN ---
        

                
                // B. Helpers y Cálculos (Tu lógica original se mantiene igual)
                const formatMoney = (amount) => {
                    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(amount);
                };
        
                // FILTRO APLICADO: Si status es 'blocked', NO aparece en la lista.
                const itemsList = (AppState.data.RentalItems || [])
                    .filter(i => i.status !== 'blocked')
                    .sort((a,b) => a.name.localeCompare(b.name));
                
                window.recalcBooking = () => {

                    
                    let globalSub=0, totalTax=0, minD=null, maxD=null;
                    
                    window.tempBookingLines.forEach(line => {
                        if(line.startDate) { if(!minD || line.startDate < minD) minD = line.startDate; }
                        if(line.endDate) { if(!maxD || line.endDate > maxD) maxD = line.endDate; }
                        
                        const item = itemsList.find(i => i.id === line.itemId);
                        const bp = item ? parseFloat(item.pricePerDay) : 0;
                        const hasTax = item ? (String(item.hasTax).toUpperCase() === 'TRUE') : false;
                        
                        let d = 0;
                        if(line.startDate && line.endDate) {
                            const diff = new Date(line.endDate) - new Date(line.startDate);
                            if(!isNaN(diff) && diff >= 0) d = Math.ceil(diff/86400000) + 1;
                        }
                        const gross = bp * d;
                        let disc = (line.discountType==='money') ? line.discountVal : (gross * (line.discountVal/100));
                        const net = Math.max(0, gross - disc + line.manualAdj);
                        line.computedNet = net;
                        if(hasTax) totalTax += (net * 0.13);
                        globalSub += net;
        
                        const row = document.getElementById(`row-${line.uuid}`);
                        if(row) {
                            const inputTotal = row.querySelector('.line-total-input');
                            if(document.activeElement !== inputTotal) {
                                inputTotal.value = net.toFixed(2);
                            }
                            const info = row.querySelector('.line-info');
                            const taxLabel = hasTax ? '<span class="text-gray-400 font-bold ml-1">+IVA</span>' : '';
                            info.innerHTML = `${d}d x $${bp}${taxLabel} ${line.manualAdj>0 ? `(Aj:${line.manualAdj})` : ''}`;
                        }
                    });
        
                    const gType = document.getElementById('c-globalDiscType').value;
                    const gVal = parseFloat(document.getElementById('c-globalDiscVal').value) || 0;
                    let gDisc = (gType==='money') ? gVal : (globalSub * (gVal/100));
                    const final = Math.max(0, globalSub - gDisc + totalTax);
        
                    document.getElementById('lbl-global-subtotal').innerText = formatMoney(globalSub);
                    document.getElementById('lbl-global-discount').innerText = formatMoney(gDisc * -1);
                    document.getElementById('lbl-global-tax').innerText = formatMoney(totalTax);
                    document.getElementById('lbl-global-total').innerText = formatMoney(final);
                    
                    const fmt = d => d ? d.split('-').reverse().join('/') : '--';
                    document.getElementById('disp-date-range').innerText = `${fmt(minD)} a ${fmt(maxD)}`;
                };

                // Helper para abrir galería desde la reserva
                window.viewItemGallery = (itemId) => {
                    const images = (AppState.data.RentalItemImages || []).filter(img => img.itemId === itemId);
                    if(images.length === 0) { UI.showToast('Sin imágenes', 'info'); return; }
                    
                    // Cargamos las imágenes en la memoria del lightbox y abrimos el primero
                    currentModalImages = images.sort((a, b) => (parseInt(a.order) || 99) - (parseInt(b.order) || 99));
                    UI.openLightbox(images[0].id);
                };
                
                const renderRow = (line) => {
                    const div = document.createElement('div');
                    div.id = `row-${line.uuid}`;
                    div.className = "grid grid-cols-12 gap-2 items-start bg-[#161616] p-3 border border-white/10 text-xs shadow-sm mb-1 group hover:border-white/20 transition-colors";
                    
                    // 1. Obtener imagen de portada
                    const allImgs = AppState.data.RentalItemImages || [];
                    const itemImgs = allImgs.filter(m => m.itemId === line.itemId);
                    const coverImg = itemImgs.find(m => String(m.isCover).toLowerCase() === 'si') || itemImgs[0];
                    const imgUrl = coverImg ? coverImg.imageUrl : 'https://placehold.co/50x50/222/555?text=Img';
                    const cursorClass = itemImgs.length > 0 ? 'cursor-pointer hover:opacity-80' : 'cursor-default';
                    const clickAction = itemImgs.length > 0 ? `onclick="window.viewItemGallery('${line.itemId}')"` : '';
        
                    div.innerHTML = `
                        <div class="col-span-4 flex gap-2">
                            <div class="w-12 h-12 flex-shrink-0 bg-[#222] rounded border border-white/10 overflow-hidden ${cursorClass}" ${clickAction} title="Ver Galería">
                                <img src="${imgUrl}" class="w-full h-full object-cover" referrerpolicy="no-referrer">
                            </div>
        
                            <div class="flex-1 min-w-0">
                                <select class="dark-select w-full text-xs p-1 rounded border border-white/10 mb-1 line-item-select bg-[#222]">
                                    <option value="">Equipo...</option>
                                    ${itemsList.map(i => `<option value="${i.id}" ${i.id === line.itemId ? 'selected' : ''}>${i.name}</option>`).join('')}
                                </select>
                                <textarea class="form-input w-full text-[10px] p-1 border-none bg-transparent line-note text-gray-400 focus:text-white placeholder-gray-600 resize-none subtle-scrollbar leading-tight" placeholder="Nota..." rows="1" style="min-height: 22px;">${line.note}</textarea>
                            </div>
                        </div>
        
                        <div class="col-span-3 flex flex-col gap-1">
                            <input type="text" class="grid-input bg-[#222] rounded border border-white/10 p-1 line-start text-center cursor-pointer" placeholder="Inicio" value="${line.startDate||''}">
                            <input type="text" class="grid-input bg-[#222] rounded border border-white/10 p-1 line-end text-center cursor-pointer" placeholder="Fin" value="${line.endDate||''}">
                        </div>
                        <div class="col-span-3">
                            <div class="flex items-center border border-white/10 rounded bg-[#222]">
                                <select class="dark-select text-[10px] p-1 border-r border-white/10 line-disc-type outline-none bg-transparent"><option value="percent" ${line.discountType==='percent'?'selected':''}>%</option><option value="money" ${line.discountType==='money'?'selected':''}>$</option></select>
                                <input type="number" step="0.01" class="bg-transparent text-white text-right text-xs p-1 w-full outline-none line-disc-val" value="${line.discountVal}">
                            </div>
                        </div>
                        <div class="col-span-1 text-right">
                            <input type="number" step="0.01" class="grid-input text-right font-bold text-white text-[11px] border-b border-white/10 focus:border-[#B8860B] line-total-input" value="0">
                            <div class="line-info text-xs text-gray-400 mt-1 font-mono"></div>
                        </div>
                        <div class="col-span-1 text-center flex flex-col justify-center h-full">
                            <button type="button" class="text-gray-500 hover:text-red-500 line-delete transition p-2"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
        
                    const getBlocks = (itemId) => {
                        if(!itemId) return [];
                        const myId = document.getElementById('input-reserva-id').value;
                        return (AppState.data.BlockedDates||[]).filter(b => b.itemId === itemId && b.bookingId !== myId).map(b => ({ from: b.startDate, to: b.endDate }));
                    };
                    const fpCfg = { locale: 'es', dateFormat: "Y-m-d", minDate: "today", disable: getBlocks(line.itemId) };
                    const fpS = flatpickr(div.querySelector('.line-start'), { ...fpCfg, onChange: (d,s) => { line.startDate=s; if(fpE) fpE.set('minDate', s); window.recalcBooking(); } });
                    const fpE = flatpickr(div.querySelector('.line-end'), { ...fpCfg, onChange: (d,s) => { line.endDate=s; window.recalcBooking(); } });
        
                    div.querySelector('.line-item-select').addEventListener('change', (e) => {
                        line.itemId = e.target.value;
                        const newB = getBlocks(line.itemId);
                        fpS.set('disable', newB); fpE.set('disable', newB);
                        
                        // Actualizar la foto al cambiar el equipo (Re-render manual simple)
                        // Buscamos las nuevas fotos y actualizamos el src y el onclick del div de imagen
                        const newImgs = (AppState.data.RentalItemImages || []).filter(m => m.itemId === line.itemId);
                        const newCover = newImgs.find(m => String(m.isCover).toLowerCase() === 'si') || newImgs[0];
                        const imgTag = div.querySelector('img');
                        const imgDiv = imgTag.parentElement;
                        
                        imgTag.src = newCover ? newCover.imageUrl : 'https://placehold.co/50x50/222/555?text=Img';
                        
                        if (newImgs.length > 0) {
                            imgDiv.onclick = () => window.viewItemGallery(line.itemId);
                            imgDiv.classList.add('cursor-pointer', 'hover:opacity-80');
                            imgDiv.classList.remove('cursor-default');
                        } else {
                            imgDiv.onclick = null;
                            imgDiv.classList.remove('cursor-pointer', 'hover:opacity-80');
                            imgDiv.classList.add('cursor-default');
                        }
        
                        window.recalcBooking();
                    });
                    div.querySelector('.line-note').addEventListener('input', function(e) { line.note = this.value; this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; });
                    div.querySelector('.line-disc-type').addEventListener('change', e => { line.discountType=e.target.value; line.manualAdj=0; window.recalcBooking(); });
                    div.querySelector('.line-disc-val').addEventListener('input', e => { line.discountVal=parseFloat(e.target.value)||0; line.manualAdj=0; window.recalcBooking(); });
                    
                    div.querySelector('.line-total-input').addEventListener('input', e => {
                        const userVal = parseFloat(e.target.value)||0;
                        const item = itemsList.find(i=>i.id===line.itemId);
                        const bp = item ? parseFloat(item.pricePerDay) : 0;
                        let d = 0; if(line.startDate && line.endDate) { const diff = new Date(line.endDate)-new Date(line.startDate); if(diff>=0) d=Math.ceil(diff/86400000)+1; }
                        const gross = bp*d;
                        const diff = gross - userVal;
                        if(diff>0) { line.manualAdj=0; if(line.discountType==='money') line.discountVal=diff; else line.discountVal=gross>0?(diff/gross)*100:0; }
                        else { line.discountVal=0; line.manualAdj=Math.abs(diff); }
                        window.recalcBooking();
                    });
                    div.querySelector('.line-delete').addEventListener('click', () => { window.tempBookingLines = window.tempBookingLines.filter(l=>l.uuid!==line.uuid); div.remove(); window.recalcBooking(); });
        
                    document.getElementById('lines-container').appendChild(div);
                };
        
                if(window.tempBookingLines.length === 0) {
                    const today = new Date().toISOString().split('T')[0];
                    window.tempBookingLines.push({ uuid: `l_${Date.now()}`, itemId:'', startDate:today, endDate:today, basePrice:0, discountType:'percent', discountVal:0, manualAdj:0, note:'' });
                }
                window.tempBookingLines.forEach(l => renderRow(l));
                window.recalcBooking();
        
                document.getElementById('btn-add-line').addEventListener('click', () => {
                    const today = new Date().toISOString().split('T')[0];
                    const newLine = { uuid: `l_${Date.now()}`, itemId:'', startDate:today, endDate:today, basePrice:0, discountType:'percent', discountVal:0, manualAdj:0, note:'' };
                    window.tempBookingLines.push(newLine);
                    renderRow(newLine);
                    window.recalcBooking();
                });
        
                document.getElementById('c-globalDiscType').addEventListener('change', window.recalcBooking);
                document.getElementById('c-globalDiscVal').addEventListener('input', window.recalcBooking);
        
            }, 200);
        
            return; // Detener flujo
        } else if(sheet === 'BlockedDates'){
             // 1. Obtener Datos para Edición
             const b = isNew ? {} : AppState.data.BlockedDates.find(x => x.blockId === id);
             
             // --- NUEVO: DETECCIÓN DE VÍNCULO (Redirección a Reserva) ---
             // Si la columna bookingId tiene datos, es un bloqueo automático
             if (b && b.bookingId && String(b.bookingId) !== "undefined" && String(b.bookingId).trim() !== "") {
                 UI.showToast('🔒 Este bloqueo pertenece a una Reserva. Redirigiendo a la reserva...', 'info');
                 
                 // Cerrar este intento de modal y abrir la reserva dueña
                 setTimeout(() => {
                     App.handleEditCrudItem('Bookings', b.bookingId); 
                 }, 500); 
                 return; // Detener apertura del modal de bloqueo
             }
             // -----------------------------------------------------------

             const items = (AppState.data.RentalItems || []).sort((a,b) => a.name.localeCompare(b.name));
             
             // Obtener nombre del equipo actual (si editamos) o el primero de la lista (si es nuevo)
             const currentItemId = b?.itemId || items[0]?.id;
             const currentItemName = items.find(i => i.id === currentItemId)?.name || 'Equipo';

             // 2. Título Dinámico Inicial
             modalTitle = isNew ? 'Nuevo Bloqueo' : `Editar Bloqueo de Equipo ${currentItemName}`;

             // 3. HTML (Usamos inputs de texto normales para que Flatpickr tome el control)
             // Agregamos un ID especial al select para escuchar cambios
             html = `
                <div class="mb-4">
                    <label class="form-label">Equipo a Bloquear</label>
                    <select id="c-itemId" data-key="itemId" class="form-select" onchange="App.updateBlockModalTitle(this)">
                        ${items.map(i => `<option value="${i.id}" ${i.id === (b?.itemId||'') ? 'selected' : ''}>${i.name}</option>`).join('')}
                    </select>
                </div>
                ${UI.inputHTML('c', 'reason', 'Motivo del Bloqueo', b?.reason)}
                <div class="grid grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label class="form-label">Desde</label>
                        <input type="text" id="c-startDate" data-key="startDate" class="form-input bg-white cursor-pointer" value="${b?.startDate||''}" placeholder="Seleccionar...">
                    </div>
                    <div class="mb-4">
                        <label class="form-label">Hasta</label>
                        <input type="text" id="c-endDate" data-key="endDate" class="form-input bg-white cursor-pointer" value="${b?.endDate||''}" placeholder="Seleccionar...">
                    </div>
                </div>
             `;

             // 4. INICIALIZACIÓN DEL CALENDARIO INTELIGENTE (Flatpickr)
             // Esto se ejecuta un poco después para que el HTML ya exista en el DOM
             setTimeout(() => {
                 const startInput = document.getElementById('c-startDate');
                 const endInput = document.getElementById('c-endDate');
                 const itemSelect = document.getElementById('c-itemId');

                 // Función para calcular fechas deshabilitadas
                 const getDisabledDates = (selectedItemId) => {
                     const allBlocks = AppState.data.BlockedDates || [];
                     // Filtramos bloqueos de ESTE equipo, EXCLUYENDO el que estamos editando (si existe)
                     const relevantBlocks = allBlocks.filter(blk => blk.itemId === selectedItemId && blk.blockId !== id);
                     
                     return relevantBlocks.map(blk => ({
                         from: blk.startDate,
                         to: blk.endDate
                     }));
                 };

                 // Configuración base de Flatpickr
                 const config = {
                     locale: 'es',
                     dateFormat: "Y-m-d",
                     disable: getDisabledDates(itemSelect.value), // Bloqueo inicial
                     minDate: "today" // No permitir bloquear el pasado (opcional)
                 };

                 // Iniciar instancias
                 const fpStart = flatpickr(startInput, { ...config, onChange: (d) => fpEnd.set('minDate', d[0]) });
                 const fpEnd = flatpickr(endInput, config);

                 // Escuchar cambios en el SELECT de equipo para actualizar los días bloqueados
                 itemSelect.addEventListener('change', (e) => {
                     const newItemId = e.target.value;
                     const newDisabled = getDisabledDates(newItemId);
                     
                     // Actualizar calendarios con los bloqueos del nuevo equipo
                     fpStart.set('disable', newDisabled);
                     fpEnd.set('disable', newDisabled);
                     
                     // Limpiar fechas si cambias de equipo para evitar conflictos
                     fpStart.clear();
                     fpEnd.clear();
                 });

                 // Helper global para actualizar título (Punto 4 dinámico)
                 App.updateBlockModalTitle = (select) => {
                     const text = select.options[select.selectedIndex].text;
                     const titleEl = document.querySelector('#modal-container h2');
                     if(titleEl) {
                         // Detectamos si es nuevo o edición basado en si hay ID
                         const prefix = id ? 'Editar Bloqueo de Equipo' : 'Nuevo Bloqueo de Equipo'; 
                         // Si es nuevo, el usuario pidió solo "Nuevo Bloqueo", pero si selecciona equipo es util ver cual
                         // Ajustemos a la petición exacta:
                         if (!id) titleEl.innerText = 'Nuevo Bloqueo'; // Título fijo para nuevo según solicitud
                         else titleEl.innerText = `Editar Bloqueo de Equipo ${text}`;
                     }
                 };

             }, 100);
            
        } else if (sheet === 'LogosClientes') {
            // Resetear variable de basura al abrir
            App.tempUploadedFileId = null;

            const l = isNew ? {} : AppState.data.LogosClientes.find(x => String(x.id) === String(id));
            
            // PUNTO 5: Título Específico
            modalTitle = isNew ? 'Nuevo Logo' : `Editar Logo de ${l.clientName}`;

            let nextOrder = 1;
            if (isNew && AppState.data.LogosClientes?.length > 0) {
                nextOrder = Math.max(...AppState.data.LogosClientes.map(i => parseInt(i.order)||0)) + 1;
            }

            // PUNTO 4: Botón Eliminar a la izquierda si es edición
            if (!isNew) {
                leftButtons = `
                    <button class="btn btn-danger h-10 px-3 mr-2" onclick="UI.closeModal(); App.handleDelete('LogosClientes', '${id}')">
                        <i class="fas fa-trash mr-2"></i> Eliminar
                    </button>
                `;
            }

            // PUNTO 3: HTML sin etiqueta FileID visible
            html = `
                ${UI.inputHTML('c', 'order', 'Orden', l?.order || nextOrder, 'number')}
                ${UI.inputHTML('c', 'clientName', 'Nombre del Cliente', l?.clientName)}
                
                <div class="mb-4">
                    <label class="form-label">Logo</label>
                    <div class="flex items-center gap-4 bg-gray-50 p-3 rounded border border-gray-200">
                        <div class="w-16 h-16 bg-white border rounded flex items-center justify-center overflow-hidden">
                            <img id="modal-logo-preview" src="${l?.logoUrl || 'https://placehold.co/100?text=Logo'}" class="max-w-full max-h-full object-contain">
                        </div>
                        <div>
                            <input type="file" id="modal-logo-upload" class="hidden" accept="image/*" onchange="App.previewSingleLogo(this)">
                            
                            <button type="button" class="btn btn-secondary text-xs" onclick="document.getElementById('modal-logo-upload').click()">
                                <i class="fas fa-upload mr-2"></i> Subir / Cambiar
                            </button>
                        </div>
                    </div>
                    <input type="hidden" id="c-logoUrl" value="${l?.logoUrl||''}">
                    <input type="hidden" id="c-fileId" value="${l?.fileId||''}">
                </div>
            `;
        }
        // 3. Footer Estratégico
        // Detectamos si estamos en Logos para cambiar la acción de Cancelar
        const cancelFn = (sheet === 'LogosClientes') ? "App.cancelLogoModal()" : "UI.closeModal()";

        const footer = `
            <div class="flex justify-between items-center w-full">
                <div class="flex items-center">
                    ${leftButtons}
                </div>
                <div class="flex items-center gap-2">
                    <button class="btn btn-secondary" onclick="${cancelFn}">Cancelar</button>
                    <button class="btn btn-primary" onclick="App.saveCrud('${sheet}','${id}')">Guardar</button>
                </div>
            </div>
        `;

        UI.showModal(modalTitle, `<form id="crud-form">${html}</form>`, footer);
    },

   // --- GESTIÓN DE CONTENIDO DE SERVICIOS (SISTEMA MAESTRO-DETALLE) ---

    handleServiceContent(id, title) {
        // 1. Cargar datos a memoria local
        currentServiceBlocks = JSON.parse(JSON.stringify(
            (AppState.data.ServiceContentBlocks || []).filter(b => b.serviceId === id)
        ));
        pendingDeletions = []; 

        // Renderizar la vista de lista inicial
        this.renderServiceBlocksModal(id, title);
    },

    // Renderiza el modal en "Modo Lista"
    renderServiceBlocksModal(serviceId, title) {
        const modalTitle = `Contenido: ${title}`;
        const html = `<div id="service-blocks-container" class="max-h-[60vh] overflow-y-auto mb-4 space-y-2 p-1"></div>`;
        
        const footer = `
            <div class="flex justify-between w-full">
                <button class="btn btn-secondary" onclick="App.addServiceBlockLocal('${serviceId}')">
                    <i class="fas fa-plus mr-2"></i> Nuevo Bloque
                </button>
                <div class="flex gap-2">
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancelar</button>
                    <button class="btn btn-primary" onclick="App.saveServiceBlocks('${serviceId}')">Guardar Todo</button>
                </div>
            </div>`;

        UI.showModal(modalTitle, html, footer);
        this.renderServiceBlocksList(serviceId, title);
    },

    // Renderiza la lista de bloques (Drag & Drop)
    renderServiceBlocksList(serviceId, serviceTitle) {
        const container = document.getElementById('service-blocks-container');
        if (!container) return;

        const sortedBlocks = currentServiceBlocks.sort((a, b) => (parseInt(a.order) || 99) - (parseInt(b.order) || 99));

        if (sortedBlocks.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-400 py-8">No hay contenido aún.</p>';
            return;
        }

        container.innerHTML = sortedBlocks.map(b => `
            <div class="p-4 border rounded bg-white relative group transition-all hover:shadow-md flex items-center gap-4"
                 draggable="true"
                 ondragstart="App.dragStartBlock(event, '${b.id}')"
                 ondragover="App.dragOverBlock(event)"
                 ondrop="App.dragDropBlock(event, '${b.id}')">
                
                <div class="text-gray-300 cursor-move hover:text-gray-600"><i class="fas fa-grip-vertical"></i></div>

                <div class="flex-1">
                    <div class="flex justify-between items-center mb-1">
                        <h4 class="font-bold text-sm">${b.blockTitle || '(Sin Título)'}</h4>
                        <span class="text-xs bg-gray-100 px-2 py-0.5 rounded text-gray-500">Orden: ${b.order}</span>
                    </div>
                    <div class="text-xs text-gray-500 truncate max-w-xs">${b.blockContentHtml?.replace(/<[^>]*>/g, '') || '...'}</div>
                </div>

                <div class="flex gap-2">
                    <button class="text-blue-500 p-2 hover:bg-blue-50 rounded" onclick="App.openBlockEditor('${b.id}', '${serviceId}', '${serviceTitle}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="text-red-400 p-2 hover:bg-red-50 rounded" onclick="App.deleteServiceBlockLocal('${b.id}', '${serviceId}', '${serviceTitle}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    },

    // Abre el "Modo Editor" para un bloque específico (Quill)
    openBlockEditor(blockId, serviceId, serviceTitle) {
        const block = currentServiceBlocks.find(b => b.id === blockId);
        if (!block) return;

        const modalTitle = `Editar Bloque: ${block.blockTitle}`;
        const html = `
            <div class="space-y-4">
                ${UI.inputHTML('blk', 'blockTitle', 'Título de Sección', block.blockTitle)}
                <div class="mb-4">
                    <label class="form-label">Contenido (Texto Rico)</label>
                    <div id="editor-block-content" class="h-64"></div>
                </div>
            </div>`;

        const footer = `
            <div class="flex justify-end gap-2 w-full">
                <button class="btn btn-secondary" onclick="App.renderServiceBlocksModal('${serviceId}', '${serviceTitle}')">Volver</button>
                <button class="btn btn-primary" onclick="App.saveBlockEditor('${blockId}', '${serviceId}', '${serviceTitle}')">Aplicar Cambios</button>
            </div>`;

        UI.showModal(modalTitle, html, footer);

        // Iniciar Quill para el bloque
        setTimeout(() => {
            activeQuillEditor = new Quill('#editor-block-content', {
                theme: 'snow',
                modules: { 
                    toolbar: [
                        ['bold', 'italic', 'underline'], 
                        [{ 'align': [] }], // Alineación añadida
                        [{ 'header': 1 }, { 'header': 2 }], 
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }], 
                        ['clean'] // Limpiar formato
                    ] 
                }
            });
            if (block.blockContentHtml) activeQuillEditor.root.innerHTML = block.blockContentHtml;
        }, 100);
    },

    // Guarda los cambios del editor en memoria y vuelve a la lista
    saveBlockEditor(blockId, serviceId, serviceTitle) {
        const block = currentServiceBlocks.find(b => b.id === blockId);
        if (block && activeQuillEditor) {
            block.blockTitle = document.getElementById('blk-blockTitle').value;
            block.blockContentHtml = activeQuillEditor.root.innerHTML;
            block._modified = true;
        }
        this.renderServiceBlocksModal(serviceId, serviceTitle);
    },

    // Agrega un bloque nuevo y abre su editor inmediatamente
    addServiceBlockLocal(serviceId) {
        let nextOrder = 1;
        if (currentServiceBlocks.length > 0) nextOrder = Math.max(...currentServiceBlocks.map(b => parseInt(b.order) || 0)) + 1;

        const newBlock = {
            id: `blk_${Date.now()}`,
            serviceId: serviceId,
            blockTitle: '',
            blockContentHtml: '',
            order: nextOrder,
            _isNew: true
        };
        currentServiceBlocks.push(newBlock);
        // Obtener título para volver
        const s = AppState.data.Services.find(x => x.id === serviceId);
        this.openBlockEditor(newBlock.id, serviceId, s?.title || '');
    },

    deleteServiceBlockLocal(id, serviceId, serviceTitle) {
        const index = currentServiceBlocks.findIndex(b => b.id === id);
        if (index > -1) {
            const item = currentServiceBlocks[index];
            if (!item._isNew) pendingDeletions.push(item);
            currentServiceBlocks.splice(index, 1);
            this.renderServiceBlocksList(serviceId, serviceTitle); // Repintado inmediato
        }
    },

    // Lógica de Reordenamiento (Drag & Drop para bloques)
    dragStartBlock(e, id) { e.dataTransfer.setData("text/plain", id); },
    dragOverBlock(e) { e.preventDefault(); },
    dragDropBlock(e, targetId) {
        e.preventDefault();
        const movedId = e.dataTransfer.getData("text/plain");
        if (movedId === targetId) return;
        
        // Lógica simple de swap de orden visual
        const movedBlock = currentServiceBlocks.find(b => b.id === movedId);
        const targetBlock = currentServiceBlocks.find(b => b.id === targetId);
        
        if (movedBlock && targetBlock) {
             const tempOrder = movedBlock.order;
             movedBlock.order = targetBlock.order;
             targetBlock.order = tempOrder;
             movedBlock._modified = true;
             targetBlock._modified = true;
             
             const s = AppState.data.Services.find(x => x.id === movedBlock.serviceId);
             this.renderServiceBlocksList(movedBlock.serviceId, s?.title);
        }
    },

    // Guardado Final a API
    async saveServiceBlocks(serviceId) {
        UI.showLoading('Guardando contenido...');
        try {
            const batch = [];
            pendingDeletions.forEach(b => batch.push({ sheet: 'ServiceContentBlocks', action: 'delete', criteria: { id: b.id } }));
            currentServiceBlocks.forEach(b => {
                if (b._modified || b._isNew) {
                    const { _isNew, _modified, ...cleanData } = b;
                    const action = b._isNew ? 'add' : 'update';
                    const criteria = b._isNew ? null : { id: b.id };
                    batch.push({ sheet: 'ServiceContentBlocks', action, criteria, data: cleanData });
                }
            });

            if (batch.length > 0) {
                await API.batchUpdate(batch, "Actualizando contenido...");
                
                // 1. Actualizar datos en memoria desde el servidor
                await App.ensureDataForView('services', true);
                
                // 2. AJUSTE CRÍTICO: Forzar repintado de la tabla para ver los contadores nuevos
                if (AppState.view === 'services') {
                    UI.renderView('services');
                }
                
                UI.showToast('Contenido actualizado');
                UI.closeModal();
            } else {
                UI.showToast('No hay cambios', 'info');
                UI.closeModal();
            }
        } catch(e) { console.error(e); UI.showToast("Error: "+e.message, 'error'); } finally { UI.hideLoading(); }
    },
    
    async addServiceBlock(sid) {
        try { await API.call('/.netlify/functions/update-sheet-data',{method:'POST',body:{sheet:'ServiceContentBlocks',action:'add',data:{id:`blk_${Date.now()}`,serviceId:sid,blockTitle:'Nuevo',blockContentHtml:'',order:99}}}); await App.ensureDataForView('services', true); const s=AppState.data.Services.find(x=>x.id===sid); this.handleServiceContent(sid,s.title); } catch(e){alert(e.message);}
    },

    // --- Helper para Filtro de Bloqueos ---
    setBlockedFilter(val) {
        AppState.blockedDatesFilter = val; // Guardamos el filtro en memoria
        UI.renderView('rentals'); // Refrescamos para ver el cambio
    },

    // --- INICIO CÓDIGO NUEVO ---
    handleManualBooking() {
        this.handleEditCrudItem('Bookings', null);
    },
    // --- FIN CÓDIGO NUEVO ---

    // NUEVA FUNCIÓN PARA MANEJO INTELIGENTE DEL FILTRO
    handleFilterChange(selectElement) {
        const customDiv = document.getElementById('dash-custom-dates');
        
        if (selectElement.value === 'custom') {
            // Mostrar inputs y esperar botón check
            if (customDiv) {
                customDiv.classList.remove('hidden');
                customDiv.classList.add('flex');
                
                if(!customDiv.dataset.init) {
                    flatpickr("#dash-date-start", { locale: 'es' });
                    flatpickr("#dash-date-end", { locale: 'es' });
                    customDiv.dataset.init = "true";
                }
            }
        } else {
            // Ocultar inputs y RECARGAR INMEDIATAMENTE
            if (customDiv) {
                customDiv.classList.add('hidden');
                customDiv.classList.remove('flex');
            }
            UI.renderView('dashboard');
        }
    },

    async saveCrud(sheet, id) {
        try {
            const isNew = !id || id === 'null';
            const data = {};
            document.querySelectorAll('#crud-form input, #crud-form textarea, #crud-form select').forEach(el => {
                data[el.id.replace('c-', '')] = el.value;
            });

            // --- BLOQUE CORREGIDO LOGOS CLIENTES ---
            if (sheet === 'LogosClientes') {
                // 1. Validaciones Básicas
                // Nota: Si es nuevo, validamos que haya archivo pendiente. Si es edición, que tenga nombre.
                if (!data.clientName) { UI.showToast('El nombre es requerido.', 'error'); return; }
               
                if (isNew && !App.pendingLogoFile) { UI.showToast('Debe seleccionar un logo.', 'error'); return; }
                if (!data.order) { UI.showToast('Orden inválido.', 'error'); return; }

                // AJUSTE: Mensaje dinámico según si es Creación o Edición
                const loadingMsg = isNew 
                    ? `Creando Logo de ${data.clientName}...` 
                    : `Editando Logo de ${data.clientName}...`;
                
                UI.showLoading(loadingMsg);

                // 2. LÓGICA DE SUBIDA DIFERIDA
                // Si el usuario seleccionó un archivo nuevo, lo subimos AHORA.
                if (App.pendingLogoFile) {
                    try {
                        console.log("Subiendo archivo a Drive...");
                        const compressed = await new Promise((resolve, reject) => { 
                            new Compressor(App.pendingLogoFile, { quality: 0.8, maxWidth: 800, success: resolve, error: reject }); 
                        });
                        const fd = new FormData(); 
                        fd.append('file', compressed, App.pendingLogoFile.name); 
                        fd.append('targetSubfolder', 'Logos'); 
                        fd.append('parentFolderName', 'Clientes');
                        
                        // SUBIDA REAL
                        const res = await API.call('/.netlify/functions/upload-image', { method: 'POST', body: fd });


                        console.log("--- DEBUG SAVE ---");
                        console.log("ID actual:", id);
                        console.log("Es nuevo?", isNew);
                        console.log("Pending File?", App.pendingLogoFile);

                        
                        // BORRADO DEL VIEJO (Si es edición y estamos reemplazando)
                        if (!isNew) {
                            // CORRECCIÓN: Convertimos ambos a String() para garantizar que lo encuentre
                            const oldItem = AppState.data.LogosClientes.find(x => String(x.id) === String(id));
                            
                            if (oldItem && oldItem.fileId && oldItem.fileId !== App.tempUploadedFileId) {
                                console.log(">> Guardando edición. Borrando logo antiguo:", oldItem.fileId);
                                App.deleteFileDirectly(oldItem.fileId);
                            } else {
                                console.warn("No se encontró imagen anterior para borrar (o ID no coincide).");
                            }
                        }

                        // ACTUALIZAR DATOS CON LO NUEVO
                        data.logoUrl = res.imageUrl;
                        data.fileId = res.fileId;
                        
                    } catch (uploadError) {
                        console.error(uploadError);
                        UI.hideLoading();
                        UI.showToast("Error subiendo la imagen al servidor.", "error");
                        return; // Detener todo si falla la subida
                    }
                } 
                // Si no hay archivo pendiente, 'data' conserva los valores de los inputs hidden (URL y ID viejos)

                // 3. LIMPIEZA DE MEMORIA
                App.pendingLogoFile = null;

                // 4. GUARDADO EN SHEETS (Igual que antes: Reordenamiento)
                const currentId = isNew ? `logo_${Date.now()}` : id;
                const currentItem = { ...data, id: currentId };

                let allItems = [...(AppState.data.LogosClientes || [])].filter(x => String(x.id) !== String(id));
                allItems.sort((a, b) => (parseInt(a.order) || 99) - (parseInt(b.order) || 99));

                let targetOrder = parseInt(data.order) || 1;
                let targetIndex = targetOrder - 1;
                if (targetIndex < 0) targetIndex = 0;
                if (targetIndex > allItems.length) targetIndex = allItems.length;

                allItems.splice(targetIndex, 0, currentItem);

                const batch = [];
                allItems.forEach((item, index) => {
                    const newOrder = index + 1;
                    if (parseInt(item.order) !== newOrder || String(item.id) === String(currentItem.id)) {
                        item.order = newOrder;
                        const isTarget = String(item.id) === String(currentItem.id);
                        const dataToSave = isTarget ? currentItem : { order: newOrder };
                        
                        batch.push({
                            sheet: 'LogosClientes',
                            action: (isTarget && isNew) ? 'add' : 'update',
                            criteria: (isTarget && isNew) ? null : { id: item.id },
                            data: dataToSave
                        });
                    }
                });
                
                await API.batchUpdate(batch, `Guardando datos de ${data.clientName}`);
                
                AppState.data.LogosClientes = allItems;
                UI.closeModal();
                UI.renderView('client-logos');
                UI.showToast('Guardado correctamente');
                UI.hideLoading();
                return;
            }
            // --- FIN BLOQUE CORREGIDO ---
            // Detectamos si es 'Projects' para aplicar reglas estrictas
            if (sheet === 'Projects') {
                const errors = [];
                const newTitle = data.title ? data.title.trim() : "";

                // Validar Título (Nombre)
                if (!newTitle) {
                    errors.push("Nombre");
                }
                // Validar Orden
                if (!data.order || isNaN(data.order)) {
                    errors.push("Orden");
                }

                // --- AJUSTE: Validación de Nombre Único ---
                // Verificamos si existe otro proyecto con el mismo nombre (ignorando mayúsculas/minúsculas)
                // Excluimos el proyecto actual (p.id !== id) por si solo estamos editando otra cosa del mismo proyecto
                const exists = (AppState.data.Projects || []).some(p => 
                    p.title.trim().toLowerCase() === newTitle.toLowerCase() && p.id !== id
                );

                if (exists) {
                    UI.showToast(`Error: Ya existe un proyecto llamado "${newTitle}". Use otro nombre.`, 'error');
                    return; // DETIENE LA EJECUCIÓN PARA EVITAR CONFLICTO DE CARPETAS
                }
                // -------------------------------------------

                // Si hay errores de campos vacíos, abortamos
                if (errors.length > 0) {
                    UI.showToast(`Faltan campos obligatorios: ${errors.join(', ')}`, 'error');
                    return; // DETIENE LA EJECUCIÓN AQUÍ
                }
            }
            
            const idField = sheet === 'BlockedDates' ? 'blockId' : 'id';
            if (isNew) data[idField] = `${sheet.toLowerCase().slice(0,5)}_${Date.now()}`;

            const itemName = data.title || data.name || 'registro';
            UI.showLoading(`Guardando ${sheet === 'Projects' ? 'proyecto' : ''} ${itemName}...`);

            // --- LOGICA ESPECIAL PARA PROYECTOS (Reordenamiento Inteligente) ---
            if (sheet === 'Projects') {
                // 1. Obtenemos la lista actual (excluyendo el que estamos editando si ya existe)
                let allProjects = [...(AppState.data.Projects || [])].filter(p => String(p.id) !== String(id));
                
                // 2. Preparamos el objeto del proyecto actual
                const currentProject = { ...data, id: isNew ? data[idField] : id };
                
                // 3. Ordenamos la lista existente por orden para asegurar la secuencia
                allProjects.sort((a, b) => (parseInt(a.order) || 99) - (parseInt(b.order) || 99));

                // 4. Calculamos dónde insertar el proyecto actual (Matemática de Array: base 0 vs base 1)
                let targetOrder = parseInt(data.order) || 1;
                let targetIndex = targetOrder - 1;
                
                // Límites de seguridad
                if (targetIndex < 0) targetIndex = 0;
                if (targetIndex > allProjects.length) targetIndex = allProjects.length;

                // 5. Insertamos el proyecto en la posición deseada (empujando al resto hacia abajo)
                allProjects.splice(targetIndex, 0, currentProject);

                // 6. Renumeramos TODOS y preparamos el lote (Batch) de actualización
                const batch = [];
                allProjects.forEach((p, index) => {
                    const newOrder = index + 1;
                    
                    // Si el orden cambió O es el proyecto que estamos guardando, lo añadimos al lote
                    if (parseInt(p.order) !== newOrder || p.id === currentProject.id) {
                        p.order = newOrder; // Actualizamos memoria local
                        
                        // Definimos los datos a guardar
                        // Si es el proyecto actual, guardamos TODOS sus datos del formulario
                        // Si es un vecino desplazado, solo guardamos su nuevo 'order'
                        const dataToSave = (p.id === currentProject.id) ? p : { order: newOrder };
                        
                        batch.push({
                            sheet: 'Projects',
                            action: (p.id === currentProject.id && isNew) ? 'add' : 'update',
                            criteria: (p.id === currentProject.id && isNew) ? null : { id: p.id },
                            data: dataToSave
                        });
                    }
                });

                // 7. Enviamos todo en una sola petición inteligente
                // Definimos el mensaje fijo "Creando proyecto [Nombre]" o "Guardando..."
                const loadingMsg = `${isNew ? 'Creando' : 'Guardando'} proyecto ${itemName}`;
                
                // Pasamos el mensaje como segundo argumento
                await API.batchUpdate(batch, loadingMsg);

                // Actualizamos memoria global para reflejar cambios inmediatamente
                AppState.data.Projects = allProjects;
                
            } else if (sheet === 'Services') {
                // --- LÓGICA UNIFICADA Y CORREGIDA PARA SERVICIOS ---
                
                // 1. CAPTURA DE INTRO (Blindada):
                // Buscamos físicamente el texto en la pantalla para asegurar que se guarde.
                const editorElement = document.querySelector('#editor-intro .ql-editor');
                if (editorElement) {
                    data.introText = editorElement.innerHTML;
                } else {
                    data.introText = activeQuillEditor ? activeQuillEditor.root.innerHTML : '';
                }

                // 2. VALIDACIONES
                const errors = [];
                if (!data.title || !data.title.trim()) errors.push("Título");
                if (!data.order || isNaN(data.order)) errors.push("Orden");
                if (!data.iconClass) errors.push("Icono");

                const exists = (AppState.data.Services || []).some(s => 
                    s.title.trim().toLowerCase() === data.title.trim().toLowerCase() && s.id !== id
                );
                if (exists) {
                    UI.showToast(`Error: Ya existe un servicio llamado "${data.title}".`, 'error');
                    return;
                }
                if (errors.length > 0) {
                    UI.showToast(`Faltan campos: ${errors.join(', ')}`, 'error');
                    return;
                }

                // 3. REORDENAMIENTO INTELIGENTE
                let allServices = [...(AppState.data.Services || [])].filter(s => String(s.id) !== String(id));
                const currentService = { ...data, id: isNew ? data[idField] : id };
                
                allServices.sort((a, b) => (parseInt(a.order) || 99) - (parseInt(b.order) || 99));

                let targetOrder = parseInt(data.order) || 1;
                let targetIndex = targetOrder - 1;
                if (targetIndex < 0) targetIndex = 0;
                if (targetIndex > allServices.length) targetIndex = allServices.length;

                allServices.splice(targetIndex, 0, currentService);

                // 4. PREPARAR EL BATCH
                const batch = [];
                allServices.forEach((s, index) => {
                    const newOrder = index + 1;
                    // Si el orden cambió O es el servicio actual
                    if (parseInt(s.order) !== newOrder || s.id === currentService.id) {
                        s.order = newOrder;
                        
                        // CLAVE DEL ÉXITO:
                        // Si es el servicio actual, enviamos 'currentService' (que ya tiene la intro capturada arriba).
                        const dataToSave = (s.id === currentService.id) ? currentService : { order: newOrder };
                        
                        batch.push({
                            sheet: 'Services',
                            action: (s.id === currentService.id && isNew) ? 'add' : 'update',
                            criteria: (s.id === currentService.id && isNew) ? null : { id: s.id },
                            data: dataToSave
                        });
                    }
                });

                // 5. ENVIAR
                const loadingMsg = `${isNew ? 'Creado' : 'Guardando'} servicio ${itemName}`;
                await API.batchUpdate(batch, loadingMsg);
                AppState.data.Services = allServices;


            } else if (sheet === 'RentalItems' || sheet === 'RentalCategories') {
                // --- LÓGICA UNIFICADA PARA ALQUILER (Equipos y Categorías) ---
                const isCat = sheet === 'RentalCategories';
                // Si es un Equipo (RentalItems), capturamos el checkbox
                if (!isCat) {
                    const taxCheckbox = document.getElementById('c-hasTax');
                    // Si la caja existe y está marcada, guardamos 'TRUE', sino 'FALSE'
                    data.hasTax = (taxCheckbox && taxCheckbox.checked) ? 'TRUE' : 'FALSE';
                }
                // ▲▲▲ FIN DEL BLOQUE NUEVO ▲▲▲
                const listName = isCat ? 'RentalCategories' : 'RentalItems';
                const nameField = isCat ? 'name' : 'name'; // Ambos usan 'name' en este caso
                
                const errors = [];
                if (!data.name || !data.name.trim()) errors.push("Nombre");
                if (!data.order || isNaN(data.order)) errors.push("Orden");
                if (!isCat && !data.pricePerDay) errors.push("Precio");
                if (!isCat && !data.categoryId) errors.push("Categoría");

                // Validación de nombre único
                const exists = (AppState.data[listName] || []).some(item => 
                    item.name.trim().toLowerCase() === data.name.trim().toLowerCase() && item.id !== id
                );
                if (exists) {
                    UI.showToast(`Error: Ya existe ${isCat ? 'una categoría' : 'un equipo'} llamado "${data.name}".`, 'error');
                    return;
                }
                if (errors.length > 0) {
                    UI.showToast(`Faltan campos: ${errors.join(', ')}`, 'error');
                    return;
                }

                // Reordenamiento Inteligente
                let allItems = [...(AppState.data[listName] || [])].filter(x => String(x.id) !== String(id));
                const currentItem = { ...data, id: isNew ? data[idField] : id };
                
                allItems.sort((a, b) => (parseInt(a.order) || 99) - (parseInt(b.order) || 99));

                let targetOrder = parseInt(data.order) || 1;
                let targetIndex = targetOrder - 1;
                if (targetIndex < 0) targetIndex = 0;
                if (targetIndex > allItems.length) targetIndex = allItems.length;

                allItems.splice(targetIndex, 0, currentItem);

                // Preparar Batch
                const batch = [];
                allItems.forEach((item, index) => {
                    const newOrder = index + 1;
                    if (parseInt(item.order) !== newOrder || String(item.id) === String(currentItem.id)) {
                        item.order = newOrder;
                        const dataToSave = (String(item.id) === String(currentItem.id)) ? currentItem : { order: newOrder };
                        batch.push({
                            sheet: sheet,
                            action: (String(item.id) === String(currentItem.id) && isNew) ? 'add' : 'update',
                            criteria: (String(item.id) === String(currentItem.id) && isNew) ? null : { id: item.id },
                            data: dataToSave
                        });
                    }
                });

                // Mensaje Personalizado
                const typeLabel = isCat ? 'Categoría' : 'Equipo';
                const loadingMsg = `${isNew ? 'Guardando' : 'Editando'} ${typeLabel} ${data.name}`; // Ajustado según solicitud
                
                await API.batchUpdate(batch, loadingMsg);
                AppState.data[listName] = allItems;
                
                // --- INICIO CÓDIGO NUEVO (GUARDADO RESERVAS) ---
            } else if (sheet === 'Bookings') {
                // 1. Validaciones
                if (!data.customerName) { UI.showToast("Falta nombre de cliente", "error"); return; }
                if (!window.tempBookingLines || window.tempBookingLines.length === 0) { UI.showToast("Debe haber al menos 1 artículo", "error"); return; }
                
                // Validar que todas las líneas tengan item y fechas
                const invalidLine = window.tempBookingLines.find(l => !l.itemId || !l.startDate || !l.endDate);
                if(invalidLine) { UI.showToast("Hay líneas incompletas (falta equipo o fechas)", "error"); return; }
            
                UI.showLoading(isNew ? "Creando Reserva..." : "Actualizando Reserva...");
            
                // 2. Preparar Datos Calculados para Cabecera (Compatibilidad Dashboard)
                // Calcular fechas globales
                const starts = window.tempBookingLines.map(l => new Date(l.start || l.startDate)); // Compatibilidad nombres
                const ends = window.tempBookingLines.map(l => new Date(l.end || l.endDate));
                const minDate = new Date(Math.min(...starts)).toISOString().split('T')[0];
                const maxDate = new Date(Math.max(...ends)).toISOString().split('T')[0];
                
                // Calcular resumen de items para el Dashboard
                const itemsList = AppState.data.RentalItems || [];
                const itemNames = window.tempBookingLines.map(l => {
                    const it = itemsList.find(i => i.id === l.itemId);
                    return it ? it.name : 'Item';
                });
                // Ej: "Cámara Sony + 2 más"
                const summaryItemName = itemNames.length > 1 
                    ? `${itemNames[0]} + ${itemNames.length - 1} más` 
                    : itemNames[0];
            
                // Total Final (Lo tomamos del DOM calculado o recalculamos)
                const finalTotal = parseFloat(document.getElementById('disp-total').innerText.replace('$','')) || 0;
            
                // 3. ID de Reserva
                if(isNew) data.id = `RES-${Date.now().toString().slice(-6)}`;
                
                // 4. PREPARAR BATCH
                const batch = [];
            
                // A. Actualizar Cabecera 'Bookings'
                const headerData = {
                    ...data,
                    startDate: minDate, // Dashboard usa esto
                    endDate: maxDate,
                    totalPrice: finalTotal, // Dashboard usa esto
                    itemName: summaryItemName, // Dashboard usa esto
                    bookingTimestamp: isNew ? new Date().toISOString() : undefined,
                    // Campos nuevos
                    globalDiscountType: document.getElementById('c-globalDiscType').value,
                    globalDiscountVal: document.getElementById('c-globalDiscVal').value,
                    globalNotes: document.getElementById('c-globalNotes')?.value || ''
                };
                
                batch.push({
                    sheet: 'Bookings',
                    action: isNew ? 'add' : 'update',
                    criteria: isNew ? null : { id: id },
                    data: headerData
                });
            
                // B. Manejo de Detalles (Estrategia: Borrar viejos del ID -> Insertar nuevos)
                if (!isNew) {
                    // Borrar lineas anteriores de esta reserva en BookingsDetails
                    // Nota: Esto requiere que el backend soporte borrar por criterio (bookingId)
                    // Como 'update-sheet-data' suele borrar por ID de fila, usamos un truco:
                    // Buscamos las filas en memoria y mandamos delete para cada una.
                    const oldLines = (AppState.data.BookingsDetails || []).filter(d => d.bookingId === id);
                    oldLines.forEach(oldL => {
                         // Asumiendo que BookingsDetails tiene columna 'id' única, si no, hay que usar row number o filtro compuesto.
                         // Si tu backend soporta delete_many_by_filter mejor. Si no, iteramos.
                         // Para seguridad, asumamos que BookingsDetails tiene un id único tipo 'bd_xxx'.
                         if(oldL.id) batch.push({ sheet: 'BookingsDetails', action: 'delete', criteria: { id: oldL.id } });
                    });
                    
                    // Borrar bloqueos viejos asociados
                    const oldBlocks = (AppState.data.BlockedDates || []).filter(b => b.bookingId === id);
                    oldBlocks.forEach(oblk => {
                        batch.push({ sheet: 'BlockedDates', action: 'delete', criteria: { blockId: oblk.blockId } });
                    });
                }
            
                // C. Insertar Nuevas Líneas y Nuevos Bloqueos
                window.tempBookingLines.forEach(line => {
                    const detailId = `bd_${Date.now()}_${Math.random().toString(36).substr(2,5)}`;
                    
                    // Detalle Contable
                    batch.push({
                        sheet: 'BookingsDetails',
                        action: 'add',
                        data: {
                            id: detailId,
                            bookingId: data.id, // Enlace FK
                            itemId: line.itemId,
                            itemName: itemsList.find(i=>i.id===line.itemId)?.name,
                            startDate: line.startDate,
                            endDate: line.endDate,
                            basePrice: line.basePrice,
                            lineDiscountType: line.discountType,
                            lineDiscountVal: line.discountVal,
                            manualAdjustment: line.manualAdj,
                            lineTotal: line.computedNet,
                            lineNote: line.note
                        }
                    });
            
                    // Bloqueo de Calendario (Si no cancelada)
                    if (data.status !== 'Cancelado') {
                        batch.push({
                            sheet: 'BlockedDates',
                            action: 'add',
                            data: {
                                blockId: `blk_${detailId}`, // Vinculado al detalle
                                bookingId: data.id,       // Vinculado a la reserva
                                itemId: line.itemId,
                                startDate: line.startDate,
                                endDate: line.endDate,
                                reason: `Reserva: ${data.customerName}`
                            }
                        });
                    }
                });
            
                // 5. ENVIAR BATCH
                await API.batchUpdate(batch, "Procesando Reserva Multi-Item...");
                
                // Limpieza
                delete window.tempBookingLines;
                window.recalcBooking = null;
                
            // --- FIN CÓDIGO NUEVO ---
            
            } else if (sheet === 'Videos') {
                // --- LÓGICA ESPECIAL VIDEOS (Validación + Reordenamiento) ---
                
                const errors = [];
                if (!data.title || !data.title.trim()) errors.push("Título");
                if (!data.order || isNaN(data.order)) errors.push("Orden");
                // (La URL no es obligatoria estrictamente por sistema, pero podrías agregarla aquí si quieres)

                // 1. Validación de duplicados (Título único)
                const exists = (AppState.data.Videos || []).some(v => 
                    v.title.trim().toLowerCase() === data.title.trim().toLowerCase() && v.id !== id
                );
                
                if (exists) {
                    UI.showToast(`Error: Ya existe un video llamado "${data.title}".`, 'error');
                    return;
                }
                if (errors.length > 0) {
                    UI.showToast(`Faltan campos: ${errors.join(', ')}`, 'error');
                    return;
                }

                // 2. Reordenamiento Inteligente
                let allVideos = [...(AppState.data.Videos || [])].filter(v => String(v.id) !== String(id));
                const currentVideo = { ...data, id: isNew ? data[idField] : id };
                
                // Ordenar existentes
                allVideos.sort((a, b) => (parseInt(a.order) || 99) - (parseInt(b.order) || 99));

                // Calcular posición de inserción
                let targetOrder = parseInt(data.order) || 1;
                let targetIndex = targetOrder - 1;
                if (targetIndex < 0) targetIndex = 0;
                if (targetIndex > allVideos.length) targetIndex = allVideos.length;

                // Insertar
                allVideos.splice(targetIndex, 0, currentVideo);

                // 3. Preparar Batch (Renumerar todo)
                const batch = [];
                allVideos.forEach((v, index) => {
                    const newOrder = index + 1;
                    // Si el orden cambia O es el video actual
                    if (parseInt(v.order) !== newOrder || v.id === currentVideo.id) {
                        v.order = newOrder;
                        const dataToSave = (v.id === currentVideo.id) ? currentVideo : { order: newOrder };
                        
                        batch.push({
                            sheet: 'Videos',
                            action: (v.id === currentVideo.id && isNew) ? 'add' : 'update',
                            criteria: (v.id === currentVideo.id && isNew) ? null : { id: v.id },
                            data: dataToSave
                        });
                    }
                });

                // 4. Enviar
                const loadingMsg = `${isNew ? 'Agregando' : 'Actualizando'} video ${data.title}`;
                await API.batchUpdate(batch, loadingMsg);
                AppState.data.Videos = allVideos;
            
            } else if (sheet === 'Bookings') {
                const errors = [];
                if (!data.customerName) errors.push("Cliente");
                if (!data.itemId) errors.push("Equipo");
                if (!data.startDate || !data.endDate) errors.push("Fechas");
                
                if (errors.length > 0) {
                    UI.showToast(`Faltan campos: ${errors.join(', ')}`, 'error');
                    return;
                }
                
                // Datos complementarios
                const item = (AppState.data.RentalItems || []).find(i => i.id === data.itemId);
                if(item) data.itemName = item.name;
                
                // Generar ID si es nuevo (Vital para el vínculo)
                if(isNew) {
                    data.id = `booking_${Date.now()}`; // Forzamos la creación del ID aquí para usarlo abajo
                    data.bookingTimestamp = new Date().toISOString();
                }

                // Mensaje Personalizado
                const msg = isNew ? `Creando Reserva para ${data.customerName}` : `Editando Reserva de ${data.customerName}`;
                UI.showLoading(`${msg}...`);

                // --- PREPARAR BATCH (LOTE DE OPERACIONES) ---
                const batch = [];

                // 1. Operación Reserva (Guardamos Dirección, Cédula, etc.)
                batch.push({
                    sheet: 'Bookings',
                    action: isNew ? 'add' : 'update',
                    criteria: isNew ? null : { id: id },
                    data: data
                });

                // 2. Operación Bloqueo Automático (El Espejo)
                // Si la reserva NO está cancelada, debe tener bloqueo
                if (data.status !== 'Cancelado') {
                    // Buscar si ya existe un bloqueo para ESTA reserva (usando la columna bookingId)
                    const existingBlock = !isNew ? (AppState.data.BlockedDates || []).find(blk => blk.bookingId === id) : null;
                    
                    const blockData = {
                        itemId: data.itemId,
                        startDate: data.startDate,
                        endDate: data.endDate,
                        reason: `Reserva: ${data.customerName} (ID: ${data.customerCedula || 'N/A'})`,
                        bookingId: isNew ? data.id : id // <--- AQUÍ SE LLENA LA COLUMNA CLAVE
                    };

                    if (existingBlock) {
                        // Actualizar bloqueo existente
                        batch.push({
                            sheet: 'BlockedDates',
                            action: 'update',
                            criteria: { blockId: existingBlock.blockId },
                            data: blockData
                        });
                    } else {
                        // Crear nuevo bloqueo vinculado
                        blockData.blockId = `blk_auto_${Date.now()}`;
                        batch.push({
                            sheet: 'BlockedDates',
                            action: 'add',
                            data: blockData
                        });
                    }
                } else {
                    // SI SE CANCELA LA RESERVA, BORRAR EL BLOQUEO
                    if (!isNew) {
                        const existingBlock = (AppState.data.BlockedDates || []).find(blk => blk.bookingId === id);
                        if (existingBlock) {
                            batch.push({
                                sheet: 'BlockedDates',
                                action: 'delete',
                                criteria: { blockId: existingBlock.blockId }
                            });
                        }
                    }
                }

                // Ejecutar todo junto
                await API.batchUpdate(batch, msg);
                

                
            // ▲▲▲ FIN DEL BLOQUE NUEVO ▲▲▲
            } else {
                // --- LÓGICA ESTÁNDAR PARA OTRAS HOJAS (Rentals, Videos, etc.) ---
                await API.call('/.netlify/functions/update-sheet-data', { 
                    method: 'POST', 
                    body: { sheet, action: isNew ? 'add' : 'update', criteria: isNew ? null : {[idField]:id}, data } 
                });
            }

            await App.ensureDataForView(AppState.view, true);
            UI.closeModal(); 
            UI.renderView(AppState.view); 
            UI.showToast('Guardado y reordenado correctamente');

        } catch (e) { 
            console.error(e);
            UI.showToast("Error al guardar: " + e.message, "error");
        } finally { 
            UI.hideLoading(); 
        }
    },
    
    async handleDelete(sheet, id, key='id') { 
        // 1. Validación de Dependencias (Categorías)
        if (sheet === 'RentalCategories') {
            const hasChildren = (AppState.data.RentalItems || []).some(item => item.categoryId === id);
            if (hasChildren) {
                UI.showToast('No se puede eliminar: Esta categoría tiene equipos asociados.', 'error');
                return; 
            }
        }

        // PUNTO 6: Mensaje de eliminación personalizado para Logos
        if (sheet === 'LogosClientes') {
            const logo = AppState.data.LogosClientes?.find(l => l.id === id);
            const clientName = logo?.clientName || 'Cliente';
            
            UI.showConfirm(`¿Eliminar Logo?`, `Se eliminará permanentemente el logo de ${clientName}.`, async () => {
                // Mensaje personalizado SIN contador
                UI.showLoading(`Eliminando Logo de ${clientName}`);
                
                try {
                    // Borrar registro y archivo asociado
                    const batch = [{
                        sheet: 'LogosClientes',
                        action: 'delete',
                        criteria: { id: id },
                        data: { fileId: logo?.fileId } // Para borrar de Drive también
                    }];
                    
                    await API.batchUpdate(batch, `Eliminando Logo de ${clientName}`);
                    
                    // Actualizar UI
                    AppState.data.LogosClientes = AppState.data.LogosClientes.filter(l => l.id !== id);
                    UI.renderView('client-logos');
                    UI.showToast('Logo eliminado');
                } catch (e) {
                    UI.showToast("Error: " + e.message, "error");
                } finally {
                    UI.hideLoading();
                }
            });
            return; // Detener flujo estándar
        }
        
        // 2. Lógica Especial de Cascada para RESERVAS
        if (sheet === 'Bookings') {
            const bookingItem = AppState.data.Bookings?.find(b => b.id === id);
            
            UI.showConfirm(`¿Eliminar Reserva ${id}?`, `Se borrarán el historial, los detalles contables y se liberarán todos los bloqueos de calendario asociados.`, async () => {
                UI.showLoading('Eliminando en cascada...');
                
                const batch = [];
                
                // 1. Borrar Cabecera
                batch.push({ sheet: 'Bookings', action: 'delete', criteria: { id: id } });
        
                // 2. Borrar Detalles (Iterar memoria actual)
                const details = (AppState.data.BookingsDetails || []).filter(d => d.bookingId === id);
                details.forEach(d => {
                    batch.push({ sheet: 'BookingsDetails', action: 'delete', criteria: { id: d.id } });
                });
        
                // 3. Borrar Bloqueos
                const blocks = (AppState.data.BlockedDates || []).filter(b => b.bookingId === id);
                blocks.forEach(b => {
                    batch.push({ sheet: 'BlockedDates', action: 'delete', criteria: { blockId: b.blockId } });
                });
        
                await API.batchUpdate(batch, "Eliminando Reserva Completa");
                
                await App.ensureDataForView(AppState.view, true);
                UI.renderView(AppState.view);
                UI.showToast('Reserva eliminada correctamente');
                UI.hideLoading();
            });
            return;
        }

        // 3. Lógica General para el resto (Proyectos, Servicios, etc.)
        const item = AppState.data[sheet]?.find(x => x[key] === id);
        let name = item?.title || item?.name || 'Registro';

        // --- LÓGICA ESPECIAL: Bloqueo -> Reserva ---
        if (sheet === 'BlockedDates') {
            const blockItem = AppState.data.BlockedDates?.find(b => b.blockId === id);
            
            // Si el bloqueo tiene ID de reserva, es automático
            if (blockItem && blockItem.bookingId && String(blockItem.bookingId) !== "undefined") {
                UI.showToast('🔒 Este bloqueo es parte de una Reserva. Abriendo la reserva...', 'info');
                
                // Redirigir al modal de la Reserva (donde ahora hay un botón ELIMINAR)
                setTimeout(() => {
                    App.handleEditCrudItem('Bookings', blockItem.bookingId);
                }, 500);
                
                return; // IMPORTANTE: Detener el borrado directo del bloqueo
            }
        }
        
        const typeLabel = sheet === 'Projects' ? 'Proyecto' : 
                         (sheet === 'Services' ? 'Servicio' : 
                         (sheet === 'RentalItems' ? 'Equipo' : 
                         (sheet === 'RentalCategories' ? 'Categoría' : 
                         (sheet === 'BlockedDates' ? 'Bloqueo del Equipo' : 
                         (sheet === 'Videos' ? 'Video' : 'Registro')))));

        const titleText = `¿Desea eliminar ${sheet === 'BlockedDates' ? 'el' : (typeLabel === 'Categoría' ? 'la' : 'el')} ${typeLabel} ${name}?`;
        const msgText = "Esta acción eliminará también las carpetas y archivos asociados.";

        UI.showConfirm(titleText, msgText, async ()=>{ 
            try {
                const parentItem = AppState.data[sheet]?.find(x => x[key] === id);
                const itemName = parentItem?.title || parentItem?.name || 'elemento';
                
                const loadTypeLabel = typeLabel; 
                const baseMessage = `Eliminando ${loadTypeLabel} ${itemName}`;
                
                UI.showLoading(`${baseMessage}...`);
                
                // Borrado en Cascada para Padres con Hijos (Imágenes)
                let childSheet = null;
                let childKey = null;

                if (sheet === 'Projects') { childSheet = 'ProjectImages'; childKey = 'projectId'; }
                else if (sheet === 'Services') { childSheet = 'ServiceImages'; childKey = 'serviceId'; }
                else if (sheet === 'RentalItems') { childSheet = 'RentalItemImages'; childKey = 'itemId'; }

                if (childSheet && AppState.data[childSheet]) {
                    const children = AppState.data[childSheet].filter(c => c[childKey] === id);
                    if (children.length > 0) {
                        const BATCH_SIZE = 10;
                        let processedCount = 0;
                        for (let i = 0; i < children.length; i += BATCH_SIZE) {
                            const batch = children.slice(i, i + BATCH_SIZE).map(child => ({
                                sheet: childSheet, action: 'delete', criteria: { id: child.id }, data: { fileId: child.fileId }
                            }));
                            processedCount += batch.length;
                            UI.showLoading(`${baseMessage} (Borrando registros ${processedCount}/${children.length})...`);
                            await API.call('/.netlify/functions/update-sheet-data', { method: 'POST', body: batch });
                            if (i + BATCH_SIZE < children.length) await new Promise(r => setTimeout(r, 1000));
                        }
                    }
                }

                UI.showLoading(`${baseMessage} (Finalizando)...`);
                const extraData = parentItem?.driveFolderId ? { fileId: parentItem.driveFolderId } : {}; 

                await API.call('/.netlify/functions/update-sheet-data',{
                    method:'POST', body:{ sheet, action:'delete', criteria:{[key]:id}, data: extraData }
                }); 

                await App.ensureDataForView(AppState.view, true); 
                UI.renderView(AppState.view); 
                UI.showToast('Eliminado correctamente'); 

            } catch(e){ 
                console.error(e);
                alert("Error al eliminar: " + e.message); 
            } finally {
                UI.hideLoading();
            }
        }); 
    },

    // Función para cambiar el título del documento en vivo
    changeDocumentTitle(newTitle) {
        const titleEl = document.getElementById('doc-type-title');
        if (titleEl) {
            titleEl.innerText = newTitle;
        }
    },

    // NUEVA FUNCIÓN PARA RESERVAS MULTI-ITEM
    async handleSaveBooking(e) {
        e.preventDefault();
        
        // Validaciones (Punto 1: Nombre desde input libre)
        const clientNameInput = document.getElementById('c-customerName');
        const clientName = clientNameInput ? clientNameInput.value : '';

        if (!clientName) { UI.showToast("Escribe el nombre del cliente", "error"); return; }
        if (!window.tempBookingLines || window.tempBookingLines.length === 0) { UI.showToast("Agrega al menos un artículo", "error"); return; }
        
        const invalid = window.tempBookingLines.find(l => !l.itemId || !l.startDate || !l.endDate);
        if(invalid) { UI.showToast("Completa los datos de las líneas", "error"); return; }

        const currentId = document.getElementById('input-reserva-id').value;
        const isNew = !currentId;
        let bookingId = currentId;
        if (isNew) {
            const now = new Date();
            bookingId = `RES-${now.getFullYear().toString().slice(-2)}${(now.getMonth()+1).toString().padStart(2,'0')}-${Math.floor(1000 + Math.random() * 9000)}`;
        }

        UI.showLoading("Guardando Reserva...");

        // Datos Cabecera
        const starts = window.tempBookingLines.map(l => new Date(l.startDate));
        const ends = window.tempBookingLines.map(l => new Date(l.endDate));
        const gStart = new Date(Math.min(...starts)).toISOString().split('T')[0];
        const gEnd = new Date(Math.max(...ends)).toISOString().split('T')[0];
        const total = parseFloat(document.getElementById('lbl-global-total').innerText.replace('$','')) || 0;
        
        const itemsRef = AppState.data.RentalItems || [];
        const names = window.tempBookingLines.map(l => itemsRef.find(i=>i.id===l.itemId)?.name || 'Item');
        const summary = names.length > 1 ? `${names[0]} + ${names.length-1}` : names[0];

        const headerData = {
            id: bookingId,
            customerName: clientName, // Texto libre
            customerPhone: document.getElementById('c-customerPhone').value,
            customerEmail: document.getElementById('c-customerEmail').value,
            customerCedula: document.getElementById('c-customerCedula').value,
            customerAddress: document.getElementById('c-customerAddress').value,
            startDate: gStart,
            endDate: gEnd,
            totalPrice: total,
            itemName: summary,
            status: document.getElementById('c-status').value,
            globalDiscountType: document.getElementById('c-globalDiscType').value,
            globalDiscountVal: document.getElementById('c-globalDiscVal').value,
            globalNotes: document.getElementById('c-globalNotes').value,
            bookingTimestamp: isNew ? new Date().toISOString() : undefined
        };

        const batch = [];
        batch.push({ sheet: 'Bookings', action: isNew ? 'add' : 'update', criteria: isNew ? null : { id: bookingId }, data: headerData });

        if (!isNew) {
            const oldLines = (AppState.data.BookingsDetails || []).filter(d => String(d.bookingId) === String(bookingId));
            oldLines.forEach(l => { if(l.id) batch.push({ sheet: 'BookingsDetails', action: 'delete', criteria: { id: l.id } }); });
            const oldBlocks = (AppState.data.BlockedDates || []).filter(b => String(b.bookingId) === String(bookingId));
            oldBlocks.forEach(b => { batch.push({ sheet: 'BlockedDates', action: 'delete', criteria: { blockId: b.blockId } }); });
        }

        window.tempBookingLines.forEach((line, idx) => {
            const detailId = `bd_${Date.now()}_${idx}`;
            batch.push({
                sheet: 'BookingsDetails',
                action: 'add',
                data: {
                    id: detailId,
                    bookingId: bookingId,
                    itemId: line.itemId,
                    itemName: itemsRef.find(i=>i.id===line.itemId)?.name,
                    startDate: line.startDate,
                    endDate: line.endDate,
                    basePrice: line.basePrice,
                    lineDiscountType: line.discountType,
                    lineDiscountVal: line.discountVal,
                    manualAdjustment: line.manualAdj,
                    lineTotal: line.computedNet,
                    lineNote: line.note
                }
            });

            if (headerData.status !== 'Cancelado') {
                batch.push({
                    sheet: 'BlockedDates',
                    action: 'add',
                    data: {
                        blockId: `blk_${detailId}`,
                        bookingId: bookingId,
                        itemId: line.itemId,
                        startDate: line.startDate,
                        endDate: line.endDate,
                        reason: `Reserva ${bookingId}: ${clientName}`
                    }
                });
            }
        });

        try {
            await API.batchUpdate(batch, "Procesando...");
            await App.loadData('dashboard'); 
            UI.closeModal();
            UI.renderView('bookings');
            UI.showToast("Reserva guardada correctamente");
        } catch(e) {
            console.error(e);
            UI.showToast("Error: " + e.message, "error");
        } finally {
            UI.hideLoading();
        }
    },

    
    async handleDeleteImage(sheet, id, row) { UI.showConfirm("¿Borrar imagen?", async ()=>{ try{ await API.call('/.netlify/functions/update-sheet-data',{method:'POST',body:{sheet,action:'delete',criteria:{id}}}); row.remove(); UI.showToast('Borrada'); }catch(e){alert(e.message);} }); },

    async quickUpdate(sheet, id, key, val) { 
        try {
            const valStr = val === true ? 'Si' : (val === false ? 'No' : val);
            await API.call('/.netlify/functions/update-sheet-data', { method: 'POST', body: { sheet, action: 'update', criteria: {id}, data: {[key]: valStr} } }); 
            if(AppState.data[sheet]) { const item = AppState.data[sheet].find(i => i.id === id); if(item) item[key] = valStr; }
            UI.showToast('Guardado');
        } catch(e) { console.error(e); UI.showToast('Error', 'error'); } 
    },
    
    async handleSaveSettings() { const data={}; document.querySelectorAll('#settings-form-container input').forEach(e=>data[e.dataset.key]=e.value); UI.showLoading('Guardando...'); try{ for(const [k,v] of Object.entries(data)) await API.call('/.netlify/functions/update-sheet-data',{method:'POST',body:{sheet:'Settings',action:'update',criteria:{key:k},data:{value:v}}}); UI.showToast('Listo'); }catch(e){alert(e.message);} finally{UI.hideLoading();} },
    async handleSaveAbout() { const data={}; document.querySelectorAll('#about-form-container textarea').forEach(e=>data[e.dataset.key]=e.value); UI.showLoading('Guardando...'); try{ for(const [k,v] of Object.entries(data)) await API.call('/.netlify/functions/update-sheet-data',{method:'POST',body:{sheet:'About',action:'update',criteria:{section:k},data:{content:v}}}); UI.showToast('Listo'); }catch(e){alert(e.message);} finally{UI.hideLoading();} },

    // A. Previsualización Local (Sin subir a Drive todavía)
    previewSingleLogo(input) {
        const file = input.files[0];
        if (!file) return;

        // 1. Guardamos el archivo en memoria para subirlo DESPUÉS (al dar Guardar)
        App.pendingLogoFile = file;

        // 2. Generamos una vista previa local inmediata
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('modal-logo-preview').src = e.target.result;
        };
        reader.readAsDataURL(file);
    },

    // B. Subida de Imágenes de Sistema (Identidad/Perfil) a Hoja 'ImagenesIdentidad'
    async uploadSystemImage(input, keyName) {
        const file = input.files[0];
        if(!file) return;

        // 1. Mensajes Personalizados
        const labels = {
            'logo_black': 'Logo Negro',
            'logo_white': 'Logo Blanco',
            'favicon': 'Favicon',
            'profile_pic': 'Foto de Perfil'
        };
        const label = labels[keyName] || 'Imagen';
        
        // Verificamos si ya existe para saber si es "Creando" o "Actualizando"
        const existing = (AppState.data.ImagenesIdentidad || []).find(i => i.key === keyName);
        const actionVerb = existing ? 'Actualizando' : 'Creando';
        
        UI.showLoading(`${actionVerb} ${label}...`);

        try {
            const compressed = await new Promise((resolve, reject) => { 
                new Compressor(file, { quality: 0.8, maxWidth: 800, success: resolve, error: reject }); 
            });
            const fd = new FormData(); 
            fd.append('file', compressed, file.name); 
            fd.append('targetSubfolder', 'Identidad'); 
            fd.append('parentFolderName', 'Sistema');
            
            const res = await API.call('/.netlify/functions/upload-image', { method: 'POST', body: fd });

            // 2. LIMPIEZA DE BASURA (El ajuste crítico)
            if (existing && existing.fileId) {
                console.log(`Eliminando ${label} anterior:`, existing.fileId);
                // Usamos la función que ya creamos y probamos con éxito
                App.deleteFileDirectly(existing.fileId);
            }

            // 3. Guardado en Sheets
            const action = existing ? 'update' : 'add';
            const criteria = existing ? { id: existing.id } : null;
            
            const newData = {
                id: existing ? existing.id : `sys_${Date.now()}`,
                key: keyName,
                imageUrl: res.imageUrl,
                fileId: res.fileId
            };

            await API.call('/.netlify/functions/update-sheet-data', { 
                method: 'POST', 
                body: { sheet: 'ImagenesIdentidad', action, criteria, data: newData } 
            });
            
            // Actualizar UI
            const previewEl = document.getElementById(`prev-${keyName}`) || document.getElementById(`preview-${keyName}`);
            if(previewEl) previewEl.src = res.imageUrl;
            
            // Actualizar Memoria
            if(!AppState.data.ImagenesIdentidad) AppState.data.ImagenesIdentidad = [];
            
            if(existing) {
                Object.assign(existing, newData);
            } else {
                AppState.data.ImagenesIdentidad.push(newData);
            }

            UI.showToast(`${label} guardado.`);
        } catch (e) {
            console.error(e);
            UI.showToast('Error: ' + e.message, 'error');
        } finally {
            UI.hideLoading();
        }
    },

    // C. Guardar Textos de Identidad/Perfil
    async handleSaveIdentityText(section) {
        // Determinar contexto
        let containerId = 'identity-form-container';
        let sheetName = 'Identidad';

        if (section === 'whoami') {
            containerId = 'whoami-form-container';
            sheetName = 'About';
        } else if (section === 'legal') {
            containerId = 'legal-form-container';
            sheetName = 'Identidad'; // Legal va en la misma hoja que redes
        }
        
        const inputs = document.querySelectorAll(`#${containerId} input, #${containerId} textarea`);
        
        UI.showLoading('Guardando Cambios...');
        try {
            const batch = [];
            const currentData = AppState.data[sheetName] || [];

            inputs.forEach(el => {
                // Obtenemos la 'key' del atributo data-key o limpiando el ID
                const key = el.dataset.key || el.id.replace('id-', '').replace('ab-', '');
                const val = el.value;
                
                if (key) {
                    const exists = currentData.some(i => i.key === key);
                    if (exists) {
                        batch.push({ sheet: sheetName, action: 'update', criteria: { key }, data: { value: val } });
                    } else if (val) { // Solo crear si tiene valor
                        batch.push({ sheet: sheetName, action: 'add', data: { key, value: val } });
                    }
                }
            });

            if(batch.length > 0) {
                await API.batchUpdate(batch, "Guardando Cambios...");
                
                // Recargar datos para confirmar
                await App.ensureDataForView('identity', true);
                UI.renderView('identity'); // Refrescar vista
                UI.showToast('Información guardada correctamente');
            } else {
                UI.showToast('No se detectaron cambios', 'info');
            }
        } catch(e) {
            console.error(e);
            UI.showToast('Error al guardar: ' + e.message, 'error');
        } finally {
            UI.hideLoading();
        }
    },

    // Cancelar ahora es simple: Solo limpia la memoria local
    cancelLogoModal() {
        App.pendingLogoFile = null; // Olvidamos el archivo
        UI.closeModal();            // Cerramos y listo. Nada pasó en el servidor.
    },
    
    // --- INICIO CÓDIGO NUEVO (Punto 2) ---
    
    // 1. Función Cerebro: Mueve un ítem y renumerar todo el resto
    reorderGlobalPortfolio(movedId, newTargetOrder) {
        // a. Obtener todas las imágenes que están en portfolio
        let portfolioList = (AppState.data.ProjectImages || [])
            .filter(i => String(i.showInPortfolio).toLowerCase().trim() === 'si')
            .sort((a, b) => (parseInt(a.portfolioOrder) || 99) - (parseInt(b.portfolioOrder) || 99));

        // b. Encontrar el ítem que se mueve
        const currentIndex = portfolioList.findIndex(i => i.id === movedId);
        if (currentIndex === -1) return;
        const [movedItem] = portfolioList.splice(currentIndex, 1);

        // c. Calcular nueva posición (Array base 0)
        let newIndex = parseInt(newTargetOrder) - 1;
        if (newIndex < 0) newIndex = 0;
        if (newIndex > portfolioList.length) newIndex = portfolioList.length;

        // d. Insertar
        portfolioList.splice(newIndex, 0, movedItem);

        // e. Renumerar secuencialmente (1, 2, 3, 4...)
        portfolioList.forEach((img, index) => {
            img.portfolioOrder = index + 1;
        });

        // f. Refrescar la vista inmediatamente
        UI.renderView('portfolio-manager');
    },

    // 2. Handlers para Drag & Drop del Portafolio
    dragStartPortfolio(e, id) {
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", id);
        e.target.style.opacity = '0.4';
    },
    dragOverPortfolio(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
    },
    dragDropPortfolio(e, targetId) {
        e.preventDefault();
        document.querySelectorAll('.portfolio-grid-item, .group').forEach(el => el.style.opacity = '1'); // Restaurar opacidad
        
        const movedId = e.dataTransfer.getData("text/plain");
        if (movedId === targetId) return;

        // Buscar el orden del elemento destino
        const targetItem = AppState.data.ProjectImages.find(i => i.id === targetId);
        
        if (targetItem) {
            // Mover el ítem arrastrado a la posición del ítem destino
            this.reorderGlobalPortfolio(movedId, targetItem.portfolioOrder);
        }
    },
    // --- FIN CÓDIGO NUEVO ---



    // --- FUNCIONES DEL EDITOR & PDF (Con Logo Fix) ---

    // 1. Abrir el Editor
    openQuoteEditor() {
        UI.showLoading('Cargando documento...');
        
        // Obtener HTML limpio
        const htmlContent = App.getQuoteHTMLString();
        
        // Inyectar en la hoja de papel
        const editorPage = document.getElementById('quote-editor-page');
        if (editorPage) {
            editorPage.innerHTML = htmlContent;
            
            // Mostrar Overlay
            document.getElementById('quote-editor-overlay').style.display = 'flex';
        } else {
            console.error("No se encontró el elemento #quote-editor-page");
            UI.showToast("Error interno al abrir editor", "error");
        }
        
        UI.hideLoading();
    },

    // 2. Imprimir desde el Editor (Imprime lo que editaste)
    printFromEditor() {
        const content = document.getElementById('quote-editor-page').innerHTML;
        const win = window.open('', '_blank');
        win.document.write(`<html><head><title>Imprimir Cotización</title></head><body style="margin:0; padding: 20px;">${content}</body></html>`);
        win.document.close();
        setTimeout(() => { win.focus(); win.print(); }, 500);
    },

    // 3. PDF desde el Editor (Usa lo que editaste)
    pdfFromEditor() {
        const element = document.getElementById('quote-editor-page');
        UI.showLoading('Generando PDF...');
        
        const opt = { 
            margin: 10, 
            filename: 'Cotizacion_Editada.pdf', 
            image: { type: 'jpeg', quality: 0.98 }, 
            html2canvas: { scale: 2, useCORS: true }, 
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
        };
        
        html2pdf().set(opt).from(element).save().then(() => {
            UI.hideLoading();
            UI.showToast('PDF Descargado');
        }).catch(e => {
            UI.hideLoading();
            console.error(e);
            UI.showToast('Error generando PDF', 'error');
        });
    },

    // 4. Generación Directa (Con Túnel Proxy + Espera)
    async generateQuoteDocument(mode) {
        const content = App.getQuoteHTMLString();

        if (mode === 'print') {
            const win = window.open('', '_blank');
            win.document.write(`<html><head><title>Documento</title></head><body style="margin:0">${content}</body></html>`);
            win.document.close();
            setTimeout(() => { win.focus(); win.print(); }, 800);

        } else if (mode === 'pdf') {
            UI.showLoading('Generando PDF...');
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            tempDiv.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
                z-index: 99999; background: white; overflow-y: scroll; padding: 40px;
            `;
            document.body.appendChild(tempDiv);

            const logoImg = tempDiv.querySelector('#pdf-logo-img');
            
            // Esperar carga real (ahora sí cargará gracias al proxy)
            await new Promise((resolve) => {
                if (!logoImg || !logoImg.src) return resolve();
                if (logoImg.complete) return resolve();
                
                logoImg.onload = () => resolve();
                logoImg.onerror = () => {
                    console.warn("Fallo carga imagen PDF, generando sin logo.");
                    resolve();
                };
                setTimeout(resolve, 5000); // 5 seg max
            });

            const opt = {
                margin: 10, 
                filename: `Documento.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true, // Esto ahora funcionará porque el proxy devuelve el header correcto
                    letterRendering: true,
                    scrollY: 0,
                    windowWidth: 800 
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            try {
                await html2pdf().set(opt).from(tempDiv).save();
                UI.showToast('PDF Descargado');
            } catch (e) {
                console.error(e);
                UI.showToast('Error generando PDF', 'error');
            } finally {
                document.body.removeChild(tempDiv);
                UI.hideLoading();
            }
        }
    },

    // 5. HELPER PARA LOGO (La solución definitiva al problema de imagen rota)
    async convertLogoToBase64InContainer(container) {
        const img = container.querySelector('#pdf-logo-img');
        if (!img || !img.src) return;

        try {
            const blob = await fetch(img.src).then(r => r.blob());
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    img.src = reader.result; // Reemplaza URL por Base64 data:image...
                    resolve();
                };
                reader.readAsDataURL(blob);
            });
        } catch (e) {
            console.warn("No se pudo convertir logo a Base64 (posible CORS)", e);
        }
    },

    getQuoteHTMLString() {
        const customerName = document.getElementById('c-customerName')?.value || 'Cliente';
        const customerId = document.getElementById('c-customerCedula')?.value || '';
        const customerEmail = document.getElementById('c-customerEmail')?.value || '';
        const customerPhone = document.getElementById('c-customerPhone')?.value || '';
        const customerAddress = document.getElementById('c-customerAddress')?.value || '';
        const quoteId = document.getElementById('header-ref-display')?.innerText || 'BORRADOR';
        const notes = document.getElementById('c-globalNotes')?.value || '';
        
        const docTitle = document.getElementById('doc-type-title')?.innerText || 'COTIZACIÓN';
        
        const subtotal = document.getElementById('lbl-global-subtotal')?.innerText || '$0.00';
        const discount = document.getElementById('lbl-global-discount')?.innerText || '$0.00';
        const tax = document.getElementById('lbl-global-tax')?.innerText || '$0.00';
        const total = document.getElementById('lbl-global-total')?.innerText || '$0.00';

        const sysImages = (AppState.data.ImagenesIdentidad || []).reduce((acc, i) => ({...acc, [i.key]: i.imageUrl}), {});
        const ident = (AppState.data.Identidad || []).reduce((acc, i) => ({...acc, [i.key]: i.value}), {});
        
        let logoSrc = sysImages.logo_black || 'https://placehold.co/150x50?text=SIN+LOGO';

        // --- LÓGICA DEL TÚNEL (PROXY) ---
        // Si el logo viene de Google Drive, lo pasamos por nuestro proxy para evitar bloqueo en PDF
        if (logoSrc.includes('drive.google.com') || logoSrc.includes('googleusercontent')) {
            // Intentar extraer ID
            let fileId = null;
            const matchId = logoSrc.match(/id=([a-zA-Z0-9_-]+)/);
            if (matchId) fileId = matchId[1];
            else if (logoSrc.includes('/d/')) fileId = logoSrc.split('/d/')[1].split('/')[0];
            
            if (fileId) {
                // Usamos nuestro propio backend para servir la imagen limpia de CORS
                logoSrc = `/.netlify/functions/proxy-image?id=${fileId}`;
            }
        }
        // ---------------------------------

        const companyInfo = `
            <strong>${ident.legal_commercial_name || 'Nombre Comercial'}</strong><br>
            ${ident.legal_name || ''}<br>
            ${ident.legal_id ? 'ID: ' + ident.legal_id : ''}<br>
            ${ident.legal_email || ''}<br>
            ${ident.legal_phone || ''}
        `;

        const itemsRows = window.tempBookingLines.map(line => {
            const item = (AppState.data.RentalItems || []).find(i => i.id === line.itemId);
            const itemName = item ? item.name : 'Artículo';
            const desc = item ? (item.description || '') : '';
            
            let days = 1;
            if(line.startDate && line.endDate) {
                const d1 = new Date(line.startDate); const d2 = new Date(line.endDate);
                const diff = Math.floor((d2 - d1) / (1000 * 60 * 60 * 24)) + 1;
                if (diff > 0) days = diff;
            }

            const fmt = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n);
            const displayedUnitPrice = line.computedNet / days;

            return `
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 12px 0;">
                        <div style="font-weight: bold; color: #111;">${itemName}</div>
                        <div style="font-size: 10px; color: #666; margin-top:2px;">${line.note || desc}</div>
                        <div style="font-size: 10px; color: #888;">${line.startDate} al ${line.endDate} (${days} días)</div>
                    </td>
                    <td style="padding: 12px 0; text-align: right;">${fmt(displayedUnitPrice)}</td>
                    <td style="padding: 12px 0; text-align: right; font-weight: bold;">${fmt(line.computedNet)}</td>
                </tr>
            `;
        }).join('');

        return `
            <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; max-width: 800px; margin: 0 auto; background: white; padding: 40px; color: #333;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; border-bottom: 2px solid #111; padding-bottom: 20px;">
                    <div>
                        <img id="pdf-logo-img" src="${logoSrc}" crossorigin="anonymous" style="height: 60px; object-fit: contain; margin-bottom: 10px;">
                        <div style="font-size: 12px; color: #555; line-height: 1.4;">${companyInfo}</div>
                    </div>
                    <div style="text-align: right;">
                        <h1 id="doc-type-title" style="font-family: 'Garamond', serif; font-size: 32px; color: #111; margin: 0;">${docTitle}</h1>
                        <div style="font-size: 14px; color: #666; margin-top: 5px;"># ${quoteId}</div>
                        <div style="font-size: 12px; color: #888; margin-top: 5px;">Fecha: ${new Date().toLocaleDateString()}</div>
                    </div>
                </div>
                <div style="margin-bottom: 40px;">
                    <div style="font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-bottom: 5px;">Cliente</div>
                    <div style="font-size: 16px; font-weight: bold; color: #000;">${customerName}</div>
                    <div style="font-size: 12px; color: #555; margin-top: 4px;">
                        ${customerId ? 'ID: ' + customerId + ' &nbsp;|&nbsp; ' : ''} ${customerEmail} <br>
                        ${customerPhone ? 'Tel: ' + customerPhone : ''} <br>
                        ${customerAddress}
                    </div>
                </div>
                <table style="width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 30px;">
                    <thead>
                        <tr style="border-bottom: 2px solid #111;">
                            <th style="text-align: left; padding: 10px 0; text-transform: uppercase; letter-spacing: 1px; font-size: 10px; color: #555;">Descripción</th>
                            <th style="text-align: right; padding: 10px 0; text-transform: uppercase; letter-spacing: 1px; font-size: 10px; color: #555; width: 100px;">Precio Unit.</th>
                            <th style="text-align: right; padding: 10px 0; text-transform: uppercase; letter-spacing: 1px; font-size: 10px; color: #555; width: 120px;">Total</th>
                        </tr>
                    </thead>
                    <tbody>${itemsRows}</tbody>
                </table>
                <div style="display: flex; justify-content: flex-end;">
                    <div style="width: 250px;">
                        <div style="display: flex; justify-content: space-between; font-size: 12px; padding: 5px 0; border-bottom: 1px solid #eee;">
                            <span style="color: #666;">Subtotal:</span><span>${subtotal}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px; padding: 5px 0; border-bottom: 1px solid #eee; color: #ef4444;">
                            <span>Descuento Global:</span><span>${discount}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px; padding: 5px 0; border-bottom: 1px solid #eee;">
                            <span style="color: #666;">IVA / Impuestos:</span><span>${tax}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; padding: 15px 0; color: #000; border-bottom: 2px solid #111;">
                            <span>TOTAL:</span><span>${total}</span>
                        </div>
                    </div>
                </div>
                ${notes ? `<div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee;"><div style="font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-bottom: 5px;">Notas / Condiciones</div><div style="font-size: 11px; color: #555; white-space: pre-line; line-height: 1.5;">${notes}</div></div>` : ''}
                <div style="margin-top: 60px; text-align: center; font-size: 10px; color: #aaa;">
                    ${ident.legal_address ? ident.legal_address + '<br>' : ''}
                    Documento generado por AG Visual Info System
                </div>
            </div>
        `;
    },


    
    

    
    async savePortfolioOrder() { UI.showLoading('Guardando...'); try { const updates = AppState.data.ProjectImages.filter(i => String(i.showInPortfolio).toLowerCase().trim() === 'si').map(i => ({ sheet: 'ProjectImages', action: 'update', criteria: {id: i.id}, data: {portfolioOrder: i.portfolioOrder} })); await API.batchUpdate(updates); UI.showToast('Orden guardado'); } catch(e) { alert(e.message); } finally { UI.hideLoading(); } },
    // CÓDIGO NUEVO (Con Feedback y Limpieza de Orden)
    async removeFromPortfolio(id) { 
        // 1. Feedback Visual Inmediato
        UI.showToast('Removiendo imagen...', 'info'); 
        
        try {
            // 2. Enviar actualización al servidor (Dos campos: No portfolio y Sin orden)
            await API.call('/.netlify/functions/update-sheet-data', { 
                method: 'POST', 
                body: { 
                    sheet: 'ProjectImages', 
                    action: 'update', 
                    criteria: { id: id }, 
                    data: { 
                        showInPortfolio: 'No', 
                        portfolioOrder: '' // <--- ESTO BORRA EL NÚMERO EN EL SHEET
                    } 
                } 
            });

            // 3. Actualizar Memoria Local
            const item = AppState.data.ProjectImages.find(i => i.id === id); 
            if(item) {
                item.showInPortfolio = 'No';
                item.portfolioOrder = ''; // Limpiamos memoria también
            }

            // 4. Refrescar Vista y Confirmar
            UI.renderView('portfolio-manager'); 
            UI.showToast('Guardado');

        } catch(e) {
            console.error(e);
            UI.showToast('Error al remover: ' + e.message, 'error');
        }
    },
};

document.addEventListener('DOMContentLoaded', () => {
    const loginBtn = document.getElementById('google-login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const mainNav = document.getElementById('main-nav');

    if (loginBtn) loginBtn.addEventListener('click', () => Auth.login());
    if (logoutBtn) logoutBtn.addEventListener('click', () => Auth.logout());
    
    if (mainNav) {
        mainNav.addEventListener('click', e => { 
            const link = e.target.closest('.sidebar-link'); 
            if(link) { 
                e.preventDefault(); 
                if (typeof App.switchView === 'function') {
                    App.switchView(link.dataset.view); 
                } else {
                    UI.renderView(link.dataset.view);
                }
            } 
        });
    }

    // --- NUEVO: Soporte de Teclado para Lightbox ---
    document.addEventListener('keydown', (e) => {
        const lb = document.getElementById('admin-lightbox');
        // Solo si el lightbox existe y está visible (no tiene la clase hidden)
        if (lb && !lb.classList.contains('hidden')) {
            if (e.key === 'ArrowLeft') UI.navLightbox(-1);
            if (e.key === 'ArrowRight') UI.navLightbox(1);
            if (e.key === 'Escape') UI.closeLightbox();
        }
    });

    setTimeout(() => Auth.init(), 100);
});
</script>

    <div id="admin-lightbox" class="fixed inset-0 z-[200] bg-black/95 hidden flex-col items-center justify-center select-none" onclick="if(event.target===this) UI.closeLightbox()">
        <button class="absolute top-4 right-6 text-white text-5xl hover:text-gray-300 transition" onclick="UI.closeLightbox()">&times;</button>
        
        <div class="flex items-center justify-between w-full px-4 md:px-12 h-full py-12">
            <button class="text-white text-6xl hover:text-accent-primary transition p-4" onclick="UI.navLightbox(-1)">&#8249;</button>
            
            <div class="flex flex-col items-center justify-center max-h-full max-w-[80vw]">
                <img id="admin-lb-img" class="max-h-[80vh] w-auto object-contain shadow-2xl border border-gray-800 bg-black" referrerpolicy="no-referrer" >
                <p id="admin-lb-caption" class="text-white font-mono text-lg mt-4 text-center bg-black/50 px-4 py-2 rounded min-h-[3rem]"></p>
            </div>

            <button class="text-white text-6xl hover:text-accent-primary transition p-4" onclick="UI.navLightbox(1)">&#8250;</button>
        </div>
    </div>

    <div id="quote-editor-overlay">
        <div id="editor-header" class="bg-white border-b px-6 py-3 flex justify-between items-center shadow-sm z-50">
            <div>
                <h3 class="font-bold text-gray-800 text-lg">Vista Previa & Edición</h3>
                <p class="text-xs text-gray-500">Puedes editar el texto directamente en la hoja antes de descargar.</p>
            </div>
            <div class="flex gap-3">
                <button onclick="App.printFromEditor()" class="btn btn-secondary text-xs h-9 px-4 shadow-sm">
                    <i class="fas fa-print mr-2"></i> Imprimir
                </button>
                <button onclick="App.pdfFromEditor()" class="btn btn-primary text-xs h-9 px-4 shadow-sm bg-gray-800 text-white hover:bg-gray-700">
                    <i class="fas fa-file-pdf mr-2"></i> Descargar PDF
                </button>
                <div class="w-px h-8 bg-gray-300 mx-1"></div>
                <button onclick="document.getElementById('quote-editor-overlay').style.display='none'" class="btn btn-danger text-xs h-9 px-4 bg-red-600 text-white hover:bg-red-700">
                    <i class="fas fa-times mr-2"></i> Cerrar
                </button>
            </div>
        </div>
        
        <div id="editor-toolbar-strip">
            <div class="relative group" title="Tipo de Documento">
                <select class="toolbar-select font-bold text-gray-700 bg-gray-50 border-gray-300" onchange="App.changeDocumentTitle(this.value)">
                    <option value="COTIZACIÓN">COTIZACIÓN</option>
                    <option value="RESERVACIÓN">RESERVACIÓN</option>
                    <option value="CONFIRMACIÓN">CONFIRMACIÓN</option>
                    <option value="FACTURA">FACTURA</option>
                    <option value="PROFORMA">PROFORMA</option>
                </select>
            </div>
            <div class="toolbar-separator"></div>
            <select class="toolbar-select" onchange="document.execCommand('fontName',false,this.value)">
                <option value="Arial">Arial</option><option value="Times New Roman">Times New Roman</option><option value="Helvetica">Helvetica</option>
            </select>
            <div class="toolbar-separator"></div>
            <select class="toolbar-select" onchange="document.execCommand('fontSize',false,this.value)">
                <option value="3">Normal</option><option value="5">Grande</option><option value="6">Título</option>
            </select>
            <div class="toolbar-separator"></div>
            
            <button class="toolbar-btn" onclick="document.execCommand('bold',false,null)" title="Negrita"><i class="fas fa-bold"></i></button>
            <button class="toolbar-btn" onclick="document.execCommand('italic',false,null)" title="Cursiva"><i class="fas fa-italic"></i></button>
            <button class="toolbar-btn" onclick="document.execCommand('underline',false,null)" title="Subrayado"><i class="fas fa-underline"></i></button>
            
            <div class="toolbar-btn" style="position: relative;" title="Color de Texto">
                <i class="fas fa-palette"></i>
                <input type="color" 
                       style="position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;" 
                       oninput="document.execCommand('foreColor', false, this.value); this.previousElementSibling.style.color = this.value;">
            </div>
        
            <div class="toolbar-separator"></div>
            <button class="toolbar-btn" onclick="document.execCommand('justifyLeft',false,null)"><i class="fas fa-align-left"></i></button>
            <button class="toolbar-btn" onclick="document.execCommand('justifyCenter',false,null)"><i class="fas fa-align-center"></i></button>
            <button class="toolbar-btn" onclick="document.execCommand('justifyRight',false,null)"><i class="fas fa-align-right"></i></button>
        </div>

        <div id="quote-editor-scroll">
            <div id="quote-editor-page" contenteditable="true" spellcheck="false"></div>
        </div>
    </div>
    
</body>
</html>










