<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Mando | AG Visual Info</title>
    <link rel="icon" type="image/png" href="https://placehold.co/32x32/1a1a1a/FDFDFD?text=AG">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root { --bg-main: #FDFDFD; --text-dark: #1a1a1a; --text-muted: #52525b; --accent: #3a3a3a; --border-color: #e5e7eb; --status-pending: #f59e0b; --status-confirmed: #10b981; --status-paid: #3b82f6; --status-canceled: #ef4444; }
        body { font-family: 'Montserrat', sans-serif; background-color: var(--bg-main); color: var(--text-dark); }
        h1, h2, h3, .font-display { font-family: 'Cormorant Garamond', serif; }
        .loader-circle { width: 50px; height: 50px; border: 4px solid rgba(0,0,0,0.1); border-radius: 50%; border-top-color: var(--accent); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn { padding: 0.5rem 1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.75rem; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; cursor: pointer; border-radius: 4px; }
        .btn-primary { background-color: var(--text-dark); color: white; }
        .btn-primary:hover { background-color: var(--accent); }
        .btn-secondary { border: 1px solid var(--text-dark); color: var(--text-dark); background: transparent; }
        .btn-secondary:hover { background: #f3f4f6; }
        .btn-danger { background-color: #ef4444; color: white; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); font-family: 'Montserrat', sans-serif; font-size: 0.9rem; }
        .form-input:focus { border-color: var(--text-dark); outline: none; }
        .form-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.25rem; display: block; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1.5rem; color: var(--text-muted); border-left: 4px solid transparent; transition: all 0.2s; font-size: 0.9rem; }
        .sidebar-link:hover { background-color: #f3f4f6; color: var(--text-dark); }
        .sidebar-link.active { background-color: #f3f4f6; color: var(--text-dark); border-left-color: var(--text-dark); font-weight: 700; }
        .sidebar-link i { width: 1.5rem; text-align: center; margin-right: 0.75rem; }
        .view { display: none; animation: fadeIn 0.3s ease-out; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); transform: scale(0.95); transition: transform 0.2s; border-radius: 8px; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .toast { position: fixed; bottom: 2rem; right: 2rem; background: var(--text-dark); color: white; padding: 1rem 1.5rem; z-index: 100; transform: translateY(100px); transition: transform 0.3s; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); font-weight: 600; border-radius: 4px; }
        .toast.visible { transform: translateY(0); }
        .toast.error { background: #ef4444; }
        .img-preview { width: 60px; height: 60px; object-fit: cover; border: 1px solid #e5e7eb; border-radius: 4px; background-color: #f9fafb; }
        
        /* UI Portafolio Corregida */
        .portfolio-grid-item { position: relative; aspect-ratio: 1; overflow: hidden; border-radius: 4px; border: 1px solid #eee; background: #f3f4f6; }
        .portfolio-grid-item img { width: 100%; height: 100%; object-fit: cover; }
        .portfolio-grid-overlay { 
            position: absolute; inset: 0; background: rgba(0,0,0,0.7); 
            opacity: 0; transition: opacity 0.2s; 
            display: flex; flex-direction: column; justify-content: center; items-center; gap: 10px; 
        }
        .portfolio-grid-item:hover .portfolio-grid-overlay { opacity: 1; }
        .portfolio-badge { position: absolute; top: 5px; right: 5px; background: #10b981; color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: bold; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        .tab-nav { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        .tab-btn { padding: 1rem; color: var(--text-muted); font-weight: 600; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab-btn.active { color: var(--text-dark); border-bottom-color: var(--text-dark); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <div id="loading-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-white">
        <div class="loader-circle"></div>
        <p id="loading-text" class="mt-4 font-display text-xl text-text-dark">Cargando Sistema...</p>
    </div>

    <div id="login-screen" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-gray-100">
        <div class="bg-white p-10 shadow-2xl max-w-md w-full text-center border-t-4 border-text-dark">
            <h1 class="font-display text-4xl font-bold mb-2">AG Visual Info</h1>
            <p class="text-text-muted mb-8 uppercase tracking-widest text-xs">Panel de Control</p>
            <button id="google-login-btn" class="w-full bg-[#4285F4] text-white font-bold py-3 px-4 flex items-center justify-center gap-3 hover:bg-[#3367D6] transition-colors shadow-md rounded">
                <i class="fab fa-google"></i> Iniciar con Google Workspace
            </button>
        </div>
    </div>

    <div id="app-screen" class="hidden flex-1 flex h-full overflow-hidden">
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col flex-shrink-0 shadow-sm z-20">
            <div class="p-6 border-b border-gray-100">
                <h2 class="font-display text-2xl font-bold">AG Admin</h2>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 space-y-1" id="main-nav">
                <a href="#" class="sidebar-link active" data-view="dashboard"><i class="fas fa-home"></i>Inicio</a>
                <a href="#" class="sidebar-link" data-view="projects"><i class="fas fa-camera"></i>Proyectos</a>
                <a href="#" class="sidebar-link" data-view="portfolio-manager"><i class="fas fa-images"></i>Portafolio</a>
                <a href="#" class="sidebar-link" data-view="services"><i class="fas fa-concierge-bell"></i>Servicios</a>
                <a href="#" class="sidebar-link" data-view="rentals"><i class="fas fa-video"></i>Alquiler</a>
                <a href="#" class="sidebar-link" data-view="bookings"><i class="fas fa-calendar-check"></i>Reservas</a>
                <a href="#" class="sidebar-link" data-view="settings"><i class="fas fa-cog"></i>Configuración</a>
            </nav>
            <div class="p-4 border-t border-gray-100">
                <button id="logout-btn" class="w-full text-left px-4 py-2 text-text-muted hover:text-red-600 transition-colors text-xs font-bold uppercase"><i class="fas fa-sign-out-alt mr-2"></i>Salir</button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-gray-50 p-8 relative">
            <div id="view-dashboard" class="view active">
                <h1 class="text-4xl font-display font-bold mb-6">Resumen</h1>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 shadow-sm border border-gray-200 rounded"><h3 class="text-xs text-text-muted uppercase font-bold">Proyectos Activos</h3><p class="text-4xl font-display font-bold mt-2" id="dash-projects">...</p></div>
                    <div class="bg-white p-6 shadow-sm border border-gray-200 rounded"><h3 class="text-xs text-text-muted uppercase font-bold">Fotos en Portafolio</h3><p class="text-4xl font-display font-bold mt-2" id="dash-portfolio">...</p></div>
                    <div class="bg-white p-6 shadow-sm border border-gray-200 rounded"><h3 class="text-xs text-text-muted uppercase font-bold">Reservas Pendientes</h3><p class="text-4xl font-display font-bold mt-2 text-yellow-600" id="dash-bookings">...</p></div>
                </div>
            </div>

            <div id="view-projects" class="view">
                <div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-display font-bold">Proyectos</h1><button class="btn btn-primary" onclick="App.handleEditCrudItem('Projects', null)"><i class="fas fa-plus"></i> Nuevo</button></div>
                <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b"><tr><th class="p-4">Orden</th><th class="p-4">Portada</th><th class="p-4">Título</th><th class="p-4">Acciones</th></tr></thead><tbody id="projects-table-body" class="divide-y divide-gray-100"></tbody></table></div>
            </div>

            <div id="view-portfolio-manager" class="view">
                <div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-display font-bold">Portafolio</h1><button class="btn btn-primary" onclick="App.savePortfolioOrder()"><i class="fas fa-save"></i> Guardar Orden</button></div>
                <div id="portfolio-manager-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
            </div>

            <div id="view-services" class="view">
                <div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-display font-bold">Servicios</h1><button class="btn btn-primary" onclick="App.handleEditCrudItem('Services', null)"><i class="fas fa-plus"></i> Nuevo</button></div>
                <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b"><tr><th class="p-4">Orden</th><th class="p-4">Título</th><th class="p-4">Acciones</th></tr></thead><tbody id="services-table-body" class="divide-y divide-gray-100"></tbody></table></div>
            </div>

            <div id="view-rentals" class="view">
                <h1 class="text-3xl font-display font-bold mb-6">Alquiler</h1>
                <div class="tab-nav"><button class="tab-btn active" onclick="UI.switchTab('rental-items')">Equipos</button><button class="tab-btn" onclick="UI.switchTab('rental-cats')">Categorías</button></div>
                <div id="tab-rental-items" class="tab-content active">
                    <div class="flex justify-end mb-4"><button class="btn btn-primary" onclick="App.handleEditCrudItem('RentalItems', null)"><i class="fas fa-plus"></i> Nuevo Equipo</button></div>
                    <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b"><tr><th class="p-4">Img</th><th class="p-4">Nombre</th><th class="p-4">Categoría</th><th class="p-4">Precio</th><th class="p-4">Acciones</th></tr></thead><tbody id="rental-items-table-body" class="divide-y divide-gray-100"></tbody></table></div>
                </div>
                <div id="tab-rental-cats" class="tab-content">
                    <div class="flex justify-end mb-4"><button class="btn btn-primary" onclick="App.handleEditCrudItem('RentalCategories', null)"><i class="fas fa-plus"></i> Nueva Categoría</button></div>
                    <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b"><tr><th class="p-4">Orden</th><th class="p-4">Nombre</th><th class="p-4">Acciones</th></tr></thead><tbody id="rental-categories-table-body" class="divide-y divide-gray-100"></tbody></table></div>
                </div>
            </div>

            <div id="view-bookings" class="view">
                <h1 class="text-3xl font-display font-bold mb-6">Reservas</h1>
                <div class="tab-nav"><button class="tab-btn active" onclick="UI.switchTab('booking-list')">Solicitudes</button><button class="tab-btn" onclick="UI.switchTab('blocked-dates')">Bloqueos</button></div>
                <div id="tab-booking-list" class="tab-content active">
                     <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b"><tr><th class="p-4">Fecha</th><th class="p-4">Cliente</th><th class="p-4">Equipo</th><th class="p-4">Total</th><th class="p-4">Estado</th><th class="p-4">Acciones</th></tr></thead><tbody id="bookings-list-body" class="divide-y divide-gray-100"></tbody></table></div>
                </div>
                <div id="tab-blocked-dates" class="tab-content">
                    <div class="flex justify-end mb-4"><button class="btn btn-primary" onclick="App.handleEditCrudItem('BlockedDates', null)"><i class="fas fa-ban"></i> Nuevo Bloqueo</button></div>
                    <div class="bg-white shadow-sm border border-gray-200 rounded overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-gray-50 text-xs uppercase text-text-muted font-bold border-b"><tr><th class="p-4">Equipo</th><th class="p-4">Motivo</th><th class="p-4">Desde</th><th class="p-4">Hasta</th><th class="p-4">Acciones</th></tr></thead><tbody id="blocked-dates-table-body" class="divide-y divide-gray-100"></tbody></table></div>
                </div>
            </div>
            
            <div id="view-settings" class="view">
                <h1 class="text-3xl font-display font-bold mb-6">Configuración</h1>
                <div id="settings-form-container" class="max-w-3xl space-y-6 bg-white p-6 rounded border border-gray-200"></div>
                <h2 class="text-2xl font-display font-bold mt-10 mb-4">Logos Clientes</h2>
                <button class="btn btn-secondary mb-4" onclick="App.handleClientLogos()">+ Gestionar Logos</button>
            </div>
        </main>
    </div>

    <div id="modal-container"></div>
    <div id="toast-container"></div>
    <div id="confirm-modal-overlay" class="modal-overlay">
        <div id="confirm-modal-content" class="modal-content p-6 bg-white rounded-lg max-w-sm text-center">
            <h3 class="text-xl font-bold mb-2">Confirmar Acción</h3>
            <p id="confirm-message" class="text-gray-600 mb-6">¿Seguro que quieres continuar?</p>
            <div class="flex justify-center gap-3">
                <button id="confirm-cancel-btn" class="btn btn-secondary">Cancelar</button>
                <button id="confirm-ok-btn" class="btn btn-danger">Confirmar</button>
            </div>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
const GOOGLE_REDIRECT_URI = 'postmessage';
// Estado Local: data = { Projects: [], Services: [] ... }
const AppState = { data: { Projects: [], Services: [], ProjectImages: [], Bookings: [] }, token: JSON.parse(localStorage.getItem('gAuthToken') || 'null'), view: 'dashboard' };

const API = {
    async call(endpoint, options = {}, isRetry = false) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 60000); // 60s para subidas pesadas
        
        const headers = new Headers(options.headers || {});
        if (AppState.token?.access_token) headers.set('Authorization', `Bearer ${AppState.token.access_token}`);
        if (options.body && !(options.body instanceof FormData)) {
            headers.set('Content-Type', 'application/json');
            options.body = JSON.stringify(options.body);
        }
        try {
            // Añadir timestamp para evitar cache
            const sep = endpoint.includes('?') ? '&' : '?';
            const res = await fetch(`${endpoint}${sep}t=${Date.now()}`, { ...options, headers, signal: controller.signal });
            clearTimeout(timeoutId);
            
            if (res.status === 401 && !isRetry) {
                if (await Auth.refresh()) return API.call(endpoint, options, true);
                else { Auth.logout(); throw new Error('Sesión expirada'); }
            }
            if (!res.ok) throw new Error((await res.json()).error || 'Error servidor');
            return await res.json();
        } catch (e) { 
            clearTimeout(timeoutId);
            if (e.name === 'AbortError') throw new Error('Tiempo de espera agotado. Verifica tu conexión.');
            throw e; 
        }
    }
};

const Auth = {
    async init() {
        if (AppState.token) {
            if (Date.now() >= AppState.token.expires_at) await this.refresh();
            UI.showApp();
        } else UI.showLogin();
    },
    async login() {
        try {
            const config = await fetch('/.netlify/functions/get-auth-config').then(r => r.json());
            google.accounts.oauth2.initCodeClient({
                client_id: config.clientId,
                scope: 'https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/drive',
                callback: (r) => r.code && this.exchangeCode(r.code)
            }).requestCode();
        } catch (e) { alert('Error config: ' + e.message); }
    },
    async exchangeCode(code) {
        UI.showLoading('Autenticando...');
        try {
            const tokens = await fetch('/.netlify/functions/auth-google', { method: 'POST', body: JSON.stringify({ code, redirectUri: GOOGLE_REDIRECT_URI }) }).then(r => r.json());
            if (tokens.error) throw new Error(tokens.error);
            this.setToken(tokens);
            UI.showApp();
        } catch (e) { alert(e.message); UI.showLogin(); }
    },
    async refresh() {
        if (!AppState.token?.refresh_token) return false;
        try {
            const t = await fetch('/.netlify/functions/auth-refresh', { method: 'POST', body: JSON.stringify({ refresh_token: AppState.token.refresh_token }) }).then(r => r.json());
            if (t.error) throw new Error(t.error);
            this.setToken({ ...AppState.token, ...t });
            return true;
        } catch { return false; }
    },
    setToken(t) {
        if (t.expires_in) t.expires_at = Date.now() + (t.expires_in * 1000);
        AppState.token = t;
        localStorage.setItem('gAuthToken', JSON.stringify(t));
    },
    logout() { localStorage.removeItem('gAuthToken'); location.reload(); }
};

const UI = {
    showLogin: () => { document.getElementById('loading-screen').style.display = 'none'; document.getElementById('app-screen').style.display = 'none'; document.getElementById('login-screen').style.display = 'flex'; },
    showApp: async () => {
        document.getElementById('login-screen').style.display = 'none';
        await App.loadData('dashboard'); // Carga inicial ligera
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('app-screen').style.display = 'flex';
        UI.renderView(AppState.view);
    },
    forceReload: () => location.reload(),
    showLoading: (msg) => { document.getElementById('loading-text').innerText = msg; document.getElementById('loading-screen').style.display = 'flex'; },
    hideLoading: () => document.getElementById('loading-screen').style.display = 'none',
    showToast: (msg, type='success') => {
        const t = document.createElement('div'); t.className = `toast ${type}`; t.innerText = msg;
        document.getElementById('toast-container').appendChild(t);
        setTimeout(() => t.classList.add('visible'), 10);
        setTimeout(() => t.remove(), 3000);
    },
    showConfirm: (message, onConfirm) => {
        const overlay = document.getElementById('confirm-modal-overlay');
        document.getElementById('confirm-message').textContent = message;
        const okBtn = document.getElementById('confirm-ok-btn');
        const cancelBtn = document.getElementById('confirm-cancel-btn');
        const newOk = okBtn.cloneNode(true);
        const newCancel = cancelBtn.cloneNode(true);
        okBtn.parentNode.replaceChild(newOk, okBtn);
        cancelBtn.parentNode.replaceChild(newCancel, cancelBtn);
        newOk.addEventListener('click', () => { overlay.classList.remove('visible'); onConfirm(); });
        newCancel.addEventListener('click', () => overlay.classList.remove('visible'));
        overlay.classList.add('visible');
    },
    switchTab(tabId) {
        const activeView = document.querySelector('.view.active');
        if(!activeView) return;
        activeView.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        activeView.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        const btns = activeView.querySelectorAll('.tab-btn');
        btns.forEach(b => { if(b.getAttribute('onclick').includes(tabId)) b.classList.add('active'); });
        document.getElementById(`tab-${tabId}`).classList.add('active');
    },
    renderView: async (view) => {
        await App.ensureDataForView(view); // Carga diferida inteligente
        AppState.view = view;
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(`view-${view}`).classList.add('active');
        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
        document.querySelector(`[data-view="${view}"]`)?.classList.add('active');
        
        const data = AppState.data;

        if (view === 'dashboard') {
            document.getElementById('dash-projects').innerText = (data.Projects || []).length;
            const portfolioCount = (data.ProjectImages || []).filter(i => i.showInPortfolio === 'Si').length;
            document.getElementById('dash-portfolio').innerText = portfolioCount;
            document.getElementById('dash-bookings').innerText = (data.Bookings || []).filter(b => b.status === 'Pendiente').length;
        } else if (view === 'projects') {
            document.getElementById('projects-table-body').innerHTML = (data.Projects || []).sort((a,b) => (a.order||99)-(b.order||99)).map(p => {
                const cover = (data.ProjectImages || []).find(i => i.projectId === p.id && i.isCover === 'Si');
                return `<tr class="border-b hover:bg-gray-50"><td class="p-4 text-xs font-bold text-gray-400">${p.order||99}</td><td class="p-4"><img src="${cover?.imageUrl || 'https://placehold.co/50'}" class="img-preview"></td><td class="p-4 font-bold text-sm">${p.title}</td><td class="p-4 flex gap-3"><button class="text-blue-600 hover:text-blue-800" onclick="App.handleEditCrudItem('Projects', '${p.id}')"><i class="fas fa-edit"></i></button><button class="text-green-600 hover:text-green-800" onclick="App.handleProjectImages('${p.id}', '${p.title.replace(/'/g, "\\'")}')"><i class="fas fa-images"></i></button><button class="text-red-600 hover:text-red-800" onclick="App.handleDelete('Projects', '${p.id}')"><i class="fas fa-trash"></i></button></td></tr>`;
            }).join('');
        } else if (view === 'portfolio-manager') {
            const images = (data.ProjectImages || []).filter(i => i.showInPortfolio === 'Si').sort((a,b) => (a.portfolioOrder||99)-(b.portfolioOrder||99));
            document.getElementById('portfolio-manager-grid').innerHTML = images.map(i => `
                <div class="portfolio-grid-item group">
                    <img src="${i.imageUrl}" class="img-preview w-full h-full">
                    <div class="portfolio-grid-overlay">
                        <input type="number" class="w-16 p-1 text-center text-sm rounded border mb-2 text-black font-bold" value="${i.portfolioOrder||99}" onchange="App.updateLocalPortfolioOrder('${i.id}', this.value)">
                        <button class="bg-red-500 text-white px-2 py-1 rounded text-xs font-bold hover:bg-red-600" onclick="App.removeFromPortfolio('${i.id}')">
                            <i class="fas fa-times"></i> Quitar
                        </button>
                    </div>
                    <span class="portfolio-badge">#${i.portfolioOrder||99}</span>
                </div>
            `).join('');
        } else if (view === 'rentals') {
             document.getElementById('rental-items-table-body').innerHTML = (data.RentalItems || []).map(i => {
                const img = (data.RentalItemImages || []).find(im => im.itemId === i.id)?.imageUrl;
                const catName = (data.RentalCategories || []).find(c => c.id === i.categoryId)?.name || 'Sin Categoría';
                return `<tr class="border-b hover:bg-gray-50"><td class="p-4"><img src="${img || 'https://placehold.co/50'}" class="img-preview"></td><td class="p-4 font-bold text-sm">${i.name}</td><td class="p-4 text-xs font-bold text-gray-500 uppercase">${catName}</td><td class="p-4 font-mono text-sm">$${i.pricePerDay}</td><td class="p-4 flex gap-3"><button class="text-blue-600 hover:text-blue-800" onclick="App.handleEditCrudItem('RentalItems', '${i.id}')"><i class="fas fa-edit"></i></button><button class="text-green-600 hover:text-green-800" onclick="App.handleRentalImages('${i.id}', '${i.name.replace(/'/g, "\\'")}')"><i class="fas fa-images"></i></button><button class="text-red-600 hover:text-red-800" onclick="App.handleDelete('RentalItems', '${i.id}')"><i class="fas fa-trash"></i></button></td></tr>`;
             }).join('');
             document.getElementById('rental-categories-table-body').innerHTML = (data.RentalCategories || []).map(c => `
                <tr class="border-b hover:bg-gray-50"><td class="p-4 text-xs font-bold text-gray-400">${c.order}</td><td class="p-4 font-bold text-sm">${c.name}</td><td class="p-4 flex gap-3"><button class="text-blue-600 hover:text-blue-800" onclick="App.handleEditCrudItem('RentalCategories', '${c.id}')"><i class="fas fa-edit"></i></button><button class="text-red-600 hover:text-red-800" onclick="App.handleDelete('RentalCategories', '${c.id}')"><i class="fas fa-trash"></i></button></td></tr>
             `).join('');
        } else if (view === 'services') {
            document.getElementById('services-table-body').innerHTML = (data.Services || []).sort((a,b) => (a.order||99)-(b.order||99)).map(s => `
                <tr class="border-b hover:bg-gray-50"><td class="p-4 text-xs font-bold text-gray-400">${s.order||99}</td><td class="p-4 font-bold text-sm">${s.title}</td><td class="p-4 flex gap-3"><button class="text-blue-600 hover:text-blue-800" onclick="App.handleEditCrudItem('Services', '${s.id}')"><i class="fas fa-edit"></i></button><button class="text-red-600 hover:text-red-800" onclick="App.handleDelete('Services', '${s.id}')"><i class="fas fa-trash"></i></button></td></tr>
            `).join('');
        } else if (view === 'bookings') {
             document.getElementById('bookings-list-body').innerHTML = (data.Bookings || []).sort((a,b) => new Date(b.bookingTimestamp) - new Date(a.bookingTimestamp)).map(b => `
                <tr class="border-b hover:bg-gray-50"><td class="p-4 text-xs text-gray-500">${new Date(b.bookingTimestamp).toLocaleDateString()}</td><td class="p-4"><div class="font-bold text-sm">${b.customerName}</div><div class="text-xs text-gray-500">${b.customerEmail}</div></td><td class="p-4 text-sm">${b.itemName}<br><span class="text-xs text-gray-500">${b.startDate} a ${b.endDate}</span></td><td class="p-4 font-mono text-sm font-bold">$${b.totalPrice}</td><td class="p-4"><span class="status-badge status-${b.status}">${b.status}</span></td><td class="p-4 flex gap-2"><select class="form-select text-xs w-auto py-1" onchange="App.quickUpdate('Bookings', '${b.id}', 'status', this.value)"><option value="Pendiente" ${b.status==='Pendiente'?'selected':''}>Pendiente</option><option value="Confirmado" ${b.status==='Confirmado'?'selected':''}>Confirmado</option><option value="Pagado" ${b.status==='Pagado'?'selected':''}>Pagado</option><option value="Cancelado" ${b.status==='Cancelado'?'selected':''}>Cancelado</option></select></td></tr>
             `).join('');
             document.getElementById('blocked-dates-table-body').innerHTML = (data.BlockedDates || []).map(bl => {
                 const item = (data.RentalItems || []).find(i => i.id === bl.itemId);
                 return `<tr class="border-b hover:bg-gray-50"><td class="p-4 font-bold text-sm">${item?.name || 'Desconocido'}</td><td class="p-4 text-sm">${bl.reason}</td><td class="p-4 text-xs font-mono">${bl.startDate}</td><td class="p-4 text-xs font-mono">${bl.endDate}</td><td class="p-4"><button class="text-red-600 hover:text-red-800" onclick="App.handleDelete('BlockedDates', '${bl.blockId}', 'blockId')"><i class="fas fa-trash"></i></button></td></tr>`;
             }).join('');
        } else if (view === 'settings') {
             const s = (data.Settings || []).reduce((acc, i) => ({...acc, [i.key]: i.value}), {});
             document.getElementById('settings-form-container').innerHTML = `${UI.inputHTML('settings', 'contact_email', 'Email', s.contact_email)} ${UI.inputHTML('settings', 'social_instagram', 'Instagram', s.social_instagram)} <button class="btn btn-primary mt-2" onclick="App.handleSaveSettings()">Guardar Ajustes</button>`;
        }
    },
    inputHTML: (p, k, l, v='', t='text') => `<div class="mb-4"><label class="form-label">${l}</label><input type="${t}" id="${p}-${k}" data-key="${k}" class="form-input" value="${v||''}"></div>`,
    textareaHTML: (p, k, l, v='') => `<div class="mb-4"><label class="form-label">${l}</label><textarea id="${p}-${k}" data-key="${k}" class="form-textarea" rows="4">${v||''}</textarea></div>`,
    selectHTML: (p, k, l, opts, v='') => `<div class="mb-4"><label class="form-label">${l}</label><select id="${p}-${k}" data-key="${k}" class="form-select">${opts.map(o => `<option value="${o.id}" ${o.id==v?'selected':''}>${o.name}</option>`).join('')}</select></div>`,
    showModal: (title, body, footer) => {
        document.getElementById('modal-container').innerHTML = `<div class="modal-overlay visible"><div class="modal-content"><div class="p-6 border-b flex justify-between items-center bg-gray-50"><h2 class="text-xl font-display font-bold text-text-dark">${title}</h2><button onclick="UI.closeModal()" class="text-2xl text-gray-400 hover:text-gray-800">&times;</button></div><div class="p-6">${body}</div><div class="p-6 bg-gray-50 text-right border-t">${footer}</div></div></div>`;
    },
    closeModal: () => document.getElementById('modal-container').innerHTML = ''
};

const App = {
    // CARGA DIFERIDA INTELIGENTE
    async ensureDataForView(view) {
        let sheetsNeeded = [];
        // Lógica de qué cargar según la vista
        if (view === 'projects' || view === 'portfolio-manager') {
            if(!AppState.data.Projects) sheetsNeeded.push('Projects');
            if(!AppState.data.ProjectImages) sheetsNeeded.push('ProjectImages');
        } else if (view === 'rentals') {
             if(!AppState.data.RentalItems) sheetsNeeded.push('RentalItems', 'RentalCategories', 'RentalItemImages');
        } else if (view === 'services') {
             if(!AppState.data.Services) sheetsNeeded.push('Services');
        } else if (view === 'bookings') {
             if(!AppState.data.Bookings) sheetsNeeded.push('Bookings', 'BlockedDates', 'RentalItems');
        } else if (view === 'settings') {
            if(!AppState.data.ClientLogos) sheetsNeeded.push('ClientLogos');
        }

        if (sheetsNeeded.length > 0) {
            UI.showLoading('Cargando detalles...');
            try {
                const newData = await API.call(`/.netlify/functions/get-admin-data?sheets=${sheetsNeeded.join(',')}`);
                // Merge
                AppState.data = { ...AppState.data, ...newData };
                UI.hideLoading();
            } catch(e) {
                console.error(e);
                UI.showToast('Error cargando datos', 'error');
                UI.hideLoading();
            }
        }
    },
    
    async loadData(mode = 'all') { 
        // Modo 'dashboard' solo carga lo básico. Modo 'all' fuerza recarga.
        const params = mode === 'dashboard' ? '?sheets=Projects,Bookings,ProjectImages' : ''; 
        const newData = await API.call(`/.netlify/functions/get-admin-data${params}`);
        AppState.data = { ...AppState.data, ...newData };
    },

    // --- GESTIÓN DE IMÁGENES OPTIMIZADA ---
    async uploadImages(input, parentId, parentTitle, type) {
        const files = Array.from(input.files);
        if (!files.length) return;

        const parentRow = type === 'Projects' 
            ? AppState.data.Projects.find(p => p.id === parentId)
            : AppState.data.RentalItems.find(r => r.id === parentId);
        
        let driveFolderId = parentRow?.driveFolderId || null;
        
        const sheetTarget = type === 'Projects' ? 'ProjectImages' : type === 'ClientLogos' ? 'ClientLogos' : 'RentalItemImages';
        const subfolder = type === 'Projects' ? 'Proyectos' : type === 'ClientLogos' ? 'Logos' : 'Alquiler';
        const idField = type === 'Projects' ? 'projectId' : type === 'RentalItems' ? 'itemId' : 'refId';
        
        // Si es logo, el parentId es genérico
        if (type === 'ClientLogos') parentId = 'general';

        let successCount = 0;

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            UI.showLoading(`Subiendo ${i+1}/${files.length}: ${file.name}`);
            
            try {
                const compressedFile = await new Promise((resolve, reject) => {
                    new Compressor(file, {
                        quality: 0.8, maxWidth: 1600, maxHeight: 1600,
                        success(result) { resolve(result); },
                        error(err) { reject(err); }
                    });
                });

                const formData = new FormData();
                formData.append('file', compressedFile, file.name);
                formData.append('targetSubfolder', subfolder);
                // Envía Nombre si no hay ID, o ID si existe. El backend maneja la lógica.
                formData.append('parentFolderName', driveFolderId || parentTitle); 

                const uploadRes = await API.call('/.netlify/functions/upload-image', { method: 'POST', body: formData });
                
                // Guardar ID de carpeta si es nuevo
                if (uploadRes.driveFolderId && !driveFolderId && type !== 'ClientLogos') {
                    driveFolderId = uploadRes.driveFolderId;
                    // Actualizar padre localmente para siguientes fotos del loop
                    if(parentRow) parentRow.driveFolderId = driveFolderId;
                    
                    await API.call('/.netlify/functions/update-sheet-data', { 
                        method: 'POST', 
                        body: { sheet: type, action: 'update', criteria: { id: parentId }, data: { driveFolderId: driveFolderId } } 
                    });
                }

                await API.call('/.netlify/functions/update-sheet-data', {
                    method: 'POST',
                    body: {
                        sheet: sheetTarget,
                        action: 'add',
                        data: {
                            id: `img_${Date.now()}_${Math.floor(Math.random()*1000)}`,
                            [idField]: parentId,
                            imageUrl: uploadRes.imageUrl,
                            fileId: uploadRes.fileId,
                            isCover: 'No',
                            showInPortfolio: 'No'
                        }
                    }
                });
                successCount++;
            } catch (error) {
                console.error(`Error subiendo ${file.name}:`, error);
                UI.showToast(`Error en ${file.name}`, 'error');
            }
        }
        
        UI.hideLoading();
        UI.showToast(`${successCount} imágenes subidas`);
        
        // Recargar SOLO las imágenes para refrescar el modal
        await App.ensureDataForView(AppState.view); // Refresca datos necesarios
        
        // Forzar recarga específica de la hoja de imágenes
        const refreshSheet = type === 'Projects' ? 'ProjectImages' : type === 'ClientLogos' ? 'ClientLogos' : 'RentalItemImages';
        const freshImages = await API.call(`/.netlify/functions/get-admin-data?sheets=${refreshSheet}`);
        AppState.data[refreshSheet] = freshImages[refreshSheet];

        if (type === 'Projects') this.handleProjectImages(parentId, parentTitle);
        else if (type === 'ClientLogos') this.handleClientLogos();
        else this.handleRentalImages(parentId, parentTitle);
    },

    async handleProjectImages(projectId, title) {
        const images = (AppState.data.ProjectImages || []).filter(i => i.projectId === projectId).sort((a,b) => (a.order||99)-(b.order||99));
        this.renderImageModal(images, projectId, title, 'Projects');
    },
    
    async handleRentalImages(itemId, name) {
        const images = (AppState.data.RentalItemImages || []).filter(i => i.itemId === itemId).sort((a,b) => (a.order||99)-(b.order||99));
        this.renderImageModal(images, itemId, name, 'RentalItems');
    },
    
    async handleClientLogos() {
        const images = (AppState.data.ClientLogos || []).sort((a,b) => (a.order||99)-(b.order||99));
         const html = images.map(i => `
            <div class="flex items-center gap-4 p-3 border rounded mb-2 bg-white image-row" id="img-row-${i.id}">
                <img src="${i.imageUrl}" class="w-16 h-16 object-contain rounded bg-gray-100">
                <div class="flex-1 grid grid-cols-1 gap-2">
                    <label class="text-xs font-bold text-gray-500">Orden <input type="number" class="border p-1 w-full rounded" value="${i.order||99}" onchange="App.quickUpdate('ClientLogos', '${i.id}', 'order', this.value)"></label>
                </div>
                <button class="text-red-500 hover:bg-red-50 p-2 rounded transition-colors" onclick="App.handleDeleteImage('ClientLogos', '${i.id}', document.getElementById('img-row-${i.id}'))"><i class="fas fa-trash"></i></button>
            </div>
        `).join('');
        
        UI.showModal(`Logos de Clientes`, 
            `<div id="img-list" class="max-h-[60vh] overflow-y-auto mb-4 pr-2">${html.length ? html : '<p class="text-center text-gray-400 py-8">No hay logos.</p>'}</div>
             <div class="border-t pt-4">
                <label class="btn btn-primary w-full text-center cursor-pointer justify-center py-3">
                    <i class="fas fa-cloud-upload-alt mr-2"></i> Subir Logo
                    <input type="file" accept="image/*" class="hidden" onchange="App.uploadImages(this, 'client_logos_id', 'Logos Clientes', 'ClientLogos')">
                </label>
             </div>`, 
            '<button class="btn btn-secondary" onclick="UI.closeModal()">Cerrar</button>'
        );
    },

    renderImageModal(images, parentId, title, type) {
        const sheet = type === 'Projects' ? 'ProjectImages' : 'RentalItemImages';
        const html = images.map(i => `
            <div class="flex items-center gap-4 p-3 border rounded mb-2 bg-white image-row" id="img-row-${i.id}">
                <img src="${i.imageUrl}" class="w-16 h-16 object-cover rounded bg-gray-100">
                <div class="flex-1 grid grid-cols-2 gap-2">
                    <label class="text-xs font-bold text-gray-500">Orden <input type="number" class="border p-1 w-full rounded" value="${i.order||99}" onchange="App.quickUpdate('${sheet}', '${i.id}', 'order', this.value)"></label>
                    ${type === 'Projects' ? `<label class="text-xs font-bold text-gray-500">Pie <input type="text" class="border p-1 w-full rounded" value="${i.caption||''}" onchange="App.quickUpdate('${sheet}', '${i.id}', 'caption', this.value)"></label>` : ''}
                </div>
                <div class="flex flex-col gap-2">
                    <label class="flex items-center gap-2 text-xs font-bold cursor-pointer select-none"><input type="checkbox" ${i.isCover==='Si'?'checked':''} onchange="App.quickUpdate('${sheet}', '${i.id}', 'isCover', this.checked?'Si':'No')"> Portada</label>
                    ${type === 'Projects' ? `<label class="flex items-center gap-2 text-xs font-bold cursor-pointer select-none"><input type="checkbox" ${i.showInPortfolio==='Si'?'checked':''} onchange="App.quickUpdate('${sheet}', '${i.id}', 'showInPortfolio', this.checked?'Si':'No')"> Portafolio</label>` : ''}
                </div>
                <button class="text-red-500 hover:bg-red-50 p-2 rounded transition-colors" onclick="App.handleDeleteImage('${sheet}', '${i.id}', document.getElementById('img-row-${i.id}'))"><i class="fas fa-trash"></i></button>
            </div>
        `).join('');
        
        UI.showModal(`Imágenes: ${title}`, 
            `<div id="img-list" class="max-h-[60vh] overflow-y-auto mb-4 pr-2">${html.length ? html : '<p class="text-center text-gray-400 py-8">No hay imágenes aún.</p>'}</div>
             <div class="border-t pt-4">
                <label class="btn btn-primary w-full text-center cursor-pointer justify-center py-3">
                    <i class="fas fa-cloud-upload-alt mr-2"></i> Subir Imágenes
                    <input type="file" multiple accept="image/*" class="hidden" onchange="App.uploadImages(this, '${parentId}', '${title.replace(/'/g, "")}', '${type}')">
                </label>
             </div>`, 
            '<button class="btn btn-secondary" onclick="UI.closeModal()">Cerrar</button>'
        );
    },

    async handleEditCrudItem(sheet, id) { 
        const isNew = !id;
        let html = '';
        
        if(sheet === 'Projects') {
            const p = isNew ? {} : AppState.data.Projects.find(x => x.id === id);
            html = `${UI.inputHTML('crud', 'order', 'Orden', p?.order||99, 'number')} ${UI.inputHTML('crud', 'title', 'Título', p?.title)} ${UI.textareaHTML('crud', 'description', 'Descripción', p?.description)}`;
        } else if (sheet === 'Services') {
             const s = isNew ? {} : AppState.data.Services.find(x => x.id === id);
             html = `${UI.inputHTML('crud', 'order', 'Orden', s?.order||99, 'number')} ${UI.inputHTML('crud', 'title', 'Título', s?.title)} ${UI.inputHTML('crud', 'icon', 'Icono (FontAwesome)', s?.icon||'fas fa-star')} ${UI.textareaHTML('crud', 'intro', 'Intro', s?.intro)}`;
        } else if (sheet === 'RentalItems') {
             const i = isNew ? {} : AppState.data.RentalItems.find(x => x.id === id);
             const cats = AppState.data.RentalCategories || [];
             html = `${UI.inputHTML('crud', 'name', 'Nombre', i?.name)} ${UI.selectHTML('crud', 'categoryId', 'Categoría', cats, i?.categoryId)} ${UI.inputHTML('crud', 'pricePerDay', 'Precio/Día', i?.pricePerDay, 'number')} ${UI.textareaHTML('crud', 'description', 'Descripción Corta', i?.description)} ${UI.textareaHTML('crud', 'long_desc', 'Descripción Larga', i?.long_desc)}`;
        } else if (sheet === 'RentalCategories') {
             const c = isNew ? {} : AppState.data.RentalCategories.find(x => x.id === id);
             html = `${UI.inputHTML('crud', 'order', 'Orden', c?.order||99, 'number')} ${UI.inputHTML('crud', 'name', 'Nombre', c?.name)}`;
        } else if (sheet === 'BlockedDates') {
             const items = AppState.data.RentalItems || [];
             html = `${UI.selectHTML('crud', 'itemId', 'Equipo', items)} ${UI.inputHTML('crud', 'reason', 'Motivo')} ${UI.inputHTML('crud', 'startDate', 'Desde', '', 'date')} ${UI.inputHTML('crud', 'endDate', 'Hasta', '', 'date')}`;
        }
        
        UI.showModal(isNew ? 'Nuevo' : 'Editar', `<form id="crud-form">${html}</form>`, `<button class="btn btn-secondary mr-2" onclick="UI.closeModal()">Cancelar</button><button class="btn btn-primary" onclick="App.saveCrud('${sheet}', '${id}')">Guardar</button>`);
    },

    async saveCrud(sheet, id) {
        try {
            const isNew = !id || id === 'null';
            const data = {};
            document.querySelectorAll('#crud-form input, #crud-form textarea, #crud-form select').forEach(el => data[el.dataset.key] = el.value);
            const idField = sheet === 'BlockedDates' ? 'blockId' : 'id';
            if(isNew) data[idField] = `${sheet.toLowerCase().slice(0,4)}_${Date.now()}`;
            
            UI.showLoading('Guardando...');
            await API.call('/.netlify/functions/update-sheet-data', { method: 'POST', body: { sheet, action: isNew ? 'add' : 'update', criteria: isNew ? null : {[idField]:id}, data } });
            
            // Recargar solo la hoja necesaria
            const newData = await API.call(`/.netlify/functions/get-admin-data?sheets=${sheet}`);
            AppState.data[sheet] = newData[sheet];
            
            UI.closeModal(); 
            UI.renderView(AppState.view);
            UI.showToast('Guardado correctamente');
        } catch (e) { alert(e.message); } finally { UI.hideLoading(); }
    },
    
    async handleDeleteImage(sheet, id, rowEl) {
        UI.showConfirm("¿Eliminar esta imagen permanentemente?", async () => {
            rowEl.style.opacity = '0.3'; rowEl.style.pointerEvents = 'none';
            try {
                const criteria = { id };
                await API.call('/.netlify/functions/update-sheet-data', { method: 'POST', body: { sheet, action: 'delete', criteria } });
                rowEl.remove();
                // Actualizar datos locales para que no reaparezca
                AppState.data[sheet] = AppState.data[sheet].filter(i => i.id !== id);
                UI.showToast('Imagen eliminada');
            } catch(e) {
                alert("Error: " + e.message); rowEl.style.opacity = '1';
            }
        });
    },
    
    async handleDelete(sheet, id, idField='id') {
        UI.showConfirm("¿Eliminar este registro y sus datos asociados?", async () => {
             UI.showLoading('Eliminando...');
             try {
                 await API.call('/.netlify/functions/update-sheet-data', { method: 'POST', body: { sheet, action: 'delete', criteria: { [idField]: id } } });
                 // Actualizar local
                 AppState.data[sheet] = AppState.data[sheet].filter(i => i[idField] !== id);
                 UI.renderView(AppState.view);
                 UI.showToast('Registro eliminado');
             } catch(e) { alert(e.message); } finally { UI.hideLoading(); }
        });
    },
    
    async quickUpdate(sheet, id, field, val) { 
        const valStr = val === true ? 'Si' : (val === false ? 'No' : val);
        try {
            // Update optimista
            const item = AppState.data[sheet].find(i => i.id === id);
            if(item) item[field] = valStr;

            await API.call('/.netlify/functions/update-sheet-data', { method: 'POST', body: { sheet, action: 'update', criteria: {id}, data: {[field]: valStr} } }); 
            UI.showToast('Actualizado');
        } catch(e) { console.error(e); UI.showToast('Error (reintentando en background)', 'error'); }
    },

    async updateLocalPortfolioOrder(id, val) {
        const item = AppState.data.ProjectImages.find(i => i.id === id);
        if(item) item.portfolioOrder = val;
    },
    
    async savePortfolioOrder() {
         UI.showLoading('Guardando orden...');
         try {
             const updates = AppState.data.ProjectImages.filter(i => i.showInPortfolio === 'Si').map(i => 
                API.call('/.netlify/functions/update-sheet-data', { method: 'POST', body: { sheet: 'ProjectImages', action: 'update', criteria: {id: i.id}, data: {portfolioOrder: i.portfolioOrder} } })
             );
             await Promise.all(updates);
             UI.showToast('Orden guardado');
         } catch(e) { alert(e.message); } finally { UI.hideLoading(); }
    },

    async removeFromPortfolio(id) {
        await this.quickUpdate('ProjectImages', id, 'showInPortfolio', 'No');
        // Refrescar vista localmente
        AppState.data.ProjectImages = AppState.data.ProjectImages.map(i => i.id === id ? {...i, showInPortfolio: 'No'} : i);
        UI.renderView('portfolio-manager');
    },
    
    async handleSaveSettings() {
        const data = {};
        document.querySelectorAll('#settings-form-container input').forEach(el => data[el.dataset.key] = el.value);
        UI.showLoading('Guardando...');
        try {
            for (const [key, value] of Object.entries(data)) {
                 await API.call('/.netlify/functions/update-sheet-data', { method: 'POST', body: { sheet: 'Settings', action: 'update', criteria: {key}, data: {value} } });
            }
            await App.loadData('settings');
            UI.showToast('Configuración guardada');
        } catch (e) { alert(e.message); } finally { UI.hideLoading(); }
    }
};

document.getElementById('google-login-btn').addEventListener('click', () => Auth.login());
document.getElementById('logout-btn').addEventListener('click', () => Auth.logout());
document.getElementById('main-nav').addEventListener('click', e => { const link = e.target.closest('.sidebar-link'); if(link) { e.preventDefault(); UI.renderView(link.dataset.view); } });
Auth.init();
</script>
</body>
</html>


