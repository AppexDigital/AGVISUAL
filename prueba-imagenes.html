<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validación Técnica de Imágenes - Appex</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body { background-color: #1a1a1a; color: #e5e5e5; font-family: monospace; }
        .section-box { border: 1px solid #333; padding: 20px; margin-bottom: 20px; border-radius: 8px; background: #222; }
        .img-preview { 
            width: 100%; height: 200px; 
            background: #000; border: 1px dashed #555; 
            display: flex; align-items: center; justify-content: center;
            object-fit: contain; margin-top: 10px;
        }
        .img-preview img { max-width: 100%; max-height: 100%; }
        input[type="text"], input[type="email"] {
            width: 100%; background: #333; border: 1px solid #444; color: #fff; padding: 8px; margin-top: 5px;
        }
        .status { font-size: 12px; margin-top: 5px; color: #aaa; }
        
        /* Estilos para el PDF (Oculto en pantalla) */
        #pdf-layout { display: none; background: white; color: black; padding: 40px; }
        #pdf-layout img { max-width: 100%; height: auto; margin-bottom: 20px; border: 1px solid #ccc; }
    </style>
</head>
<body class="p-8 max-w-4xl mx-auto">

    <h1 class="text-2xl font-bold text-[#B8860B] mb-6">PROTOCOLO DE VALIDACIÓN DE IMÁGENES</h1>

    <div class="section-box">
        <h2 class="text-green-500 font-bold mb-2">1. LINK GOOGLE DRIVE (Manual)</h2>
        <p class="text-xs text-gray-400 mb-2">Pega el link de compartir de Drive. El sistema intentará convertirlo a vista directa.</p>
        <input type="text" id="driveInput" placeholder="https://drive.google.com/file/d/..." oninput="renderDriveImage()">
        <div class="img-preview" id="driveContainer">
            <span class="text-gray-600">Vista Previa Drive</span>
        </div>
        <p class="status" id="driveStatus">Esperando link...</p>
    </div>

    <div class="section-box">
        <h2 class="text-green-500 font-bold mb-2">2. LINK LH3 GOOGLE (Manual)</h2>
        <p class="text-xs text-gray-400 mb-2">Pega el link formato lh3.googleusercontent.com/d/{ID}</p>
        <input type="text" id="lh3Input" placeholder="https://lh3.googleusercontent.com/d/..." oninput="renderLh3Image()">
        <div class="img-preview" id="lh3Container">
            <span class="text-gray-600">Vista Previa LH3</span>
        </div>
        <p class="status" id="lh3Status">Esperando link...</p>
    </div>

    <div class="section-box">
        <h2 class="text-blue-500 font-bold mb-2">3. CARGA IMGBB (API Automática)</h2>
        <p class="text-xs text-gray-400 mb-2">Selecciona archivo -> Sube a API -> Obtiene Link -> Muestra Imagen</p>
        <div class="flex gap-4 mb-2">
            <input type="file" id="imgbbFile" class="text-sm">
            <button onclick="uploadToImgbb()" class="bg-blue-600 px-4 py-1 rounded hover:bg-blue-500 text-sm">Cargar a API</button>
        </div>
        <label class="text-xs text-gray-500">Link Retornado por API:</label>
        <input type="text" id="imgbbOutputLink" readonly placeholder="El link aparecerá aquí automáticamente..." class="text-blue-300">
        <div class="img-preview" id="imgbbContainer">
            <span class="text-gray-600">Vista Previa ImgBB</span>
        </div>
        <p class="status" id="imgbbStatus">Esperando archivo...</p>
    </div>

    <hr class="border-gray-700 my-8">

    <div class="grid grid-cols-2 gap-6">
        
        <div class="section-box">
            <h3 class="font-bold text-white mb-4">Enviar por Correo</h3>
            <label class="text-xs">Correo del Cliente:</label>
            <input type="email" id="clientEmail" placeholder="cliente@ejemplo.com">
            <button onclick="sendEmail()" class="w-full mt-4 bg-[#B8860B] text-black font-bold py-2 rounded hover:bg-yellow-600">
                <i class="fas fa-paper-plane mr-2"></i>Enviar Reporte
            </button>
            <p class="status" id="emailStatus"></p>
        </div>

        <div class="section-box">
            <h3 class="font-bold text-white mb-4">Generar Documento</h3>
            <p class="text-xs text-gray-400 mb-4">Descarga un PDF compilando las 3 imágenes visualizadas arriba.</p>
            <button onclick="generatePDF()" class="w-full bg-red-600 text-white font-bold py-2 rounded hover:bg-red-500">
                <i class="fas fa-file-pdf mr-2"></i>Descargar PDF
            </button>
        </div>
    </div>

    <div id="pdf-layout">
        <h1 style="border-bottom: 2px solid #000; padding-bottom: 10px;">Reporte de Evidencias</h1>
        <p>Fecha: <span id="pdfDate"></span></p>
        
        <div style="margin-top: 20px;">
            <h3>1. Evidencia Drive</h3>
            <img id="pdf-img-1" src="">
            <p style="font-size: 10px; color: blue;" id="pdf-link-1"></p>
        </div>
        <div style="margin-top: 20px;">
            <h3>2. Evidencia LH3</h3>
            <img id="pdf-img-2" src="">
            <p style="font-size: 10px; color: blue;" id="pdf-link-2"></p>
        </div>
        <div style="margin-top: 20px;">
            <h3>3. Evidencia ImgBB</h3>
            <img id="pdf-img-3" src="">
            <p style="font-size: 10px; color: blue;" id="pdf-link-3"></p>
        </div>
    </div>

    <script>
        // --- 1. LÓGICA DRIVE ---
        function renderDriveImage() {
            const input = document.getElementById('driveInput').value;
            const container = document.getElementById('driveContainer');
            const status = document.getElementById('driveStatus');

            // Intento básico de extraer ID y convertir a link directo
            try {
                let directLink = input;
                // Regex para extraer ID de Drive
                const idMatch = input.match(/[-\w]{25,}/);
                if (idMatch) {
                    // Convertir a formato de visualización directa
                    directLink = `https://lh3.googleusercontent.com/d/${idMatch[0]}`;
                }
                
                container.innerHTML = `<img src="${directLink}" onerror="this.src=''; this.parentElement.innerHTML='<span class=\'text-red-500\'>Error al cargar</span>'">`;
                status.textContent = "Intentando renderizar...";
            } catch (e) {
                status.textContent = "Link inválido";
            }
        }

        // --- 2. LÓGICA LH3 ---
        function renderLh3Image() {
            const input = document.getElementById('lh3Input').value;
            const container = document.getElementById('lh3Container');
            
            if(input.length > 10) {
                container.innerHTML = `<img src="${input}" onerror="this.src=''; this.parentElement.innerHTML='<span class=\'text-red-500\'>Error: Link roto o sin permisos</span>'">`;
                document.getElementById('lh3Status').textContent = "Link detectado";
            }
        }

        // --- 3. LÓGICA IMGBB (API) ---
        async function uploadToImgbb() {
            const fileInput = document.getElementById('imgbbFile');
            const status = document.getElementById('imgbbStatus');
            const outputInput = document.getElementById('imgbbOutputLink');
            const container = document.getElementById('imgbbContainer');

            if (fileInput.files.length === 0) {
                alert("Selecciona un archivo primero");
                return;
            }

            status.textContent = "Subiendo a ImgBB vía Backend...";
            
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);

            try {
                // LLAMADA A TU FUNCIÓN SERVERLESS
                // Esta función debe existir en tu carpeta /functions/upload-imgbb.js
                // y usar process.env.IMGBB_API_KEY
                const response = await fetch('/.netlify/functions/upload-imgbb', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error("Error en el servidor");

                const result = await response.json();
                
                // Asumiendo que tu función devuelve { url: "..." }
                if (result.url) {
                    outputInput.value = result.url;
                    container.innerHTML = `<img src="${result.url}">`;
                    status.textContent = "¡Carga exitosa! Link obtenido.";
                    status.classList.add('text-green-500');
                } else {
                    throw new Error("Respuesta de API inesperada");
                }

            } catch (error) {
                console.error(error);
                status.textContent = "Fallo en la carga. ¿Está configurada la función backend?";
                status.classList.add('text-red-500');
                
                // MOCKUP PARA QUE VEAS EL FUNCIONAMIENTO SI NO TIENES EL BACKEND LISTO AÚN
                // Comenta esto cuando tengas el backend real
                /*
                setTimeout(() => {
                    const mockUrl = "https://i.ibb.co/wzn25F2/ejemplo.jpg"; 
                    outputInput.value = mockUrl;
                    container.innerHTML = `<img src="${mockUrl}">`;
                    status.textContent = "(Simulación) Imagen cargada";
                }, 1000);
                */
            }
        }

        // --- 4. ENVÍO DE CORREO ---
        async function sendEmail() {
            const email = document.getElementById('clientEmail').value;
            const link1 = document.getElementById('driveContainer').querySelector('img')?.src || "Sin imagen";
            const link2 = document.getElementById('lh3Container').querySelector('img')?.src || "Sin imagen";
            const link3 = document.getElementById('imgbbOutputLink').value || "Sin imagen";
            const status = document.getElementById('emailStatus');

            if (!email) { alert("Pon un correo"); return; }

            status.textContent = "Enviando correo...";

            try {
                // LLAMADA A TU FUNCIÓN SERVERLESS DE CORREO
                // Esta función debe existir en /functions/send-email.js
                // y usar tus credenciales SMTP o API de email guardadas
                const response = await fetch('/.netlify/functions/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: email,
                        subject: "Reporte de Evidencias - Appex",
                        links: [link1, link2, link3]
                    })
                });

                if (response.ok) {
                    status.textContent = "Correo enviado correctamente.";
                    status.classList.add('text-green-500');
                } else {
                    throw new Error("Error en el envío");
                }
            } catch (e) {
                console.error(e);
                status.textContent = "Error al enviar. Verifica tu función de backend.";
                status.classList.add('text-red-500');
            }
        }

        // --- 5. GENERACIÓN DE PDF ---
        function generatePDF() {
            const element = document.getElementById('pdf-layout');
            
            // Preparar datos para el PDF
            document.getElementById('pdfDate').textContent = new Date().toLocaleString();
            
            const img1 = document.getElementById('driveContainer').querySelector('img')?.src;
            const img2 = document.getElementById('lh3Container').querySelector('img')?.src;
            const img3 = document.getElementById('imgbbContainer').querySelector('img')?.src; // Usa la del contenedor, no el input

            if(img1) { document.getElementById('pdf-img-1').src = img1; document.getElementById('pdf-link-1').textContent = img1; }
            if(img2) { document.getElementById('pdf-img-2').src = img2; document.getElementById('pdf-link-2').textContent = img2; }
            if(img3) { document.getElementById('pdf-img-3').src = img3; document.getElementById('pdf-link-3').textContent = document.getElementById('imgbbOutputLink').value; }

            // Mostrar temporalmente para renderizar
            element.style.display = 'block';

            html2pdf()
                .set({ margin: 10, filename: 'evidencias.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } })
                .from(element)
                .save()
                .then(() => {
                    element.style.display = 'none';
                });
        }
    </script>
</body>
</html>
