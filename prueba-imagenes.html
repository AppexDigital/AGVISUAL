<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba Aislada: Módulo de Evidencias - Appex</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --bg-dark: #1F1F1F;
            --accent-gold: #B8860B;
            --text-light: #FBF9F3;
        }
        body { font-family: sans-serif; background-color: var(--bg-dark); color: var(--text-light); }
        .input-dark {
            background-color: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 8px 12px; border-radius: 6px; width: 100%;
        }
        .btn-gold {
            background-color: var(--accent-gold); color: black; font-weight: bold;
            padding: 10px 20px; border-radius: 6px; transition: all 0.2s;
        }
        .btn-gold:hover { filter: brightness(1.1); transform: translateY(-1px); }
        
        /* Estilo para el contenedor que se convertirá en PDF */
        #pdf-container {
            background-color: #ffffff; 
            color: #000000;
            padding: 20px;
            border-radius: 8px;
            /* Oculto visualmente en modo oscuro, pero usado para generar el PDF limpio */
            display: none; 
        }
        /* Contenedor visual en pantalla (Modo Oscuro) */
        #screen-container .img-box {
            aspect-ratio: 16/9; background-color: #000; border: 1px dashed #444;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            border-radius: 6px;
        }
        #screen-container img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-8">

    <div class="w-full max-w-3xl space-y-8">
        
        <header class="text-center border-b border-white/10 pb-6">
            <h1 class="text-3xl font-bold text-[#B8860B]">Validación de Evidencias</h1>
            <p class="text-gray-400 text-sm mt-1">Prueba aislada de flujo de carga y reporte</p>
        </header>

        <div class="bg-white/5 p-6 rounded-xl border border-white/10">
            <label class="block text-sm font-bold text-gray-300 mb-2">1. Cargar Imágenes (API Segura)</label>
            <div class="flex gap-4">
                <input type="file" id="fileInput" multiple class="input-dark cursor-pointer" accept="image/*">
                <button id="uploadBtn" class="btn-gold whitespace-nowrap">
                    <i class="fas fa-cloud-upload-alt mr-2"></i>Procesar
                </button>
            </div>
            <p id="statusMsg" class="text-xs text-gray-500 mt-2 h-4"></p>
        </div>

        <div id="screen-container" class="space-y-6">
            
            <div class="bg-white/5 p-4 rounded-xl border border-white/10 flex gap-4 items-start">
                <div class="w-1/3">
                    <div class="img-box" id="preview-box-1">
                        <span class="text-gray-600 text-xs">Sin imagen</span>
                    </div>
                </div>
                <div class="w-2/3 space-y-2">
                    <label class="text-xs font-bold text-[#B8860B]">LINK EVIDENCIA #1</label>
                    <input type="text" id="link-input-1" class="input-dark text-sm font-mono text-green-400" readonly placeholder="Esperando carga...">
                </div>
            </div>

            <div class="bg-white/5 p-4 rounded-xl border border-white/10 flex gap-4 items-start">
                <div class="w-1/3">
                    <div class="img-box" id="preview-box-2">
                        <span class="text-gray-600 text-xs">Sin imagen</span>
                    </div>
                </div>
                <div class="w-2/3 space-y-2">
                    <label class="text-xs font-bold text-[#B8860B]">LINK EVIDENCIA #2</label>
                    <input type="text" id="link-input-2" class="input-dark text-sm font-mono text-green-400" readonly placeholder="Esperando carga...">
                </div>
            </div>

            <div class="bg-white/5 p-4 rounded-xl border border-white/10 flex gap-4 items-start">
                <div class="w-1/3">
                    <div class="img-box" id="preview-box-3">
                        <span class="text-gray-600 text-xs">Sin imagen</span>
                    </div>
                </div>
                <div class="w-2/3 space-y-2">
                    <label class="text-xs font-bold text-[#B8860B]">LINK EVIDENCIA #3</label>
                    <input type="text" id="link-input-3" class="input-dark text-sm font-mono text-green-400" readonly placeholder="Esperando carga...">
                </div>
            </div>

        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">
            
            <div class="bg-white/5 p-6 rounded-xl border border-white/10">
                <label class="block text-sm font-bold text-gray-300 mb-2">Destinatario del Reporte</label>
                <div class="space-y-3">
                    <input type="email" id="emailInput" class="input-dark" placeholder="cliente@ejemplo.com">
                    <button id="sendEmailBtn" class="w-full bg-[#22c55e] text-white font-bold py-2 rounded-md hover:bg-green-600 transition-colors">
                        <i class="fas fa-paper-plane mr-2"></i>Enviar Reporte
                    </button>
                </div>
            </div>

            <div class="bg-white/5 p-6 rounded-xl border border-white/10 flex flex-col justify-between">
                <div>
                    <label class="block text-sm font-bold text-gray-300 mb-1">Descargar Documento</label>
                    <p class="text-xs text-gray-500 mb-4">Genera un PDF oficial con las 3 evidencias.</p>
                </div>
                <button id="generatePdfBtn" class="w-full bg-[#ef4444] text-white font-bold py-2 rounded-md hover:bg-red-600 transition-colors">
                    <i class="fas fa-file-pdf mr-2"></i>Generar PDF
                </button>
            </div>

        </div>

    </div>

    <div id="pdf-template" style="display: none;">
        <div style="padding: 40px; font-family: sans-serif; color: #000;">
            <h1 style="color: #B8860B; border-bottom: 2px solid #B8860B; padding-bottom: 10px;">Reporte de Evidencias</h1>
            <p style="margin-top: 10px; color: #666;">Fecha: <span id="pdf-date"></span></p>
            
            <div style="margin-top: 30px;">
                <h3 style="background: #eee; padding: 5px;">Evidencia #1</h3>
                <img id="pdf-img-1" src="" style="width: 100%; max-height: 300px; object-fit: contain; margin: 10px 0; border: 1px solid #ddd;">
                <p style="font-size: 12px; color: blue; word-break: break-all;" id="pdf-link-1"></p>
            </div>

            <div style="margin-top: 30px;">
                <h3 style="background: #eee; padding: 5px;">Evidencia #2</h3>
                <img id="pdf-img-2" src="" style="width: 100%; max-height: 300px; object-fit: contain; margin: 10px 0; border: 1px solid #ddd;">
                <p style="font-size: 12px; color: blue; word-break: break-all;" id="pdf-link-2"></p>
            </div>

            <div style="margin-top: 30px;">
                <h3 style="background: #eee; padding: 5px;">Evidencia #3</h3>
                <img id="pdf-img-3" src="" style="width: 100%; max-height: 300px; object-fit: contain; margin: 10px 0; border: 1px solid #ddd;">
                <p style="font-size: 12px; color: blue; word-break: break-all;" id="pdf-link-3"></p>
            </div>
            
            <div style="margin-top: 50px; text-align: center; font-size: 10px; color: #999;">
                Generado automáticamente por Appex System
            </div>
        </div>
    </div>

    <script>
        // REFERENCIAS
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const statusMsg = document.getElementById('statusMsg');
        
        // 1. LÓGICA DE CARGA (SIMULADA CON LINKS REALES PARA PRUEBA)
        uploadBtn.addEventListener('click', async () => {
            statusMsg.textContent = "Conectando con API...";
            statusMsg.className = "text-xs text-yellow-500 mt-2 h-4";
            
            // NOTA PARA EL USUARIO: Aquí llamamos a tu función de Netlify.
            // Si estás en local sin 'netlify dev', esto fallará, así que puse un fallback.
            try {
                // INTENTO DE LLAMADA REAL
                /* const formData = new FormData();
                for (const file of fileInput.files) { formData.append('images', file); }
                const response = await fetch('/.netlify/functions/upload-photos', { method: 'POST', body: formData });
                const data = await response.json(); 
                */

                // --- MOCKUP (SIMULACIÓN) PARA QUE VEAS QUE EL HTML FUNCIONA YA MISMO ---
                // Esto simula que el servidor te devolvió 3 links de Cloudinary/ImgBB
                await new Promise(r => setTimeout(r, 1500)); // Espera falsa de 1.5s
                const fakeData = {
                    urls: [
                        "https://images.unsplash.com/photo-1585409677983-0f6c41ca9c3b?w=600&auto=format&fit=crop", // Foto Ejemplo 1
                        "https://images.unsplash.com/photo-1518770660439-4636190af475?w=600&auto=format&fit=crop", // Foto Ejemplo 2
                        "https://images.unsplash.com/photo-1526374965328-7f61d4dc18c5?w=600&auto=format&fit=crop"  // Foto Ejemplo 3
                    ]
                };
                
                // LLENAR CAMPOS EN PANTALLA
                updateEvidence(1, fakeData.urls[0]);
                updateEvidence(2, fakeData.urls[1]);
                updateEvidence(3, fakeData.urls[2]);

                statusMsg.textContent = "¡Carga completada exitosamente!";
                statusMsg.className = "text-xs text-green-500 mt-2 h-4";

            } catch (error) {
                console.error(error);
                statusMsg.textContent = "Error en la conexión.";
                statusMsg.className = "text-xs text-red-500 mt-2 h-4";
            }
        });

        function updateEvidence(index, url) {
            // Actualizar vista en pantalla (Oscuro)
            document.getElementById(`link-input-${index}`).value = url;
            const box = document.getElementById(`preview-box-${index}`);
            box.innerHTML = `<img src="${url}" alt="Evidencia ${index}">`;

            // Actualizar vista oculta para PDF (Blanco)
            document.getElementById(`pdf-img-${index}`).src = url;
            document.getElementById(`pdf-link-${index}`).textContent = url;
        }

        // 2. LÓGICA DE PDF (html2pdf)
        document.getElementById('generatePdfBtn').addEventListener('click', () => {
            const element = document.getElementById('pdf-template');
            
            // Poner fecha actual
            document.getElementById('pdf-date').textContent = new Date().toLocaleDateString();
            
            // Mostrar temporalmente para renderizar
            element.style.display = 'block';
            
            const opt = {
                margin:       0.5,
                filename:     'reporte_evidencias.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            // Generar y luego ocultar
            html2pdf().set(opt).from(element).save().then(() => {
                element.style.display = 'none';
            });
        });

        // 3. LÓGICA DE CORREO (Simulación)
        document.getElementById('sendEmailBtn').addEventListener('click', () => {
            const email = document.getElementById('emailInput').value;
            if(!email.includes('@')) {
                alert("Por favor ingresa un correo válido.");
                return;
            }
            
            // Aquí llamarías a tu API de envío de correos
            const btn = document.getElementById('sendEmailBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Enviando...';
            
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-check mr-2"></i>¡Enviado!';
                btn.classList.replace('bg-[#22c55e]', 'bg-blue-600');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.replace('bg-blue-600', 'bg-[#22c55e]');
                }, 3000);
            }, 1500);
        });

    </script>
</body>
</html>
