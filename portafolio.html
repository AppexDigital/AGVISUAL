<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ad√°n G√≥mez | Fot√≥grafo Profesional (v12.4)</title>
    
    <link rel="icon" type="image/png" href="https://placehold.co/32x32/1a1a1a/FDFDFD?text=AG">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* ============================================================
           1. BASES, VARIABLES Y TIPOGRAF√çA (ORIGINALES E INTACTAS)
           ============================================================ */
        :root {
            --bg-main: #FDFDFD;
            --text-dark: #1a1a1a;
            --text-light: #f8f9fa;
            --accent: #3a3a3a;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-dark);
            overflow-x: hidden;
        }
        h1, h2, h3, h4, .font-display { 
            font-family: 'Cormorant Garamond', serif; 
            line-height: 1.4; 
        }
        
        /* ============================================================
           2. ARQUITECTURA DE TRANSICI√ìN Y CARGA (CROSSFADE)
           ============================================================ */
        .page-container { display: none; opacity: 0; transition: opacity 0.5s ease-in-out; }
        .page-active { display: block; opacity: 1; }
        .page-exiting { display: block; opacity: 0; }
        .reveal { opacity: 0; transition: opacity 1.2s cubic-bezier(0.165, 0.84, 0.44, 1); }
        .reveal.visible { opacity: 1; }
        
        .loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-main); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .loader.hidden { opacity: 0; visibility: hidden; transition: opacity 0.5s ease, visibility 0.5s ease; }
        .loader-circle {
            width: 50px; height: 50px; border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%; border-top-color: var(--accent);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* ============================================================
           3. HEADER Y NAVEGACI√ìN DIN√ÅMICA (REPARADO: AJUSTE 8, 9, 16)
           ============================================================ */
        #header { transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1); padding-top: 1.5rem; padding-bottom: 1.5rem; background-color: transparent; }
        #header.header-scrolled {
            background-color: rgba(253, 253, 253, 0.95);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            padding-top: 0.5rem; padding-bottom: 0.5rem;
        }
        
        /* L√≥gica exclusiva para Servicios: Logo Blanco arriba */
        .header-white-icons .nav-link-text, .header-white-icons .social-icon, 
        .header-white-icons #mobile-cart-header, .header-white-icons #mobile-menu-button .icon-bar {
            color: white !important;
        }
        .header-white-icons .logo-dark { display: none !important; }
        .header-white-icons .logo-light { display: block !important; }
        .header-white-icons .icon-bar { background-color: white !important; }

        /* Forzado a Negro: Scroll o Men√∫ abierto (AJUSTE 7) */
        .header-scrolled .logo-dark, #mobile-menu.open ~ #header .logo-dark { display: block !important; }
        .header-scrolled .logo-light, #mobile-menu.open ~ #header .logo-light { display: none !important; }
        .header-scrolled .nav-link-text, .header-scrolled .social-icon, 
        .header-scrolled #mobile-cart-header, #mobile-menu.open ~ #header .nav-link-text,
        #mobile-menu.open ~ #header #mobile-menu-button .icon-bar { color: black !important; }
        .header-scrolled .icon-bar, #mobile-menu.open ~ #header .icon-bar { background-color: black !important; }

        /* ============================================================
           4. MEN√ö M√ìVIL Y SCROLL LOCK (CONSERVADO + AJUSTE 16)
           ============================================================ */
        #mobile-menu {
            background-color: rgba(253, 253, 253, 0.95); backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px); transform: translateX(100%);
            transition: transform 0.6s cubic-bezier(0.76, 0, 0.24, 1);
        }
        #mobile-menu.open { transform: translateX(0); }
        .mobile-nav-link {
            font-family: 'Cormorant Garamond', serif; color: var(--text-dark);
            opacity: 0; transform: translateY(30px);
            transition: opacity 0.5s ease, transform 0.5s ease; position: relative;
        }
        .mobile-nav-link::after {
            content: ''; position: absolute; bottom: -5px; left: 0; width: 0;
            height: 2px; background-color: var(--accent); transition: width 0.4s ease;
        }
        .mobile-nav-link:hover::after, .mobile-nav-link.nav-active::after { width: 100%; }
        #mobile-menu-button .icon-bar { transition: all 0.3s ease-in-out; }
        #mobile-menu-button.open .icon-bar:nth-child(1) { transform: translateY(8px) rotate(45deg); }
        #mobile-menu-button.open .icon-bar:nth-child(2) { opacity: 0; }
        #mobile-menu-button.open .icon-bar:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }
        .lock-scroll { overflow: hidden !important; height: 100vh !important; }

        /* ============================================================
           5. GALER√çA Y LIGHTBOX (CONSERVADOS INTEGROS)
           ============================================================ */
        .gallery-item { cursor: pointer; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; }
        .gallery-item:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15); }
        .gallery-item img { transition: transform 0.8s ease; }
        .gallery-item:hover img { transform: scale(1.05); }
        .gallery-item .overlay { opacity: 0; transition: opacity 0.5s ease; background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 80%); }
        .gallery-item:hover .overlay { opacity: 1; }
        .gallery-item .overlay p { transform: translateY(20px); transition: transform 0.5s ease; }
        .gallery-item:hover .overlay p { transform: translateY(0); }
        
        #lightbox { background-color: rgba(10, 10, 10, 0.95); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); transition: opacity 0.4s ease-in-out; }
        #lightbox-image { transition: transform 0.4s cubic-bezier(0.23, 1, 0.32, 1); transform: scale(0.9); box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5); max-height: 80vh; }
        #lightbox.visible #lightbox-image { transform: scale(1); }
        #lightbox.visible { opacity: 1; pointer-events: auto; }
        #lightbox-close { transition: all 0.3s ease; }
        #lightbox-close:hover { transform: rotate(90deg); color: #ff5252; }
        .lightbox-nav {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1); color: white; border: none; width: 50px; height: 50px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;
            cursor: pointer; transition: all 0.3s ease; z-index: 101;
        }
        .lightbox-nav:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-50%) scale(1.1); }
        #lightbox-prev { left: 20px; }
        #lightbox-next { right: 20px; }

        /* ============================================================
           6. GRIDS Y DISE√ëO RESPONSIVO (PIR√ÅMIDE INVERTIDA + MOSAICO)
           ============================================================ */
        #services-grid, #videos-container, #rental-grid-categorized {
            display: flex !important; flex-wrap: wrap; justify-content: center; gap: 2rem;
        }
        .service-grid-item, .video-card, .rental-card { flex: 0 1 350px; }

        @media (max-width: 640px) {
            /* Mosaico Masonry para Galer√≠as (AJUSTE 2, 7) */
            #portfolio-gallery, .gallery-mosaico-mobile {
                display: block !important; column-count: 2 !important; column-gap: 0.5rem !important;
            }
            .gallery-item { break-inside: avoid; margin-bottom: 0.5rem; }
            
            /* Tarjetas Alquiler (AJUSTE 5, 6) */
            #rental-grid-categorized { gap: 0.75rem !important; }
            .rental-card { flex: 0 1 calc(50% - 0.4rem) !important; }
            .rental-card h3 { font-size: 0.95rem !important; }
            .rental-card .p-6 { padding: 0.5rem !important; }

            /* Grid Servicios */
            .service-grid-item { flex: 0 1 calc(50% - 0.5rem) !important; padding: 1rem !important; }
            .service-icon-wrapper { width: 45px; height: 45px; margin-bottom: 0.5rem; }
            .service-icon { font-size: 1.2rem; }
        }

        /* ============================================================
           7. EST√âTICA DE ALQUILER Y CARRUSELES (CONSERVADO + AJUSTE 5)
           ============================================================ */
        .rental-card {
            background-color: white; border: 1px solid #e5e7eb !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0; transform: translateY(20px); overflow: hidden;
            display: flex; flex-direction: column;
        }
        .rental-card.visible { opacity: 1; transform: translateY(0); }
        .tax-badge-inline { font-size: 10px; color: #6b7280; font-weight: bold; margin-left: 5px; }

        .carousel-container { width: 100%; overflow: hidden; position: relative; background-color: #f3f4f6; }
        .carousel-track { display: flex; transition: transform 0.5s ease-in-out; }
        .carousel-item { min-width: 100%; height: 100%; }
        .carousel-item img { width: 100%; height: 100%; object-fit: cover; }
        .thumb-nav img { width: 60px; height: 60px; object-fit: cover; cursor: pointer; opacity: 0.5; transition: opacity 0.3s; border: 1px solid #eee; }
        .thumb-nav img.active { opacity: 1; border: 2px solid black; }

        /* ============================================================
           8. MODALES Y CARRITO (NOTIFICACI√ìN ROJA - AJUSTE 13)
           ============================================================ */
        .calendar-modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 100; opacity: 0; transition: opacity 0.3s ease-in-out; display: flex; justify-content: center; align-items: center; padding: 1rem; pointer-events: none; }
        .calendar-modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .calendar-modal-content { background-color: white; padding: 1.5rem; max-width: 400px; width: 100%; transform: scale(0.95); opacity: 0; transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        .calendar-modal-overlay.visible .calendar-modal-content { transform: scale(1); opacity: 1; }

        .cart-item-count {
            position: absolute; top: -8px; right: -8px; background-color: #ff0000 !important;
            color: #ffffff !important; border-radius: 50% !important; width: 20px !important; height: 20px !important;
            display: flex !important; align-items: center; justify-content: center;
            font-size: 10px !important; font-weight: 800; border: 2px solid #FDFDFD;
            opacity: 0; transform: scale(0); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .cart-item-count.visible { opacity: 1; transform: scale(1); }

        /* ============================================================
           9. RICH TEXT Y CONTENIDO DEL EDITOR (INTACTO)
           ============================================================ */
        .rich-text-content h1, .rich-text-content h2, .rich-text-content h3 { font-family: 'Cormorant Garamond', serif; font-weight: 700; margin-top: 1.5em; margin-bottom: 0.5em; line-height: 1.2; }
        .rich-text-content p { margin-bottom: 1em; line-height: 1.8; }
        .rich-text-content ul { list-style-type: disc; padding-left: 0; margin-bottom: 1em; list-style-position: inside; }
        .rich-text-content strong, .rich-text-content b { font-weight: 700; color: #000; }
        
        /* ============================================================
           10. CONTACTO, MAPA Y EXCEPCIONES (INTACTO)
           ============================================================ */
        .contact-icon-link { background-color: #f3f4f6; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; }
        #google-map { width: 100%; height: 450px; filter: grayscale(100%) contrast(90%); transition: filter 0.5s ease; border: 0; }
        #google-map:hover { filter: grayscale(0%) contrast(100%); }
        .btn-primary:hover { background-color: #4a4a4a !important; transform: translateY(-2px); transition: all 0.3s ease; }
    </style>
</head>
<body class="antialiased">
    <!-- Indicador de carga -->
    <div class="loader" id="page-loader">
        <div class="flex flex-col items-center w-3/4 max-w-xs md:max-w-md">
            <img src="https://placehold.co/200x64/ffffff/ffffff?text=..." alt="" class="w-full h-auto mb-8 logo-dark transition-opacity duration-300">
            <img src="https://placehold.co/200x64/ffffff/ffffff?text=..." alt="" class="w-full h-auto mb-8 logo-light" style="display: none;">
            <div class="loader-circle"></div>
        </div>
    </div>
    
    <!-- ===== HEADER ===== -->
    <header id="header" class="fixed top-0 left-0 right-0 z-50">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <a href="#" data-target="portfolio" class="nav-link relative group">
                <img src="https://placehold.co/350x144/ffffff/ffffff?text=AG" alt="" class="w-40 lg:w-[250px] h-auto transition-all duration-300 group-hover:scale-105 logo-dark">
                <img src="https://placehold.co/350x144/ffffff/ffffff?text=AG" alt="" class="w-40 lg:w-[250px] h-auto transition-all duration-300 group-hover:scale-105 logo-light" style="display: none;">
            </a>

            <div class="flex items-center">
                <nav class="hidden lg:flex items-center space-x-8 text-sm uppercase tracking-widest">
                    <a href="#" data-target="portfolio" class="nav-link hover:text-gray-500 transition-colors relative group">
                        <span class="nav-link-text">Portafolio</span>
                        <span class="nav-link-underline absolute bottom-0 left-0 w-0 h-0.5 bg-black transition-all duration-300 group-hover:w-full"></span>
                    </a>
                    <a href="#" data-target="projects" class="nav-link hover:text-gray-500 transition-colors relative group">
                        <span class="nav-link-text">Proyectos</span>
                        <span class="nav-link-underline absolute bottom-0 left-0 w-0 h-0.5 bg-black transition-all duration-300 group-hover:w-full"></span>
                    </a>
                    <a href="#" data-target="services" class="nav-link hover:text-gray-500 transition-colors relative group">
                        <span class="nav-link-text">Servicios</span>
                        <span class="nav-link-underline absolute bottom-0 left-0 w-0 h-0.5 bg-black transition-all duration-300 group-hover:w-full"></span>
                    </a>
                    <a href="#" data-target="rental" class="nav-link hover:text-gray-500 transition-colors relative group">
                        <span class="nav-link-text">Alquiler</span>
                        <span class="nav-link-underline absolute bottom-0 left-0 w-0 h-0.5 bg-black transition-all duration-300 group-hover:w-full"></span>
                    </a>
                    <a href="#" data-target="about" class="nav-link hover:text-gray-500 transition-colors relative group">
                        <span class="nav-link-text">Qui√©n Soy</span>
                        <span class="nav-link-underline absolute bottom-0 left-0 w-0 h-0.5 bg-black transition-all duration-300 group-hover:w-full"></span>
                    </a>
                    <a href="#" data-target="contact" class="nav-link hover:text-gray-500 transition-colors relative group">
                        <span class="nav-link-text">Contacto</span>
                        <span class="nav-link-underline absolute bottom-0 left-0 w-0 h-0.5 bg-black transition-all duration-300 group-hover:w-full"></span>
                    </a>
                </nav>

                <div class="hidden lg:flex items-center space-x-4 ml-8">
                   <a href="#" aria-label="WhatsApp" class="social-icon text-gray-700 hover:text-black transition-colors"><i class="fab fa-whatsapp fa-lg"></i></a>
                    <a href="#" aria-label="Instagram" class="social-icon text-gray-700 hover:text-black transition-colors"><i class="fas fa-camera-retro fa-lg"></i></a>
                    <a href="#" aria-label="YouTube" class="social-icon text-gray-700 hover:text-black transition-colors"><i class="fab fa-youtube fa-lg"></i></a>
                    <a href="#" aria-label="Email" class="social-icon text-gray-700 hover:text-black transition-colors"><i class="fas fa-envelope fa-lg"></i></a>
                    <a href="#" aria-label="Tel√©fono" class="social-icon text-gray-700 hover:text-black transition-colors"><i class="fas fa-phone-alt fa-lg"></i></a>
                    <button id="cart-button" class="cart-button social-icon text-gray-700 hover:text-black ml-2">
                        <i class="fas fa-shopping-bag fa-lg"></i>
                        <span id="cart-item-count" class="cart-item-count">0</span>
                    </button>
                </div>

                <div class="flex items-center gap-4 lg:hidden">
                    <button id="mobile-cart-header" class="cart-button text-gray-700 relative" onclick="toggleCart(true)">
                        <i class="fas fa-shopping-bag fa-lg"></i>
                        <span class="cart-item-count absolute -top-2 -right-2 rounded-full w-5 h-5 text-[10px] flex items-center justify-center">0</span>
                    </button>
                    <button id="mobile-menu-button" class="z-50 w-8 h-6 flex flex-col justify-between" aria-label="Men√∫">
                        <span class="block w-full h-0.5 bg-black icon-bar"></span>
                        <span class="block w-full h-0.5 bg-black icon-bar"></span>
                        <span class="block w-full h-0.5 bg-black icon-bar"></span>
                    </button>
                </div>
            </div>
        </div>
    </header>
    <!-- Men√∫ M√≥vil Overlay (Redise√±ado) -->
    <div id="mobile-menu" class="fixed top-0 right-0 w-full h-full z-40 lg:hidden flex flex-col" aria-hidden="true">
        <nav class="flex flex-col justify-center items-center h-full space-y-8 text-3xl flex-grow">
            <a href="#" data-target="portfolio" class="nav-link mobile-nav-link uppercase">Portafolio</a>
            <a href="#" data-target="projects" class="nav-link mobile-nav-link uppercase">Proyectos</a>
            <a href="#" data-target="services" class="nav-link mobile-nav-link uppercase">Servicios</a>
            <a href="#" data-target="rental" class="nav-link mobile-nav-link uppercase">Alquiler</a>
            <a href="#" data-target="about" class="nav-link mobile-nav-link uppercase">Qui√©n Soy</a>
            <a href="#" data-target="contact" class="nav-link mobile-nav-link uppercase">Contacto</a>
        </nav>
        <div class="flex justify-center items-center flex-wrap gap-6 pb-12 px-6">
            <a href="#" aria-label="WhatsApp" class="text-gray-900"><i class="fab fa-whatsapp fa-2x"></i></a>
            <a href="#" aria-label="Instagram" class="text-gray-900"><i class="fas fa-camera-retro fa-2x"></i></a>
            <a href="#" aria-label="Facebook" class="text-gray-900"><i class="fab fa-facebook-f fa-2x"></i></a>
            <a href="#" aria-label="YouTube" class="text-gray-900"><i class="fab fa-youtube fa-2x"></i></a>
            <a href="#" aria-label="Email" class="text-gray-900"><i class="fas fa-envelope fa-2x"></i></a>
            <a href="#" aria-label="Tel√©fono" class="text-gray-900"><i class="fas fa-phone-alt fa-2x"></i></a>
        </div>
    </div>
    <main id="main-content">
        <!-- ===== PORTFOLIO PAGE ===== -->
        <section id="portfolio" class="page-container pt-28 md:pt-36 pb-0" aria-label="Portafolio">
            <div class="container mx-auto px-4 sm:px-6">
                <!-- El contenedor de la galer√≠a ahora es el elemento principal -->
                <div class="reveal">
                    <div id="portfolio-gallery" class="columns-2 sm:columns-3 lg:columns-4 gap-6 space-y-6">
                        <!-- Las ~200 im√°genes se insertan aqu√≠ desde JS -->
                    </div>
                </div>
            </div>

            <div class="bg-zinc-700 text-white py-20 mt-24 reveal">
                <div class="container mx-auto px-6">
                    <div id="videos-container" class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-6xl mx-auto">
                        </div>
                </div>
            </div>

            <div class="bg-gray-100 py-20 reveal">
                <div class="container mx-auto px-6">
                    <div class="text-center mb-12">
                         <h2 class="text-4xl font-display text-gray-800 text-reveal">Confianza y Colaboraci√≥n</h2>
                    </div>
                    <div id="client-logos-container" class="flex justify-center items-center flex-wrap gap-x-12 gap-y-8 max-w-4xl mx-auto min-h-[100px]">
                        </div>
                </div>
            </div>
            
            <div class="bg-gray-100 pt-12 pb-24 reveal">
                <div class="container mx-auto px-6 text-center">
                     <div class="text-center mb-12">
                        <h2 class="text-4xl font-display text-gray-800 text-reveal py-2">¬øListo para el Siguiente Paso?</h2>
                        <p class="text-lg text-gray-600 mt-2 text-reveal">Explora mis proyectos o cont√°ctame para empezar a crear.</p>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                        <a href="#" data-target="projects" class="nav-link btn-primary inline-block bg-black text-white font-bold py-4 px-10 rounded-full text-lg hover:bg-gray-800 transition-transform hover:scale-105 w-full sm:w-auto">Explorar Proyectos</a>
                        <a href="#" data-target="contact" class="nav-link btn-primary inline-block bg-zinc-700 text-white font-bold py-4 px-10 rounded-full text-lg hover:bg-zinc-800 transition-transform hover:scale-105 w-full sm:w-auto">Contactar Ahora</a>
                    </div>
                </div>
            </div>
        </section>
        <!-- ===== PROJECTS PAGE ===== -->
        <section id="projects" class="page-container pt-28 md:pt-36 pb-20 md:pb-24 bg-gray-50" aria-label="Proyectos">
            <div class="container mx-auto px-4 md:px-12">
                <div id="projects-container" class="space-y-20">
                    <!-- Los 7 proyectos se insertan aqu√≠ desde JS -->
                </div>
                <div class="text-center mt-24 reveal">
                     <h3 class="text-3xl font-display text-gray-800 text-reveal">¬øListo para crear tu propia historia?</h3>
                    <a href="#" data-target="services" class="nav-link btn-primary mt-8 inline-block bg-black text-white font-bold py-4 px-10 rounded-full text-lg hover:bg-gray-800 transition-transform hover:scale-105">Descubre mis Servicios</a>
                </div>
            </div>
        </section>
        <!-- ===== SERVICES PAGE (REDESIGNED) ===== -->
        <section id="services" class="page-container pt-28 md:pt-36 pb-20 md:pb-24" aria-label="Servicios">
            <div class="container mx-auto px-6">
                <div id="services-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 max-w-6xl mx-auto reveal">
                    <!-- Los servicios se insertan aqu√≠ desde JS -->
                </div>
            </div>
        </section>
        <!-- ===== RENTAL PAGE (REDESIGNED) ===== -->
        <section id="rental" class="page-container pt-28 md:pt-36 pb-20 md:pb-24 bg-white" aria-label="Alquiler de Equipo">
            <div class="container mx-auto px-6">
                <div id="rental-filters-wrapper" class="reveal mb-12">
                    <div id="rental-filters" class="flex justify-center flex-wrap gap-4">
                        <!-- Filtros de categor√≠a se insertan aqu√≠ -->
                    </div>
                </div>
                <div id="rental-grid-categorized" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- Las tarjetas de alquiler se insertan aqu√≠ -->
                </div>
            </div>
        </section>
        <!-- ===== ABOUT ME PAGE (REDESIGNED) ===== -->
        <section id="about" class="page-container pt-24 md:pt-32 pb-20 md:pb-24 bg-gray-50 overflow-x-hidden w-full" aria-label="Sobre m√≠">
            <div class="container mx-auto px-6">
                <div class="max-w-4xl mx-auto">
                    <div class="text-center reveal">
                        <div class="relative inline-block">
                            <img src="https://placehold.co/288x288/cccccc/999999?text=Cargando..." alt="" class="shadow-xl w-72 h-72 mx-auto mb-8 object-cover transition-opacity duration-500">
                            <div class="absolute inset-0 border-4 border-white border-opacity-30 animate-ping"></div>
                        </div>
                        <p id="about-intro-phrase" class="text-xl text-gray-700 leading-relaxed max-w-2xl mx-auto italic text-reveal mt-8">"No hago fotos para vivir, vivo para hacer fotos. Mi c√°mara no es una herramienta, es una extensi√≥n de mi curiosidad por el mundo y las historias que la gente tiene que contar."</p>
                    </div>
                    <div class="prose max-w-none lg:prose-lg mx-auto mt-16 text-gray-600 leading-relaxed space-y-8 reveal text-justify">
                        <h3 class="text-3xl font-display text-black !mb-4 text-reveal">Mi Filosof√≠a</h3>
                        <div id="about-bio" class="text-reveal space-y-4">
                            <p>Hola, soy Ad√°n G√≥mez. Desde que tom√©...</p>
                        </div>
                        
                        <h3 class="text-3xl font-display text-black !mt-16 !mb-4 text-reveal">Mi Proceso Creativo</h3>
                        <div id="about-process" class="text-reveal space-y-4">
                            <p>Cada proyecto es un viaje colaborativo...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- ===== CONTACT PAGE (REDESIGNED) ===== -->
        <section id="contact" class="page-container pt-28 md:pt-36" aria-label="Contacto">
             <div class="container mx-auto px-6 pb-20 md:pb-24">
                <div class="max-w-3xl mx-auto grid grid-cols-2 md:grid-cols-3 gap-6 text-center reveal">
                    <a href="#" class="contact-icon-link p-8 flex flex-col items-center justify-center">
                        <i class="fas fa-camera-retro fa-3x mb-3"></i>
                        <span class="font-bold">Instagram</span>
                    </a>
                    <a href="#" class="contact-icon-link p-8 flex flex-col items-center justify-center">
                        <i class="fas fa-phone-alt fa-3x mb-3"></i>
                        <span class="font-bold">WhatsApp</span>
                    </a>
                    <a href="#" class="contact-icon-link p-8 flex flex-col items-center justify-center">
                        <i class="fas fa-envelope fa-3x mb-3"></i>
                        <span class="font-bold">Email</span>
                    </a>
                    <a href="#" class="contact-icon-link p-8 flex flex-col items-center justify-center">
                        <i class="fab fa-facebook-f fa-3x mb-3"></i>
                        <span class="font-bold">Facebook</span>
                    </a>
                    <a href="#" class="contact-icon-link p-8 flex flex-col items-center justify-center">
                        <i class="fab fa-youtube fa-3x mb-3"></i>
                        <span class="font-bold">YouTube</span>
                    </a>
                    <a href="#" class="contact-icon-link p-8 flex flex-col items-center justify-center">
                        <i class="fas fa-phone fa-3x mb-3"></i>
                        <span class="font-bold">Tel√©fono</span>
                    </a>
                </div>
            </div>
            <div class="container mx-auto px-6 text-center mb-12 reveal">
                <h2 class="text-4xl font-display text-gray-800 text-reveal">Mi Estudio</h2>
             </div>
            <div class="reveal">
                <iframe id="google-map" src="https://www.google.com/maps/embed?pb=!1m18!m12!1m3!1d31431.83101261831!2d-84.0101680513672!3d10.023880900000004!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x8fa0f3c43dd70743%3A0x18258b381d58552a!2sV%C3%A1squez%20de%20Coronado!5e0!3m2!1ses-419!2scr!4v1722547858413!5m2!1ses-419!2scr" width="100%" height="450" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
            </div>
        </section>
        <!-- PROJECT DETAIL PAGES CONTAINER -->
        <div id="project-detail-pages"></div>
        <!-- RENTAL DETAIL PAGES CONTAINER -->
        <div id="rental-detail-pages"></div>
        <!-- SERVICE DETAIL PAGES CONTAINER -->
        <div id="service-detail-pages"></div>
    </main>
    <!-- Lightbox Modal -->
    <div id="lightbox" class="fixed inset-0 z-[100] flex items-center justify-center hidden opacity-0" role="dialog" aria-modal="true" aria-label="Vista ampliada de imagen">
        <button id="lightbox-close" class="absolute top-6 right-6 text-white text-5xl font-light hover:opacity-75 transition-opacity" aria-label="Cerrar vista ampliada">√ó</button>
        <button id="lightbox-prev" class="lightbox-nav" aria-label="Imagen anterior">
            <i class="fas fa-chevron-left"></i>
        </button>
        <button id="lightbox-next" class="lightbox-nav" aria-label="Imagen siguiente">
            <i class="fas fa-chevron-right"></i>
        </button>
        <div class="text-white text-center absolute bottom-6 left-0 right-0">
            <p id="lightbox-caption" class="text-lg"></p>
        </div>
        <img id="lightbox-image" src="" alt="Vista ampliada" class="max-w-[90vw] max-h-[85vh] shadow-2xl">
    </div>

    <!-- Contenedor del Modal del Calendario (se a√±ade al final del body) -->
    <div id="calendar-modal-container"></div>
    
    <!-- NUEVA ESTRUCTURA DEL CARRITO -->
    <div id="cart-overlay"></div>
    <aside id="cart-drawer" aria-labelledby="cart-heading">
        <div class="p-6 border-b flex justify-between items-center">
            <h2 id="cart-heading" class="text-2xl font-display">Tu Carrito de Alquiler</h2>
            <button id="cart-close-btn" class="text-2xl text-gray-500 hover:text-black">&times;</button>
        </div>
        <div id="cart-items-container" class="flex-grow overflow-y-auto p-6">
            <!-- Los art√≠culos del carrito se renderizar√°n aqu√≠ -->
            <div id="cart-empty-state" class="text-center p-8 flex flex-col items-center justify-center h-full">
                <i class="fas fa-camera-retro text-5xl text-gray-300 mb-6"></i>
                <h3 class="font-display text-2xl mb-2">Tu carrito est√° vac√≠o</h3>
                <p class="text-gray-500 mb-8 max-w-xs">Parece que a√∫n no has a√±adido equipo. ¬°Explora nuestro cat√°logo!</p>
                <a href="#" data-target="rental" class="nav-link btn-primary inline-block bg-black text-white font-bold py-3 px-8 rounded-full hover:bg-gray-800">
                    Explorar Equipo
                </a>
            </div>
        </div>
        <div class="p-6 border-t bg-gray-50">
            <div class="flex justify-between items-center font-bold text-lg mb-4">
                <span>Subtotal:</span>
                <span id="cart-subtotal">$0.00</span>
            </div>
            <button id="checkout-btn" class="w-full bg-black text-white py-4 font-bold hover:bg-gray-800 transition-colors disabled:bg-gray-300">Finalizar Reserva</button>
        </div>
    </aside>
    
    <!-- NUEVA ESTRUCTURA PARA EL MODAL DE CHECKOUT -->
    <div id="checkout-modal-container"></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
        
            // =================================================================
            // 1. VARIABLES GLOBALES Y MEMORIA
            // =================================================================
            let globalData = {
                portfolio: [],
                videos: [],
                logos: [],
                allProjectImages: [], 
                projects: [],         
                services: [],         
                rentals: { items: [], categories: [], dates: [] } 
            };
            let rentalDataGlobal = {}; 
            let cart = [];
            
            // Lightbox vars
            let lightboxImages = [];
            let currentLbIndex = 0;
    
            // =================================================================
            // 2. SELECTORES DEL DOM (DEFINIDOS PRIMERO - VITAL)
            // =================================================================
            const header = document.getElementById('header');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const allNavLinks = document.querySelectorAll('.nav-link');
            const pageLoader = document.getElementById('page-loader');
            
            // Lightbox Elements
            const lightbox = document.getElementById('lightbox');
            const lightboxImage = document.getElementById('lightbox-image');
            const lightboxCaption = document.getElementById('lightbox-caption');
            const lightboxClose = document.getElementById('lightbox-close');
            const lightboxPrev = document.getElementById('lightbox-prev');
            const lightboxNext = document.getElementById('lightbox-next');
            
            // Carrito Elements
            const cartButton = document.getElementById('cart-button');
            const mobileCartButton = document.getElementById('mobile-cart-button');
            const cartItemCount = document.getElementById('cart-item-count');
            const mobileCartItemCount = document.getElementById('mobile-cart-item-count');
            const cartOverlay = document.getElementById('cart-overlay');
            const cartDrawer = document.getElementById('cart-drawer');
            const cartCloseBtn = document.getElementById('cart-close-btn');
            const cartItemsContainer = document.getElementById('cart-items-container');
            const cartEmptyState = document.getElementById('cart-empty-state');
            const cartSubtotalEl = document.getElementById('cart-subtotal');
            const checkoutBtn = document.getElementById('checkout-btn');
    
            // =================================================================
            // 3. API FETCH (CONEXI√ìN SEGURA)
            // =================================================================
            const fetchSectionData = async (section) => {
                try {
                    // console.log(`üì° Descargando: ${section}...`); 
                    const res = await fetch(`/.netlify/functions/get-website-data?section=${section}`);
                    if (!res.ok) throw new Error('Error API');
                    return await res.json();
                } catch (e) {
                    console.warn(`Esperando datos para ${section}...`);
                    return null;
                }
            };

            // --- HELPER: EXPANDIR RANGOS DE FECHAS ---
            // Toma una fecha de inicio y fin, y devuelve una lista de todos los d√≠as intermedios.
            const getDatesInRange = (startDate, endDate) => {
                const date = new Date(startDate + 'T00:00:00');
                const end = new Date(endDate + 'T00:00:00');
                const dates = [];
                while (date <= end) {
                    dates.push(new Date(date).toISOString().split('T')[0]);
                    date.setDate(date.getDate() + 1);
                }
                return dates;
            };
            
    
            // =================================================================
            // 4. FUNCIONES DE INTERFAZ (UI)
            // =================================================================
            const handleScrollHeader = () => {
                // Ajuste 8 & 9: Blanco SOLO en Service Detail cuando est√° arriba
                const isServiceDetail = !!document.querySelector('.page-active[id^="service-detail-"]');
                const menuOpen = mobileMenu.classList.contains('open');
                
                if (window.scrollY > 50 || menuOpen) {
                    header.classList.add('header-scrolled');
                    header.classList.remove('header-white-icons');
                    // Forzamos logo negro en scroll
                    document.querySelectorAll('.logo-dark').forEach(el => el.style.display = 'block');
                    document.querySelectorAll('.logo-light').forEach(el => el.style.display = 'none');
                } else {
                    header.classList.remove('header-scrolled');
                    if (isServiceDetail) {
                        header.classList.add('header-white-icons');
                        document.querySelectorAll('.logo-dark').forEach(el => el.style.display = 'none');
                        document.querySelectorAll('.logo-light').forEach(el => el.style.display = 'block');
                    } else {
                        header.classList.remove('header-white-icons');
                        document.querySelectorAll('.logo-dark').forEach(el => el.style.display = 'block');
                        document.querySelectorAll('.logo-light').forEach(el => el.style.display = 'none');
                    }
                }
            };

            // Ajuste 11: Bloqueo persistente local (Carrito + Memoria)
            const getLocalBlockedDates = (itemId) => {
                const savedCart = JSON.parse(localStorage.getItem('ag_rental_cart') || '[]');
                return savedCart
                    .filter(c => String(c.id) === String(itemId))
                    .flatMap(c => getDatesInRange(c.startDate, c.endDate));
            };
    
            // Inyectar Botones de Regreso al final de Proyectos y Servicios
            const addBackButtons = () => {
                const containers = ['projects-container', 'service-detail-pages'];
                containers.forEach(id => {
                    const el = document.getElementById(id);
                    if (el && !el.querySelector('.back-footer-btn')) {
                        const btn = document.createElement('div');
                        btn.className = 'flex justify-center mt-12 mb-8 back-footer-btn';
                        btn.innerHTML = `<button onclick="navigateTo('${id.includes('service') ? 'services' : 'projects'}')" class="btn-primary bg-zinc-700 text-white px-8 py-3 rounded-full font-bold">VOLVER</button>`;
                        el.appendChild(btn);
                    }
                });
            };
    
            const toggleMobileMenu = (forceState) => {
                const isOpen = typeof forceState === 'boolean' ? forceState : !mobileMenu.classList.contains('open');
                mobileMenu.classList.toggle('open', isOpen);
                
                // SCROLL LOCK: Bloqueo de fondo al abrir men√∫
                if (isOpen) {
                    document.body.style.overflow = 'hidden';
                    document.body.style.height = '100vh';
                } else {
                    document.body.style.overflow = '';
                    document.body.style.height = '';
                }
                mobileMenuButton.classList.toggle('open', isOpen);
                mobileMenuButton.setAttribute('aria-expanded', isOpen);
    
                // RESTAURADO: Bucle que hace aparecer los textos uno por uno
                const links = mobileMenu.querySelectorAll('.mobile-nav-link');
                links.forEach((link, index) => {
                    if (isOpen) {
                        // Entrada: Retraso escalonado
                        setTimeout(() => {
                            link.style.opacity = '1';
                            link.style.transform = 'translateY(0)';
                        }, 150 + (index * 50));
                    } else {
                        // Salida: Reset inmediato
                        link.style.opacity = '0';
                        link.style.transform = 'translateY(30px)';
                    }
                });
            };
    
            const toggleCart = (show) => {
                if (show) {
                    cartOverlay.classList.add('visible');
                    cartDrawer.classList.add('visible');
                } else {
                    cartOverlay.classList.remove('visible');
                    cartDrawer.classList.remove('visible');
                }
            };
    
            const updateCartIcon = () => {
                const count = cart.length;
                if(cartItemCount) { cartItemCount.textContent = count; cartItemCount.classList.toggle('visible', count > 0); }
                if(mobileCartItemCount) { mobileCartItemCount.textContent = count; mobileCartItemCount.classList.toggle('visible', count > 0); }
            };
    
            const observeElements = (container) => {
                if(!container) return;
                const revealObserver = new IntersectionObserver((entries, obs) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('visible');
                            obs.unobserve(entry.target);
                            entry.target.querySelectorAll('.text-reveal').forEach(el => setTimeout(() => el.classList.add('revealed'), 200));
                        }
                    });
                }, { threshold: 0.1 });
                container.querySelectorAll('.reveal').forEach(el => revealObserver.observe(el));
            };
    
            // --- Lightbox Logic ---
            const openLightbox = (src, caption, imagesArr, index) => {
                lightboxImages = imagesArr; currentLbIndex = index;
                lightboxImage.src = src; 
                if(lightboxCaption) lightboxCaption.textContent = caption;
                
                const hasMultiple = imagesArr.length > 1;
                if(lightboxPrev) lightboxPrev.style.display = hasMultiple ? 'flex' : 'none';
                if(lightboxNext) lightboxNext.style.display = hasMultiple ? 'flex' : 'none';
                
                lightbox.classList.remove('hidden');
                setTimeout(() => lightbox.classList.add('visible'), 10);
            };
    
            const navigateLightbox = (dir) => {
                if(lightboxImages.length < 2) return;
                currentLbIndex = (dir === 'next') 
                    ? (currentLbIndex + 1) % lightboxImages.length 
                    : (currentLbIndex - 1 + lightboxImages.length) % lightboxImages.length;
                
                lightboxImage.style.opacity = '0';
                setTimeout(() => {
                    lightboxImage.src = lightboxImages[currentLbIndex].src;
                    if(lightboxCaption) lightboxCaption.textContent = lightboxImages[currentLbIndex].title;
                    lightboxImage.style.opacity = '1';
                }, 200);
            };
    
            const closeLightbox = () => {
                lightbox.classList.remove('visible');
                setTimeout(() => { lightbox.classList.add('hidden'); lightboxImage.src = ''; }, 300);
            };


            // --- GESTI√ìN DE MEMORIA DEL CARRITO ---
            const saveCartToMemory = () => localStorage.setItem('ag_rental_cart', JSON.stringify(cart));

            const loadCartFromMemory = () => {
                const saved = localStorage.getItem('ag_rental_cart');
                if (saved) {
                    try { cart = JSON.parse(saved); renderCart(); updateCartIcon(); } 
                    catch (e) { console.error(e); cart = []; }
                }
            };

            const syncCartWithFreshData = () => {
                if (cart.length === 0 || globalData.rentals.items.length === 0) return;
                let updated = false;
                cart = cart.map(cItem => {
                    const fresh = globalData.rentals.items.find(i => i.id === cItem.id);
                    if (fresh) {
                        const freshPrice = parseFloat(fresh.pricePerDay);
                        if (cItem.price !== freshPrice || cItem.name !== fresh.name) {
                            cItem.price = freshPrice; cItem.name = fresh.name;
                            cItem.hasTax = String(fresh.hasTax).toLowerCase() === 'true';
                            updated = true;
                        }
                    }
                    return cItem;
                });
                if (updated) { saveCartToMemory(); renderCart(); }
            };
            
            // =================================================================
            // 5. RENDERIZADORES (PINTAR HTML)
            // =================================================================
            
            const renderCart = () => {
                // 1. Limpiar items visuales
                const items = cartItemsContainer.querySelectorAll('.cart-item');
                items.forEach(item => item.remove());

                // 2. PREPARACI√ìN DEL FOOTER (CR√çTICO: Hacemos esto SIEMPRE, est√© vac√≠o o lleno)
                const footerContainer = document.querySelector('#cart-drawer .border-t.bg-gray-50');
                let detailsDiv = document.getElementById('cart-footer-details');

                // Si no existe el contenedor din√°mico de totales, lo creamos ahora
                if (!detailsDiv) {
                    detailsDiv = document.createElement('div');
                    detailsDiv.id = 'cart-footer-details';
                    
                    // Lo insertamos antes del bot√≥n de Checkout
                    if (checkoutBtn && footerContainer) {
                        footerContainer.insertBefore(detailsDiv, checkoutBtn);
                        
                        // Eliminamos el HTML est√°tico viejo (el que ven√≠a por defecto en el HTML)
                        // para que no salga duplicado el "Subtotal".
                        const oldStaticTotal = footerContainer.querySelector('.flex.justify-between.items-center.font-bold');
                        if (oldStaticTotal) oldStaticTotal.remove();
                    }
                }

                // 3. L√≥gica de Estado (Vac√≠o vs Lleno)
                if (cart.length === 0) {
                    cartEmptyState.style.display = 'flex';
                    checkoutBtn.disabled = true;
                    
                    // AHORA S√ç: El contenedor existe seguro, podemos escribir
                    if (detailsDiv) {
                        detailsDiv.innerHTML = `
                            <div class="flex justify-between items-center font-bold text-lg mb-4">
                                <span>Total:</span><span>$0.00</span>
                            </div>`;
                    }
                } else {
                    cartEmptyState.style.display = 'none';
                    checkoutBtn.disabled = false;
                    
                    let subtotalGlobal = 0;
                    let taxGlobal = 0;
    
                    cart.forEach(item => {
                        const lineSubtotal = item.price * item.totalDays;
                        const lineTax = item.hasTax ? (lineSubtotal * 0.13) : 0;
                        
                        subtotalGlobal += lineSubtotal;
                        taxGlobal += lineTax;
    
                        const cartItemEl = document.createElement('div');
                        cartItemEl.className = 'cart-item flex items-start space-x-4 py-4 border-b';
                        cartItemEl.innerHTML = `
                            <img src="${item.image}" alt="${item.name}" class="w-20 h-20 object-cover">
                            <div class="flex-grow">
                                <h4 class="font-bold text-sm">${item.name}</h4>
                                <p class="text-xs text-gray-500 my-1">
                                    ${new Date(item.startDate + 'T00:00:00').toLocaleDateString('es-ES')} - ${new Date(item.endDate + 'T00:00:00').toLocaleDateString('es-ES')}
                                </p>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs bg-gray-100 px-2 py-1 rounded">${item.totalDays} d√≠as</span>
                                    <div class="text-right">
                                        <p class="font-bold text-sm">$${(lineSubtotal + lineTax).toFixed(2)}</p>
                                        ${item.hasTax ? '<span class="text-[10px] text-gray-400 block">(Inc. IVA)</span>' : ''}
                                    </div>
                                </div>
                            </div>
                            <button class="cart-item-remove-btn text-gray-400 hover:text-red-500 ml-2" data-cart-id="${item.cartId}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        `;
                        cartItemsContainer.appendChild(cartItemEl);
                    });
    
                    // Renderizamos los totales en el contenedor seguro
                    const totalGlobal = subtotalGlobal + taxGlobal;
                    if (taxGlobal > 0) {
                        detailsDiv.innerHTML = `
                            <div class="space-y-2 mb-4 text-sm text-gray-600">
                                <div class="flex justify-between"><span>Subtotal:</span><span>$${subtotalGlobal.toFixed(2)}</span></div>
                                <div class="flex justify-between text-black"><span>IVA (13%):</span><span>$${taxGlobal.toFixed(2)}</span></div>
                                <div class="flex justify-between font-bold text-xl text-black border-t pt-2 mt-2">
                                    <span>Total:</span><span>$${totalGlobal.toFixed(2)}</span>
                                </div>
                            </div>
                        `;
                    } else {
                        detailsDiv.innerHTML = `
                            <div class="flex justify-between items-center font-bold text-xl mb-4 text-black">
                                <span>Total:</span><span>$${totalGlobal.toFixed(2)}</span>
                            </div>
                        `;
                    }
                }
            };
    
            const addToCart = (item, startDate, endDate) => {
                const totalDays = Math.ceil(Math.abs(new Date(endDate) - new Date(startDate)) / (86400000)) + 1;
                const cartId = `${item.id}-${startDate}`; 
                
                if (cart.some(cartItem => cartItem.cartId === cartId)) {
                    alert('Este art√≠culo ya est√° en tu carrito para estas fechas.');
                    return;
                }
    
                // CORRECCI√ìN: Extraemos expl√≠citamente .imageUrl del primer objeto del array
                const firstImageObj = (item.images && item.images.length > 0) ? item.images[0] : null;
                const thumbUrl = firstImageObj ? firstImageObj.imageUrl : 'https://placehold.co/100?text=Sin+Foto';
    
                cart.push({ 
                    ...item, 
                    cartId: cartId, 
                    startDate: startDate, 
                    endDate: endDate, 
                    totalDays: totalDays, 
                    image: thumbUrl // Ahora s√≠ es un string (URL), no un objeto
                });

                saveCartToMemory();
                renderCart(); 
                updateCartIcon(); 
                toggleCart(true);
            };
    
            const renderPortfolio = () => {
                const gallery = document.getElementById('portfolio-gallery');
                if(!gallery) return;
                if (globalData.portfolio.length === 0) { gallery.innerHTML = '<p class="text-center col-span-full text-gray-400 py-10">Cargando portafolio...</p>'; return; }
                gallery.innerHTML = globalData.portfolio.map(item => `
                    <div class="gallery-item break-inside-avoid overflow-hidden relative img-container mb-6">
                        <img src="${item.imageUrl}" alt="${item.caption || 'Foto'}" loading="lazy" class="w-full h-auto object-cover hover:scale-105 transition-transform duration-700">
                        <div class="overlay absolute inset-0 flex items-end p-4 bg-gradient-to-t from-black/60 to-transparent opacity-0 hover:opacity-100 transition-opacity duration-300">
                            <p class="text-white text-lg font-bold translate-y-4 transition-transform duration-300">${item.caption || ''}</p>
                        </div>
                    </div>`).join('');
            };
    
            const renderVideos = (list) => {
                const container = document.getElementById('videos-container');
                if(!container) return;
                if (!list || list.length === 0) { container.parentElement.parentElement.style.display = 'none'; return; }
                container.innerHTML = list.map(v => {
                    let src = v.embedUrl || "";
                    if (src.includes('watch?v=')) src = src.replace('watch?v=', 'embed/');
                    else if (src.includes('youtu.be/')) src = src.replace('youtu.be/', 'www.youtube.com/embed/');
                    
                    // AJUSTE: Activar API de YouTube
                    const separator = src.includes('?') ? '&' : '?';
                    src += `${separator}enablejsapi=1`;

                    return `<div class="w-full aspect-video overflow-hidden shadow-lg gallery-item group bg-black rounded-none border border-gray-800 relative"><iframe src="${src}" title="${v.title}" class="w-full h-full object-cover" allowfullscreen></iframe></div>`;
                }).join('');
            };
    
            const renderClientLogos = (list) => {
                const container = document.getElementById('client-logos-container');
                if(!container) return;
                if (!list || list.length === 0) { container.innerHTML = ''; return; }
                container.innerHTML = list.map(l => `<img src="${l.logoUrl}" alt="Cliente" class="client-logo h-24 md:h-32 w-auto object-contain transition-all duration-300 grayscale hover:grayscale-0 opacity-70 hover:opacity-100 hover:scale-110">`).join('');
            };
    
            // Ajuste 1: Zig-Zag Proyectos y Bot√≥n Regresar (Ajuste 4)
            const renderProjects = () => {
                const container = document.getElementById('projects-container');
                if(!container) return;
                
                let html = globalData.projects.map((p, i) => `
                    <div class="grid grid-cols-1 md:grid-cols-2 items-center reveal gap-8 md:gap-12">
                        <div class="p-4 md:p-8 ${i % 2 === 0 ? 'md:text-right' : 'md:order-last md:text-left'}">
                            <h3 class="text-3xl md:text-4xl font-display mb-4">${p.title}</h3>
                            <p class="text-gray-600 mb-6 line-clamp-3">${p.description}</p>
                            <a href="#" data-target="project-detail-${p.id}" class="nav-link text-black font-bold uppercase border-b-2 border-black pb-1">Ver Galer√≠a Completa</a>
                        </div>
                        <div class="overflow-hidden h-64 md:h-96 shadow-lg"><img src="${p.coverImageUrl}" class="w-full h-full object-cover"></div>
                    </div>`).join('');
                
                // Bot√≥n Seguir Explorando al final (Ajuste 4)
                html += `<div class="flex justify-center mt-12"><button onclick="navigateTo('portfolio')" class="btn-primary bg-black text-white px-10 py-4 rounded-full font-bold">VOLVER AL INICIO</button></div>`;
                container.innerHTML = html;
                observeElements(container);
            };




            
            const renderServicesGrid = () => {
                const container = document.getElementById('services-grid');
                if(!container) return;
                
                // Si por error se cre√≥ el buscador antes, lo eliminamos del DOM
                const searchBar = document.getElementById('service-search-container');
                if (searchBar) searchBar.remove();
    
                if (globalData.services.length === 0) { 
                    container.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400">Cargando servicios...</div>'; 
                    return; 
                }
    
                container.innerHTML = globalData.services.map(s => `
                    <a href="#" data-target="service-detail-${s.id}" class="nav-link service-grid-item items-center justify-center text-center py-12 reveal">
                        <div class="service-icon-wrapper"><i class="${s.iconClass || 'fas fa-camera'} service-icon"></i></div>
                        <h3 class="text-2xl font-display text-gray-900">${s.title}</h3>
                    </a>`).join('');
                
                observeElements(container);
            };

            // Funci√≥n auxiliar para el carrusel de miniaturas (Ajuste 3)
            window.moveCarousel = (targetId, index) => {
                const section = document.getElementById(targetId);
                if (!section) return;
                const track = section.querySelector('.carousel-track');
                const thumbs = section.querySelectorAll('.thumb-nav img');
                
                track.style.transform = `translateX(-${index * 100}%)`;
                thumbs.forEach((t, i) => t.classList.toggle('active', i === index));
            };

            const renderRentalPage = () => {
                const filtersContainer = document.getElementById('rental-filters');
                const gridContainer = document.getElementById('rental-grid-categorized');
                if (!filtersContainer || !gridContainer) return;

                if (globalData.rentals.categories.length === 0) { 
                    gridContainer.innerHTML = '<p class="text-center col-span-full text-gray-400">Cargando...</p>'; 
                    return; 
                }

                const cats = globalData.rentals.categories;
                filtersContainer.innerHTML = `<button class="rental-category-btn active" data-category="Todo">Todo</button>` + 
                    cats.map(c => `<button class="rental-category-btn" data-category="${c.id}">${c.name}</button>`).join('');

                let activeCategory = 'Todo';

                const renderItems = () => {
                    let items = globalData.rentals.items;
                    if(activeCategory !== 'Todo') items = items.filter(i => i.categoryId === activeCategory);
                    
                    gridContainer.innerHTML = items.map(currentItem => {
                        const taxBadge = String(currentItem.hasTax).toLowerCase() === 'true' ? '<span class="tax-badge-inline"> + IVA</span>' : '';
                        const imgs = currentItem.images || [];
                        const firstImg = imgs.length ? imgs[0].imageUrl : 'https://placehold.co/400?text=Sin+Foto';

                        return `
                        <div class="rental-card reveal flex flex-col h-full"> 
                            <div class="carousel-container h-80 w-full relative">
                                <div class="carousel-track flex h-full">
                                    <div class="carousel-item w-full"><img src="${firstImg}" class="w-full h-full object-cover"></div>
                                </div>
                            </div>
                            <div class="p-6 flex flex-col flex-grow">
                                <div class="flex justify-between items-baseline mb-2">
                                    <h3 class="font-display text-2xl">${currentItem.name}</h3>
                                    <p class="font-bold text-xl">$${currentItem.pricePerDay}${taxBadge}</p>
                                </div>
                                <p class="text-gray-600 text-sm mb-4 line-clamp-3">${currentItem.shortDescription || currentItem.description}</p>
                                <a href="#" data-target="rental-detail-${currentItem.id}" class="nav-link text-sm font-bold text-black uppercase mt-auto">Ver Detalles</a>
                            </div>
                        </div>`;
                    }).join('');
                    observeElements(gridContainer);
                };

                filtersContainer.onclick = (e) => { 
                    if (e.target.matches('.rental-category-btn')) { 
                        filtersContainer.querySelector('.active').classList.remove('active'); 
                        e.target.classList.add('active'); 
                        activeCategory = e.target.dataset.category; 
                        renderItems(); 
                    }
                };
                renderItems();
            };



            
         




            
    
            const renderProjectDetail = (targetId) => {
                const realId = targetId.substring(15);
                const project = globalData.projects.find(p => String(p.id) === realId);
                if (!project) return;
                
                const container = document.getElementById('project-detail-pages');
                container.innerHTML = `
                    <section id="${targetId}" class="page-container pt-32 md:pt-40 pb-20 md:pb-24 bg-white">
                        <div class="container mx-auto px-6"><div class="max-w-6xl mx-auto">
                            <a href="#" data-target="projects" class="nav-link text-gray-500 hover:text-black transition-colors mb-8 inline-flex items-center gap-2"><i class="fas fa-arrow-left"></i> Volver a Proyectos</a>
                            <div class="text-center mb-16 reveal"><h2 class="text-4xl md:text-6xl font-display text-reveal mb-4">${project.title}</h2><p class="text-lg text-gray-600 mt-4 max-w-3xl mx-auto text-reveal text-center">${project.description}</p></div>
                            <div class="columns-1 sm:columns-2 lg:columns-3 gap-6 space-y-6 reveal">
                                ${(project.images||[]).map(img => `
                                    <div class="gallery-item break-inside-avoid overflow-hidden relative img-container mb-6 group">
                                        <img src="${img.imageUrl}" loading="lazy" class="w-full h-auto object-cover shadow-sm transition-transform duration-500 group-hover:scale-105">
                                        ${img.caption ? `<div class="absolute bottom-0 left-0 w-full p-2 bg-black/50 text-white text-xs opacity-0 group-hover:opacity-100 transition-opacity">${img.caption}</div>` : ''}
                                    </div>`).join('')}
                            </div>
                        </div></div>
                    </section>`;
                
                // IMPORTANTE: Eliminamos la l√≠nea 'navigateTo(targetId);' que causaba el bucle.
                // Solo necesitamos activar la p√°gina manualmente si no est√° activa.
                const page = document.getElementById(targetId);
                if(page && !page.classList.contains('page-active')) {
                    document.querySelectorAll('.page-active').forEach(p => { p.classList.remove('page-active'); p.style.display='none'; });
                    page.style.display='block';
                    setTimeout(()=>page.classList.add('page-active'), 10);
                    window.scrollTo(0,0);
                }
            };
    
            const renderServiceDetail = (targetId) => {
                const realId = targetId.substring(15);
                const service = globalData.services.find(s => String(s.id) === realId);
                if (!service) return;
                
                const container = document.getElementById('service-detail-pages');
                container.innerHTML = `
                    <section id="${targetId}" class="page-container">
                         <div class="h-auto md:h-[50vh] bg-zinc-700 flex items-center justify-center text-white pt-28 md:pt-36 pb-16">
                            <div class="text-center reveal"><h1 class="text-5xl md:text-7xl font-display text-reveal py-2">${service.title}</h1></div>
                        </div>
                        
                        <div class="container mx-auto px-6 py-10 md:py-16">
                            <div class="max-w-4xl mx-auto">
                                <a href="#" data-target="services" class="nav-link text-gray-500 hover:text-black transition-colors mb-8 inline-block"><i class="fas fa-arrow-left mr-2"></i> Volver a Servicios</a>
                                
                                <div class="reveal mt-2 mb-4">
                                    <div class="rich-text-content text-xl text-gray-700 leading-relaxed text-reveal">
                                        ${service.introText || ''}
                                    </div>
                                </div>
    
                                <div class="space-y-4">
                                    ${(service.contentBlocks||[]).map(b => `
                                        <div class="reveal">
                                            <h3 class="text-3xl font-display text-black mb-1 text-reveal">${b.blockTitle}</h3>
                                            <div class="rich-text-content text-gray-600 text-lg leading-relaxed text-reveal">
                                                ${b.blockContentHtml}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
    
                                ${(service.images||[]).length ? `<div class="mt-8 reveal"><h3 class="text-3xl font-display text-black mb-6 text-center text-reveal">Galer√≠a</h3><div class="columns-1 md:columns-2 gap-6 space-y-6">${service.images.map(img=>`<div class="gallery-item break-inside-avoid overflow-hidden relative img-container shadow-lg"><img src="${img.imageUrl}" class="w-full h-auto object-cover hover:scale-105 transition-transform duration-700"></div>`).join('')}</div></div>` : ''}
                                
                                <div class="text-center mt-8 reveal border-t pt-8">
                                    <h3 class="text-4xl font-display text-gray-800 text-reveal mb-2">¬øInteresado?</h3>
                                    <p class="text-gray-500 mb-6">Cu√©ntame sobre tu proyecto y hagamos magia.</p>
                                    <a href="#" data-target="contact" class="nav-link btn-primary inline-block bg-black text-white font-bold py-4 px-12 rounded-full text-lg hover:bg-gray-800 transition-all transform hover:-translate-y-1 shadow-lg">Cont√°ctame</a>
                                </div>
                            </div>
                        </div>
                    </section>`;
                
                const page = document.getElementById(targetId);
                if(page) {
                    document.querySelectorAll('.page-active').forEach(p => { p.classList.remove('page-active'); p.style.display='none'; });
                    page.style.display='block';
                    
                    // Forzamos el scroll arriba
                    window.scrollTo(0,0);
                    
                    setTimeout(()=> {
                        page.classList.add('page-active');
                        observeElements(page);
                        // AJUSTE CLAVE: Forzamos la actualizaci√≥n del header inmediatamente
                        handleScrollHeader(); 
                    }, 10);
                }
            };
    
            const renderRentalDetail = (targetId) => {
                const itemId = targetId.substring(14);
                let item;
                for(const cat in rentalDataGlobal) { item = rentalDataGlobal[cat].find(i=>String(i.id)===itemId); if(item) break; }
                if(!item) return;
                
                const trackHTML = item.images.map(img => `<div class="carousel-item w-full h-full"><img src="${img.imageUrl}" class="w-full h-full object-cover"></div>`).join('');
                
                // Generar miniaturas con evento de clic para el carrusel (Ajuste 3)
                const thumbsHTML = item.images.map((img, idx) => `
                    <img src="${img.imageUrl}" 
                         onclick="moveCarousel('${targetId}', ${idx})" 
                         class="${idx === 0 ? 'active' : ''} cursor-pointer hover:opacity-100 transition-opacity" 
                         style="width:60px; height:60px; object-fit:cover; margin-right:5px; border:1px solid #eee;">
                `).join('');
                
                document.getElementById('rental-detail-pages').innerHTML = `
                    <section id="${targetId}" class="page-container pt-32 pb-24 bg-white">
                        <div class="container mx-auto px-6">
                            <a href="#" data-target="rental" class="nav-link text-gray-500 mb-8 inline-block"><i class="fas fa-arrow-left"></i> Volver al Cat√°logo</a>
                            <div class="grid grid-cols-1 lg:grid-cols-5 gap-12">
                                <div class="lg:col-span-3">
                                    <div class="carousel-container h-[400px] relative overflow-hidden">
                                        <div class="carousel-track flex h-full transition-transform duration-500">${trackHTML}</div>
                                    </div>
                                    <div class="thumb-nav mt-4 flex overflow-x-auto pb-2">${thumbsHTML}</div>
                                </div>
                                <div class="lg:col-span-2">
                                    <h2 class="text-4xl font-display mb-2">${item.name}</h2>
                                    <p class="text-3xl font-bold mb-6">$${item.price}<span class="tax-badge-inline">${item.hasTax?' + IVA':''}</span></p>
                                    <div class="rich-text-content mb-8 text-gray-600 leading-relaxed">
                                        ${item.longDescription || item.description}
                                    </div>
                                    <button id="calendar-btn-${item.id}" class="btn-primary w-full bg-black text-white py-4 rounded-full mb-4 font-bold tracking-widest uppercase text-sm">
                                        Consultar Disponibilidad
                                    </button>
                                    <button onclick="navigateTo('rental')" class="w-full border border-black py-3 rounded-full hover:bg-gray-50 transition font-bold text-xs tracking-widest uppercase">Seguir Explorando</button>
                                </div>
                            </div>
                        </div>
                    </section>`;
                
                const section = document.getElementById(targetId);
                // Bloqueo persistente que suma Sheets + Carrito Local (Ajuste 11)
                const allBooked = [...new Set([...(item.bookedDates || []), ...getLocalBlockedDates(item.id)])];
                section.querySelector(`#calendar-btn-${item.id}`).onclick = () => showCalendarModal(item, allBooked);
                
                const page = document.getElementById(targetId);
                if(page) {
                    document.querySelectorAll('.page-active').forEach(p => { p.classList.remove('page-active'); p.style.display='none'; });
                    page.style.display='block';
                    setTimeout(()=>page.classList.add('page-active'), 10);
                    window.scrollTo(0,0);
                }
                // Forzar Flatpickr en m√≥viles para evitar el nativo (Ajuste 11)
                setTimeout(() => { navigateTo(targetId); }, 10);
            };
    
            // =================================================================
            // 6. ORQUESTACI√ìN DE DATOS (LOGICA MAESTRA)
            // =================================================================
            const loadSection = async (sectionName) => {
                if (sectionName === 'projects' && globalData.projects.length > 0) return;
                if (sectionName === 'services' && globalData.services.length > 0) return;
                if (sectionName === 'rental' && globalData.rentals.items.length > 0) return;
    
                const apiParam = sectionName === 'rental' ? 'rentals' : sectionName; 
                const data = await fetchSectionData(apiParam);
                if (!data) return;
    
                // --- FILTRO DE SEGURIDAD EXACTO ---
                // La regla es simple: Solo se muestra si el status es "active".
                const isVisible = (item) => {
                    // Obtenemos el valor de la columna 'status', lo pasamos a min√∫sculas y quitamos espacios.
                    const status = String(item.status || '').toLowerCase().trim();
                    // Solo devolvemos 'true' si el estado es exactamente 'active'.
                    return status === 'active';
                };
    
                if (sectionName === 'projects') {
                    globalData.projects = (data.projects || [])
                        .filter(isVisible) // Aplica el filtro: solo "active"
                        .map(p => {
                            const pImages = globalData.allProjectImages.filter(img => img.projectId === p.id);
                            const cover = pImages.find(i => String(i.isCover).toLowerCase() === 'si') || pImages[0];
                            return { ...p, coverImageUrl: cover?.imageUrl, images: pImages };
                        });
                    renderProjects();
                } 
                else if (sectionName === 'services') {
                    globalData.services = (data.services || [])
                        .filter(isVisible) // Aplica el filtro: solo "active"
                        .map(s => s);
                    renderServicesGrid();
                } 
                else if (sectionName === 'rental') {
                    const visibleItems = (data.rentalItems || []).filter(isVisible);
                    globalData.rentals.items = visibleItems;
                    globalData.rentals.categories = data.rentalCategories || [];
                    globalData.rentals.dates = data.blockedDates || [];
                    
                    rentalDataGlobal = {}; 
                    data.rentalCategories.forEach(cat => {
                        rentalDataGlobal[cat.name] = visibleItems
                            .filter(i => i.categoryId === cat.id)
                            .map(i => ({
                                ...i, 
                                price: parseFloat(i.pricePerDay), 
                                hasTax: String(i.hasTax).toLowerCase() === 'true',
                                images: i.images || [],
                                bookedDates: data.blockedDates
                                    .filter(b => b.itemId === i.id)
                                    .flatMap(b => getDatesInRange(b.startDate, b.endDate))
                            }));
                    });
                    renderRentalPage();
                    syncCartWithFreshData();
                }
            };
    
            const navigateTo = (targetId) => {

                const iframes = document.querySelectorAll('iframe');
                iframes.forEach(iframe => {
                    iframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
                });
                
                // A. CARGA INTELIGENTE
                if (['projects', 'services', 'rental'].includes(targetId)) loadSection(targetId);
                
                // B. MANEJO DE DETALLES PROFUNDOS (Espera a tener datos)
                if (targetId.startsWith('service-detail-')) {
                    if (globalData.services.length === 0) loadSection('services').then(() => renderServiceDetail(targetId));
                    else renderServiceDetail(targetId);
                }
                else if (targetId.startsWith('rental-detail-')) {
                    if (globalData.rentals.items.length === 0) loadSection('rental').then(() => renderRentalDetail(targetId));
                    else renderRentalDetail(targetId);
                }
                else if (targetId.startsWith('project-detail-')) {
                    if (globalData.projects.length === 0) loadSection('projects').then(() => renderProjectDetail(targetId));
                    else renderProjectDetail(targetId);
                }
    
                // C. TRANSICI√ìN VISUAL
                const currentPage = document.querySelector('.page-active');
                const targetPage = document.getElementById(targetId);
                if (!targetPage || currentPage === targetPage) return;
    
                if (currentPage) { currentPage.classList.add('page-exiting'); currentPage.classList.remove('page-active'); }
                targetPage.style.display = 'block';
                setTimeout(() => { targetPage.classList.add('page-active'); handleScrollHeader(); }, 10);
                if (currentPage) setTimeout(() => { currentPage.classList.remove('page-exiting'); currentPage.style.display = 'none'; }, 500);
    
                // D. MENU
                let active = targetId;
                if(targetId.startsWith('project-detail-')) active='projects';
                else if(targetId.startsWith('rental-detail-')) active='rental';
                else if(targetId.startsWith('service-detail-')) active='services';
                allNavLinks.forEach(l => { l.classList.remove('nav-active'); if(l.dataset.target===active) l.classList.add('nav-active'); });
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
                observeElements(targetPage);
            };




            
            const initialize = async () => {
                const apiData = await fetchSectionData('home');
                
                // --- ADAPTADOR UNIVERSAL DE DATOS ---
                // Lee los datos sin importar si el sheet usa 'key' o 'section'
                const normalizeData = (data) => {
                    if (!data) return {};
                    if (!Array.isArray(data)) return data; 
                    
                    return data.reduce((acc, item) => {
                        const rawKey = item.key || item.section || item.id;
                        const rawVal = item.value || item.content || item.description || item.text;
                        
                        if (rawKey) {
                            const cleanKey = String(rawKey).trim(); 
                            acc[cleanKey] = rawVal;
                        }
                        return acc;
                    }, {});
                };

                // Helper de b√∫squeda profunda (Sabueso)
                // Encuentra valores aunque est√©n anidados o con nombres raros
                const findText = (data, keyName) => {
                    if(!data) return '';
                    if(!Array.isArray(data) && data[keyName]) return data[keyName];
                    const norm = normalizeData(data);
                    return norm[keyName] || '';
                };

                if (apiData) {
                    // Procesamos los datos clave
                    const imgs = normalizeData(apiData.sysImages);
                    const ident = normalizeData(apiData.identity);
                    const about = normalizeData(apiData.about); 
                    
                    // --- 1. IDENTIDAD VISUAL ---
                    // Helper extra para im√°genes
                    let imagesObj = imgs;
                    if (Array.isArray(apiData.sysImages) && apiData.sysImages[0]?.imageUrl) {
                         imagesObj = apiData.sysImages.reduce((acc, item) => ({ ...acc, [item.key]: item.imageUrl }), {});
                    }

                    if(imagesObj.logo_black) document.querySelectorAll('.logo-dark').forEach(e=>e.src=imagesObj.logo_black);
                    if(imagesObj.logo_white) document.querySelectorAll('.logo-light').forEach(e=>e.src=imagesObj.logo_white);
                    if(imagesObj.favicon) document.querySelector("link[rel*='icon']").href=imagesObj.favicon;
                    
                    // --- 2. SECCI√ìN: QUI√âN SOY ---
                    
                    // A. Frase
                    if(about.intro_phrase) { 
                        const el = document.getElementById('about-intro-phrase'); 
                        if(el) el.textContent = `"${about.intro_phrase.replace(/^"|"$/g, '')}"`; 
                    }

                    // B. Bio y Proceso
                    if(about.bio) { 
                        const el = document.getElementById('about-bio'); 
                        if(el) el.innerHTML = `<div class="rich-text-content text-gray-600 text-lg leading-relaxed text-justify">${about.bio}</div>`;
                    }
                    if(about.process) { 
                        const el = document.getElementById('about-process'); 
                        if(el) el.innerHTML = `<div class="rich-text-content text-gray-600 text-lg leading-relaxed text-justify">${about.process}</div>`;
                    }

                    // D. Foto de Perfil
                    const profileSrc = imagesObj.profile_pic || about.profile_pic;
                    if(profileSrc) { 
                        const el = document.querySelector('#about img'); 
                        if(el) { el.src = profileSrc; el.removeAttribute('srcset'); }
                    }
    
                    // --- 3. CONTACTO Y REDES (L√ìGICA REPARADA Y MEJORADA) ---
                    
                    // Funci√≥n maestra que actualiza Iconos (Header) y Cuadros Grandes (Contacto)
                    const updateAllContactLinks = (type, value) => {
                        if (!value) return;

                        let href = value;
                        let target = '_blank';
                        let isSocial = true;
                        
                        // 1. Definir Protocolos (Qu√© hace el clic)
                        if (type === 'WhatsApp') {
                            href = `https://wa.me/${value.replace(/[^0-9]/g, '')}`;
                        } else if (type === 'Email') {
                            href = `mailto:${value}`;
                            target = '_self'; // Abre la app de correo ah√≠ mismo
                            isSocial = false;
                        } else if (type === 'Tel√©fono') {
                            href = `tel:${value.replace(/[^0-9+]/g, '')}`; // Abre marcador
                            target = '_self';
                            isSocial = false;
                        }

                        // 2. Actualizar ICONOS PEQUE√ëOS (Header/Footer)
                        // Buscamos por aria-label (ej: aria-label="Instagram")
                        document.querySelectorAll(`a[aria-label="${type}"]`).forEach(a => {
                            a.href = href;
                            if (target === '_blank') a.target = '_blank';
                            if (type === 'Tel√©fono') a.title = value; // Tooltip para PC
                        });

                        // 3. Actualizar CUADROS GRANDES (Secci√≥n Contacto)
                        // Buscamos los cuadros que contienen la palabra clave (ej: "Instagram")
                        document.querySelectorAll('.contact-icon-link').forEach(box => {
                            // Usamos textContent para encontrar el cuadro correcto
                            if (box.textContent.includes(type)) {
                                box.href = href;
                                if (target === '_blank') box.target = '_blank';
                                
                                // AJUSTE CLAVE: Mostrar el n√∫mero/correo real en vez de la palabra "Tel√©fono"
                                if (!isSocial) {
                                    const textSpan = box.querySelector('span'); // El texto en negrita
                                    if (textSpan) textSpan.textContent = value;
                                }
                            }
                        });
                    };

                    // Ejecutamos la actualizaci√≥n para cada red usando los datos del Sheet
                    updateAllContactLinks('Instagram', ident.social_instagram);
                    updateAllContactLinks('Facebook', ident.social_facebook);
                    updateAllContactLinks('YouTube', ident.social_youtube);
                    updateAllContactLinks('WhatsApp', ident.social_whatsapp);
                    updateAllContactLinks('Email', ident.contact_email); 
                    updateAllContactLinks('Tel√©fono', ident.contact_phone); 

                    // 4. MAPA (REPARACI√ìN AUTOM√ÅTICA DE ENLACE)
                    const mapUrl = ident.social_maps;
                    const mapFrame = document.getElementById('google-map');
                    
                    if (mapFrame) {
                        if (mapUrl && mapUrl.length > 5) {
                            let finalSrc = mapUrl;
                            
                            // TRUCO: Si el link NO es de tipo "embed", Google lo bloquea.
                            // Si detectamos un link normal, lo convertimos a un formato "legacy" que s√≠ funciona.
                            if (!mapUrl.includes('embed') && !mapUrl.includes('output=embed')) {
                                // Convertimos el link normal en una b√∫squeda embebida
                                finalSrc = `https://maps.google.com/maps?q=${encodeURIComponent(mapUrl)}&t=&z=15&ie=UTF8&iwloc=&output=embed`;
                            }
                            
                            mapFrame.src = finalSrc;
                            mapFrame.style.display = 'block';
                        } else {
                            // Si no hay mapa, ocultamos el cuadro gris feo
                            mapFrame.style.display = 'none';
                        }
                    }
    
                    // --- 4. DATOS GLOBALES (Portafolio, Videos, etc.) ---
                    globalData.portfolio = apiData.portfolioGallery || [];
                    globalData.videos = apiData.videos || [];
                    globalData.logos = apiData.clientLogos || [];
                    globalData.allProjectImages = apiData.allProjectImages || [];
                }
                
                // Renderizados iniciales
                renderPortfolio(); 
                renderVideos(globalData.videos); 
                renderClientLogos(globalData.logos); 
                renderCart(); 
                loadCartFromMemory();
                updateCartIcon();
                
                setTimeout(() => pageLoader.classList.add('hidden'), 1500);
                
                // Navegaci√≥n Inicial (Manejo de Hash)
                if(window.location.hash) {
                    const target = window.location.hash.substring(1);
                    navigateTo(target);
                } else {
                    const initial = document.getElementById('portfolio');
                    if(initial) { 
                        initial.classList.add('page-active'); 
                        observeElements(initial); 
                        document.querySelectorAll('.nav-link[data-target="portfolio"]').forEach(l => l.classList.add('nav-active')); 
                    }
                }
            };





            
            // =================================================================
            // 7. MODALES (CALENDARIO Y CHECKOUT)
            // =================================================================
            const showCheckoutModal = () => {
                const container = document.getElementById('checkout-modal-container');
                
                // 1. C√ÅLCULO CORRECTO DEL TOTAL (Incluyendo IVA si aplica)
                const total = cart.reduce((t, i) => {
                    const lineSubtotal = i.price * i.totalDays;
                    const lineTotal = i.hasTax ? (lineSubtotal * 1.13) : lineSubtotal;
                    return t + lineTotal;
                }, 0);

                container.innerHTML = `
                <div id="checkout-modal-overlay" class="checkout-modal-overlay visible">
                    <div id="checkout-modal-content" class="checkout-modal-content">
                        <div class="p-6 border-b flex justify-between items-center"><h2 class="text-2xl font-display">Reserva</h2><button id="close-co" class="text-2xl">√ó</button></div>
                        
                        <div id="step-1" class="checkout-step active">
                            <div class="p-6">
                                <form id="co-form" class="space-y-4">
                                    <div><label class="block text-sm font-bold">Nombre Completo</label><input type="text" id="co-name" required class="form-input mt-1" placeholder="Tu nombre"></div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="block text-sm font-bold">C√©dula / ID</label><input type="text" id="co-cedula" required class="form-input mt-1" placeholder="Requerido"></div>
                                        <div><label class="block text-sm font-bold">Tel√©fono</label><input type="tel" id="co-phone" required class="form-input mt-1" placeholder="8888-8888"></div>
                                    </div>
                                    <div><label class="block text-sm font-bold">Email</label><input type="email" id="co-email" required class="form-input mt-1" placeholder="contacto@email.com"></div>
                                    <div><label class="block text-sm font-bold">Direcci√≥n Exacta</label><textarea id="co-address" required class="form-input mt-1" rows="2" placeholder="Provincia, Cant√≥n, Distrito y se√±as..."></textarea></div>
                                </form>
                            </div>
                            <div class="p-6 bg-gray-50 flex justify-end"><button id="btn-next-1" class="bg-black text-white py-3 px-6 font-bold hover:bg-gray-800">Siguiente</button></div>
                        </div>

                        <div id="step-2" class="checkout-step">
                            <div class="p-6">
                                <h3 class="font-bold text-lg mb-4">Resumen de Solicitud</h3>
                                <div class="max-h-60 overflow-y-auto pr-2 custom-scrollbar space-y-3">
                                    ${cart.map(i => `
                                        <div class="flex justify-between text-sm border-b pb-2">
                                            <div>
                                                <span class="font-bold block">${i.name}</span>
                                                <span class="text-xs text-gray-500">${i.totalDays} d√≠as (${new Date(i.startDate + 'T00:00:00').toLocaleDateString()} - ${new Date(i.endDate + 'T00:00:00').toLocaleDateString()})</span>
                                            </div>
                                            <div class="text-right">
                                                <span class="font-bold">$${((i.price * i.totalDays) * (i.hasTax ? 1.13 : 1)).toFixed(2)}</span>
                                                ${i.hasTax ? '<span class="text-[10px] text-gray-400 block">(Inc. IVA)</span>' : ''}
                                            </div>
                                        </div>`).join('')}
                                </div>
                                <div class="flex justify-between items-center font-bold text-xl mt-6 pt-4 border-t border-black">
                                    <span>Total:</span>
                                    <span>$${total.toFixed(2)}</span>
                                </div>
                            </div>
                            <div class="p-6 bg-gray-50 flex justify-between">
                                <button id="btn-back-2" class="bg-gray-200 py-3 px-6 font-bold hover:bg-gray-300 rounded text-sm">Atr√°s</button>
                                <button id="btn-pay" class="bg-black text-white py-3 px-8 font-bold hover:bg-gray-800 rounded shadow-lg flex items-center gap-2">
                                    <span>Confirmar Reserva</span>
                                    <div id="co-spinner" class="loader-circle w-4 h-4 border-2 border-white border-t-transparent hidden"></div>
                                </button>
                            </div>
                        </div>

                        <div id="step-3" class="checkout-step">
                            <div class="p-12 text-center">
                                <div class="text-green-600 text-6xl mb-6"><i class="fas fa-check-circle"></i></div>
                                <h3 class="text-3xl font-display font-bold mb-2">¬°Solicitud Recibida!</h3>
                                <p class="text-gray-600 mb-6">Tu c√≥digo de reserva es:</p>
                                <div class="bg-gray-100 py-4 rounded-lg border border-dashed border-gray-400 mb-8">
                                    <span id="final-res-id" class="text-3xl font-mono font-bold tracking-widest text-black">---</span>
                                </div>
                                <p class="text-sm text-gray-500 mb-6">Te hemos enviado un correo con los detalles. Nos pondremos en contacto pronto.</p>
                                <button id="btn-finish" class="bg-black text-white py-3 px-8 rounded-full font-bold hover:bg-gray-800 transition-transform hover:scale-105">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>`;
                
                const overlay = document.getElementById('checkout-modal-overlay');
                const step1 = document.getElementById('step-1'); 
                const step2 = document.getElementById('step-2'); 
                const step3 = document.getElementById('step-3');
                
                const close = () => { overlay.classList.remove('visible'); setTimeout(()=>container.innerHTML='',300); };
                
                document.getElementById('close-co').onclick = close;
                document.getElementById('btn-finish').onclick = close;
                
                document.getElementById('btn-next-1').onclick = () => { 
                    if(document.getElementById('co-form').checkValidity()) { 
                        step1.classList.remove('active'); 
                        step2.classList.add('active'); 
                    } else document.getElementById('co-form').reportValidity(); 
                };
                
                document.getElementById('btn-back-2').onclick = () => { 
                    step2.classList.remove('active'); 
                    step1.classList.add('active'); 
                };

                // L√ìGICA DE ENV√çO REAL (Batch Completo)
                document.getElementById('btn-pay').onclick = async () => {
                    const btn = document.getElementById('btn-pay');
                    const spinner = document.getElementById('co-spinner');
                    
                    // Bloquear UI
                    btn.disabled = true;
                    btn.querySelector('span').textContent = 'Procesando...';
                    spinner.classList.remove('hidden');
                
                    try {
                        const now = new Date();
                        const bookingId = `RES-${now.getFullYear().toString().slice(-2)}${(now.getMonth()+1).toString().padStart(2,'0')}-${Math.floor(1000 + Math.random() * 9000)}`;
                        
                        const customer = {
                            name: document.getElementById('co-name').value,
                            cedula: document.getElementById('co-cedula').value,
                            phone: document.getElementById('co-phone').value,
                            email: document.getElementById('co-email').value,
                            address: document.getElementById('co-address').value
                        };
                
                        const starts = cart.map(i => new Date(i.startDate));
                        const ends = cart.map(i => new Date(i.endDate));
                        const minDate = new Date(Math.min(...starts)).toISOString().split('T')[0];
                        const maxDate = new Date(Math.max(...ends)).toISOString().split('T')[0];
                
                        const itemNames = cart.map(i => i.name);
                        const summaryName = itemNames.length > 1 ? `${itemNames[0]} + ${itemNames.length-1} m√°s` : itemNames[0];
                
                        const batch = [];
                
                        // 1. REGISTRAR CABECERA DE RESERVA (CORREGIDO)
                        batch.push({
                            sheet: 'Bookings',
                            action: 'add',
                            data: {
                                id: bookingId,
                                customerName: customer.name,
                                customerCedula: customer.cedula,
                                customerPhone: customer.phone,
                                customerEmail: customer.email,
                                customerAddress: customer.address,
                                itemName: summaryName,
                                totalPrice: total,
                                status: 'Pendiente', 
                                startDate: minDate,
                                endDate: maxDate,
                                bookingTimestamp: now.toISOString(),
                                globalDiscountVal: 0,
                                globalNotes: ''
                            }
                        });
                
                        // 2. REGISTRAR DETALLES Y BLOQUEOS POR ITEM
                        cart.forEach((item, idx) => {
                            const detailId = `bd_${Date.now()}_${idx}`;
                            
                            batch.push({
                                sheet: 'BookingsDetails',
                                action: 'add',
                                data: {
                                    id: detailId,
                                    bookingId: bookingId,
                                    itemId: item.id,
                                    itemName: item.name,
                                    startDate: item.startDate,
                                    endDate: item.endDate,
                                    basePrice: item.price,
                                    lineTotal: (item.price * item.totalDays) * (item.hasTax ? 1.13 : 1),
                                    lineNote: '',
                                    itemImage: item.image || '', 
                                    itemHasTax: item.hasTax ? 'Si' : 'No'  
                                }
                            });
                
                            batch.push({
                                sheet: 'BlockedDates',
                                action: 'add',
                                data: {
                                    blockId: `blk_${detailId}`,
                                    bookingId: bookingId,
                                    itemId: item.id,
                                    startDate: item.startDate,
                                    endDate: item.endDate,
                                    reason: `Reserva Web: ${customer.name}`
                                }
                            });
                        });
                
                        // 3. ENVIAR AL SERVIDOR
                        const response = await fetch('/.netlify/functions/update-sheet-data', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(batch)
                        });
                
                        const resData = await response.json();
                
                        if (!response.ok) {
                            if (resData.error && resData.error.includes('CONFLICTO')) {
                                throw new Error('¬°Vaya! Alguien acaba de reservar uno de los equipos seleccionados para esas fechas.');
                            }
                            throw new Error(resData.error || 'Error desconocido del servidor');
                        }
                
                        document.getElementById('final-res-id').textContent = bookingId;
                        cart = [];
                        saveCartToMemory(); 
                        renderCart();
                        updateCartIcon();
                        step2.classList.remove('active');
                        step3.classList.add('active');
                
                    } catch (error) {
                        console.error(error);
                        alert(`No se pudo procesar la reserva: ${error.message}`);
                        btn.disabled = false;
                        btn.querySelector('span').textContent = 'Confirmar Reserva';
                        spinner.classList.add('hidden');
                    }
                };
            };
    
            const showCalendarModal = (item, bookedDates) => {
                const modalContainer = document.getElementById('calendar-modal-container');
                // HTML ID√âNTICO AL EST√ÅTICO
                modalContainer.innerHTML = `
                    <div id="calendar-modal-overlay" class="calendar-modal-overlay">
                        <div class="calendar-modal-content">
                            <div class="calendar-header">
                                <button id="calendar-prev" class="calendar-nav-btn"><i class="fas fa-chevron-left"></i></button>
                                <h3 id="calendar-month-year" class="font-display text-2xl"></h3>
                                <button id="calendar-next" class="calendar-nav-btn"><i class="fas fa-chevron-right"></i></button>
                            </div>
                            <div class="calendar-grid">
                                <div class="calendar-day-name">D</div><div class="calendar-day-name">L</div><div class="calendar-day-name">M</div>
                                <div class="calendar-day-name">M</div><div class="calendar-day-name">J</div><div class="calendar-day-name">V</div>
                                <div class="calendar-day-name">S</div>
                            </div>
                            <div id="calendar-days" class="calendar-grid"></div>
                            
                            <div class="booking-summary">
                                <div class="flex justify-between items-center text-sm"><span>Desde:</span><span id="summary-start-date">--/--/----</span></div>
                                <div class="flex justify-between items-center text-sm"><span>Hasta:</span><span id="summary-end-date">--/--/----</span></div>
                                <div class="flex justify-between items-center text-sm border-t mt-2 pt-2"><span>Total D√≠as:</span><span id="summary-total-days">0</span></div>
                                <div class="flex justify-between items-center text-xl font-bold mt-2"><span>Total a Pagar:</span><span id="summary-total-price">$0</span></div>
                            </div>
                            
                            <button id="add-to-cart-btn" class="w-full mt-4 bg-black text-white py-3 font-bold disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Agregar al Carrito</button>
                        </div>
                    </div>
                `;
                
                const overlay = document.getElementById('calendar-modal-overlay');
                const monthYearEl = document.getElementById('calendar-month-year');
                const daysContainer = document.getElementById('calendar-days');
                const summaryStartDate = document.getElementById('summary-start-date');
                const summaryEndDate = document.getElementById('summary-end-date');
                const summaryTotalDays = document.getElementById('summary-total-days');
                const summaryTotalPrice = document.getElementById('summary-total-price');
                const addToCartBtn = document.getElementById('add-to-cart-btn');
                
                const close = () => {
                    overlay.classList.remove('visible');
                    setTimeout(() => modalContainer.innerHTML = '', 300);
                };
    
                setTimeout(() => overlay.classList.add('visible'), 10);
    
                let currentDate = new Date();
                currentDate.setDate(1);
                let selectedStartDate = null;
                let selectedEndDate = null;
    
                const renderMonth = () => {
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    const today = new Date(); today.setHours(0,0,0,0);
                    
                    // Capitalizar mes
                    let monthName = new Intl.DateTimeFormat('es-ES', { month: 'long' }).format(currentDate);
                    monthName = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                    monthYearEl.textContent = `${monthName} ${year}`;
                    
                    daysContainer.innerHTML = '';
                    const firstDayOfMonth = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    
                    for (let i = 0; i < firstDayOfMonth; i++) daysContainer.innerHTML += `<div></div>`;
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayEl = document.createElement('button');
                        dayEl.textContent = day;
                        dayEl.classList.add('calendar-day');
                        
                        // Construir fecha local sin problemas de zona horaria
                        const dayDate = new Date(year, month, day); 
                        const dateString = dayDate.toLocaleDateString('en-CA'); // YYYY-MM-DD local
                        
                        // Bloqueo: si es pasado O si est√° en la lista de bookedDates
                        if (dayDate < today || bookedDates.includes(dateString)) {
                            dayEl.classList.add('disabled');
                        } else {
                            dayEl.dataset.date = dateString;
                        }
                        
                        // Estilos de selecci√≥n
                        if (selectedStartDate && dateString === selectedStartDate) dayEl.classList.add('selected');
                        if (selectedEndDate && dateString === selectedEndDate) dayEl.classList.add('selected');
                        if (selectedStartDate && selectedEndDate && dateString > selectedStartDate && dateString < selectedEndDate) dayEl.classList.add('in-range');
                        
                        daysContainer.appendChild(dayEl);
                    }
                };
                
                // DENTRO DE showCalendarModal
                const updateSummary = () => {
                    addToCartBtn.disabled = !(selectedStartDate && selectedEndDate);
                    
                    if (selectedStartDate && selectedEndDate) {
                        const startObj = new Date(selectedStartDate + 'T00:00:00');
                        const endObj = new Date(selectedEndDate + 'T00:00:00');
                        
                        summaryStartDate.textContent = startObj.toLocaleDateString('es-ES');
                        summaryEndDate.textContent = endObj.toLocaleDateString('es-ES');
                        
                        const diffDays = Math.ceil((endObj - startObj) / (1000 * 60 * 60 * 24)) + 1;
                        summaryTotalDays.textContent = diffDays;
    
                        // --- C√ÅLCULO DE PRECIO E IMPUESTOS ---
                        const subtotal = diffDays * item.price;
                        const taxAmount = item.hasTax ? (subtotal * 0.13) : 0;
                        const total = subtotal + taxAmount;
    
                        // Construimos el HTML del precio din√°micamente
                        let priceHTML = '';
                        if (item.hasTax) {
                            priceHTML = `
                                <div class="flex flex-col items-end w-full">
                                    <div class="text-xs text-gray-500 font-normal">Subtotal: $${subtotal.toFixed(2)}</div>
                                    <div class="text-xs text-gray-500 font-normal">IVA (13%): $${taxAmount.toFixed(2)}</div>
                                    <div class="text-xl font-bold mt-1 text-black">Total: $${total.toFixed(2)}</div>
                                </div>
                            `;
                        } else {
                            priceHTML = `<span>Total:</span><span class="text-xl font-bold">$${total.toFixed(2)}</span>`;
                        }
                        
                        // Inyectamos el HTML (reemplazamos el contenido simple anterior)
                        const priceContainer = document.querySelector('.booking-summary .flex.items-center.text-xl');
                        if(priceContainer) {
                            // Si hay impuesto, cambiamos la estructura flex para alinear a la derecha
                            priceContainer.className = item.hasTax ? "mt-2 pt-2 border-t flex justify-end" : "flex justify-between items-center text-xl font-bold mt-2";
                            priceContainer.innerHTML = priceHTML;
                        }
    
                    } else {
                         summaryStartDate.textContent = '--/--/----'; summaryEndDate.textContent = '--/--/----';
                         summaryTotalDays.textContent = '0'; 
                         // Reset visual
                         const priceContainer = document.querySelector('.booking-summary .flex.justify-end') || document.querySelector('.booking-summary .flex.text-xl');
                         if(priceContainer) {
                             priceContainer.className = "flex justify-between items-center text-xl font-bold mt-2";
                             priceContainer.innerHTML = `<span>Total a Pagar:</span><span>$0.00</span>`;
                         }
                    }
                };
                
                daysContainer.addEventListener('click', (e) => {
                    if (e.target.matches('.calendar-day') && !e.target.classList.contains('disabled')) {
                        const clickedDateStr = e.target.dataset.date;
                        
                        if (!selectedStartDate || (selectedStartDate && selectedEndDate)) {
                            // Nuevo inicio
                            selectedStartDate = clickedDateStr; selectedEndDate = null;
                        } else if (clickedDateStr < selectedStartDate) {
                            // Clic antes del inicio -> Nuevo inicio
                            selectedStartDate = clickedDateStr;
                        } else {
                            // Selecci√≥n de final
                            // Verificar si hay d√≠as bloqueados en medio
                            let validRange = true;
                            let tempDate = new Date(selectedStartDate + 'T00:00:00');
                            const endDateObj = new Date(clickedDateStr + 'T00:00:00');
                            
                            while(tempDate <= endDateObj) {
                                const tempStr = tempDate.toLocaleDateString('en-CA');
                                if(bookedDates.includes(tempStr)) {
                                    validRange = false; break;
                                }
                                tempDate.setDate(tempDate.getDate() + 1);
                            }
                            
                            if(!validRange) {
                                alert("El rango incluye d√≠as no disponibles.");
                                selectedStartDate = null; selectedEndDate = null;
                            } else {
                                selectedEndDate = clickedDateStr;
                            }
                        }
                        renderMonth(); updateSummary();
                    }
                });
                
                addToCartBtn.addEventListener('click', () => {
                    if (selectedStartDate && selectedEndDate) {
                        addToCart(item, selectedStartDate, selectedEndDate);
                        close();
                    }
                });
    
                document.getElementById('calendar-prev').onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderMonth(); };
                document.getElementById('calendar-next').onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderMonth(); };
                overlay.addEventListener('click', e => { if(e.target === overlay) close(); });
                
                renderMonth();
            };
    
            // =================================================================
            // 8. LISTENERS GLOBALES (Event Delegation)
            // =================================================================
            document.addEventListener('click', function(e) {
                // A. Navegaci√≥n Men√∫
                const navLink = e.target.closest('.nav-link');
                if (navLink) { 
                    e.preventDefault(); 
                    if(cartDrawer.classList.contains('visible')) toggleCart(false); 
                    if(mobileMenu.classList.contains('open')) toggleMobileMenu(false); 
                    navigateTo(navLink.dataset.target); 
                    return;
                }
                
                // B. Lightbox
                // B. Lightbox
                // Simplificamos la detecci√≥n: si es img dentro de gallery-item, abre lightbox
                const galleryItem = e.target.closest('.gallery-item');
                if(galleryItem && !galleryItem.closest('.rental-card') && !e.target.closest('iframe')) {
                    const img = galleryItem.querySelector('img');
                    // IMPORTANTE: Detectamos si el click fue DIRECTAMENTE en la imagen o en el overlay
                    if(img && (e.target === img || e.target.closest('.overlay'))) {
                        // Recolectar todas las imagenes de la pagina actual para navegar
                        const activePage = document.querySelector('.page-active');
                        if(activePage) {
                            const allItems = Array.from(activePage.querySelectorAll('.gallery-item img'));
                            const imgs = allItems.map(i=>({
                                src: i.src, 
                                title: i.closest('.gallery-item').querySelector('.overlay p')?.textContent || i.alt || ''
                            }));
                            const idx = allItems.indexOf(img); 
                            if(idx !== -1) openLightbox(img.src, imgs[idx].title, imgs, idx);
                        }
                    }
                }
                
                // C. Carrito Eliminar
                if (e.target.closest('.cart-item-remove-btn')) {
                    const id = e.target.closest('.cart-item-remove-btn').dataset.cartId;
                    cart = cart.filter(i => i.cartId !== id);
                    saveCartToMemory();
                    renderCart(); updateCartIcon();
                }
            });
    
            // Listeners Fijos
            if(mobileMenuButton) mobileMenuButton.onclick = () => toggleMobileMenu();
            if(cartButton) cartButton.onclick = () => toggleCart(true);
            if(mobileCartButton) mobileCartButton.onclick = () => { toggleCart(true); toggleMobileMenu(false); };
            if(cartCloseBtn) cartCloseBtn.onclick = () => toggleCart(false);
            if(cartOverlay) cartOverlay.onclick = () => toggleCart(false);
            if(checkoutBtn) checkoutBtn.onclick = () => { if(cart.length>0){ toggleCart(false); setTimeout(showCheckoutModal,500); }};
            
            if(lightboxClose) lightboxClose.onclick = closeLightbox;
            if(lightboxPrev) lightboxPrev.onclick = () => navigateLightbox('prev');
            if(lightboxNext) lightboxNext.onclick = () => navigateLightbox('next');
            if(lightbox) lightbox.onclick = (e) => { if(e.target===lightbox) closeLightbox(); };
            
            document.onkeydown = (e) => {
                if (lightbox.classList.contains('visible')) {
                    if(e.key==='Escape') closeLightbox();
                    if(e.key==='ArrowLeft') navigateLightbox('prev');
                    if(e.key==='ArrowRight') navigateLightbox('next');
                }
            };
    
            // Scroll
            window.addEventListener('scroll', handleScrollHeader, { passive: true });
    
            // ARRANCAR
            initialize();
        });
    </script>
</body>
</html>
